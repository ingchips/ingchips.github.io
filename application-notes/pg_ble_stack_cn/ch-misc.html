<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>12 杂项 | 低功耗蓝牙开发者手册</title>
  <meta name="description" content="12 杂项 | 低功耗蓝牙开发者手册." />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="12 杂项 | 低功耗蓝牙开发者手册" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="12 杂项 | 低功耗蓝牙开发者手册." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="12 杂项 | 低功耗蓝牙开发者手册" />
  
  <meta name="twitter:description" content="12 杂项 | 低功耗蓝牙开发者手册." />
  

<meta name="author" content="Ingchips Technology Co., Ltd." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-sm.html"/>
<link rel="next" href="ch-cap.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">低功耗蓝牙开发者手册</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 版本历史</a></li>
<li class="chapter" data-level="2" data-path="ch-intro.html"><a href="ch-intro.html"><i class="fa fa-check"></i><b>2</b> 简介</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-intro.html"><a href="ch-intro.html#缩略语及术语"><i class="fa fa-check"></i><b>2.1</b> 缩略语及术语</a></li>
<li class="chapter" data-level="2.2" data-path="ch-intro.html"><a href="ch-intro.html#参考文档"><i class="fa fa-check"></i><b>2.2</b> 参考文档</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ch-overview.html"><a href="ch-overview.html"><i class="fa fa-check"></i><b>3</b> 概览</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-overview.html"><a href="ch-overview.html#基本原则"><i class="fa fa-check"></i><b>3.1</b> 基本原则</a></li>
<li class="chapter" data-level="3.2" data-path="ch-overview.html"><a href="ch-overview.html#协议栈架构"><i class="fa fa-check"></i><b>3.2</b> 协议栈架构</a></li>
<li class="chapter" data-level="3.3" data-path="ch-overview.html"><a href="ch-overview.html#ch-overview-comm-model"><i class="fa fa-check"></i><b>3.3</b> 通信模型</a></li>
<li class="chapter" data-level="3.4" data-path="ch-overview.html"><a href="ch-overview.html#回调函数事件包"><i class="fa fa-check"></i><b>3.4</b> 回调函数事件包</a></li>
<li class="chapter" data-level="3.5" data-path="ch-overview.html"><a href="ch-overview.html#事件包的解析"><i class="fa fa-check"></i><b>3.5</b> 事件包的解析</a></li>
<li class="chapter" data-level="3.6" data-path="ch-overview.html"><a href="ch-overview.html#ch0-ctrl-err-code"><i class="fa fa-check"></i><b>3.6</b> Controller 错误码</a></li>
<li class="chapter" data-level="3.7" data-path="ch-overview.html"><a href="ch-overview.html#ch0-att-err-codes"><i class="fa fa-check"></i><b>3.7</b> ATT 错误码</a></li>
<li class="chapter" data-level="3.8" data-path="ch-overview.html"><a href="ch-overview.html#controller-特性定义"><i class="fa fa-check"></i><b>3.8</b> Controller 特性定义</a></li>
<li class="chapter" data-level="3.9" data-path="ch-overview.html"><a href="ch-overview.html#蓝牙规范版本编号"><i class="fa fa-check"></i><b>3.9</b> 蓝牙规范版本编号</a></li>
<li class="chapter" data-level="3.10" data-path="ch-overview.html"><a href="ch-overview.html#白名单"><i class="fa fa-check"></i><b>3.10</b> 白名单</a></li>
<li class="chapter" data-level="3.11" data-path="ch-overview.html"><a href="ch-overview.html#异步特性"><i class="fa fa-check"></i><b>3.11</b> 异步特性</a></li>
<li class="chapter" data-level="3.12" data-path="ch-overview.html"><a href="ch-overview.html#线程安全性"><i class="fa fa-check"></i><b>3.12</b> 线程安全性</a></li>
<li class="chapter" data-level="3.13" data-path="ch-overview.html"><a href="ch-overview.html#ch-overview-ble-addr"><i class="fa fa-check"></i><b>3.13</b> BLE 设备地址</a></li>
<li class="chapter" data-level="3.14" data-path="ch-overview.html"><a href="ch-overview.html#解析列表与隐私"><i class="fa fa-check"></i><b>3.14</b> 解析列表与隐私</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-features.html"><a href="ch-features.html"><i class="fa fa-check"></i><b>4</b> 特性简析</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-features.html"><a href="ch-features.html#新特性"><i class="fa fa-check"></i><b>4.1</b> 5.0 新特性</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-features.html"><a href="ch-features.html#新的-phy"><i class="fa fa-check"></i><b>4.1.1</b> 新的 PHY</a></li>
<li class="chapter" data-level="4.1.2" data-path="ch-features.html"><a href="ch-features.html#扩展广播"><i class="fa fa-check"></i><b>4.1.2</b> 扩展广播</a></li>
<li class="chapter" data-level="4.1.3" data-path="ch-features.html"><a href="ch-features.html#周期广播"><i class="fa fa-check"></i><b>4.1.3</b> 周期广播</a></li>
<li class="chapter" data-level="4.1.4" data-path="ch-features.html"><a href="ch-features.html#信道选择算法-2"><i class="fa fa-check"></i><b>4.1.4</b> 信道选择算法 #2</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-features.html"><a href="ch-features.html#新特性-1"><i class="fa fa-check"></i><b>4.2</b> 5.1 新特性</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-features.html"><a href="ch-features.html#cte"><i class="fa fa-check"></i><b>4.2.1</b> CTE</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-features.html"><a href="ch-features.html#ch-feature-prd-transfer"><i class="fa fa-check"></i><b>4.2.2</b> 周期广播同步信息传递</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-features.html"><a href="ch-features.html#新特性-2"><i class="fa fa-check"></i><b>4.3</b> 5.2 新特性</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-features.html"><a href="ch-features.html#le-audio"><i class="fa fa-check"></i><b>4.3.1</b> LE Audio</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-features.html"><a href="ch-features.html#增强的-atteatt"><i class="fa fa-check"></i><b>4.3.2</b> 增强的 ATT（EATT）</a></li>
<li class="chapter" data-level="4.3.3" data-path="ch-features.html"><a href="ch-features.html#路径损耗监测与功率控制"><i class="fa fa-check"></i><b>4.3.3</b> 路径损耗监测与功率控制</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="ch-features.html"><a href="ch-features.html#新特性-3"><i class="fa fa-check"></i><b>4.4</b> 5.3 新特性</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="ch-features.html"><a href="ch-features.html#减速模式"><i class="fa fa-check"></i><b>4.4.1</b> 减速模式</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="ch-features.html"><a href="ch-features.html#新特性-4"><i class="fa fa-check"></i><b>4.5</b> 5.4 新特性</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="ch-features.html"><a href="ch-features.html#带响应的周期广播pawr"><i class="fa fa-check"></i><b>4.5.1</b> 带响应的周期广播（PAwR）</a></li>
<li class="chapter" data-level="4.5.2" data-path="ch-features.html"><a href="ch-features.html#广播数据加密"><i class="fa fa-check"></i><b>4.5.2</b> 广播数据加密</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="ch-features.html"><a href="ch-features.html#其它"><i class="fa fa-check"></i><b>4.6</b> 其它</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="ch-features.html"><a href="ch-features.html#广播时-coded-phy-选择"><i class="fa fa-check"></i><b>4.6.1</b> 广播时 Coded PHY 选择</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-adv.html"><a href="ch-adv.html"><i class="fa fa-check"></i><b>5</b> GAP - 广播</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-adv.html"><a href="ch-adv.html#概览"><i class="fa fa-check"></i><b>5.1</b> 概览</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="ch-adv.html"><a href="ch-adv.html#类型"><i class="fa fa-check"></i><b>5.1.1</b> 类型</a></li>
<li class="chapter" data-level="5.1.2" data-path="ch-adv.html"><a href="ch-adv.html#ch1-adv-filter"><i class="fa fa-check"></i><b>5.1.2</b> 过滤策略</a></li>
<li class="chapter" data-level="5.1.3" data-path="ch-adv.html"><a href="ch-adv.html#phy"><i class="fa fa-check"></i><b>5.1.3</b> PHY</a></li>
<li class="chapter" data-level="5.1.4" data-path="ch-adv.html"><a href="ch-adv.html#广播集"><i class="fa fa-check"></i><b>5.1.4</b> 广播集</a></li>
<li class="chapter" data-level="5.1.5" data-path="ch-adv.html"><a href="ch-adv.html#相关事件"><i class="fa fa-check"></i><b>5.1.5</b> 相关事件</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ch-adv.html"><a href="ch-adv.html#使用说明"><i class="fa fa-check"></i><b>5.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-adv.html"><a href="ch-adv.html#配置广播"><i class="fa fa-check"></i><b>5.2.1</b> 配置广播</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-adv.html"><a href="ch-adv.html#ch1-adv-data-edit"><i class="fa fa-check"></i><b>5.2.2</b> 广播数据</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch-adv.html"><a href="ch-adv.html#配置周期广播"><i class="fa fa-check"></i><b>5.2.3</b> 配置周期广播</a></li>
<li class="chapter" data-level="5.2.4" data-path="ch-adv.html"><a href="ch-adv.html#起停广播"><i class="fa fa-check"></i><b>5.2.4</b> 起停广播</a></li>
<li class="chapter" data-level="5.2.5" data-path="ch-adv.html"><a href="ch-adv.html#起停周期广播"><i class="fa fa-check"></i><b>5.2.5</b> 起停周期广播</a></li>
<li class="chapter" data-level="5.2.6" data-path="ch-adv.html"><a href="ch-adv.html#为周期广播添加-cte"><i class="fa fa-check"></i><b>5.2.6</b> 为周期广播添加 CTE</a></li>
<li class="chapter" data-level="5.2.7" data-path="ch-adv.html"><a href="ch-adv.html#带响应的周期广播pawr-1"><i class="fa fa-check"></i><b>5.2.7</b> 带响应的周期广播（PAwR）</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-scan.html"><a href="ch-scan.html"><i class="fa fa-check"></i><b>6</b> GAP - 扫描</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-scan.html"><a href="ch-scan.html#概览-1"><i class="fa fa-check"></i><b>6.1</b> 概览</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-scan.html"><a href="ch-scan.html#间隔与窗口"><i class="fa fa-check"></i><b>6.1.1</b> 间隔与窗口</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-scan.html"><a href="ch-scan.html#过滤策略"><i class="fa fa-check"></i><b>6.1.2</b> 过滤策略</a></li>
<li class="chapter" data-level="6.1.3" data-path="ch-scan.html"><a href="ch-scan.html#主动与被动"><i class="fa fa-check"></i><b>6.1.3</b> 主动与被动</a></li>
<li class="chapter" data-level="6.1.4" data-path="ch-scan.html"><a href="ch-scan.html#phy-1"><i class="fa fa-check"></i><b>6.1.4</b> PHY</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-scan.html"><a href="ch-scan.html#使用说明-1"><i class="fa fa-check"></i><b>6.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ch-scan.html"><a href="ch-scan.html#配置参数"><i class="fa fa-check"></i><b>6.2.1</b> 配置参数</a></li>
<li class="chapter" data-level="6.2.2" data-path="ch-scan.html"><a href="ch-scan.html#起停扫描"><i class="fa fa-check"></i><b>6.2.2</b> 起停扫描</a></li>
<li class="chapter" data-level="6.2.3" data-path="ch-scan.html"><a href="ch-scan.html#处理数据"><i class="fa fa-check"></i><b>6.2.3</b> 处理数据</a></li>
<li class="chapter" data-level="6.2.4" data-path="ch-scan.html"><a href="ch-scan.html#与周期广播同步"><i class="fa fa-check"></i><b>6.2.4</b> 与周期广播同步</a></li>
<li class="chapter" data-level="6.2.5" data-path="ch-scan.html"><a href="ch-scan.html#与-pawr-同步"><i class="fa fa-check"></i><b>6.2.5</b> 与 PAwR 同步</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-conn.html"><a href="ch-conn.html"><i class="fa fa-check"></i><b>7</b> GAP - 连接</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-conn.html"><a href="ch-conn.html#概览-2"><i class="fa fa-check"></i><b>7.1</b> 概览</a></li>
<li class="chapter" data-level="7.2" data-path="ch-conn.html"><a href="ch-conn.html#使用说明-2"><i class="fa fa-check"></i><b>7.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-conn.html"><a href="ch-conn.html#ch-scan-create-connection"><i class="fa fa-check"></i><b>7.2.1</b> 建立连接</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-conn.html"><a href="ch-conn.html#取消连接"><i class="fa fa-check"></i><b>7.2.2</b> 取消连接</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-conn.html"><a href="ch-conn.html#获取对端版本"><i class="fa fa-check"></i><b>7.2.3</b> 获取对端版本</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-conn.html"><a href="ch-conn.html#获取对端特性"><i class="fa fa-check"></i><b>7.2.4</b> 获取对端特性</a></li>
<li class="chapter" data-level="7.2.5" data-path="ch-conn.html"><a href="ch-conn.html#设置-phy"><i class="fa fa-check"></i><b>7.2.5</b> 设置 PHY</a></li>
<li class="chapter" data-level="7.2.6" data-path="ch-conn.html"><a href="ch-conn.html#更新连接参数"><i class="fa fa-check"></i><b>7.2.6</b> 更新连接参数</a></li>
<li class="chapter" data-level="7.2.7" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-subrating"><i class="fa fa-check"></i><b>7.2.7</b> 减速模式</a></li>
<li class="chapter" data-level="7.2.8" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-pathloss"><i class="fa fa-check"></i><b>7.2.8</b> 路损检测与上报</a></li>
<li class="chapter" data-level="7.2.9" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-power-ctrl"><i class="fa fa-check"></i><b>7.2.9</b> 功率控制</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html"><i class="fa fa-check"></i><b>8</b> GATT - 服务器</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#ch-gatt-server-overview"><i class="fa fa-check"></i><b>8.1</b> 概览</a></li>
<li class="chapter" data-level="8.2" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#使用说明-3"><i class="fa fa-check"></i><b>8.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#profile-数据"><i class="fa fa-check"></i><b>8.2.1</b> Profile 数据</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#实现读回调"><i class="fa fa-check"></i><b>8.2.2</b> 实现读回调</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#实现写回调"><i class="fa fa-check"></i><b>8.2.3</b> 实现写回调</a></li>
<li class="chapter" data-level="8.2.4" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#发送通知notification"><i class="fa fa-check"></i><b>8.2.4</b> 发送通知（Notification）</a></li>
<li class="chapter" data-level="8.2.5" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#发送指示indication"><i class="fa fa-check"></i><b>8.2.5</b> 发送指示（Indication）</a></li>
<li class="chapter" data-level="8.2.6" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#响应事件"><i class="fa fa-check"></i><b>8.2.6</b> 响应事件</a></li>
<li class="chapter" data-level="8.2.7" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#att_mtu"><i class="fa fa-check"></i><b>8.2.7</b> ATT_MTU</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html"><i class="fa fa-check"></i><b>9</b> GATT - 客户端</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#概览-3"><i class="fa fa-check"></i><b>9.1</b> 概览</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#句柄范围"><i class="fa fa-check"></i><b>9.1.1</b> 句柄范围</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#使用说明-4"><i class="fa fa-check"></i><b>9.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#创建客户端"><i class="fa fa-check"></i><b>9.2.1</b> 创建客户端</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#发现服务"><i class="fa fa-check"></i><b>9.2.2</b> 发现服务</a></li>
<li class="chapter" data-level="9.2.3" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#读取特征"><i class="fa fa-check"></i><b>9.2.3</b> 读取特征</a></li>
<li class="chapter" data-level="9.2.4" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#写入特征"><i class="fa fa-check"></i><b>9.2.4</b> 写入特征</a></li>
<li class="chapter" data-level="9.2.5" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#订阅特征"><i class="fa fa-check"></i><b>9.2.5</b> 订阅特征</a></li>
<li class="chapter" data-level="9.2.6" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#att_mtu-1"><i class="fa fa-check"></i><b>9.2.6</b> ATT_MTU</a></li>
<li class="chapter" data-level="9.2.7" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#自定义-mtu"><i class="fa fa-check"></i><b>9.2.7</b> 自定义 MTU </a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ch-l2cap.html"><a href="ch-l2cap.html"><i class="fa fa-check"></i><b>10</b> L2CAP</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-l2cap.html"><a href="ch-l2cap.html#概览-4"><i class="fa fa-check"></i><b>10.1</b> 概览</a></li>
<li class="chapter" data-level="10.2" data-path="ch-l2cap.html"><a href="ch-l2cap.html#使用说明-5"><i class="fa fa-check"></i><b>10.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="ch-l2cap.html"><a href="ch-l2cap.html#从端请求更新连接参数"><i class="fa fa-check"></i><b>10.2.1</b> 从端请求更新连接参数</a></li>
<li class="chapter" data-level="10.2.2" data-path="ch-l2cap.html"><a href="ch-l2cap.html#基于信用点的连接"><i class="fa fa-check"></i><b>10.2.2</b> 基于信用点的连接</a></li>
<li class="chapter" data-level="10.2.3" data-path="ch-l2cap.html"><a href="ch-l2cap.html#ch-i2cap-tx-queue"><i class="fa fa-check"></i><b>10.2.3</b> 传输队列</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-sm.html"><a href="ch-sm.html"><i class="fa fa-check"></i><b>11</b> 安全管理</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-sm.html"><a href="ch-sm.html#概览-5"><i class="fa fa-check"></i><b>11.1</b> 概览</a></li>
<li class="chapter" data-level="11.2" data-path="ch-sm.html"><a href="ch-sm.html#使用说明-6"><i class="fa fa-check"></i><b>11.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="ch-sm.html"><a href="ch-sm.html#初始化"><i class="fa fa-check"></i><b>11.2.1</b> 初始化</a></li>
<li class="chapter" data-level="11.2.2" data-path="ch-sm.html"><a href="ch-sm.html#使用私有随机地址"><i class="fa fa-check"></i><b>11.2.2</b> 使用私有随机地址</a></li>
<li class="chapter" data-level="11.2.3" data-path="ch-sm.html"><a href="ch-sm.html#sm-事件回调"><i class="fa fa-check"></i><b>11.2.3</b> SM 事件回调</a></li>
<li class="chapter" data-level="11.2.4" data-path="ch-sm.html"><a href="ch-sm.html#每个连接的个性化设置"><i class="fa fa-check"></i><b>11.2.4</b> 每个连接的个性化设置</a></li>
<li class="chapter" data-level="11.2.5" data-path="ch-sm.html"><a href="ch-sm.html#地址解析查找"><i class="fa fa-check"></i><b>11.2.5</b> 地址解析、查找</a></li>
<li class="chapter" data-level="11.2.6" data-path="ch-sm.html"><a href="ch-sm.html#p-256-椭圆曲线"><i class="fa fa-check"></i><b>11.2.6</b> P-256 椭圆曲线</a></li>
<li class="chapter" data-level="11.2.7" data-path="ch-sm.html"><a href="ch-sm.html#基于-oob-数据的配对"><i class="fa fa-check"></i><b>11.2.7</b> 基于 OOB 数据的配对</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-misc.html"><a href="ch-misc.html"><i class="fa fa-check"></i><b>12</b> 杂项</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-misc.html"><a href="ch-misc.html#接收-cte"><i class="fa fa-check"></i><b>12.1</b> 接收 CTE</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-misc.html"><a href="ch-misc.html#基于连接的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.1</b> 基于连接的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.2" data-path="ch-misc.html"><a href="ch-misc.html#misc-cte-periodic-adv"><i class="fa fa-check"></i><b>12.1.2</b> 基于周期广播的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.3" data-path="ch-misc.html"><a href="ch-misc.html#基于私有方式-1-的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.3</b> 基于私有方式 #1 的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.4" data-path="ch-misc.html"><a href="ch-misc.html#基于私有方式-2-的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.4</b> 基于私有方式 #2 的 CTE 接收和发送</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-misc.html"><a href="ch-misc.html#加密与解密"><i class="fa fa-check"></i><b>12.2</b> 加密与解密</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-misc.html"><a href="ch-misc.html#aes-128-加密"><i class="fa fa-check"></i><b>12.2.1</b> AES-128 加密</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-misc.html"><a href="ch-misc.html#aes-ccm"><i class="fa fa-check"></i><b>12.2.2</b> AES-CCM</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-misc.html"><a href="ch-misc.html#协议栈配置"><i class="fa fa-check"></i><b>12.3</b> 协议栈配置</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="ch-misc.html"><a href="ch-misc.html#data-length-与-mtu"><i class="fa fa-check"></i><b>12.3.1</b> Data Length 与 MTU</a></li>
<li class="chapter" data-level="12.3.2" data-path="ch-misc.html"><a href="ch-misc.html#面向测试"><i class="fa fa-check"></i><b>12.3.2</b> 面向测试</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="ch-misc.html"><a href="ch-misc.html#api-返回值"><i class="fa fa-check"></i><b>12.4</b> API 返回值</a></li>
<li class="chapter" data-level="12.5" data-path="ch-misc.html"><a href="ch-misc.html#键值存储接口与实现"><i class="fa fa-check"></i><b>12.5</b> 键值存储接口与实现</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="ch-misc.html"><a href="ch-misc.html#键值存储接口"><i class="fa fa-check"></i><b>12.5.1</b> 键值存储接口</a></li>
<li class="chapter" data-level="12.5.2" data-path="ch-misc.html"><a href="ch-misc.html#默认的键值存储实现"><i class="fa fa-check"></i><b>12.5.2</b> 默认的键值存储实现</a></li>
<li class="chapter" data-level="12.5.3" data-path="ch-misc.html"><a href="ch-misc.html#自定义键值存储实现"><i class="fa fa-check"></i><b>12.5.3</b> 自定义键值存储实现</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="ch-misc.html"><a href="ch-misc.html#ch98-le-dev-db"><i class="fa fa-check"></i><b>12.6</b> 设备数据库</a></li>
<li class="chapter" data-level="12.7" data-path="ch-misc.html"><a href="ch-misc.html#ch-misc-synced-api"><i class="fa fa-check"></i><b>12.7</b> 同步版 API</a>
<ul>
<li class="chapter" data-level="12.7.1" data-path="ch-misc.html"><a href="ch-misc.html#gap-同步-api"><i class="fa fa-check"></i><b>12.7.1</b> GAP 同步 API</a></li>
<li class="chapter" data-level="12.7.2" data-path="ch-misc.html"><a href="ch-misc.html#gatt-客户端同步-api"><i class="fa fa-check"></i><b>12.7.2</b> GATT 客户端同步 API</a></li>
</ul></li>
<li class="chapter" data-level="12.8" data-path="ch-misc.html"><a href="ch-misc.html#ch-misc-thread-safe-api"><i class="fa fa-check"></i><b>12.8</b> 线程安全的 API</a></li>
<li class="chapter" data-level="12.9" data-path="ch-misc.html"><a href="ch-misc.html#ch-misc-privacy"><i class="fa fa-check"></i><b>12.9</b> 链路层隐私</a>
<ul>
<li class="chapter" data-level="12.9.1" data-path="ch-misc.html"><a href="ch-misc.html#将已配对设备添加到解析列表"><i class="fa fa-check"></i><b>12.9.1</b> 将已配对设备添加到解析列表</a></li>
<li class="chapter" data-level="12.9.2" data-path="ch-misc.html"><a href="ch-misc.html#广播"><i class="fa fa-check"></i><b>12.9.2</b> 广播</a></li>
<li class="chapter" data-level="12.9.3" data-path="ch-misc.html"><a href="ch-misc.html#扫描"><i class="fa fa-check"></i><b>12.9.3</b> 扫描</a></li>
<li class="chapter" data-level="12.9.4" data-path="ch-misc.html"><a href="ch-misc.html#建立连接"><i class="fa fa-check"></i><b>12.9.4</b> 建立连接</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="ch-cap.html"><a href="ch-cap.html"><i class="fa fa-check"></i><b>13</b> 协议栈能力</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-cap.html"><a href="ch-cap.html#非标扩展"><i class="fa fa-check"></i><b>13.1</b> “非标”扩展</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">低功耗蓝牙开发者手册</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-misc" class="section level1 hasAnchor" number="12">
<h1><span class="header-section-number">12</span> 杂项<a href="ch-misc.html#ch-misc" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="接收-cte" class="section level2 hasAnchor" number="12.1">
<h2><span class="header-section-number">12.1</span> 接收 CTE<a href="ch-misc.html#接收-cte" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>共有四种 CTE 接收、发送方式<a href="ch-cap.html#fn53" class="footnote-ref" id="fnref53"><sup>53</sup></a>。
以 AoA 为例，各种方式的使用方法如下。</p>
<div id="基于连接的-cte-接收和发送" class="section level3 hasAnchor" number="12.1.1">
<h3><span class="header-section-number">12.1.1</span> 基于连接的 CTE 接收和发送<a href="ch-misc.html#基于连接的-cte-接收和发送" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>这种方式的使用可参考 SDK <em>Central CTE</em> 和 <em>Peripehral LED &amp; CTE</em>。</p>
<div id="发送方" class="section level4 hasAnchor" number="12.1.1.1">
<h4><span class="header-section-number">12.1.1.1</span> 发送方<a href="ch-misc.html#发送方" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>建立连接后：</p>
<ol style="list-style-type: decimal">
<li><p>调用 <code>gap_set_connection_cte_tx_param</code> 配置发送参数：</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb105-1"><a href="ch-misc.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connection_cte_tx_param<span class="op">(</span></span>
<span id="cb105-2"><a href="ch-misc.html#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb105-3"><a href="ch-misc.html#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> hci_con_handle_t  conn_handle<span class="op">,</span></span>
<span id="cb105-4"><a href="ch-misc.html#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 允许发送的 CTE 类型组合</span></span>
<span id="cb105-5"><a href="ch-misc.html#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           cte_types<span class="op">,</span></span>
<span id="cb105-6"><a href="ch-misc.html#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用于 AoD 发送的天线切换模板的长度</span></span>
<span id="cb105-7"><a href="ch-misc.html#cb105-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           switching_pattern_len<span class="op">,</span></span>
<span id="cb105-8"><a href="ch-misc.html#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用于 AoD 发送的天线切换模板</span></span>
<span id="cb105-9"><a href="ch-misc.html#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>          <span class="op">*</span>antenna_ids</span>
<span id="cb105-10"><a href="ch-misc.html#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<p>对于 AoA 模式，不需要配置天线切换模板，但是模板的长度必须至少为 <span class="math inline">\(2\)</span>：</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb106-1"><a href="ch-misc.html#cb106-1" aria-hidden="true" tabindex="-1"></a>gap_set_connection_cte_tx_param<span class="op">(</span></span>
<span id="cb106-2"><a href="ch-misc.html#cb106-2" aria-hidden="true" tabindex="-1"></a>  con_handle<span class="op">,</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> CTE_AOA<span class="op">),</span> <span class="dv">2</span><span class="op">,</span> NULL<span class="op">);</span></span></code></pre></div></li>
<li><p>调用 <code>gap_set_connection_cte_response_enable</code> 使能 CTE 响应：</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb107-1"><a href="ch-misc.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connection_cte_response_enable<span class="op">(</span></span>
<span id="cb107-2"><a href="ch-misc.html#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb107-3"><a href="ch-misc.html#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> hci_con_handle_t  conn_handle<span class="op">,</span></span>
<span id="cb107-4"><a href="ch-misc.html#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 是否使能</span></span>
<span id="cb107-5"><a href="ch-misc.html#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           enable<span class="op">);</span></span></code></pre></div></li>
</ol>
</div>
<div id="接收方" class="section level4 hasAnchor" number="12.1.1.2">
<h4><span class="header-section-number">12.1.1.2</span> 接收方<a href="ch-misc.html#接收方" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>使用 <code>ll_set_def_antenna</code> 配置默认天线。建立连接后：</p>
<ol style="list-style-type: decimal">
<li><p>调用 <code>gap_set_connection_cte_rx_param</code> 配置接收参数：</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb108-1"><a href="ch-misc.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connection_cte_rx_param<span class="op">(</span></span>
<span id="cb108-2"><a href="ch-misc.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb108-3"><a href="ch-misc.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> hci_con_handle_t  conn_handle<span class="op">,</span></span>
<span id="cb108-4"><a href="ch-misc.html#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 是否使能 CTE 采样</span></span>
<span id="cb108-5"><a href="ch-misc.html#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           sampling_enable<span class="op">,</span></span>
<span id="cb108-6"><a href="ch-misc.html#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 时隙长度</span></span>
<span id="cb108-7"><a href="ch-misc.html#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> cte_slot_duration_type_t slot_durations<span class="op">,</span></span>
<span id="cb108-8"><a href="ch-misc.html#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 天线切换模板的长度</span></span>
<span id="cb108-9"><a href="ch-misc.html#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           switching_pattern_len<span class="op">,</span></span>
<span id="cb108-10"><a href="ch-misc.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 天线切换模板</span></span>
<span id="cb108-11"><a href="ch-misc.html#cb108-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>          <span class="op">*</span>antenna_ids<span class="op">);</span></span></code></pre></div>
<p>时隙长度共有两种：</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb109-1"><a href="ch-misc.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb109-2"><a href="ch-misc.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb109-3"><a href="ch-misc.html#cb109-3" aria-hidden="true" tabindex="-1"></a>    CTE_SLOT_DURATION_1US <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb109-4"><a href="ch-misc.html#cb109-4" aria-hidden="true" tabindex="-1"></a>    CTE_SLOT_DURATION_2US <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb109-5"><a href="ch-misc.html#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> cte_slot_duration_type_t<span class="op">;</span></span></code></pre></div>
<p>关于天线切换模板的更多信息请参考《Application Note: Direction Finding Solution》。</p></li>
<li><p>调用 <code>gap_set_connection_cte_request_enable</code> 开始发送 CTE 请求</p>
<p>连接模式的 CTE 为按需发送：一方发送一次 CTE 请求，对方就响应一次。</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb110-1"><a href="ch-misc.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connection_cte_request_enable<span class="op">(</span></span>
<span id="cb110-2"><a href="ch-misc.html#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb110-3"><a href="ch-misc.html#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> hci_con_handle_t  conn_handle<span class="op">,</span></span>
<span id="cb110-4"><a href="ch-misc.html#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 是否使能</span></span>
<span id="cb110-5"><a href="ch-misc.html#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           enable<span class="op">,</span></span>
<span id="cb110-6"><a href="ch-misc.html#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 发送 CTE 请求的间隔</span></span>
<span id="cb110-7"><a href="ch-misc.html#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint16_t</span>          requested_cte_interval<span class="op">,</span></span>
<span id="cb110-8"><a href="ch-misc.html#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 请求的 CTE 的长度（范围 2~20，单位 8μs）</span></span>
<span id="cb110-9"><a href="ch-misc.html#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>           requested_cte_length<span class="op">,</span></span>
<span id="cb110-10"><a href="ch-misc.html#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 请求的 CTE 的类型</span></span>
<span id="cb110-11"><a href="ch-misc.html#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> cte_type_t        requested_cte_type<span class="op">);</span></span></code></pre></div>
<p><code>requested_cte_interval</code> 表示每 <code>requested_cte_interval</code> 个连接间隔发送一次 CTE 请求， <span class="math inline">\(0\)</span> 表示只发送一次。
对于 AoA，<code>requested_cte_type</code> 为 <code>CTE_AOA</code>。</p></li>
<li><p>响应 <code>HCI_SUBEVENT_LE_CONNECTION_IQ_REPORT</code> 事件</p>
<p>使用 <code>decode_hci_le_meta_event</code> 解析事件内容：</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb111-1"><a href="ch-misc.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> le_meta_conn_iq_report_t <span class="op">*</span>rpt <span class="op">=</span></span>
<span id="cb111-2"><a href="ch-misc.html#cb111-2" aria-hidden="true" tabindex="-1"></a>  decode_hci_le_meta_event<span class="op">(</span>packet<span class="op">,</span> le_meta_conn_iq_report_t<span class="op">);</span></span></code></pre></div>
<p>如果 CTE 请求失败（未收到响应），则会收到 <code>HCI_SUBEVENT_LE_CTE_REQ_FAILED</code> 事件。</p></li>
</ol>
</div>
</div>
<div id="misc-cte-periodic-adv" class="section level3 hasAnchor" number="12.1.2">
<h3><span class="header-section-number">12.1.2</span> 基于周期广播的 CTE 接收和发送<a href="ch-misc.html#misc-cte-periodic-adv" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>这种方式的使用可参考 SDK <em>Periodic Advertiser</em> 和 <em>Periodic Scanner</em>。</p>
<div id="发送方-1" class="section level4 hasAnchor" number="12.1.2.1">
<h4><span class="header-section-number">12.1.2.1</span> 发送方<a href="ch-misc.html#发送方-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>使能周期广播后，</p>
<ol style="list-style-type: decimal">
<li><p>调用 <code>gap_set_connectionless_cte_tx_param</code> 配置 CTE 发送参数</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb112-1"><a href="ch-misc.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connectionless_cte_tx_param<span class="op">(</span></span>
<span id="cb112-2"><a href="ch-misc.html#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 广播句柄</span></span>
<span id="cb112-3"><a href="ch-misc.html#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       adv_handle<span class="op">,</span></span>
<span id="cb112-4"><a href="ch-misc.html#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// CTE 长度（范围 2~20，单位 8μs）</span></span>
<span id="cb112-5"><a href="ch-misc.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       cte_len<span class="op">,</span></span>
<span id="cb112-6"><a href="ch-misc.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// CTE 类型（对于 AoA，即 CTE_AOA）</span></span>
<span id="cb112-7"><a href="ch-misc.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> cte_type_t    cte_type<span class="op">,</span></span>
<span id="cb112-8"><a href="ch-misc.html#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 一个周期广播里 CTE 发送次数</span></span>
<span id="cb112-9"><a href="ch-misc.html#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       cte_count<span class="op">,</span></span>
<span id="cb112-10"><a href="ch-misc.html#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用于 AoD 发送的天线切换模板的长度</span></span>
<span id="cb112-11"><a href="ch-misc.html#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       switching_pattern_len<span class="op">,</span></span>
<span id="cb112-12"><a href="ch-misc.html#cb112-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用于 AoD 发送的天线切换模板</span></span>
<span id="cb112-13"><a href="ch-misc.html#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>      <span class="op">*</span>antenna_ids<span class="op">);</span></span></code></pre></div></li>
<li><p>调用 <code>gap_set_connectionless_cte_tx_enable</code> 使能 CTE 发送</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb113-1"><a href="ch-misc.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connectionless_cte_tx_enable<span class="op">(</span></span>
<span id="cb113-2"><a href="ch-misc.html#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 广播句柄</span></span>
<span id="cb113-3"><a href="ch-misc.html#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       adv_handle<span class="op">,</span></span>
<span id="cb113-4"><a href="ch-misc.html#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 是否使能</span></span>
<span id="cb113-5"><a href="ch-misc.html#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       cte_enable<span class="op">);</span></span></code></pre></div>
<h4 id="接收方-1" class="hasAnchor">接收方<a href="ch-misc.html#接收方-1" class="anchor-section" aria-label="Anchor link to header"></a></h4></li>
</ol>
<p>与周期广播建立同步后，调用 <code>gap_set_connectionless_iq_sampling_enable</code> 启动 CTE 接收。</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb114-1"><a href="ch-misc.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_set_connectionless_iq_sampling_enable<span class="op">(</span></span>
<span id="cb114-2"><a href="ch-misc.html#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 同步句柄</span></span>
<span id="cb114-3"><a href="ch-misc.html#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint16_t</span>      sync_handle<span class="op">,</span></span>
<span id="cb114-4"><a href="ch-misc.html#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 是否使能采样</span></span>
<span id="cb114-5"><a href="ch-misc.html#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       sampling_enable<span class="op">,</span></span>
<span id="cb114-6"><a href="ch-misc.html#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 时隙长度</span></span>
<span id="cb114-7"><a href="ch-misc.html#cb114-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> cte_slot_duration_type_t slot_durations<span class="op">,</span></span>
<span id="cb114-8"><a href="ch-misc.html#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 每个周期广播间隔内最多接收多少个 CTE</span></span>
<span id="cb114-9"><a href="ch-misc.html#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       max_sampled_ctes<span class="op">,</span></span>
<span id="cb114-10"><a href="ch-misc.html#cb114-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 天线切换模板长度</span></span>
<span id="cb114-11"><a href="ch-misc.html#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>       switching_pattern_len<span class="op">,</span></span>
<span id="cb114-12"><a href="ch-misc.html#cb114-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 天线切换模板</span></span>
<span id="cb114-13"><a href="ch-misc.html#cb114-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span>      <span class="op">*</span>antenna_ids<span class="op">);</span></span></code></pre></div>
<p>此后就可以周期性收到 <code>HCI_SUBEVENT_LE_CONNECTIONLESS_IQ_REPORT</code> 事件，利用 <code>decode_hci_le_meta_event</code>
解析事件内容：</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb115-1"><a href="ch-misc.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> le_meta_connless_iq_report_t <span class="op">*</span>rpt <span class="op">=</span></span>
<span id="cb115-2"><a href="ch-misc.html#cb115-2" aria-hidden="true" tabindex="-1"></a>  decode_hci_le_meta_event<span class="op">(</span>packet<span class="op">,</span> le_meta_connless_iq_report_t<span class="op">);</span></span></code></pre></div>
</div>
</div>
<div id="基于私有方式-1-的-cte-接收和发送" class="section level3 hasAnchor" number="12.1.3">
<h3><span class="header-section-number">12.1.3</span> 基于私有方式 #1 的 CTE 接收和发送<a href="ch-misc.html#基于私有方式-1-的-cte-接收和发送" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>这种方式最为灵活，需要配置的参数也最多，可参考 SDK <em>Ext. Raw Packet Tx/Rx</em>。</p>
</div>
<div id="基于私有方式-2-的-cte-接收和发送" class="section level3 hasAnchor" number="12.1.4">
<h3><span class="header-section-number">12.1.4</span> 基于私有方式 #2 的 CTE 接收和发送<a href="ch-misc.html#基于私有方式-2-的-cte-接收和发送" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>这种方式的使用可参考 SDK <em>Central CTE</em> 和 <em>Peripehral LED &amp; CTE</em>。</p>
<div id="发送方-2" class="section level4 hasAnchor" number="12.1.4.1">
<h4><span class="header-section-number">12.1.4.1</span> 发送方<a href="ch-misc.html#发送方-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>配置一个扩展广播集，属性设置为不可连接、不可扫描。待广播集使能后，调用 <code>ll_attach_cte_to_adv_set</code><a href="ch-cap.html#fn54" class="footnote-ref" id="fnref54"><sup>54</sup></a>
为扩展广播附加 CTE。</p>
</div>
<div id="接收方-2" class="section level4 hasAnchor" number="12.1.4.2">
<h4><span class="header-section-number">12.1.4.2</span> 接收方<a href="ch-misc.html#接收方-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>启动扫描之后，调用 <code>ll_scanner_enable_iq_sampling</code><a href="ch-cap.html#fn55" class="footnote-ref" id="fnref55"><sup>55</sup></a> 使能 CTE 采样。
之后，通过 <code>HCI_SUBEVENT_LE_VENDOR_PRO_CONNECTIONLESS_IQ_REPORT</code> 事件获得 CTE 报告。</p>
</div>
</div>
</div>
<div id="加密与解密" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> 加密与解密<a href="ch-misc.html#加密与解密" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="aes-128-加密" class="section level3 hasAnchor" number="12.2.1">
<h3><span class="header-section-number">12.2.1</span> AES-128 加密<a href="ch-misc.html#aes-128-加密" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>通过 <code>gap_aes_encrypt</code> 进行 AES-128 加密：</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb116-1"><a href="ch-misc.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_aes_encrypt<span class="op">(</span></span>
<span id="cb116-2"><a href="ch-misc.html#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>key<span class="op">,</span>           <span class="co">// 密钥（大端模式）</span></span>
<span id="cb116-3"><a href="ch-misc.html#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>plaintext<span class="op">,</span>     <span class="co">// 明文（大端模式）</span></span>
<span id="cb116-4"><a href="ch-misc.html#cb116-4" aria-hidden="true" tabindex="-1"></a>  gap_hci_cmd_complete_cb_t cb<span class="op">,</span> <span class="co">// 加密完成后的回调</span></span>
<span id="cb116-5"><a href="ch-misc.html#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">);</span>             <span class="co">// 回调函数的用户数据</span></span></code></pre></div>
<p>以 <a href="https://www.nist.gov/publications/advanced-encryption-standard-aes">FIPS 197</a>
里的数据为例：</p>
<pre><code>PLAINTEXT: 00112233445566778899aabbccddeeff
KEY:       000102030405060708090a0b0c0d0e0f
CIPHERTEXT:69c4e0d86a7b0430d8cdb78070b4c55a</code></pre>
<p>写成大端模式的数组形式：</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb118-1"><a href="ch-misc.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> plain_text<span class="op">[]</span> <span class="op">=</span></span>
<span id="cb118-2"><a href="ch-misc.html#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x11</span><span class="op">,</span> <span class="bn">0x22</span><span class="op">,</span> <span class="bn">0x33</span><span class="op">,</span> <span class="bn">0x44</span><span class="op">,</span> <span class="bn">0x55</span><span class="op">,</span> <span class="bn">0x66</span><span class="op">,</span> <span class="bn">0x77</span><span class="op">,</span></span>
<span id="cb118-3"><a href="ch-misc.html#cb118-3" aria-hidden="true" tabindex="-1"></a>     <span class="bn">0x88</span><span class="op">,</span> <span class="bn">0x99</span><span class="op">,</span> <span class="bn">0xaa</span><span class="op">,</span> <span class="bn">0xbb</span><span class="op">,</span> <span class="bn">0xcc</span><span class="op">,</span> <span class="bn">0xdd</span><span class="op">,</span> <span class="bn">0xee</span><span class="op">,</span> <span class="bn">0xff</span><span class="op">};</span></span>
<span id="cb118-4"><a href="ch-misc.html#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> key<span class="op">[]</span> <span class="op">=</span></span>
<span id="cb118-5"><a href="ch-misc.html#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x02</span><span class="op">,</span> <span class="bn">0x03</span><span class="op">,</span> <span class="bn">0x04</span><span class="op">,</span> <span class="bn">0x05</span><span class="op">,</span> <span class="bn">0x06</span><span class="op">,</span> <span class="bn">0x07</span><span class="op">,</span></span>
<span id="cb118-6"><a href="ch-misc.html#cb118-6" aria-hidden="true" tabindex="-1"></a>     <span class="bn">0x08</span><span class="op">,</span> <span class="bn">0x09</span><span class="op">,</span> <span class="bn">0x0a</span><span class="op">,</span> <span class="bn">0x0b</span><span class="op">,</span> <span class="bn">0x0c</span><span class="op">,</span> <span class="bn">0x0d</span><span class="op">,</span> <span class="bn">0x0e</span><span class="op">,</span> <span class="bn">0x0f</span><span class="op">};</span></span>
<span id="cb118-7"><a href="ch-misc.html#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> cipher_text<span class="op">[]</span> <span class="op">=</span></span>
<span id="cb118-8"><a href="ch-misc.html#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="bn">0x69</span><span class="op">,</span> <span class="bn">0xc4</span><span class="op">,</span> <span class="bn">0xe0</span><span class="op">,</span> <span class="bn">0xd8</span><span class="op">,</span> <span class="bn">0x6a</span><span class="op">,</span> <span class="bn">0x7b</span><span class="op">,</span> <span class="bn">0x04</span><span class="op">,</span> <span class="bn">0x30</span><span class="op">,</span></span>
<span id="cb118-9"><a href="ch-misc.html#cb118-9" aria-hidden="true" tabindex="-1"></a>     <span class="bn">0xd8</span><span class="op">,</span> <span class="bn">0xcd</span><span class="op">,</span> <span class="bn">0xb7</span><span class="op">,</span> <span class="bn">0x80</span><span class="op">,</span> <span class="bn">0x70</span><span class="op">,</span> <span class="bn">0xb4</span><span class="op">,</span> <span class="bn">0xc5</span><span class="op">,</span> <span class="bn">0x5a</span><span class="op">};</span></span></code></pre></div>
<p>加密：</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb119-1"><a href="ch-misc.html#cb119-1" aria-hidden="true" tabindex="-1"></a>gap_aes_encrypt<span class="op">(</span>key<span class="op">,</span> plain_text<span class="op">,</span> aes_cb<span class="op">,</span> NULL<span class="op">);</span></span></code></pre></div>
<p>在回调函数 <code>aes_cb</code> 对比密文如下：</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb120-1"><a href="ch-misc.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> aes_cb<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>return_param<span class="op">,</span> <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb120-2"><a href="ch-misc.html#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb120-3"><a href="ch-misc.html#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> reversed<span class="op">[</span><span class="dv">16</span><span class="op">];</span></span>
<span id="cb120-4"><a href="ch-misc.html#cb120-4" aria-hidden="true" tabindex="-1"></a>    reverse_bytes<span class="op">(</span>return_param <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> reversed<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>reversed<span class="op">));</span></span>
<span id="cb120-5"><a href="ch-misc.html#cb120-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Matched: %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb120-6"><a href="ch-misc.html#cb120-6" aria-hidden="true" tabindex="-1"></a>      memcmp<span class="op">(</span>reversed<span class="op">,</span> cipher_text<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>cipher_text<span class="op">))</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb120-7"><a href="ch-misc.html#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这里 <code>return_param</code> 的内容与规范中相应 HCI 命令的 Return Parameters 一致。密文采用小端模式，
所以需要反转为大端模式，再与测试数据比较。</p>
<p>在上一次 AES 加密完成前，允许再次调用 <code>gap_aes_encrypt</code>。所有的加密任务保存在一个队列中，顺序完成。</p>
<p>也通过 <code>ll_aes_encrypt</code> 进行 AES-128 加密。
使用时务必检查返回值，若不为 0 表示硬件正忙。遇到此情况时可稍后重试。</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb121-1"><a href="ch-misc.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ll_aes_encrypt<span class="op">(</span></span>
<span id="cb121-2"><a href="ch-misc.html#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>key<span class="op">,</span>       <span class="co">// 密钥（小端模式）</span></span>
<span id="cb121-3"><a href="ch-misc.html#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>plaintext<span class="op">,</span> <span class="co">// 明文（小端模式）</span></span>
<span id="cb121-4"><a href="ch-misc.html#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> <span class="op">*</span>ciphertext<span class="op">);</span>     <span class="co">// 密文（大端模式）</span></span></code></pre></div>
<p><code>ll_aes_encrypt</code> 与 <code>gap_aes_encrypt</code> 的不同点：</p>
<ul>
<li><code>ll_aes_encrypt</code> 以阻塞模式工作，不支持队列方式</li>
<li><code>ll_aes_encrypt</code> 可以更快完成加密</li>
<li>数据的大小端</li>
</ul>
</div>
<div id="aes-ccm" class="section level3 hasAnchor" number="12.2.2">
<h3><span class="header-section-number">12.2.2</span> AES-CCM<a href="ch-misc.html#aes-ccm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>CCM 是 Cipher Block Chaining-Message Authentication Code (CBC-MAC) 和 Counter 模式（CTR）的组合，同时对数据加密和生成认证信息。
通过 <code>gap_start_ccm</code> 启动 AES-CCM 计算<a href="ch-cap.html#fn56" class="footnote-ref" id="fnref56"><sup>56</sup></a>：</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb122-1"><a href="ch-misc.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> gap_start_ccm<span class="op">(</span></span>
<span id="cb122-2"><a href="ch-misc.html#cb122-2" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span>  type<span class="op">,</span>        <span class="co">// 类型：0 为加密，1 为解密</span></span>
<span id="cb122-3"><a href="ch-misc.html#cb122-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span>  mic_size<span class="op">,</span>    <span class="co">// MIC 长度（4 或 8 字节）</span></span>
<span id="cb122-4"><a href="ch-misc.html#cb122-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> msg_len<span class="op">,</span>     <span class="co">// 消息长度（最长 384 字节）</span></span>
<span id="cb122-5"><a href="ch-misc.html#cb122-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> aad_len<span class="op">,</span>     <span class="co">// AAD 长度（最长 16 字节，可为 0）</span></span>
<span id="cb122-6"><a href="ch-misc.html#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint32_t</span> tag<span class="op">,</span>         <span class="co">// 数据标签（任意值）</span></span>
<span id="cb122-7"><a href="ch-misc.html#cb122-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>key<span class="op">,</span>   <span class="co">// 密钥</span></span>
<span id="cb122-8"><a href="ch-misc.html#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>nonce<span class="op">,</span> <span class="co">// Nonce（长度 13 字节）</span></span>
<span id="cb122-9"><a href="ch-misc.html#cb122-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>msg<span class="op">,</span>   <span class="co">// 消息</span></span>
<span id="cb122-10"><a href="ch-misc.html#cb122-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>aad<span class="op">,</span>   <span class="co">// AAD</span></span>
<span id="cb122-11"><a href="ch-misc.html#cb122-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> <span class="op">*</span>out_msg<span class="op">,</span>     <span class="co">// 加解密输出</span></span>
<span id="cb122-12"><a href="ch-misc.html#cb122-12" aria-hidden="true" tabindex="-1"></a>        gap_hci_cmd_complete_cb_t cb<span class="op">,</span> <span class="co">// 计算完成后的回调</span></span>
<span id="cb122-13"><a href="ch-misc.html#cb122-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">);</span>             <span class="co">// 回调函数的用户数据</span></span></code></pre></div>
<p>AAD 为补充认证证数据（Additional Authenticated Data），可为数据提供额外的完整性保护。
这个函数使用了自定义的 HCI 消息 <code>HCI_VENDOR_CCM</code>。由于消息数据量大，这条消息仅传递指针，
因此所有的数据（<code>key</code>、<code>nonce</code>、<code>aad</code>、<code>msg</code>、<code>out_msg</code>）必须一直存在，直到计算完成方可释放。
加密时，输出到 <code>out_msg</code> 的数据长度为 (<code>msg_len</code> + <code>mic_size</code>)；解密时，<code>msg</code> 传入的数据长度为
(<code>msg_len</code> + <code>mic_size</code>)。</p>
<p>回调函数收到的 <code>return_param</code> 参数转换自 <code>event_vendor_ccm_complete_t *</code>。</p>
<p>例如：</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb123-1"><a href="ch-misc.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> plain_text<span class="op">[]</span> <span class="op">=</span></span>
<span id="cb123-2"><a href="ch-misc.html#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x11</span><span class="op">,</span> <span class="bn">0x22</span><span class="op">,</span> <span class="bn">0x33</span><span class="op">,</span> <span class="bn">0x44</span><span class="op">,</span> <span class="bn">0x55</span><span class="op">,</span> <span class="bn">0x66</span><span class="op">,</span> <span class="bn">0x77</span><span class="op">,</span></span>
<span id="cb123-3"><a href="ch-misc.html#cb123-3" aria-hidden="true" tabindex="-1"></a>     <span class="bn">0x88</span><span class="op">,</span> <span class="bn">0x99</span><span class="op">,</span> <span class="bn">0xaa</span><span class="op">,</span> <span class="bn">0xbb</span><span class="op">,</span> <span class="bn">0xcc</span><span class="op">,</span> <span class="bn">0xdd</span><span class="op">,</span> <span class="bn">0xee</span><span class="op">,</span> <span class="bn">0xff</span><span class="op">};</span></span>
<span id="cb123-4"><a href="ch-misc.html#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> key<span class="op">[]</span> <span class="op">=</span></span>
<span id="cb123-5"><a href="ch-misc.html#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x01</span><span class="op">,</span> <span class="bn">0x02</span><span class="op">,</span> <span class="bn">0x03</span><span class="op">,</span> <span class="bn">0x04</span><span class="op">,</span> <span class="bn">0x05</span><span class="op">,</span> <span class="bn">0x06</span><span class="op">,</span> <span class="bn">0x07</span><span class="op">,</span></span>
<span id="cb123-6"><a href="ch-misc.html#cb123-6" aria-hidden="true" tabindex="-1"></a>     <span class="bn">0x08</span><span class="op">,</span> <span class="bn">0x09</span><span class="op">,</span> <span class="bn">0x0a</span><span class="op">,</span> <span class="bn">0x0b</span><span class="op">,</span> <span class="bn">0x0c</span><span class="op">,</span> <span class="bn">0x0d</span><span class="op">,</span> <span class="bn">0x0e</span><span class="op">,</span> <span class="bn">0x0f</span><span class="op">};</span></span>
<span id="cb123-7"><a href="ch-misc.html#cb123-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-8"><a href="ch-misc.html#cb123-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MSG_LEN     16</span></span>
<span id="cb123-9"><a href="ch-misc.html#cb123-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MIC_SIZE    4</span></span>
<span id="cb123-10"><a href="ch-misc.html#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="ch-misc.html#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint8_t</span> nonce<span class="op">[</span><span class="dv">13</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">};</span></span>
<span id="cb123-12"><a href="ch-misc.html#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint8_t</span> ccm_enc_out<span class="op">[</span>MSG_LEN <span class="op">+</span> MIC_SIZE<span class="op">];</span></span>
<span id="cb123-13"><a href="ch-misc.html#cb123-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint8_t</span> ccm_dec_out<span class="op">[</span>MSG_LEN<span class="op">];</span></span></code></pre></div>
<p>加密：</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb124-1"><a href="ch-misc.html#cb124-1" aria-hidden="true" tabindex="-1"></a>gap_start_ccm<span class="op">(</span><span class="dv">0</span><span class="op">,</span> MIC_SIZE<span class="op">,</span> MSG_LEN<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb124-2"><a href="ch-misc.html#cb124-2" aria-hidden="true" tabindex="-1"></a>            key<span class="op">,</span> nonce<span class="op">,</span> plain_text<span class="op">,</span> NULL<span class="op">,</span></span>
<span id="cb124-3"><a href="ch-misc.html#cb124-3" aria-hidden="true" tabindex="-1"></a>            ccm_enc_out<span class="op">,</span> ccm_enc_cb<span class="op">,</span> NULL<span class="op">);;</span></span></code></pre></div>
<p>在回调函数 <code>ccm_enc_cb</code> 里解密：</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb125-1"><a href="ch-misc.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ccm_enc_cb<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>return_param<span class="op">,</span> <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb125-2"><a href="ch-misc.html#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb125-3"><a href="ch-misc.html#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> event_vendor_ccm_complete_t <span class="op">*</span>complete <span class="op">=</span></span>
<span id="cb125-4"><a href="ch-misc.html#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="dt">const</span> event_vendor_ccm_complete_t <span class="op">*)</span>return_param<span class="op">;</span></span>
<span id="cb125-5"><a href="ch-misc.html#cb125-5" aria-hidden="true" tabindex="-1"></a>  gap_start_ccm<span class="op">(</span><span class="dv">1</span><span class="op">,</span> MIC_SIZE<span class="op">,</span> MSG_LEN<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb125-6"><a href="ch-misc.html#cb125-6" aria-hidden="true" tabindex="-1"></a>        key<span class="op">,</span> nonce<span class="op">,</span> ccm_enc_out<span class="op">,</span> NULL<span class="op">,</span></span>
<span id="cb125-7"><a href="ch-misc.html#cb125-7" aria-hidden="true" tabindex="-1"></a>        ccm_dec_out<span class="op">,</span> ccm_dec_cb<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb125-8"><a href="ch-misc.html#cb125-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在回调函数 <code>ccm_dec_cb</code> 里检查 MIC 验证状态并比对数据：</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb126-1"><a href="ch-misc.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ccm_dec_cb<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>return_param<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb126-2"><a href="ch-misc.html#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb126-3"><a href="ch-misc.html#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> event_vendor_ccm_complete_t <span class="op">*</span>complete <span class="op">=</span></span>
<span id="cb126-4"><a href="ch-misc.html#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="dt">const</span> event_vendor_ccm_complete_t <span class="op">*)</span>return_param<span class="op">;</span></span>
<span id="cb126-5"><a href="ch-misc.html#cb126-5" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;CCM DEC Status: %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> complete<span class="op">-&gt;</span>status<span class="op">);</span></span>
<span id="cb126-6"><a href="ch-misc.html#cb126-6" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;Matched: %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb126-7"><a href="ch-misc.html#cb126-7" aria-hidden="true" tabindex="-1"></a>    memcmp<span class="op">(</span>ccm_dec_out<span class="op">,</span> plain_text<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>plain_text<span class="op">))</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb126-8"><a href="ch-misc.html#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>event_vendor_ccm_complete_t</code> 的定义如下：</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb127-1"><a href="ch-misc.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span></span>
<span id="cb127-2"><a href="ch-misc.html#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb127-3"><a href="ch-misc.html#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>  status<span class="op">;</span>   <span class="co">// 状态码</span></span>
<span id="cb127-4"><a href="ch-misc.html#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>  type<span class="op">;</span></span>
<span id="cb127-5"><a href="ch-misc.html#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>  mic_size<span class="op">;</span></span>
<span id="cb127-6"><a href="ch-misc.html#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> msg_len<span class="op">;</span></span>
<span id="cb127-7"><a href="ch-misc.html#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> aad_len<span class="op">;</span></span>
<span id="cb127-8"><a href="ch-misc.html#cb127-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> tag<span class="op">;</span></span>
<span id="cb127-9"><a href="ch-misc.html#cb127-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span>out_msg<span class="op">;</span></span>
<span id="cb127-10"><a href="ch-misc.html#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> event_vendor_ccm_complete_t<span class="op">;</span></span></code></pre></div>
<p>状态码在加密时，总是为 0；在解密时，0 表示 MIC 验证通过，非 0 表示失败。其它域与传入
<code>gap_start_ccm</code> 的参数一一对应、相等。</p>
<p>在上一次 AES-CCM 计算完成前，允许再次调用 <code>gap_start_ccm</code>。所有的计算任务保存在一个队列中，顺序完成。</p>
</div>
</div>
<div id="协议栈配置" class="section level2 hasAnchor" number="12.3">
<h2><span class="header-section-number">12.3</span> 协议栈配置<a href="ch-misc.html#协议栈配置" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>协议栈提供若干配置项，通过 <code>btstack_config</code> 配置：</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb128-1"><a href="ch-misc.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> btstack_config<span class="op">(</span></span>
<span id="cb128-2"><a href="ch-misc.html#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// btstack_config_item 的比特组合</span></span>
<span id="cb128-3"><a href="ch-misc.html#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> flags<span class="op">);</span></span></code></pre></div>
<p>每个配置项对应一个比特位，可通过“或”运算同时使能多项配置。</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb129-1"><a href="ch-misc.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> btstack_config_item <span class="op">{</span></span>
<span id="cb129-2"><a href="ch-misc.html#cb129-2" aria-hidden="true" tabindex="-1"></a>    STACK_ATT_SERVER_ENABLE_AUTO_DATA_LEN_REQ <span class="op">=</span> <span class="op">...,</span></span>
<span id="cb129-3"><a href="ch-misc.html#cb129-3" aria-hidden="true" tabindex="-1"></a>    STACK_GATT_CLIENT_DISABLE_AUTO_DATA_LEN_REQ <span class="op">=</span> <span class="op">...,</span></span>
<span id="cb129-4"><a href="ch-misc.html#cb129-4" aria-hidden="true" tabindex="-1"></a>    STACK_DISABLE_L2CAP_TIMEOUT <span class="op">=</span> <span class="op">...,</span></span>
<span id="cb129-5"><a href="ch-misc.html#cb129-5" aria-hidden="true" tabindex="-1"></a>    STACK_SM_USE_FIXED_CSRK <span class="op">=</span> <span class="op">...</span></span>
<span id="cb129-6"><a href="ch-misc.html#cb129-6" aria-hidden="true" tabindex="-1"></a>    STACK_GATT_CLIENT_DISABLE_MTU_EXCHANGE <span class="op">=</span> <span class="op">...</span></span>
<span id="cb129-7"><a href="ch-misc.html#cb129-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb129-8"><a href="ch-misc.html#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<div id="data-length-与-mtu" class="section level3 hasAnchor" number="12.3.1">
<h3><span class="header-section-number">12.3.1</span> Data Length 与 MTU<a href="ch-misc.html#data-length-与-mtu" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>低功耗蓝牙进入连接模式后，各层分别协商通信中数据包的大小，对于 ATT 层，由 MTU EXCHANGE 流程实现；对于链路层，由 DATA LENGTH 更新流程实现。</p>
<p>按照规范，进入连接模式后，DATA LENGTH 更新流程可以由主或从设备在任何时刻发起。这导致了一个问题：某些芯片无法处理对方设备“随时”发起的
DATA LENGTH 更新流程<a href="ch-cap.html#fn57" class="footnote-ref" id="fnref57"><sup>57</sup></a>。
为了更新地兼容不同的芯片，协议栈定义了两个配置项：</p>
<ul>
<li><code>STACK_ATT_SERVER_ENABLE_AUTO_DATA_LEN_REQ</code></li>
<li><code>STACK_GATT_CLIENT_DISABLE_AUTO_DATA_LEN_REQ</code></li>
</ul>
<p>这两个配置分别控制 GATT Server、Client 在 MTU EXCHANGE 时是否自动发起 DATA LENGTH 更新流程。默认情况下，Servier 不会自动发起更新流程，
而 Client 会自动发起。</p>
</div>
<div id="面向测试" class="section level3 hasAnchor" number="12.3.2">
<h3><span class="header-section-number">12.3.2</span> 面向测试<a href="ch-misc.html#面向测试" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>STACK_DISABLE_L2CAP_TIMEOUT</code> 用于防止 L2CAP 超时，<code>STACK_SM_USE_FIXED_CSRK</code> 用来使用固定的 CSRK。</p>
<p>当 GATT 客户端实例创建时，会自动发起 MTU 协商。通过 <code>STACK_GATT_CLIENT_DISABLE_MTU_EXCHANGE</code> 可关闭该功能，MTU 保持初始默认值 <code>ATT_MTU</code>。</p>
<p>这些配置项用于 PTS 测试。</p>
</div>
</div>
<div id="api-返回值" class="section level2 hasAnchor" number="12.4">
<h2><span class="header-section-number">12.4</span> API 返回值<a href="ch-misc.html#api-返回值" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>绝大多数协议栈 API 都带有 <code>uint8_t</code> 型的返回值，<span class="math inline">\(0\)</span> 为成功，非 <span class="math inline">\(0\)</span> 为错误。开发者需要关注这些返回值。</p>
<p>几个例子：</p>
<ul>
<li><p><code>att_server_notify</code> 的返回值：</p>
<ul>
<li><span class="math inline">\(0\)</span>：成功</li>
<li><code>BTSTACK_LE_CHANNEL_NOT_EXIST</code>：连接不存在（连接句柄参数错误？）</li>
<li><code>BTSTACK_ACL_BUFFERS_FULL</code>：内存已满</li>
</ul></li>
<li><p><code>gap_set_ext_adv_para</code> 的返回值：</p>
<ul>
<li><span class="math inline">\(0\)</span>：成功</li>
<li><code>BTSTACK_MEMORY_ALLOC_FAILED</code>：内存已满</li>
</ul></li>
</ul>
</div>
<div id="键值存储接口与实现" class="section level2 hasAnchor" number="12.5">
<h2><span class="header-section-number">12.5</span> 键值存储接口与实现<a href="ch-misc.html#键值存储接口与实现" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="键值存储接口" class="section level3 hasAnchor" number="12.5.1">
<h3><span class="header-section-number">12.5.1</span> 键值存储接口<a href="ch-misc.html#键值存储接口" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>协议栈定义了一个简单的键值存储接口（<em>kv_storage</em>），其键（<em>key</em>） 为 <code>uint8_t</code>，值（<em>value</em>） 为长度不超过 <code>KV_VALUE_MAX_LEN</code>
的数组。
开发者可以在 App 里使用这个接口，<em>key</em> 的取值范围应该在 <code>KV_USER_KEY_START</code> 和 <code>KV_USER_KEY_END</code> 之间。
这个存储模块的增、删、改、查等功能如下。</p>
<ul>
<li><p>增/改：<code>kv_put</code></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb130-1"><a href="ch-misc.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 如果 key 不存在，为“增”；如果 key 存在，为“改”</span></span>
<span id="cb130-2"><a href="ch-misc.html#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> kv_put<span class="op">(</span></span>
<span id="cb130-3"><a href="ch-misc.html#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> kvkey_t key<span class="op">,</span></span>
<span id="cb130-4"><a href="ch-misc.html#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 值</span></span>
<span id="cb130-5"><a href="ch-misc.html#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb130-6"><a href="ch-misc.html#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 值的长度</span></span>
<span id="cb130-7"><a href="ch-misc.html#cb130-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int16_t</span> len<span class="op">);</span></span></code></pre></div></li>
<li><p>删：<code>kv_remove</code></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb131-1"><a href="ch-misc.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_remove<span class="op">(</span></span>
<span id="cb131-2"><a href="ch-misc.html#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 键</span></span>
<span id="cb131-3"><a href="ch-misc.html#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> kvkey_t key<span class="op">)</span></span></code></pre></div></li>
<li><p>清空：<code>kv_remove_all</code></p>
<div class="sourceCode" id="cb132"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb132-1"><a href="ch-misc.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_remove_all<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div></li>
<li><p>查：<code>kv_get</code></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb133-1"><a href="ch-misc.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 返回：指向值的指针</span></span>
<span id="cb133-2"><a href="ch-misc.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> <span class="op">*</span>kv_get<span class="op">(</span></span>
<span id="cb133-3"><a href="ch-misc.html#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 键</span></span>
<span id="cb133-4"><a href="ch-misc.html#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> kvkey_t key<span class="op">,</span></span>
<span id="cb133-5"><a href="ch-misc.html#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 输出：值的长度</span></span>
<span id="cb133-6"><a href="ch-misc.html#cb133-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int16_t</span> <span class="op">*</span>len<span class="op">);</span></span></code></pre></div>
<p>这个 API 返回的指针直接指向模块内值的存储空间，允许开发者在不改变值的长度的前提下修改其的内容。
修改之后需要调用 <code>kv_value_modified</code> 告知存储模块。</p></li>
<li><p>遍历：<code>kv_visit</code></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb134-1"><a href="ch-misc.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_visit<span class="op">(</span></span>
<span id="cb134-2"><a href="ch-misc.html#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 访问者回调</span></span>
<span id="cb134-3"><a href="ch-misc.html#cb134-3" aria-hidden="true" tabindex="-1"></a>  f_kv_visitor visitor<span class="op">,</span></span>
<span id="cb134-4"><a href="ch-misc.html#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 传递给回调的用户参数</span></span>
<span id="cb134-5"><a href="ch-misc.html#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">);</span></span></code></pre></div>
<p>使用这个 API 可以遍历存储内所有的键值对。</p></li>
<li><p>数据已被修改</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb135-1"><a href="ch-misc.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_value_modified_of_key<span class="op">(</span></span>
<span id="cb135-2"><a href="ch-misc.html#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 键</span></span>
<span id="cb135-3"><a href="ch-misc.html#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> kvkey_t key<span class="op">);</span></span></code></pre></div></li>
</ul>
<p>协议栈内实现了这个接口。开发者既可以使用内置的默认实现，也可以自定义实现。</p>
</div>
<div id="默认的键值存储实现" class="section level3 hasAnchor" number="12.5.2">
<h3><span class="header-section-number">12.5.2</span> 默认的键值存储实现<a href="ch-misc.html#默认的键值存储实现" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>默认的键值存储实现的总储存大小为 1024 字节。这个实现本身没有数据持久化。
持久化需要开发者通过 <code>kv_init</code><a href="ch-cap.html#fn58" class="footnote-ref" id="fnref58"><sup>58</sup></a> 提供回调来实现：</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb136-1"><a href="ch-misc.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_init<span class="op">(</span></span>
<span id="cb136-2"><a href="ch-misc.html#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用来保存数据的回调</span></span>
<span id="cb136-3"><a href="ch-misc.html#cb136-3" aria-hidden="true" tabindex="-1"></a>  f_kv_write_to_nvm f_write<span class="op">,</span></span>
<span id="cb136-4"><a href="ch-misc.html#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用来读取（恢复）数据的回调</span></span>
<span id="cb136-5"><a href="ch-misc.html#cb136-5" aria-hidden="true" tabindex="-1"></a>  f_kv_read_from_nvm f_read<span class="op">);</span></span></code></pre></div>
<p>当键值存储模块初始化时，会调用 <code>f_read</code> 恢复之前的数据状态；当存储里的数据更新后，键值存储模块会自动调用 <code>f_write</code> 回调。
考虑到 Flash 不宜频繁擦写，键值存储模块通过定时器超时来触发写入。每当数据更新时，复位定时器。</p>
<p>使用这种实现时需要注意以下几点：</p>
<ol style="list-style-type: decimal">
<li>该模块查找一个 <em>key</em> 的时间复杂度为 <span class="math inline">\(\mathcal{O}(n)\)</span>；</li>
<li>该模块不是线程安全的。</li>
</ol>
</div>
<div id="自定义键值存储实现" class="section level3 hasAnchor" number="12.5.3">
<h3><span class="header-section-number">12.5.3</span> 自定义键值存储实现<a href="ch-misc.html#自定义键值存储实现" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>通过在 <code>app_main</code> 里调用 <code>kv_init_backend</code> 可以自定义键值存储实现：</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb137-1"><a href="ch-misc.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> kv_init_backend<span class="op">(</span></span>
<span id="cb137-2"><a href="ch-misc.html#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> kv_backend_t <span class="op">*</span>backend<span class="op">);</span></span></code></pre></div>
<p>其中 <code>kv_backend_t</code> 包含以下回调接口：</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb138-1"><a href="ch-misc.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> kv_backend</span>
<span id="cb138-2"><a href="ch-misc.html#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb138-3"><a href="ch-misc.html#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 清空</span></span>
<span id="cb138-4"><a href="ch-misc.html#cb138-4" aria-hidden="true" tabindex="-1"></a>    f_kv_remove_all kv_remove_all<span class="op">;</span></span>
<span id="cb138-5"><a href="ch-misc.html#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 删除</span></span>
<span id="cb138-6"><a href="ch-misc.html#cb138-6" aria-hidden="true" tabindex="-1"></a>    f_kv_remove     kv_remove<span class="op">;</span></span>
<span id="cb138-7"><a href="ch-misc.html#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 增/改</span></span>
<span id="cb138-8"><a href="ch-misc.html#cb138-8" aria-hidden="true" tabindex="-1"></a>    f_kv_put        kv_put<span class="op">;</span></span>
<span id="cb138-9"><a href="ch-misc.html#cb138-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 查</span></span>
<span id="cb138-10"><a href="ch-misc.html#cb138-10" aria-hidden="true" tabindex="-1"></a>    f_kv_get        kv_get<span class="op">;</span></span>
<span id="cb138-11"><a href="ch-misc.html#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 遍历</span></span>
<span id="cb138-12"><a href="ch-misc.html#cb138-12" aria-hidden="true" tabindex="-1"></a>    f_kv_visit      kv_visit<span class="op">;</span></span>
<span id="cb138-13"><a href="ch-misc.html#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 数据已被修改</span></span>
<span id="cb138-14"><a href="ch-misc.html#cb138-14" aria-hidden="true" tabindex="-1"></a>    f_kv_value_modified_of_key kv_value_modified_of_key<span class="op">;</span></span>
<span id="cb138-15"><a href="ch-misc.html#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> kv_backend_t<span class="op">;</span></span></code></pre></div>
<p>注意 <code>app_main</code> 里不能既调用 <code>kv_init</code> 又调用 <code>kv_init_backend</code>，会导致混乱。
当 <code>app_main</code> 里既没有调用 <code>kv_init</code> 也没有调用 <code>kv_init_backend</code> 时，
会使用默认的键值存储实现，且不支持数据持久化。</p>
</div>
</div>
<div id="ch98-le-dev-db" class="section level2 hasAnchor" number="12.6">
<h2><span class="header-section-number">12.6</span> 设备数据库<a href="ch-misc.html#ch98-le-dev-db" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>设备数据库模块（<em>le_device_db</em>）负责存储、管理设备的绑定信息。这个模块是基于键值存储模块实现的，
所能存储的设备个数等于 max(软件包所支持的连接数目, 10)<a href="ch-cap.html#fn59" class="footnote-ref" id="fnref59"><sup>59</sup></a>。删、查等接口如下。</p>
<ul>
<li><p>查：<code>le_device_db_find</code></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb139-1"><a href="ch-misc.html#cb139-1" aria-hidden="true" tabindex="-1"></a>le_device_memory_db_t <span class="op">*</span>le_device_db_find<span class="op">(</span></span>
<span id="cb139-2"><a href="ch-misc.html#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 待查设备的地址类型</span></span>
<span id="cb139-3"><a href="ch-misc.html#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">int</span> addr_type<span class="op">,</span></span>
<span id="cb139-4"><a href="ch-misc.html#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 待查设备的地址</span></span>
<span id="cb139-5"><a href="ch-misc.html#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> bd_addr_t addr<span class="op">,</span></span>
<span id="cb139-6"><a href="ch-misc.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 输出：在数据库里的序号</span></span>
<span id="cb139-7"><a href="ch-misc.html#cb139-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>index<span class="op">);</span></span></code></pre></div></li>
<li><p>删</p>
<p>直接按地址删除：</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb140-1"><a href="ch-misc.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> le_device_db_remove<span class="op">(</span></span>
<span id="cb140-2"><a href="ch-misc.html#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 待删设备的地址类型</span></span>
<span id="cb140-3"><a href="ch-misc.html#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">int</span> addr_type<span class="op">,</span></span>
<span id="cb140-4"><a href="ch-misc.html#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 待删设备的地址</span></span>
<span id="cb140-5"><a href="ch-misc.html#cb140-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> bd_addr_t addr<span class="op">);</span></span></code></pre></div>
<p>根据在数据库里的编号删除：</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb141-1"><a href="ch-misc.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> le_device_db_remove_key<span class="op">(</span></span>
<span id="cb141-2"><a href="ch-misc.html#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 待删设备在数据库里的编号</span></span>
<span id="cb141-3"><a href="ch-misc.html#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> index<span class="op">);</span></span></code></pre></div></li>
<li><p>遍历</p>
<p>这个模块支持迭代器遍历：</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb142-1"><a href="ch-misc.html#cb142-1" aria-hidden="true" tabindex="-1"></a>le_device_memory_db_iter_t iter<span class="op">;</span></span>
<span id="cb142-2"><a href="ch-misc.html#cb142-2" aria-hidden="true" tabindex="-1"></a>le_device_db_iter_init<span class="op">(&amp;</span>iter<span class="op">);</span></span>
<span id="cb142-3"><a href="ch-misc.html#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>le_device_db_iter_next<span class="op">(&amp;</span>iter<span class="op">))</span></span>
<span id="cb142-4"><a href="ch-misc.html#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb142-5"><a href="ch-misc.html#cb142-5" aria-hidden="true" tabindex="-1"></a>    le_device_memory_db_t <span class="op">*</span>cur <span class="op">=</span> le_device_db_iter_cur<span class="op">(&amp;</span>iter<span class="op">);</span></span>
<span id="cb142-6"><a href="ch-misc.html#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb142-7"><a href="ch-misc.html#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
</ul>
</div>
<div id="ch-misc-synced-api" class="section level2 hasAnchor" number="12.7">
<h2><span class="header-section-number">12.7</span> 同步版 API<a href="ch-misc.html#ch-misc-synced-api" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>SDK 提供的工具模块 <em>btstack_sync</em> 里包含几个 GAP、GATT 客户端同步版本的 API。
要使用这些 API 必须先初始化同步执行器。</p>
<ul>
<li><p>v8.2 及以上版本（基于 <code>btstack_push_user_runnable</code> 实现）</p>
<p>如下创建同步执行器对象：</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb143-1"><a href="ch-misc.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> gatt_client_synced_runner <span class="op">*</span>synced_runner <span class="op">=</span></span>
<span id="cb143-2"><a href="ch-misc.html#cb143-2" aria-hidden="true" tabindex="-1"></a>    gatt_client_create_sync_runner<span class="op">(</span>enable_gap_api<span class="op">);</span></span></code></pre></div>
<p>这里的 <code>enable_gap_api</code> 表示是否使能 GAP 同步版 API。</p></li>
<li><p>v8.2 以下版本（基于 <code>btstack_push_user_msg</code> 实现）</p>
<div class="rmdcaution">
<p>
v8.2 以下版本的 <em>gatt_client_util</em> 模块仅提供 GATT
客户端同步版本 API， 未提供 GAP 同步版 API —— 开发者可参考 v8.2
自行添加。
</p>
</div>
<ol style="list-style-type: decimal">
<li><p>基于 <code>btstack_push_user_msg</code> 实现一个消息传递函数，</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb144-1"><a href="ch-misc.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">// runner 为同步执行器</span></span>
<span id="cb144-2"><a href="ch-misc.html#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co">// msg_id 为同步执行器内部的消息，从其数据类型可看出最多只有 256 种 ID，</span></span>
<span id="cb144-3"><a href="ch-misc.html#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 可以映射到 btstack_push_user_msg 的 uint32_t 型消息 ID 的一个子集里。</span></span>
<span id="cb144-4"><a href="ch-misc.html#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> synced_push_user_msg<span class="op">(</span></span>
<span id="cb144-5"><a href="ch-misc.html#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> gatt_client_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb144-6"><a href="ch-misc.html#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> msg_id<span class="op">)</span></span>
<span id="cb144-7"><a href="ch-misc.html#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb144-8"><a href="ch-misc.html#cb144-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 把同步执行器消息映射到 USER_MSG_SYNC_MSG_START 以上</span></span>
<span id="cb144-9"><a href="ch-misc.html#cb144-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// App 可以使用的消息 ID 范围是 [0..USER_MSG_SYNC_MSG_START - 1]</span></span>
<span id="cb144-10"><a href="ch-misc.html#cb144-10" aria-hidden="true" tabindex="-1"></a>    btstack_push_user_msg<span class="op">(</span>USER_MSG_SYNC_MSG_START <span class="op">+</span> msg_id<span class="op">,</span></span>
<span id="cb144-11"><a href="ch-misc.html#cb144-11" aria-hidden="true" tabindex="-1"></a>        runner<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb144-12"><a href="ch-misc.html#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>更新 <code>user_msg_handler</code> 把同步执行器内部的消息交给 <code>gatt_client_sync_handle_msg</code></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb145-1"><a href="ch-misc.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> user_msg_handler<span class="op">(</span><span class="dt">uint32_t</span> msg_id<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span></span>
<span id="cb145-2"><a href="ch-misc.html#cb145-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> size<span class="op">)</span></span>
<span id="cb145-3"><a href="ch-misc.html#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb145-4"><a href="ch-misc.html#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>msg_id<span class="op">)</span></span>
<span id="cb145-5"><a href="ch-misc.html#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb145-6"><a href="ch-misc.html#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb145-7"><a href="ch-misc.html#cb145-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb145-8"><a href="ch-misc.html#cb145-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>msg_id <span class="op">&gt;=</span> USER_MSG_SYNC_MSG_START<span class="op">)</span></span>
<span id="cb145-9"><a href="ch-misc.html#cb145-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb145-10"><a href="ch-misc.html#cb145-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> gatt_client_synced_runner <span class="op">*</span>runner <span class="op">=</span></span>
<span id="cb145-11"><a href="ch-misc.html#cb145-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span><span class="kw">struct</span> gatt_client_synced_runner <span class="op">*)</span>data<span class="op">;</span></span>
<span id="cb145-12"><a href="ch-misc.html#cb145-12" aria-hidden="true" tabindex="-1"></a>            gatt_client_sync_handle_msg<span class="op">(</span>runner<span class="op">,</span></span>
<span id="cb145-13"><a href="ch-misc.html#cb145-13" aria-hidden="true" tabindex="-1"></a>                msg_id <span class="op">-</span> USER_MSG_SYNC_MSG_START<span class="op">);</span></span>
<span id="cb145-14"><a href="ch-misc.html#cb145-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb145-15"><a href="ch-misc.html#cb145-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb145-16"><a href="ch-misc.html#cb145-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>创建同步执行器对象</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb146-1"><a href="ch-misc.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> gatt_client_synced_runner <span class="op">*</span>synced_runner <span class="op">=</span></span>
<span id="cb146-2"><a href="ch-misc.html#cb146-2" aria-hidden="true" tabindex="-1"></a>    gatt_client_create_sync_runner<span class="op">(</span>synced_push_user_msg<span class="op">);</span></span></code></pre></div></li>
</ol></li>
</ul>
<p>注意：对于一个连接，最多只能存在一个与之关联的同步执行器。最简单的用法是在初始化时创建唯一一个同步执行器对象<a href="ch-cap.html#fn60" class="footnote-ref" id="fnref60"><sup>60</sup></a>。创建多个同步执行器时，最多只能有一个使能了 GAP 同步版 API。</p>
<p>上述准备工作做完，就可以使用同步 API 了。下面这个函数 —— 称为一个同步执行体 —— 使用同步 API 多次读取某个特征的值并打印：</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb147-1"><a href="ch-misc.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 用 user_data 表示 value_handle</span></span>
<span id="cb147-2"><a href="ch-misc.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> demo_synced_api<span class="op">(</span></span>
<span id="cb147-3"><a href="ch-misc.html#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> gatt_client_synced_runner <span class="op">*</span>synced_runner<span class="op">,</span></span>
<span id="cb147-4"><a href="ch-misc.html#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb147-5"><a href="ch-misc.html#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb147-6"><a href="ch-misc.html#cb147-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> handle <span class="op">=</span> <span class="op">(</span><span class="dt">uint16_t</span><span class="op">)(</span><span class="dt">uintptr_t</span><span class="op">)</span>user_data<span class="op">;</span></span>
<span id="cb147-7"><a href="ch-misc.html#cb147-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="dt">uint8_t</span> data<span class="op">[</span><span class="dv">255</span><span class="op">];</span></span>
<span id="cb147-8"><a href="ch-misc.html#cb147-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb147-9"><a href="ch-misc.html#cb147-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;synced read value for %d times:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> n<span class="op">);</span></span>
<span id="cb147-10"><a href="ch-misc.html#cb147-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-11"><a href="ch-misc.html#cb147-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;</span> n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span> n<span class="op">--)</span></span>
<span id="cb147-12"><a href="ch-misc.html#cb147-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb147-13"><a href="ch-misc.html#cb147-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint16_t</span> length <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>data<span class="op">);</span></span>
<span id="cb147-14"><a href="ch-misc.html#cb147-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 注意：这个函数返回后，数据就读取完成了</span></span>
<span id="cb147-15"><a href="ch-misc.html#cb147-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> err <span class="op">=</span> gatt_client_sync_read_value_of_characteristic<span class="op">(</span></span>
<span id="cb147-16"><a href="ch-misc.html#cb147-16" aria-hidden="true" tabindex="-1"></a>                synced_runner<span class="op">,</span> mas_conn_handle<span class="op">,</span> handle<span class="op">,</span></span>
<span id="cb147-17"><a href="ch-misc.html#cb147-17" aria-hidden="true" tabindex="-1"></a>                data<span class="op">,</span> <span class="op">&amp;</span>length<span class="op">);</span></span>
<span id="cb147-18"><a href="ch-misc.html#cb147-18" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;[%d]: err = %d:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> n<span class="op">,</span> err<span class="op">);</span></span>
<span id="cb147-19"><a href="ch-misc.html#cb147-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>err<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb147-20"><a href="ch-misc.html#cb147-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// print_value(data, length);</span></span>
<span id="cb147-21"><a href="ch-misc.html#cb147-21" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;wait for 200ms...</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> n<span class="op">,</span> err<span class="op">);</span></span>
<span id="cb147-22"><a href="ch-misc.html#cb147-22" aria-hidden="true" tabindex="-1"></a>        vTaskDelay<span class="op">(</span>pdMS_TO_TICKS<span class="op">(</span><span class="dv">200</span><span class="op">));</span></span>
<span id="cb147-23"><a href="ch-misc.html#cb147-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-24"><a href="ch-misc.html#cb147-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;done</span><span class="sc">\n\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb147-25"><a href="ch-misc.html#cb147-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这种同步执行体不能直接使用，而要交给同步执行器去执行：</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb148-1"><a href="ch-misc.html#cb148-1" aria-hidden="true" tabindex="-1"></a>gatt_client_sync_run<span class="op">(</span>synced_runner<span class="op">,</span> demo_synced_api<span class="op">,</span></span>
<span id="cb148-2"><a href="ch-misc.html#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="dt">void</span> <span class="op">*)(</span><span class="dt">uintptr_t</span><span class="op">)</span>value_handle<span class="op">);</span></span></code></pre></div>
<p>这里，<code>demo_synced_api</code> 函数运行于同步执行器内的线程。<code>gatt_client_sync_run</code> 可以从任意线程调用。</p>
<div id="gap-同步-api" class="section level3 hasAnchor" number="12.7.1">
<h3><span class="header-section-number">12.7.1</span> GAP 同步 API<a href="ch-misc.html#gap-同步-api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p><code>gap_sync_ext_create_connection</code>：建立连接</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb149-1"><a href="ch-misc.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gap_sync_ext_create_connection<span class="op">(</span></span>
<span id="cb149-2"><a href="ch-misc.html#cb149-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb149-3"><a href="ch-misc.html#cb149-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> initiating_filter_policy_t filter_policy<span class="op">,</span></span>
<span id="cb149-4"><a href="ch-misc.html#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> bd_addr_type_t own_addr_type<span class="op">,</span></span>
<span id="cb149-5"><a href="ch-misc.html#cb149-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> bd_addr_type_t peer_addr_type<span class="op">,</span></span>
<span id="cb149-6"><a href="ch-misc.html#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>peer_addr<span class="op">,</span></span>
<span id="cb149-7"><a href="ch-misc.html#cb149-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">uint8_t</span> initiating_phy_num<span class="op">,</span></span>
<span id="cb149-8"><a href="ch-misc.html#cb149-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> initiating_phy_config_t <span class="op">*</span>phy_configs<span class="op">,</span></span>
<span id="cb149-9"><a href="ch-misc.html#cb149-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> timeout_ms<span class="op">,</span></span>
<span id="cb149-10"><a href="ch-misc.html#cb149-10" aria-hidden="true" tabindex="-1"></a>    le_meta_event_enh_create_conn_complete_t <span class="op">*</span>complete<span class="op">);</span></span></code></pre></div>
<p>与 <code>gap_ext_create_connection</code> 相比，这个函数是“阻塞”的：函数直到连接成功或者超时才返回。
如果调用 <code>gap_create_connection</code> 时出错，则 <code>gap_ext_create_connection</code> 会返回其错误码；
其它情况下返回的值即 <code>le_meta_event_enh_create_conn_complete_t</code> 里的 <code>status</code> 字段。
也就是说，连接建立成功时返回值为 0 时，超时时返回值为 0x02<a href="ch-cap.html#fn61" class="footnote-ref" id="fnref61"><sup>61</sup></a> (未知的连接句柄)。</p>
<p><code>complete</code> 参数为输出，保存了<code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE</code> 事件的数据。
同使用 <code>gap_ext_create_connection</code> 一样，已有的 HCI 事件回调函数也会收到
这个 <code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE</code> 事件。</p></li>
<li><p><code>gap_sync_le_read_channel_map</code>：读取某连接所使用的信道集合</p>
<p>函数原型如下：</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb150-1"><a href="ch-misc.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gap_sync_le_read_channel_map<span class="op">(</span></span>
<span id="cb150-2"><a href="ch-misc.html#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb150-3"><a href="ch-misc.html#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb150-4"><a href="ch-misc.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  hci_con_handle_t con_handle<span class="op">,</span></span>
<span id="cb150-5"><a href="ch-misc.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 用前 37 个比特表示的信道集合</span></span>
<span id="cb150-6"><a href="ch-misc.html#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> channel_map<span class="op">[</span><span class="dv">5</span><span class="op">]);</span></span></code></pre></div></li>
<li><p><code>gap_sync_read_rssi</code>：读取某连接的 RSSI</p>
<p>函数原型如下：</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb151-1"><a href="ch-misc.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gap_sync_read_rssi<span class="op">(</span></span>
<span id="cb151-2"><a href="ch-misc.html#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb151-3"><a href="ch-misc.html#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb151-4"><a href="ch-misc.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  hci_con_handle_t con_handle<span class="op">,</span></span>
<span id="cb151-5"><a href="ch-misc.html#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// RSSI 输出</span></span>
<span id="cb151-6"><a href="ch-misc.html#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int8_t</span> <span class="op">*</span>rssi<span class="op">);</span></span></code></pre></div></li>
<li><p><code>gap_sync_read_phy</code>：读取某连接的 PHY</p>
<p>函数原型如下：</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb152-1"><a href="ch-misc.html#cb152-1" aria-hidden="true" tabindex="-1"></a>gap_sync_read_phy<span class="op">(</span></span>
<span id="cb152-2"><a href="ch-misc.html#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb152-3"><a href="ch-misc.html#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb152-4"><a href="ch-misc.html#cb152-4" aria-hidden="true" tabindex="-1"></a>  hci_con_handle_t con_handle<span class="op">,</span></span>
<span id="cb152-5"><a href="ch-misc.html#cb152-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 本设备发送方向使用的 PHY</span></span>
<span id="cb152-6"><a href="ch-misc.html#cb152-6" aria-hidden="true" tabindex="-1"></a>  phy_type_t <span class="op">*</span>tx_phy<span class="op">,</span></span>
<span id="cb152-7"><a href="ch-misc.html#cb152-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 本设备接收方向使用的 PHY</span></span>
<span id="cb152-8"><a href="ch-misc.html#cb152-8" aria-hidden="true" tabindex="-1"></a>  phy_type_t <span class="op">*</span>rx_phy<span class="op">);</span></span></code></pre></div></li>
<li><p><code>gap_sync_read_remote_version</code>：读取某连接对端设备的版本</p>
<p>函数原型如下：</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb153-1"><a href="ch-misc.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gap_sync_read_remote_version<span class="op">(</span></span>
<span id="cb153-2"><a href="ch-misc.html#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb153-3"><a href="ch-misc.html#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb153-4"><a href="ch-misc.html#cb153-4" aria-hidden="true" tabindex="-1"></a>  hci_con_handle_t con_handle<span class="op">,</span></span>
<span id="cb153-5"><a href="ch-misc.html#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 蓝牙链路层协议版本编号</span></span>
<span id="cb153-6"><a href="ch-misc.html#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> <span class="op">*</span>version<span class="op">,</span></span>
<span id="cb153-7"><a href="ch-misc.html#cb153-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 厂家编号</span></span>
<span id="cb153-8"><a href="ch-misc.html#cb153-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> <span class="op">*</span>manufacturer_name<span class="op">,</span></span>
<span id="cb153-9"><a href="ch-misc.html#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Controller 版本号</span></span>
<span id="cb153-10"><a href="ch-misc.html#cb153-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> <span class="op">*</span>subversion<span class="op">);</span></span></code></pre></div>
<p>蓝牙链路层协议版本号由 Bluethooth SIG 指定，部分编号与版本号的对应关系如表
<a href="ch-overview.html#tab:ch-overview-ble-version">3.4</a> 所示；
厂家编号由厂家申请、Bluethooth SIG 指定<a href="ch-cap.html#fn62" class="footnote-ref" id="fnref62"><sup>62</sup></a>；
Controller 版本号由 Controller 厂家自行指定。</p></li>
<li><p><code>gap_sync_read_remote_used_features</code>：读取某连接对端设备使用的蓝牙特性</p>
<p>函数原型如下：</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a href="ch-misc.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> gap_sync_read_remote_used_features<span class="op">(</span></span>
<span id="cb154-2"><a href="ch-misc.html#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> btstack_synced_runner <span class="op">*</span>runner<span class="op">,</span></span>
<span id="cb154-3"><a href="ch-misc.html#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 连接句柄</span></span>
<span id="cb154-4"><a href="ch-misc.html#cb154-4" aria-hidden="true" tabindex="-1"></a>  hci_con_handle_t con_handle<span class="op">,</span></span>
<span id="cb154-5"><a href="ch-misc.html#cb154-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 蓝牙特性比特图</span></span>
<span id="cb154-6"><a href="ch-misc.html#cb154-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> features<span class="op">[</span><span class="dv">8</span><span class="op">]);</span></span></code></pre></div>
<p>蓝牙特性的定义参见表 <a href="ch-overview.html#tab:ch-overview-ble-features">3.3</a>。</p></li>
</ul>
</div>
<div id="gatt-客户端同步-api" class="section level3 hasAnchor" number="12.7.2">
<h3><span class="header-section-number">12.7.2</span> GATT 客户端同步 API<a href="ch-misc.html#gatt-客户端同步-api" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>本模块提供了以下同步 API，其原型与异步版本基本类似：</p>
<ul>
<li><p><code>gatt_client_sync_discover_all</code>：同步发现所有服务</p></li>
<li><p><code>gatt_client_sync_read_value_of_characteristic</code>：同步读取特征的值</p></li>
<li><p><code>gatt_client_sync_read_characteristic_descriptor</code>：同步读取特征描述符</p></li>
<li><p><code>gatt_client_sync_write_value_of_characteristic</code>：同步有响应地写入特征的值</p></li>
<li><p><code>gatt_client_sync_write_value_of_characteristic_without_response</code>：同步无响应地写入特征的值<a href="ch-cap.html#fn63" class="footnote-ref" id="fnref63"><sup>63</sup></a></p></li>
<li><p><code>gatt_client_sync_write_characteristic_descriptor</code>：同步写入特征描述符</p></li>
</ul>
</div>
</div>
<div id="ch-misc-thread-safe-api" class="section level2 hasAnchor" number="12.8">
<h2><span class="header-section-number">12.8</span> 线程安全的 API<a href="ch-misc.html#ch-misc-thread-safe-api" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>SDK 提供的工具模块 <em>btstack_mt</em> 借助 <code>btstack_push_user_runnable</code> 为 Host 常用 API
重新封装了一套线程安全的 API。
每个 API 与原始 API 参数完全一致，得到的返回值也相同，只是函数名称增加了表示多线程的 <code>mt_</code> 前辍。</p>
<p>每个 <code>mt_foo</code> 函数都有一个 <code>f_btstack_user_runnable</code> 类型的辅助函数 <code>foo_0</code>，调用背后的
<code>foo</code> 所需要的参数及保存返回值的变量等都通过第一个参数 <code>ctx</code> 传入，伪代码如下：</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb155-1"><a href="ch-misc.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> foo_0<span class="op">(*</span>ctx<span class="op">,</span> <span class="dt">uint16_t</span> _<span class="op">)</span></span>
<span id="cb155-2"><a href="ch-misc.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb155-3"><a href="ch-misc.html#cb155-3" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">-&gt;</span>_ret <span class="op">=</span> foo<span class="op">(</span>ctx<span class="op">-&gt;</span>param<span class="op">);</span></span>
<span id="cb155-4"><a href="ch-misc.html#cb155-4" aria-hidden="true" tabindex="-1"></a>  event_set<span class="op">(</span>ctx<span class="op">-&gt;</span>_event<span class="op">);</span></span>
<span id="cb155-5"><a href="ch-misc.html#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>mt_foo</code> 的伪代码如下：</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb156-1"><a href="ch-misc.html#cb156-1" aria-hidden="true" tabindex="-1"></a>type mt_foo<span class="op">(</span>param<span class="op">)</span></span>
<span id="cb156-2"><a href="ch-misc.html#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb156-3"><a href="ch-misc.html#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>in Host task<span class="op">)</span></span>
<span id="cb156-4"><a href="ch-misc.html#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> foo<span class="op">(</span>param<span class="op">);</span></span>
<span id="cb156-5"><a href="ch-misc.html#cb156-5" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">-&gt;</span>param <span class="op">=</span> param<span class="op">;</span></span>
<span id="cb156-6"><a href="ch-misc.html#cb156-6" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">-&gt;</span>_event <span class="op">=</span> event_create<span class="op">();</span></span>
<span id="cb156-7"><a href="ch-misc.html#cb156-7" aria-hidden="true" tabindex="-1"></a>  btstack_push_user_runnable<span class="op">(</span>foo_0<span class="op">,</span> <span class="op">&amp;</span>ctx<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb156-8"><a href="ch-misc.html#cb156-8" aria-hidden="true" tabindex="-1"></a>  event_wait<span class="op">(</span>ctx<span class="op">-&gt;</span>_event<span class="op">);</span></span>
<span id="cb156-9"><a href="ch-misc.html#cb156-9" aria-hidden="true" tabindex="-1"></a>  event_free<span class="op">(</span>ctx<span class="op">-&gt;</span>_event<span class="op">);</span></span>
<span id="cb156-10"><a href="ch-misc.html#cb156-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ctx<span class="op">-&gt;</span>_ret<span class="op">;</span></span>
<span id="cb156-11"><a href="ch-misc.html#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>由于通用 OS 接口未提供释放的接口，所以这个模块实现了一个事件对象池以模拟事件的释放（伪代码里的 <code>event_free</code>）。</p>
<p>用上述“阻塞”方式实现的线程安全 API，既可以获取实际的返回值，也可以避免复制内存数据。
允许这样的用法：</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb157-1"><a href="ch-misc.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> do_some_thing<span class="op">()</span></span>
<span id="cb157-2"><a href="ch-misc.html#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb157-3"><a href="ch-misc.html#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> data<span class="op">[</span><span class="dv">10</span><span class="op">];</span></span>
<span id="cb157-4"><a href="ch-misc.html#cb157-4" aria-hidden="true" tabindex="-1"></a>  向 data 写入数据<span class="op">;</span></span>
<span id="cb157-5"><a href="ch-misc.html#cb157-5" aria-hidden="true" tabindex="-1"></a>  mt_att_server_notify<span class="op">(</span>con_handle<span class="op">,</span></span>
<span id="cb157-6"><a href="ch-misc.html#cb157-6" aria-hidden="true" tabindex="-1"></a>    att_handle<span class="op">,</span> data<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>data<span class="op">));</span></span>
<span id="cb157-7"><a href="ch-misc.html#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb157-8"><a href="ch-misc.html#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="ch-misc.html#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> any_thread<span class="op">()</span></span>
<span id="cb157-10"><a href="ch-misc.html#cb157-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb157-11"><a href="ch-misc.html#cb157-11" aria-hidden="true" tabindex="-1"></a>  do_some_thing<span class="op">();</span></span>
<span id="cb157-12"><a href="ch-misc.html#cb157-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 此时 do_some_thing 里的 data 已被释放</span></span>
<span id="cb157-13"><a href="ch-misc.html#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>注意事项：</p>
<ul>
<li>这个模块依赖于一个真正的 RTOS。使用 NoOS 软件包时，必需提供真正的队列及事件支持。</li>
<li>封装必然存在开销。对于高性能、高实时性的应用，不推荐使用。反之，对于相对简单的应用，则推荐使用，可以简化代码；</li>
<li>不要在中断服务程序内使用这些 API<a href="ch-cap.html#fn64" class="footnote-ref" id="fnref64"><sup>64</sup></a>。</li>
</ul>
</div>
<div id="ch-misc-privacy" class="section level2 hasAnchor" number="12.9">
<h2><span class="header-section-number">12.9</span> 链路层隐私<a href="ch-misc.html#ch-misc-privacy" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>下面以充分保护隐私为出发点说明链路层隐私特性的使用方法。</p>
<div id="将已配对设备添加到解析列表" class="section level3 hasAnchor" number="12.9.1">
<h3><span class="header-section-number">12.9.1</span> 将已配对设备添加到解析列表<a href="ch-misc.html#将已配对设备添加到解析列表" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>同白名单类似，地址解析列表也完全由开发者管理。下面的代码演示了如何将设备数据库里的信息添加到解析列表和白名单。</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb158-1"><a href="ch-misc.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> populate_pairing_data<span class="op">(</span><span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>local_irk<span class="op">)</span></span>
<span id="cb158-2"><a href="ch-misc.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb158-3"><a href="ch-misc.html#cb158-3" aria-hidden="true" tabindex="-1"></a>    gap_clear_resolving_list<span class="op">();</span></span>
<span id="cb158-4"><a href="ch-misc.html#cb158-4" aria-hidden="true" tabindex="-1"></a>    gap_clear_white_lists<span class="op">();</span></span>
<span id="cb158-5"><a href="ch-misc.html#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="ch-misc.html#cb158-6" aria-hidden="true" tabindex="-1"></a>    le_device_memory_db_iter_t device_db_iter<span class="op">;</span></span>
<span id="cb158-7"><a href="ch-misc.html#cb158-7" aria-hidden="true" tabindex="-1"></a>    le_device_db_iter_init<span class="op">(&amp;</span>device_db_iter<span class="op">);</span></span>
<span id="cb158-8"><a href="ch-misc.html#cb158-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>le_device_db_iter_next<span class="op">(&amp;</span>device_db_iter<span class="op">))</span></span>
<span id="cb158-9"><a href="ch-misc.html#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb158-10"><a href="ch-misc.html#cb158-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">const</span> le_device_memory_db_t <span class="op">*</span>dev <span class="op">=</span></span>
<span id="cb158-11"><a href="ch-misc.html#cb158-11" aria-hidden="true" tabindex="-1"></a>            le_device_db_iter_cur<span class="op">(&amp;</span>device_db_iter<span class="op">);</span></span>
<span id="cb158-12"><a href="ch-misc.html#cb158-12" aria-hidden="true" tabindex="-1"></a>        gap_add_dev_to_resolving_list<span class="op">(</span>dev<span class="op">-&gt;</span>addr<span class="op">,</span></span>
<span id="cb158-13"><a href="ch-misc.html#cb158-13" aria-hidden="true" tabindex="-1"></a>            dev<span class="op">-&gt;</span>addr_type<span class="op">,</span> dev<span class="op">-&gt;</span>irk<span class="op">,</span> local_irk<span class="op">);</span></span>
<span id="cb158-14"><a href="ch-misc.html#cb158-14" aria-hidden="true" tabindex="-1"></a>        gap_add_whitelist<span class="op">(</span>dev<span class="op">-&gt;</span>addr<span class="op">,</span> dev<span class="op">-&gt;</span>addr_type<span class="op">);</span></span>
<span id="cb158-15"><a href="ch-misc.html#cb158-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-16"><a href="ch-misc.html#cb158-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="rmdcaution">
<p>
上面的演示代码假定对于所有的配对设备，本端使用的 IRK
相同。与不同的设备配对时，本端使用不同的 IRK 也是可以的。
</p>
</div>
</div>
<div id="广播" class="section level3 hasAnchor" number="12.9.2">
<h3><span class="header-section-number">12.9.2</span> 广播<a href="ch-misc.html#广播" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="未配对时" class="section level4 hasAnchor" number="12.9.2.1">
<h4><span class="header-section-number">12.9.2.1</span> 未配对时<a href="ch-misc.html#未配对时" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>当设备未配对或者期望被新的设备连接时，可事先生成不可解析随机地址或用 IRK 生成可解析地址，将其配置为广播集的随机地址，并使用这个随机地址发送广播，
即：</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb159-1"><a href="ch-misc.html#cb159-1" aria-hidden="true" tabindex="-1"></a>gap_set_adv_set_random_addr<span class="op">(...,</span> 生成的地址<span class="op">);</span></span>
<span id="cb159-2"><a href="ch-misc.html#cb159-2" aria-hidden="true" tabindex="-1"></a>gap_set_ext_adv_para<span class="op">(</span></span>
<span id="cb159-3"><a href="ch-misc.html#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb159-4"><a href="ch-misc.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RANDOM<span class="op">,</span> <span class="co">// own_addr_type</span></span>
<span id="cb159-5"><a href="ch-misc.html#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
</div>
<div id="已配对时" class="section level4 hasAnchor" number="12.9.2.2">
<h4><span class="header-section-number">12.9.2.2</span> 已配对时<a href="ch-misc.html#已配对时" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>当设备已与唯一的对端设备配对，发送广播等待与其建立连接时，将对端设备的身份地址填入 <code>gap_set_ext_adv_para</code> 的 <code>peer_addr</code> 参数，
Controller 从解析列表中查到对应的本端 IRK，使用与之对应的可解析地址（如地址不存在，会自动生成）发送广播：</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb160-1"><a href="ch-misc.html#cb160-1" aria-hidden="true" tabindex="-1"></a>gap_set_ext_adv_para<span class="op">(</span></span>
<span id="cb160-2"><a href="ch-misc.html#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb160-3"><a href="ch-misc.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RESOLVED_RAN<span class="op">,</span> <span class="co">// own_addr_type</span></span>
<span id="cb160-4"><a href="ch-misc.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  peer_addr_type<span class="op">,</span>               <span class="co">// peer_addr_type</span></span>
<span id="cb160-5"><a href="ch-misc.html#cb160-5" aria-hidden="true" tabindex="-1"></a>  peer_addr<span class="op">,</span>                    <span class="co">// peer_addr</span></span>
<span id="cb160-6"><a href="ch-misc.html#cb160-6" aria-hidden="true" tabindex="-1"></a>  ADV_FILTER_ALLOW_SCAN_WLST_CON_WLST<span class="op">,</span> <span class="co">// adv_filter_policy</span></span>
<span id="cb160-7"><a href="ch-misc.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
<p>当设备已与多个对端设备配对，发送广播等待与任意对端建立连接时，分为两种情况：</p>
<ol style="list-style-type: decimal">
<li><p>使用了相同的本端 IRK</p>
<p>由于使用任意对端的身份地址都会检索到这个 IRK，所以可以任意选择一个对端设备的身份地址填入 <code>gap_set_ext_adv_para</code>
的 <code>peer_addr</code> 参数，代码同上。</p></li>
<li><p>使用了各不相同的本端 IRK</p>
<p>可以轮流使用每个对端设备身份地址，填入 <code>gap_set_ext_adv_para</code> 的 <code>peer_addr</code> 参数，发送广播并等待一段时间，如无连接则切换到下一个设备。
或者用多个对端设备身份地址同时配置多个广播集。</p></li>
</ol>
<p>如果地址解析成功，<code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE_..</code> 事件里的 <code>peer_addr_type</code>
将会是 <code>BD_ADDR_TYPE_LE_RESOLVED_RAN</code> 或者 <code>BD_ADDR_TYPE_LE_RESOLVED_PUB</code>，
<code>peer_addr</code> 是解析出的对端的身份地址。<code>HCI_SUBEVENT_LE_SCAN_REQUEST_RECEIVED</code> 事件里的 <code>scanner_addr_type</code>
将会是 <code>BD_ADDR_TYPE_LE_RESOLVED_RAN</code> 或者 <code>BD_ADDR_TYPE_LE_RESOLVED_PUB</code>，
<code>scanner_addr</code> 是解析出的扫描者的身份地址。</p>
</div>
</div>
<div id="扫描" class="section level3 hasAnchor" number="12.9.3">
<h3><span class="header-section-number">12.9.3</span> 扫描<a href="ch-misc.html#扫描" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>可以生成不同于身份地址（如不可解析随机地址或用 IRK 生成可解析地址）的随机地址，并调用 <code>gap_set_random_device_address</code>。</p>
<p>如果需要扫描周围全部设备的广播信息，可如下配置扫描参数：</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb161-1"><a href="ch-misc.html#cb161-1" aria-hidden="true" tabindex="-1"></a>gap_set_ext_scan_para<span class="op">(</span></span>
<span id="cb161-2"><a href="ch-misc.html#cb161-2" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RANDOM<span class="op">,</span>               <span class="co">// own_addr_type</span></span>
<span id="cb161-3"><a href="ch-misc.html#cb161-3" aria-hidden="true" tabindex="-1"></a>  SCAN_ACCEPT_ALL_EXCEPT_NOT_DIRECTED<span class="op">,</span>  <span class="co">// filter_policy</span></span>
<span id="cb161-4"><a href="ch-misc.html#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
<p>如果只扫描白名单内设备的广播信息，可如下配置扫描参数：</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb162-1"><a href="ch-misc.html#cb162-1" aria-hidden="true" tabindex="-1"></a>gap_set_ext_scan_para<span class="op">(</span></span>
<span id="cb162-2"><a href="ch-misc.html#cb162-2" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RANDOM<span class="op">,</span>                <span class="co">// own_addr_type</span></span>
<span id="cb162-3"><a href="ch-misc.html#cb162-3" aria-hidden="true" tabindex="-1"></a>  SCAN_ACCEPT_WLIST_EXCEPT_NOT_DIRECTED<span class="op">,</span> <span class="co">// filter_policy</span></span>
<span id="cb162-4"><a href="ch-misc.html#cb162-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
<p>此时，Controller 扫描到某设备的广播时，尝试解析地址。对于主动扫描，如果解析成功且通过了白名单，
就使用对应于本端 IRK 的可解析地址发送扫描请求。</p>
<p>如果地址解析成功，<code>HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT</code> 事件里的 <code>addr_type</code>
将会是 <code>BD_ADDR_TYPE_LE_RESOLVED_RAN</code> 或者 <code>BD_ADDR_TYPE_LE_RESOLVED_PUB</code>，
<code>address</code> 是解析出的广播者身份地址。</p>
</div>
<div id="建立连接" class="section level3 hasAnchor" number="12.9.4">
<h3><span class="header-section-number">12.9.4</span> 建立连接<a href="ch-misc.html#建立连接" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>事先生成不可解析随机地址或用 IRK 生成可解析地址，并调用 <code>gap_set_random_device_address</code>。</p>
<div id="未配对时-1" class="section level4 hasAnchor" number="12.9.4.1">
<h4><span class="header-section-number">12.9.4.1</span> 未配对时<a href="ch-misc.html#未配对时-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>如果需要连接一个未配对的设备，可如下配置：</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb163-1"><a href="ch-misc.html#cb163-1" aria-hidden="true" tabindex="-1"></a>gap_ext_create_connection<span class="op">(</span></span>
<span id="cb163-2"><a href="ch-misc.html#cb163-2" aria-hidden="true" tabindex="-1"></a>  INITIATING_ADVERTISER_FROM_PARAM<span class="op">,</span>   <span class="co">// filter_policy</span></span>
<span id="cb163-3"><a href="ch-misc.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RANDOM<span class="op">,</span>             <span class="co">// own_addr_type</span></span>
<span id="cb163-4"><a href="ch-misc.html#cb163-4" aria-hidden="true" tabindex="-1"></a>  peer_addr_type<span class="op">,</span> <span class="co">// peer_addr_type</span></span>
<span id="cb163-5"><a href="ch-misc.html#cb163-5" aria-hidden="true" tabindex="-1"></a>  peer_addr<span class="op">,</span>      <span class="co">// peer_addr</span></span>
<span id="cb163-6"><a href="ch-misc.html#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
</div>
<div id="已配对时-1" class="section level4 hasAnchor" number="12.9.4.2">
<h4><span class="header-section-number">12.9.4.2</span> 已配对时<a href="ch-misc.html#已配对时-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>如果需要连接单一的确定的已配对设备，可如下配置：</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a href="ch-misc.html#cb164-1" aria-hidden="true" tabindex="-1"></a>gap_ext_create_connection<span class="op">(</span></span>
<span id="cb164-2"><a href="ch-misc.html#cb164-2" aria-hidden="true" tabindex="-1"></a>  INITIATING_ADVERTISER_FROM_PARAM<span class="op">,</span>   <span class="co">// filter_policy</span></span>
<span id="cb164-3"><a href="ch-misc.html#cb164-3" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RESOLVED_RAN<span class="op">,</span>       <span class="co">// own_addr_type</span></span>
<span id="cb164-4"><a href="ch-misc.html#cb164-4" aria-hidden="true" tabindex="-1"></a>  peer_addr_type<span class="op">,</span> <span class="co">// peer_addr_type</span></span>
<span id="cb164-5"><a href="ch-misc.html#cb164-5" aria-hidden="true" tabindex="-1"></a>  peer_addr<span class="op">,</span>      <span class="co">// peer_addr</span></span>
<span id="cb164-6"><a href="ch-misc.html#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
<p>如果需要连接白名单内的任一已知设备，可如下配置：</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb165-1"><a href="ch-misc.html#cb165-1" aria-hidden="true" tabindex="-1"></a>gap_ext_create_connection<span class="op">(</span></span>
<span id="cb165-2"><a href="ch-misc.html#cb165-2" aria-hidden="true" tabindex="-1"></a>  INITIATING_ADVERTISER_FROM_LIST<span class="op">,</span>   <span class="co">// filter_policy</span></span>
<span id="cb165-3"><a href="ch-misc.html#cb165-3" aria-hidden="true" tabindex="-1"></a>  BD_ADDR_TYPE_LE_RESOLVED_RAN<span class="op">,</span>      <span class="co">// own_addr_type</span></span>
<span id="cb165-4"><a href="ch-misc.html#cb165-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...);</span></span></code></pre></div>
<p>如果地址解析成功，<code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE_..</code> 事件里的 <code>peer_addr_type</code>
将会是 <code>BD_ADDR_TYPE_LE_RESOLVED_RAN</code> 或者 <code>BD_ADDR_TYPE_LE_RESOLVED_PUB</code>，
<code>peer_addr</code> 是解析出的对端的身份地址。</p>

</div>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="53">
<li id="fn53"><p>参考《Application Note: Direction Finding Solution》。<a href="ch-misc.html#fnref53" class="footnote-back">↩︎</a></p></li>
<li id="fn54"><p>参考《Controller API Reference》。<a href="ch-misc.html#fnref54" class="footnote-back">↩︎</a></p></li>
<li id="fn55"><p>参考《Controller API Reference》。<a href="ch-misc.html#fnref55" class="footnote-back">↩︎</a></p></li>
<li id="fn56"><p>为防止与 Media Access Controller 混淆，蓝牙规范使用 MIC 代替 MAC。<a href="ch-misc.html#fnref56" class="footnote-back">↩︎</a></p></li>
<li id="fn57"><p><a href="https://ingchips.github.io/blog/2021-06-02-sdk-6/#%E5%85%BC%E5%AE%B9%E6%80%A7" class="uri">https://ingchips.github.io/blog/2021-06-02-sdk-6/#%E5%85%BC%E5%AE%B9%E6%80%A7</a><a href="ch-misc.html#fnref57" class="footnote-back">↩︎</a></p></li>
<li id="fn58"><p>只能在 <code>app_main</code> 就调用。<a href="ch-misc.html#fnref58" class="footnote-back">↩︎</a></p></li>
<li id="fn59"><p>对于 v8.4.12 或更旧的版本，所能存储的设备个数等于软件包所支持的连接数目。<a href="ch-misc.html#fnref59" class="footnote-back">↩︎</a></p></li>
<li id="fn60"><p>为多个连接创建多个同步执行器的优势在于多个
GATT 客户端上的会话可以并发。<a href="ch-misc.html#fnref60" class="footnote-back">↩︎</a></p></li>
<li id="fn61"><p>由规范规定。<a href="ch-misc.html#fnref61" class="footnote-back">↩︎</a></p></li>
<li id="fn62"><p><a href="https://www.bluetooth.com/specifications/assigned-numbers/" class="uri">https://www.bluetooth.com/specifications/assigned-numbers/</a><a href="ch-misc.html#fnref62" class="footnote-back">↩︎</a></p></li>
<li id="fn63"><p>这个函数的原始版本不是严格意义上的异步操作。考虑到在一个同步执行体内可能既会用到有响应的写入，也会用到无响应的写入，加入这个 API 可以带来便利。<a href="ch-misc.html#fnref63" class="footnote-back">↩︎</a></p></li>
<li id="fn64"><p>可以使用 <code>btstack_push_user_runnable</code>。<a href="ch-misc.html#fnref64" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-sm.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-cap.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["pg_ble_stack.pdf", "pg_ble_stack.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
