<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 概览 | 低功耗蓝牙开发者手册</title>
  <meta name="description" content="3 概览 | 低功耗蓝牙开发者手册." />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="3 概览 | 低功耗蓝牙开发者手册" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="3 概览 | 低功耗蓝牙开发者手册." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 概览 | 低功耗蓝牙开发者手册" />
  
  <meta name="twitter:description" content="3 概览 | 低功耗蓝牙开发者手册." />
  

<meta name="author" content="Ingchips Technology Co., Ltd." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-intro.html"/>
<link rel="next" href="ch-features.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">低功耗蓝牙开发者手册</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 版本历史</a></li>
<li class="chapter" data-level="2" data-path="ch-intro.html"><a href="ch-intro.html"><i class="fa fa-check"></i><b>2</b> 简介</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-intro.html"><a href="ch-intro.html#缩略语及术语"><i class="fa fa-check"></i><b>2.1</b> 缩略语及术语</a></li>
<li class="chapter" data-level="2.2" data-path="ch-intro.html"><a href="ch-intro.html#参考文档"><i class="fa fa-check"></i><b>2.2</b> 参考文档</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ch-overview.html"><a href="ch-overview.html"><i class="fa fa-check"></i><b>3</b> 概览</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-overview.html"><a href="ch-overview.html#基本原则"><i class="fa fa-check"></i><b>3.1</b> 基本原则</a></li>
<li class="chapter" data-level="3.2" data-path="ch-overview.html"><a href="ch-overview.html#协议栈架构"><i class="fa fa-check"></i><b>3.2</b> 协议栈架构</a></li>
<li class="chapter" data-level="3.3" data-path="ch-overview.html"><a href="ch-overview.html#ch-overview-comm-model"><i class="fa fa-check"></i><b>3.3</b> 通信模型</a></li>
<li class="chapter" data-level="3.4" data-path="ch-overview.html"><a href="ch-overview.html#回调函数事件包"><i class="fa fa-check"></i><b>3.4</b> 回调函数事件包</a></li>
<li class="chapter" data-level="3.5" data-path="ch-overview.html"><a href="ch-overview.html#事件包的解析"><i class="fa fa-check"></i><b>3.5</b> 事件包的解析</a></li>
<li class="chapter" data-level="3.6" data-path="ch-overview.html"><a href="ch-overview.html#ch-ctrl-err-code"><i class="fa fa-check"></i><b>3.6</b> Controller 错误码</a></li>
<li class="chapter" data-level="3.7" data-path="ch-overview.html"><a href="ch-overview.html#controller-特性定义"><i class="fa fa-check"></i><b>3.7</b> Controller 特性定义</a></li>
<li class="chapter" data-level="3.8" data-path="ch-overview.html"><a href="ch-overview.html#蓝牙规范版本编号"><i class="fa fa-check"></i><b>3.8</b> 蓝牙规范版本编号</a></li>
<li class="chapter" data-level="3.9" data-path="ch-overview.html"><a href="ch-overview.html#白名单"><i class="fa fa-check"></i><b>3.9</b> 白名单</a></li>
<li class="chapter" data-level="3.10" data-path="ch-overview.html"><a href="ch-overview.html#异步特性"><i class="fa fa-check"></i><b>3.10</b> 异步特性</a></li>
<li class="chapter" data-level="3.11" data-path="ch-overview.html"><a href="ch-overview.html#线程安全性"><i class="fa fa-check"></i><b>3.11</b> 线程安全性</a></li>
<li class="chapter" data-level="3.12" data-path="ch-overview.html"><a href="ch-overview.html#ble-设备地址-ch-overview-ble-addr"><i class="fa fa-check"></i><b>3.12</b> BLE 设备地址 {ch-overview-ble-addr}</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-features.html"><a href="ch-features.html"><i class="fa fa-check"></i><b>4</b> 特性简析</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-features.html"><a href="ch-features.html#新特性"><i class="fa fa-check"></i><b>4.1</b> 5.0 新特性</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-features.html"><a href="ch-features.html#新的-phy"><i class="fa fa-check"></i><b>4.1.1</b> 新的 PHY</a></li>
<li class="chapter" data-level="4.1.2" data-path="ch-features.html"><a href="ch-features.html#扩展广播"><i class="fa fa-check"></i><b>4.1.2</b> 扩展广播</a></li>
<li class="chapter" data-level="4.1.3" data-path="ch-features.html"><a href="ch-features.html#周期广播"><i class="fa fa-check"></i><b>4.1.3</b> 周期广播</a></li>
<li class="chapter" data-level="4.1.4" data-path="ch-features.html"><a href="ch-features.html#信道选择算法-2"><i class="fa fa-check"></i><b>4.1.4</b> 信道选择算法 #2</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-features.html"><a href="ch-features.html#新特性-1"><i class="fa fa-check"></i><b>4.2</b> 5.1 新特性</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-features.html"><a href="ch-features.html#cte"><i class="fa fa-check"></i><b>4.2.1</b> CTE</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-features.html"><a href="ch-features.html#ch-feature-prd-transfer"><i class="fa fa-check"></i><b>4.2.2</b> 周期广播同步信息传递</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-features.html"><a href="ch-features.html#新特性-2"><i class="fa fa-check"></i><b>4.3</b> 5.2 新特性</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-features.html"><a href="ch-features.html#le-audio"><i class="fa fa-check"></i><b>4.3.1</b> LE Audio</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-features.html"><a href="ch-features.html#增强的-atteatt"><i class="fa fa-check"></i><b>4.3.2</b> 增强的 ATT（EATT）</a></li>
<li class="chapter" data-level="4.3.3" data-path="ch-features.html"><a href="ch-features.html#路径损耗监测与功率控制"><i class="fa fa-check"></i><b>4.3.3</b> 路径损耗监测与功率控制</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="ch-features.html"><a href="ch-features.html#新特性-3"><i class="fa fa-check"></i><b>4.4</b> 5.3 新特性</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="ch-features.html"><a href="ch-features.html#减速模式"><i class="fa fa-check"></i><b>4.4.1</b> 减速模式</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="ch-features.html"><a href="ch-features.html#新特性-4"><i class="fa fa-check"></i><b>4.5</b> 5.4 新特性</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="ch-features.html"><a href="ch-features.html#有响应的周期广播pawr"><i class="fa fa-check"></i><b>4.5.1</b> 有响应的周期广播（PAwR）</a></li>
<li class="chapter" data-level="4.5.2" data-path="ch-features.html"><a href="ch-features.html#广播数据加密"><i class="fa fa-check"></i><b>4.5.2</b> 广播数据加密</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="ch-features.html"><a href="ch-features.html#其它"><i class="fa fa-check"></i><b>4.6</b> 其它</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="ch-features.html"><a href="ch-features.html#广播时-coded-phy-选择"><i class="fa fa-check"></i><b>4.6.1</b> 广播时 Coded PHY 选择</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-adv.html"><a href="ch-adv.html"><i class="fa fa-check"></i><b>5</b> GAP - 广播</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-adv.html"><a href="ch-adv.html#概览"><i class="fa fa-check"></i><b>5.1</b> 概览</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="ch-adv.html"><a href="ch-adv.html#类型"><i class="fa fa-check"></i><b>5.1.1</b> 类型</a></li>
<li class="chapter" data-level="5.1.2" data-path="ch-adv.html"><a href="ch-adv.html#ch1-adv-filter"><i class="fa fa-check"></i><b>5.1.2</b> 过滤策略</a></li>
<li class="chapter" data-level="5.1.3" data-path="ch-adv.html"><a href="ch-adv.html#phy"><i class="fa fa-check"></i><b>5.1.3</b> PHY</a></li>
<li class="chapter" data-level="5.1.4" data-path="ch-adv.html"><a href="ch-adv.html#广播集"><i class="fa fa-check"></i><b>5.1.4</b> 广播集</a></li>
<li class="chapter" data-level="5.1.5" data-path="ch-adv.html"><a href="ch-adv.html#相关事件"><i class="fa fa-check"></i><b>5.1.5</b> 相关事件</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ch-adv.html"><a href="ch-adv.html#使用说明"><i class="fa fa-check"></i><b>5.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-adv.html"><a href="ch-adv.html#配置广播"><i class="fa fa-check"></i><b>5.2.1</b> 配置广播</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-adv.html"><a href="ch-adv.html#ch1-adv-data-edit"><i class="fa fa-check"></i><b>5.2.2</b> 广播数据</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch-adv.html"><a href="ch-adv.html#配置周期广播"><i class="fa fa-check"></i><b>5.2.3</b> 配置周期广播</a></li>
<li class="chapter" data-level="5.2.4" data-path="ch-adv.html"><a href="ch-adv.html#起停广播"><i class="fa fa-check"></i><b>5.2.4</b> 起停广播</a></li>
<li class="chapter" data-level="5.2.5" data-path="ch-adv.html"><a href="ch-adv.html#起停周期广播"><i class="fa fa-check"></i><b>5.2.5</b> 起停周期广播</a></li>
<li class="chapter" data-level="5.2.6" data-path="ch-adv.html"><a href="ch-adv.html#为周期广播添加-cte"><i class="fa fa-check"></i><b>5.2.6</b> 为周期广播添加 CTE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-scan.html"><a href="ch-scan.html"><i class="fa fa-check"></i><b>6</b> GAP - 扫描</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-scan.html"><a href="ch-scan.html#概览-1"><i class="fa fa-check"></i><b>6.1</b> 概览</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="ch-scan.html"><a href="ch-scan.html#间隔与窗口"><i class="fa fa-check"></i><b>6.1.1</b> 间隔与窗口</a></li>
<li class="chapter" data-level="6.1.2" data-path="ch-scan.html"><a href="ch-scan.html#过滤策略"><i class="fa fa-check"></i><b>6.1.2</b> 过滤策略</a></li>
<li class="chapter" data-level="6.1.3" data-path="ch-scan.html"><a href="ch-scan.html#主动与被动"><i class="fa fa-check"></i><b>6.1.3</b> 主动与被动</a></li>
<li class="chapter" data-level="6.1.4" data-path="ch-scan.html"><a href="ch-scan.html#phy-1"><i class="fa fa-check"></i><b>6.1.4</b> PHY</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="ch-scan.html"><a href="ch-scan.html#使用说明-1"><i class="fa fa-check"></i><b>6.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ch-scan.html"><a href="ch-scan.html#配置参数"><i class="fa fa-check"></i><b>6.2.1</b> 配置参数</a></li>
<li class="chapter" data-level="6.2.2" data-path="ch-scan.html"><a href="ch-scan.html#起停扫描"><i class="fa fa-check"></i><b>6.2.2</b> 起停扫描</a></li>
<li class="chapter" data-level="6.2.3" data-path="ch-scan.html"><a href="ch-scan.html#处理数据"><i class="fa fa-check"></i><b>6.2.3</b> 处理数据</a></li>
<li class="chapter" data-level="6.2.4" data-path="ch-scan.html"><a href="ch-scan.html#与周期广播同步"><i class="fa fa-check"></i><b>6.2.4</b> 与周期广播同步</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-conn.html"><a href="ch-conn.html"><i class="fa fa-check"></i><b>7</b> GAP - 连接</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-conn.html"><a href="ch-conn.html#概览-2"><i class="fa fa-check"></i><b>7.1</b> 概览</a></li>
<li class="chapter" data-level="7.2" data-path="ch-conn.html"><a href="ch-conn.html#使用说明-2"><i class="fa fa-check"></i><b>7.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-conn.html"><a href="ch-conn.html#建立连接"><i class="fa fa-check"></i><b>7.2.1</b> 建立连接</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-conn.html"><a href="ch-conn.html#取消连接"><i class="fa fa-check"></i><b>7.2.2</b> 取消连接</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-conn.html"><a href="ch-conn.html#获取对端版本"><i class="fa fa-check"></i><b>7.2.3</b> 获取对端版本</a></li>
<li class="chapter" data-level="7.2.4" data-path="ch-conn.html"><a href="ch-conn.html#获取对端特性"><i class="fa fa-check"></i><b>7.2.4</b> 获取对端特性</a></li>
<li class="chapter" data-level="7.2.5" data-path="ch-conn.html"><a href="ch-conn.html#设置-phy"><i class="fa fa-check"></i><b>7.2.5</b> 设置 PHY</a></li>
<li class="chapter" data-level="7.2.6" data-path="ch-conn.html"><a href="ch-conn.html#更新连接参数"><i class="fa fa-check"></i><b>7.2.6</b> 更新连接参数</a></li>
<li class="chapter" data-level="7.2.7" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-subrating"><i class="fa fa-check"></i><b>7.2.7</b> 减速模式</a></li>
<li class="chapter" data-level="7.2.8" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-pathloss"><i class="fa fa-check"></i><b>7.2.8</b> 路损检测与上报</a></li>
<li class="chapter" data-level="7.2.9" data-path="ch-conn.html"><a href="ch-conn.html#ch-conn-power-ctrl"><i class="fa fa-check"></i><b>7.2.9</b> 功率控制</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html"><i class="fa fa-check"></i><b>8</b> GATT - 服务器</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#概览-3"><i class="fa fa-check"></i><b>8.1</b> 概览</a></li>
<li class="chapter" data-level="8.2" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#使用说明-3"><i class="fa fa-check"></i><b>8.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#profile-数据"><i class="fa fa-check"></i><b>8.2.1</b> Profile 数据</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#实现读回调"><i class="fa fa-check"></i><b>8.2.2</b> 实现读回调</a></li>
<li class="chapter" data-level="8.2.3" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#实现写回调"><i class="fa fa-check"></i><b>8.2.3</b> 实现写回调</a></li>
<li class="chapter" data-level="8.2.4" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#发送通知notification"><i class="fa fa-check"></i><b>8.2.4</b> 发送通知（Notification）</a></li>
<li class="chapter" data-level="8.2.5" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#发送指示indication"><i class="fa fa-check"></i><b>8.2.5</b> 发送指示（Indication）</a></li>
<li class="chapter" data-level="8.2.6" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#响应事件"><i class="fa fa-check"></i><b>8.2.6</b> 响应事件</a></li>
<li class="chapter" data-level="8.2.7" data-path="ch-gatt-server.html"><a href="ch-gatt-server.html#att_mtu"><i class="fa fa-check"></i><b>8.2.7</b> ATT_MTU</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html"><i class="fa fa-check"></i><b>9</b> GATT - 客户端</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#概览-4"><i class="fa fa-check"></i><b>9.1</b> 概览</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#句柄范围"><i class="fa fa-check"></i><b>9.1.1</b> 句柄范围</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#使用说明-4"><i class="fa fa-check"></i><b>9.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#创建客户端"><i class="fa fa-check"></i><b>9.2.1</b> 创建客户端</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#发现服务"><i class="fa fa-check"></i><b>9.2.2</b> 发现服务</a></li>
<li class="chapter" data-level="9.2.3" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#读取特征"><i class="fa fa-check"></i><b>9.2.3</b> 读取特征</a></li>
<li class="chapter" data-level="9.2.4" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#写入特征"><i class="fa fa-check"></i><b>9.2.4</b> 写入特征</a></li>
<li class="chapter" data-level="9.2.5" data-path="ch-gatt-client.html"><a href="ch-gatt-client.html#订阅特征"><i class="fa fa-check"></i><b>9.2.5</b> 订阅特征</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ch-l2cap.html"><a href="ch-l2cap.html"><i class="fa fa-check"></i><b>10</b> L2CAP</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-l2cap.html"><a href="ch-l2cap.html#概览-5"><i class="fa fa-check"></i><b>10.1</b> 概览</a></li>
<li class="chapter" data-level="10.2" data-path="ch-l2cap.html"><a href="ch-l2cap.html#使用说明-5"><i class="fa fa-check"></i><b>10.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="ch-l2cap.html"><a href="ch-l2cap.html#从端请求更新连接参数"><i class="fa fa-check"></i><b>10.2.1</b> 从端请求更新连接参数</a></li>
<li class="chapter" data-level="10.2.2" data-path="ch-l2cap.html"><a href="ch-l2cap.html#基于信用点的连接"><i class="fa fa-check"></i><b>10.2.2</b> 基于信用点的连接</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-sm.html"><a href="ch-sm.html"><i class="fa fa-check"></i><b>11</b> 安全管理</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-sm.html"><a href="ch-sm.html#概览-6"><i class="fa fa-check"></i><b>11.1</b> 概览</a></li>
<li class="chapter" data-level="11.2" data-path="ch-sm.html"><a href="ch-sm.html#使用说明-6"><i class="fa fa-check"></i><b>11.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="ch-sm.html"><a href="ch-sm.html#初始化"><i class="fa fa-check"></i><b>11.2.1</b> 初始化</a></li>
<li class="chapter" data-level="11.2.2" data-path="ch-sm.html"><a href="ch-sm.html#使用私有随机地址"><i class="fa fa-check"></i><b>11.2.2</b> 使用私有随机地址</a></li>
<li class="chapter" data-level="11.2.3" data-path="ch-sm.html"><a href="ch-sm.html#sm-事件回调"><i class="fa fa-check"></i><b>11.2.3</b> SM 事件回调</a></li>
<li class="chapter" data-level="11.2.4" data-path="ch-sm.html"><a href="ch-sm.html#每个连接的个性化设置"><i class="fa fa-check"></i><b>11.2.4</b> 每个连接的个性化设置</a></li>
<li class="chapter" data-level="11.2.5" data-path="ch-sm.html"><a href="ch-sm.html#地址解析查找"><i class="fa fa-check"></i><b>11.2.5</b> 地址解析、查找</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-misc.html"><a href="ch-misc.html"><i class="fa fa-check"></i><b>12</b> 杂项</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-misc.html"><a href="ch-misc.html#接收-cte"><i class="fa fa-check"></i><b>12.1</b> 接收 CTE</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-misc.html"><a href="ch-misc.html#基于连接的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.1</b> 基于连接的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.2" data-path="ch-misc.html"><a href="ch-misc.html#misc-cte-periodic-adv"><i class="fa fa-check"></i><b>12.1.2</b> 基于周期广播的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.3" data-path="ch-misc.html"><a href="ch-misc.html#基于私有方式-1-的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.3</b> 基于私有方式 #1 的 CTE 接收和发送</a></li>
<li class="chapter" data-level="12.1.4" data-path="ch-misc.html"><a href="ch-misc.html#基于私有方式-2-的-cte-接收和发送"><i class="fa fa-check"></i><b>12.1.4</b> 基于私有方式 #2 的 CTE 接收和发送</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-misc.html"><a href="ch-misc.html#兼容性"><i class="fa fa-check"></i><b>12.2</b> 兼容性</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-misc.html"><a href="ch-misc.html#data-length-与-mtu"><i class="fa fa-check"></i><b>12.2.1</b> Data Length 与 MTU</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-misc.html"><a href="ch-misc.html#api-返回值"><i class="fa fa-check"></i><b>12.3</b> API 返回值</a></li>
<li class="chapter" data-level="12.4" data-path="ch-misc.html"><a href="ch-misc.html#键值存储"><i class="fa fa-check"></i><b>12.4</b> 键值存储</a></li>
<li class="chapter" data-level="12.5" data-path="ch-misc.html"><a href="ch-misc.html#ch98-le-dev-db"><i class="fa fa-check"></i><b>12.5</b> 设备数据库</a></li>
<li class="chapter" data-level="12.6" data-path="ch-misc.html"><a href="ch-misc.html#ch-misc-synced-api"><i class="fa fa-check"></i><b>12.6</b> 同步版 API</a>
<ul>
<li class="chapter" data-level="12.6.1" data-path="ch-misc.html"><a href="ch-misc.html#gap-同步-api"><i class="fa fa-check"></i><b>12.6.1</b> GAP 同步 API</a></li>
<li class="chapter" data-level="12.6.2" data-path="ch-misc.html"><a href="ch-misc.html#gatt-客户端同步-api"><i class="fa fa-check"></i><b>12.6.2</b> GATT 客户端同步 API</a></li>
</ul></li>
<li class="chapter" data-level="12.7" data-path="ch-misc.html"><a href="ch-misc.html#ch-misc-thread-safe-api"><i class="fa fa-check"></i><b>12.7</b> 线程安全的 API</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="ch-cap.html"><a href="ch-cap.html"><i class="fa fa-check"></i><b>13</b> 协议栈能力</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-cap.html"><a href="ch-cap.html#非标扩展"><i class="fa fa-check"></i><b>13.1</b> “非标”扩展</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">低功耗蓝牙开发者手册</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-overview" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> 概览<a href="ch-overview.html#ch-overview" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="基本原则" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> 基本原则<a href="ch-overview.html#基本原则" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>BLE 协议栈<strong>尽最大努力</strong>执行各项任务，比如
<ul>
<li>将发射功率设置为 <span class="math inline">\(100dBm\)</span>，协议栈将以最大功率进行发射</li>
<li>广播、连接并发时，部分广播事件、连接事件可能因需要执行其它任务而被忽略（跳过）</li>
<li>极端情况下，当协议栈可能会主动终止某些任务并上报相应的事件</li>
</ul></li>
<li>连接模式下已进入 BLE 协议栈的数据包不会丢失、总是可以送达，除非连接断开</li>
</ol>
</div>
<div id="协议栈架构" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> 协议栈架构<a href="ch-overview.html#协议栈架构" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Controller、Host 以两个任务（或者线程）的形式运行，HCI 接口经过特殊设计，尽量减少内存数据的复制。
Host 的架构如图 <a href="ch-overview.html#fig:ch0-host-overview">3.1</a> 所示，主要通过 GAP、ATT、GATT Client、SM 等 4
个模块为开发者提供操作接口。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch0-host-overview"></span>
<img src="img/stack_overview.png" alt="Host 架构" width="50%" />
<p class="caption">
图 3.1: Host 架构
</p>
</div>
<p>Host 任务的伪代码如下：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="ch-overview.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> host_task<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb1-2"><a href="ch-overview.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-3"><a href="ch-overview.html#cb1-3" aria-hidden="true" tabindex="-1"></a>    host_init<span class="op">();</span></span>
<span id="cb1-4"><a href="ch-overview.html#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>true<span class="op">)</span></span>
<span id="cb1-5"><a href="ch-overview.html#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-6"><a href="ch-overview.html#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>recv_msg<span class="op">(</span>msg<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb1-7"><a href="ch-overview.html#cb1-7" aria-hidden="true" tabindex="-1"></a>        process_msg<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb1-8"><a href="ch-overview.html#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-9"><a href="ch-overview.html#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>也就是说 Host 任务是由各种消息驱动的。这些消息既包括来自 Controller 的事件、ACL 数据，
也包含软件定时器消息和用户发送的消息（<code>btstack_push_user_msg</code>）。</p>
<p><code>process_msg</code> 的伪代码如下：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="ch-overview.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process_msg<span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb2-2"><a href="ch-overview.html#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-3"><a href="ch-overview.html#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>msg<span class="op">)</span></span>
<span id="cb2-4"><a href="ch-overview.html#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-5"><a href="ch-overview.html#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HCI Event<span class="op">:</span></span>
<span id="cb2-6"><a href="ch-overview.html#cb2-6" aria-hidden="true" tabindex="-1"></a>        调用各个回调<span class="op">();</span></span>
<span id="cb2-7"><a href="ch-overview.html#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-8"><a href="ch-overview.html#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> ACL 数据<span class="op">:</span></span>
<span id="cb2-9"><a href="ch-overview.html#cb2-9" aria-hidden="true" tabindex="-1"></a>        调用各个回调<span class="op">();</span></span>
<span id="cb2-10"><a href="ch-overview.html#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-11"><a href="ch-overview.html#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> 软件定时器<span class="op">:</span></span>
<span id="cb2-12"><a href="ch-overview.html#cb2-12" aria-hidden="true" tabindex="-1"></a>        超时处理<span class="op">();</span></span>
<span id="cb2-13"><a href="ch-overview.html#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-14"><a href="ch-overview.html#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> 用户消息<span class="op">:</span></span>
<span id="cb2-15"><a href="ch-overview.html#cb2-15" aria-hidden="true" tabindex="-1"></a>        弹出用户消息事件<span class="op">();</span></span>
<span id="cb2-16"><a href="ch-overview.html#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-17"><a href="ch-overview.html#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> 用户执行体<span class="op">:</span></span>
<span id="cb2-18"><a href="ch-overview.html#cb2-18" aria-hidden="true" tabindex="-1"></a>        运行用户执行体<span class="op">();</span></span>
<span id="cb2-19"><a href="ch-overview.html#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb2-20"><a href="ch-overview.html#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-21"><a href="ch-overview.html#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>各个模块（包含协议内部模块及 App<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>）通过注册回调函数以响应这些事件。
有的模块在处理这些消息时又会产生其它的新事件，
为了响应这些新事件可以再向这些模块注册回调函数。也就是说，Host 内部各个模块（以及 App）通过消息、回调函数耦合在一起。
例如：</p>
<ul>
<li><p><code>hci_add_event_handler</code></p>
<p>通过这个函数可以注册一个能够监听所有 HCI 事件的回调；</p></li>
<li><p><code>att_server_init</code></p>
<p>向 ATT Server 模块注册用以响应特征读写的回调函数。</p></li>
</ul>
</div>
<div id="ch-overview-comm-model" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> 通信模型<a href="ch-overview.html#ch-overview-comm-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>通信是指由一地向另一地进行信息的传输与交换，其目的是传输信息、削减另一地的不确定性。对于 BLE 而言，主要有两种通信方式：
一对多的广播、一对一的连接。低功耗蓝牙定义了四种角色：广播发送方称为广播者（Broadcaster），接收方称为观察者（Observer）；
连接的发起方称为主角色（新名称为中心角色，Central），接受方称为从角色（新名称为外围角色，Periperhal）。</p>
<p>蓝牙规范定义了广播数据的格式、AD 类型，见图 <a href="ch-overview.html#fig:ch0-adv-data-format">3.2</a>。如，AD 类型 <span class="math inline">\(0x09\)</span> 表示设备名称，其后面的 AD 数据域是一个 UTF-8 字符串。
另请参阅“<a href="ch-adv.html#ch1-adv-data-edit">广播数据</a>”一节。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch0-adv-data-format"></span>
<img src="img/adv_data_format.png" alt="广播及扫描响应数据包格式" width="80%" />
<p class="caption">
图 3.2: 广播及扫描响应数据包格式
</p>
</div>
<p>对于连接模式，低功耗蓝牙定义了特征（Characteristic）和值（Value）这两个概念，进而组织成服务（Service），再由服务组成配置（Profile）。
特征的标识用 UUI​D 标识。客户端发现了服务器支持的服务后，就可以读写特征的值，或者订阅特征<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>。
显然特征不见得支持所有这些操作，因此，蓝牙核心规范又为特征定义了属性（Property）、
描述符（Discriptor）等装饰物，以说明特征所支持的操作、需要的权限。UUID 长度为 <span class="math inline">\(16\)</span> 字节，为了提高传输效率，BLE 定义了一系列特殊的 UUID，
它们的区别仅在于 2 个字节，另外 <span class="math inline">\(14\)</span> 个字节相同：</p>
<pre><code>0x0000xxxx-0000-1000-8000-00805F9B34FB</code></pre>
<p>这两个字节就是所谓的 16-bit UUID，由蓝牙特别兴趣小组公司负责管理、分配<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>。</p>
</div>
<div id="回调函数事件包" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> 回调函数事件包<a href="ch-overview.html#回调函数事件包" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>协议栈的各种回调函数遵循类似的原型，其输入称为事件包：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="ch-overview.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>btstack_packet_handler_t<span class="op">)</span> <span class="op">(</span></span>
<span id="cb4-2"><a href="ch-overview.html#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 事件包类型</span></span>
<span id="cb4-3"><a href="ch-overview.html#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> packet_type<span class="op">,</span></span>
<span id="cb4-4"><a href="ch-overview.html#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 关联的信道（一般指蓝牙连接句柄）</span></span>
<span id="cb4-5"><a href="ch-overview.html#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> channel<span class="op">,</span></span>
<span id="cb4-6"><a href="ch-overview.html#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 事件包内容</span></span>
<span id="cb4-7"><a href="ch-overview.html#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>packet<span class="op">,</span></span>
<span id="cb4-8"><a href="ch-overview.html#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 事件包内容的长度</span></span>
<span id="cb4-9"><a href="ch-overview.html#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> size<span class="op">);</span></span></code></pre></div>
<p>包类型 <code>packet_type</code> 的取值如下：</p>
<ul>
<li><p><code>HCI_EVENT_PACKET</code>：HCI 事件包（<strong>常用</strong>）</p>
<p>这个类型的事件包是个“大杂烩”，多个模块弹出的事件包都会使用这个类型。</p></li>
<li><p><code>HCI_ACL_DATA_PACKET</code>：Controller 上报的 ACL 数据</p>
<p>这个类型的事件包只会被通过 <code>hci_register_acl_packet_handler</code> 注册的 ACL 数据回调函数收到。</p></li>
<li><p><code>HCI_COMPLETED_SDU_PACKET</code>：来自 LE 信用信道的完整 SDU</p>
<p>这个类型的事件包只会被通过 <code>l2cap_register_service</code> 注册的 L2CAP 服务回调函数收到。</p></li>
<li><p><code>L2CAP_EVENT_PACKET</code>：来自 L2CAP 的事件包</p>
<p>这个类型的事件包只会被通过 <code>l2cap_add_event_handler</code> 注册的 L2CAP 事件回调函数收到。</p></li>
</ul>
</div>
<div id="事件包的解析" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> 事件包的解析<a href="ch-overview.html#事件包的解析" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>下面只介绍 <code>HCI_EVENT_PACKET</code> 事件包的解析，其它几种类型不常用。</p>
<p>首先使用 <code>hci_event_packet_get_type(packet)</code> 获取事件代码，根据事件代码的不同，后续的处理大不相同。
常用的几种事件代码如下。</p>
<ol style="list-style-type: decimal">
<li><p><code>BTSTACK_EVENT_STATE</code>：蓝牙协议栈事件</p>
<p>一般用于响应协议栈初始化：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="ch-overview.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>btstack_event_state_get_state<span class="op">(</span>packet<span class="op">)</span> <span class="op">!=</span> HCI_STATE_WORKING<span class="op">)</span></span>
<span id="cb5-2"><a href="ch-overview.html#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb5-3"><a href="ch-overview.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// App 初始化</span></span></code></pre></div></li>
<li><p><code>HCI_EVENT_LE_META</code>：BLE 元事件</p>
<p>这个元事件下辖多个子事件。先通过 <code>hci_event_le_meta_get_subevent_code(packet)</code> 获得子事件代码，然后通过
<code>decode_hci_le_meta_event(packet, sub_event_type)</code> 宏得到子事件的内容。
<code>sub_event_type</code> 为子事件内容对应的数据类型，各字段与蓝牙核心规范里的定义一致<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>。</p>
<p>协议栈的版本及初始化流程导致下列子事件不会出现，只会出现对应的扩展过的、功能更全面的事件：</p>
<ul>
<li><p><code>HCI_SUBEVENT_LE_CONNECTION_COMPLETE</code></p>
<p>改用 <code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE</code></p></li>
<li><p><code>HCI_SUBEVENT_LE_ADVERTISING_REPORT</code></p>
<p>改用 <code>HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT</code></p></li>
</ul>
<p>协议栈可能报告的子事件及对应的 <code>sub_event_type</code> 类型如下：</p>
<ul>
<li><p><code>HCI_SUBEVENT_LE_CONNECTION_UPDATE_COMPLETE</code></p>
<p>连接参数更新（<code>le_meta_event_conn_update_complete_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_READ_REMOTE_USED_FEATURES_COMPLETE</code></p>
<p>读取对端特性（<code>le_meta_event_read_remote_feature_complete_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_LONG_TERM_KEY_REQUEST</code></p>
<p>请求 LTK（<code>le_meta_event_long_term_key_request_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_REMOTE_CONNECTION_PARAMETER_REQUEST_COMPLETE</code></p>
<p>远端连接参数请求（<code>le_meta_event_remote_conn_param_request_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_DATA_LENGTH_CHANGE_EVENT</code></p>
<p>数据包长度改变（<code>le_meta_event_data_length_changed_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE</code></p>
<p>连接建立（<code>le_meta_event_enh_create_conn_complete_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_DIRECT_ADVERTISING_REPORT</code></p>
<p>定向广播报告（<code>le_meta_directed_adv_report_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PHY_UPDATE_COMPLETE</code></p>
<p>PHY 更新完成（<code>le_meta_phy_update_complete_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT</code></p>
<p>扩展广播报告（<code>le_meta_event_ext_adv_report_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PERIODIC_ADVERTISING_SYNC_ESTABLISHED</code></p>
<p>周期广播同步建立（<code>le_meta_event_periodic_adv_sync_established_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PERIODIC_ADVERTISING_REPORT</code></p>
<p>周期广播报告（<code>le_meta_event_periodic_adv_report_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PERIODIC_ADVERTISING_SYNC_LOST</code></p>
<p>周期广播同步丢失（<code>le_meta_event_periodic_adv_sync_lost_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_SCAN_TIMEOUT</code></p>
<p>扫描超时</p></li>
<li><p><code>HCI_SUBEVENT_LE_ADVERTISING_SET_TERMINATED</code></p>
<p>广播停止（<code>le_meta_adv_set_terminated_t</code>）</p>
<p>如果是由于广播是由于建立了连接而停止，那么从这个事件里可以得到广播句柄和连接句柄的对应关系。</p></li>
<li><p><code>HCI_SUBEVENT_LE_SCAN_REQUEST_RECEIVED</code></p>
<p>收到扫描请求（<code>le_meta_scan_req_received_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_CHANNEL_SELECTION_ALGORITHM</code></p>
<p>信道选择算法（<code>le_meta_ch_sel_algo_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_CONNECTIONLESS_IQ_REPORT</code></p>
<p>无连接 IQ 报告（<code>le_meta_connless_iq_report_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_CONNECTION_IQ_REPORT</code></p>
<p>有连接 IQ 报告（<code>le_meta_conn_iq_report_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_CTE_REQ_FAILED</code></p>
<p>CTE 请求失败（<code>le_meta_cte_req_failed_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PRD_ADV_SYNC_TRANSFER_RCVD</code></p>
<p>周期广播转移请求（<code>le_meta_prd_adv_sync_transfer_recv_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_REQUEST_PEER_SCA</code></p>
<p>对端 SCA 请求完成（<code>le_meta_request_peer_sca_complete_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_PATH_LOSS_THRESHOLD</code></p>
<p>路损门限报告（<code>le_meta_path_loss_threshold_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_TRANSMIT_POWER_REPORTING</code></p>
<p>发射功率报告（<code>le_meta_tx_power_reporting_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_SUBRATE_CHANGE</code></p>
<p>减速模式改变（<code>le_meta_subrate_change_t</code>）</p></li>
<li><p><code>HCI_SUBEVENT_LE_VENDOR_PRO_CONNECTIONLESS_IQ_REPORT</code></p>
<p>私有无连接 IQ 报告（<code>le_meta_pro_connless_iq_report_t</code>）</p></li>
</ul></li>
<li><p><code>HCI_EVENT_DISCONNECTION_COMPLETE</code>：连接断开事件</p>
<p>通过 <code>decode_hci_event_disconn_complete(packet)</code> 解析事件内容：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="ch-overview.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> event_disconn_complete</span>
<span id="cb6-2"><a href="ch-overview.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="ch-overview.html#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 状态码</span></span>
<span id="cb6-4"><a href="ch-overview.html#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> status<span class="op">;</span></span>
<span id="cb6-5"><a href="ch-overview.html#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 连接句柄</span></span>
<span id="cb6-6"><a href="ch-overview.html#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> conn_handle<span class="op">;</span></span>
<span id="cb6-7"><a href="ch-overview.html#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 原因</span></span>
<span id="cb6-8"><a href="ch-overview.html#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> reason<span class="op">;</span></span>
<span id="cb6-9"><a href="ch-overview.html#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> event_disconn_complete_t<span class="op">;</span></span></code></pre></div></li>
<li><p><code>HCI_EVENT_COMMAND_COMPLETE</code>：HCI 命令完成事件</p>
<p>通过 <code>hci_event_command_complete_get_command_opcode(packet)</code> 获得 HCI 命令码。
通过 <code>hci_event_command_complete_get_return_parameters(packet)</code> 获得 Controller 返回的参数，其中第 1 个字节为命令完成的状态，
<span class="math inline">\(0\)</span> 表示没有错误，详见“<a href="ch-overview.html#ch-ctrl-err-code">Controller 错误码</a>”。其它参数需要根据命令码做具体分析。</p></li>
<li><p><code>HCI_EVENT_COMMAND_STATUS</code>：HCI 命令状态事件</p>
<p>有些 HCI 命令可以立即完成，得到结果，Controller 会上报相应的 <code>HCI_EVENT_COMMAND_COMPLETE</code>。有些 HCI 命令则需要一定时间才能完成，比如发起连接，
Controller 收到这样的命令后不上报 <code>HCI_EVENT_COMMAND_COMPLETE</code>，而是上报 <code>HCI_EVENT_COMMAND_STATUS</code>。</p>
<p>通过 <code>hci_event_command_status_get_command_opcode(packet)</code> 获得 HCI 命令码。
通过 <code>hci_event_command_status_get_status(packet)</code> 获得状态，<span class="math inline">\(0\)</span> 表示没有错误，详见“<a href="ch-overview.html#ch-ctrl-err-code">Controller 错误码</a>”。</p></li>
<li><p><code>BTSTACK_EVENT_USER_MSG</code>：来自 <code>btstack_push_user_msg</code> 的用户消息</p></li>
</ol>
</div>
<div id="ch-ctrl-err-code" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> Controller 错误码<a href="ch-overview.html#ch-ctrl-err-code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>表 <a href="ch-overview.html#tab:ch0-ctrl-err-code">3.1</a> 列出了 Controller 使用的部分错误码。</p>
<table>
<caption><span id="tab:ch0-ctrl-err-code">表 3.1: </span> Controller 错误码</caption>
<thead>
<tr class="header">
<th align="left">错误码</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0x00</td>
<td align="left">无错误</td>
</tr>
<tr class="even">
<td align="left">0x01</td>
<td align="left">未知的命令</td>
</tr>
<tr class="odd">
<td align="left">0x02</td>
<td align="left">未知的连接句柄</td>
</tr>
<tr class="even">
<td align="left">0x03</td>
<td align="left">硬件错误</td>
</tr>
<tr class="odd">
<td align="left">0x05</td>
<td align="left">鉴权失败</td>
</tr>
<tr class="even">
<td align="left">0x06</td>
<td align="left">PIN 或密钥缺失</td>
</tr>
<tr class="odd">
<td align="left">0x07</td>
<td align="left">超出内存容量</td>
</tr>
<tr class="even">
<td align="left">0x08</td>
<td align="left">连接超时</td>
</tr>
<tr class="odd">
<td align="left">0x09</td>
<td align="left">连接数目达到极限</td>
</tr>
<tr class="even">
<td align="left">0x0B</td>
<td align="left">连接已存在</td>
</tr>
<tr class="odd">
<td align="left">0x0C</td>
<td align="left">命令不允许</td>
</tr>
<tr class="even">
<td align="left">0x11</td>
<td align="left">不支持的特性或参数值</td>
</tr>
<tr class="odd">
<td align="left">0x12</td>
<td align="left">HCI 命令参数错误</td>
</tr>
<tr class="even">
<td align="left">0x13</td>
<td align="left">远端用户断开连接</td>
</tr>
<tr class="odd">
<td align="left">0x14</td>
<td align="left">远端设备因资源紧张断开连接</td>
</tr>
<tr class="even">
<td align="left">0x15</td>
<td align="left">远端设备因关机断开连接</td>
</tr>
<tr class="odd">
<td align="left">0x16</td>
<td align="left">本机断开连接</td>
</tr>
<tr class="even">
<td align="left">0x1A</td>
<td align="left">不支持的远端或 LMP 特性</td>
</tr>
<tr class="odd">
<td align="left">0x1E</td>
<td align="left">非法的 LMP 或 LL 参数</td>
</tr>
<tr class="even">
<td align="left">0x1F</td>
<td align="left">未指定的错误</td>
</tr>
<tr class="odd">
<td align="left">0x20</td>
<td align="left">不支持的 LMP 或 LL 参数</td>
</tr>
<tr class="even">
<td align="left">0x22</td>
<td align="left">LMP 或 LL 响应超时</td>
</tr>
<tr class="odd">
<td align="left">0x23</td>
<td align="left">LMP 错误（会话冲突）</td>
</tr>
<tr class="even">
<td align="left">0x28</td>
<td align="left">时机已过</td>
</tr>
<tr class="odd">
<td align="left">0x2E</td>
<td align="left">不支持信道分类</td>
</tr>
<tr class="even">
<td align="left">0x2F</td>
<td align="left">安全特性不足</td>
</tr>
<tr class="odd">
<td align="left">0x3A</td>
<td align="left">Controller 正忙</td>
</tr>
<tr class="even">
<td align="left">0x3C</td>
<td align="left">定向广播超时</td>
</tr>
<tr class="odd">
<td align="left">0x3D</td>
<td align="left">因 MIC 错误而断开连接</td>
</tr>
<tr class="even">
<td align="left">0x3E</td>
<td align="left">连接无法建立</td>
</tr>
<tr class="odd">
<td align="left">0x43</td>
<td align="left">到达极限</td>
</tr>
<tr class="even">
<td align="left">0xFE</td>
<td align="left">任务调度失败（私有错误码）</td>
</tr>
<tr class="odd">
<td align="left">0xFF</td>
<td align="left">其它错误（私有错误码）</td>
</tr>
</tbody>
</table>
</div>
<div id="controller-特性定义" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> Controller 特性定义<a href="ch-overview.html#controller-特性定义" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<table>
<caption><span id="tab:ch-overview-ble-features">表 3.2: </span> BLE 链路层特性定义</caption>
<thead>
<tr class="header">
<th align="center">比特位置</th>
<th align="left">链路层特性</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0</td>
<td align="left">LE Encryption</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="left">Connection Parameters Request</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="left">Extended Reject Indication</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="left">Slave-initiated Features Exchange</td>
</tr>
<tr class="odd">
<td align="center">4</td>
<td align="left">LE Ping</td>
</tr>
<tr class="even">
<td align="center">5</td>
<td align="left">LE Data Packet Length Extension</td>
</tr>
<tr class="odd">
<td align="center">6</td>
<td align="left">LL Privacy</td>
</tr>
<tr class="even">
<td align="center">7</td>
<td align="left">Extended Scanner Filter Policies</td>
</tr>
<tr class="odd">
<td align="center">8</td>
<td align="left">LE 2M PHY</td>
</tr>
<tr class="even">
<td align="center">9</td>
<td align="left">Stable Modulation Index - Transmitter</td>
</tr>
<tr class="odd">
<td align="center">10</td>
<td align="left">Stable Modulation Index - Receiver</td>
</tr>
<tr class="even">
<td align="center">11</td>
<td align="left">LE Coded PHY</td>
</tr>
<tr class="odd">
<td align="center">12</td>
<td align="left">LE Extended Advertising</td>
</tr>
<tr class="even">
<td align="center">13</td>
<td align="left">LE Periodic Advertising</td>
</tr>
<tr class="odd">
<td align="center">14</td>
<td align="left">Channel Selection Algorithm #2</td>
</tr>
<tr class="even">
<td align="center">15</td>
<td align="left">LE Power Class 1</td>
</tr>
<tr class="odd">
<td align="center">16</td>
<td align="left">Minimum Number of Used Channels Procedure</td>
</tr>
<tr class="even">
<td align="center">17</td>
<td align="left">Connection CTE Request</td>
</tr>
<tr class="odd">
<td align="center">18</td>
<td align="left">Connection CTE Response</td>
</tr>
<tr class="even">
<td align="center">19</td>
<td align="left">Connectionless CTE Transmitter</td>
</tr>
<tr class="odd">
<td align="center">20</td>
<td align="left">Connectionless CTE Receiver</td>
</tr>
<tr class="even">
<td align="center">21</td>
<td align="left">Antenna Switching During CTE Transmission (AoD)</td>
</tr>
<tr class="odd">
<td align="center">22</td>
<td align="left">Antenna Switching During CTE Reception (AoA)</td>
</tr>
<tr class="even">
<td align="center">23</td>
<td align="left">Receiving Constant Tone Extensions</td>
</tr>
<tr class="odd">
<td align="center">24</td>
<td align="left">Periodic Advertising Sync Transfer - Sender</td>
</tr>
<tr class="even">
<td align="center">25</td>
<td align="left">Periodic Advertising Sync Transfer - Recipient</td>
</tr>
<tr class="odd">
<td align="center">26</td>
<td align="left">Sleep Clock Accuracy Updates</td>
</tr>
<tr class="even">
<td align="center">27</td>
<td align="left">Remote Public Key Validation</td>
</tr>
<tr class="odd">
<td align="center">28</td>
<td align="left">Connected Isochronous Stream - Master</td>
</tr>
<tr class="even">
<td align="center">29</td>
<td align="left">Connected Isochronous Stream - Slave</td>
</tr>
<tr class="odd">
<td align="center">30</td>
<td align="left">Isochronous Broadcaster</td>
</tr>
<tr class="even">
<td align="center">31</td>
<td align="left">Synchronized Receiver</td>
</tr>
<tr class="odd">
<td align="center">32</td>
<td align="left">Isochronous Channels (Host Support)</td>
</tr>
<tr class="even">
<td align="center">33</td>
<td align="left">LE Power Control Request</td>
</tr>
<tr class="odd">
<td align="center">34</td>
<td align="left">LE Power Control Request</td>
</tr>
<tr class="even">
<td align="center">35</td>
<td align="left">LE Path Loss Monitoring</td>
</tr>
<tr class="odd">
<td align="center">36</td>
<td align="left">Periodic Advertising ADI</td>
</tr>
<tr class="even">
<td align="center">37</td>
<td align="left">Connection Subrating</td>
</tr>
<tr class="odd">
<td align="center">38</td>
<td align="left">Connection Subrating (Host Support)</td>
</tr>
<tr class="even">
<td align="center">39</td>
<td align="left">Channel Classification</td>
</tr>
</tbody>
</table>
<div class="rmdnote">
<p>
两个比特位置 33 和 34 合并表示 LE 功控请求特性，只能同为 0 或同为 1。
这是因为蓝牙规范 5.2 的特性定义有误，5.3
加以修正，只得以两个比特表示同一特性。
</p>
</div>
</div>
<div id="蓝牙规范版本编号" class="section level2 hasAnchor" number="3.8">
<h2><span class="header-section-number">3.8</span> 蓝牙规范版本编号<a href="ch-overview.html#蓝牙规范版本编号" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<table>
<caption><span id="tab:ch-overview-ble-version">表 3.3: </span> 蓝牙链路层协议版本号</caption>
<thead>
<tr class="header">
<th align="center">编号</th>
<th align="left">蓝牙链路层协议版本号</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">6</td>
<td align="left">4.0</td>
</tr>
<tr class="even">
<td align="center">7</td>
<td align="left">4.1</td>
</tr>
<tr class="odd">
<td align="center">8</td>
<td align="left">4.2</td>
</tr>
<tr class="even">
<td align="center">9</td>
<td align="left">5.0</td>
</tr>
<tr class="odd">
<td align="center">10</td>
<td align="left">5.1</td>
</tr>
<tr class="even">
<td align="center">11</td>
<td align="left">5.2</td>
</tr>
<tr class="odd">
<td align="center">12</td>
<td align="left">5.3</td>
</tr>
<tr class="even">
<td align="center">13</td>
<td align="left">5.4</td>
</tr>
</tbody>
</table>
</div>
<div id="白名单" class="section level2 hasAnchor" number="3.9">
<h2><span class="header-section-number">3.9</span> 白名单<a href="ch-overview.html#白名单" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在广播、扫描或者建立连接时，都可能用到白名单。操作白名单的 API 共有 3 个：</p>
<ol style="list-style-type: decimal">
<li><p><code>gap_clear_white_lists</code>：清空白名单</p></li>
<li><p><code>gap_add_whitelist</code>：添加一个设备地址</p></li>
<li><p><code>gap_remove_whitelist</code>：删除一个设备地址</p></li>
</ol>
</div>
<div id="异步特性" class="section level2 hasAnchor" number="3.10">
<h2><span class="header-section-number">3.10</span> 异步特性<a href="ch-overview.html#异步特性" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Host API 绝大多数都是异步非阻塞操作，比如调用 <code>gap_set_ext_adv_enable()</code> 并不立即使能广播：这个函数只会给 Controller
发送一条 HCI 消息<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>，Controller 接收消息、完成处理之后才会真正开始广播。</p>
<p>这种异步特性可能使得实现某些功能的代码冗长、零散，开发者可以考虑使用其它语言<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>，
或者重新封装 Host API，使其变为同步操作（参考 “<a href="ch-misc.html#ch-misc-synced-api">同步版 API</a>”一节）。</p>
</div>
<div id="线程安全性" class="section level2 hasAnchor" number="3.11">
<h2><span class="header-section-number">3.11</span> 线程安全性<a href="ch-overview.html#线程安全性" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Host 是线程<strong>不安全</strong>的，除下列函数之外的所有 API，如无特殊说明都必须在 Host 任务的上下文内调用。
当其它任务需要调用 Host API 时，必须触发一段处于 Host 任务上下文内的代码，再在这段代码里调用 Host API。
下列函数恰是为该功能设置：</p>
<ul>
<li><p><code>btstack_push_user_msg</code></p>
<p>通过 <code>btstack_push_user_msg</code> 向 Host 发送一条消息，消息的回调处理处于 Host 任务上下文内，
在这里可以调用 Host API。</p></li>
<li><p><code>btstack_push_user_runnable</code></p>
<p>通过 <code>btstack_push_user_runnable</code> 向 Host 发送一个可执行体（函数指针及参数），Host
任务在其上下文内运行这个可执行体。这个可执行体可以自由调用 Host API。
SDK 提供的工具模块 <code>btstack_mt.c</code> 利用这个函数实现了一套“<a href="ch-misc.html#ch-misc-thread-safe-api">线程安全的 API</a>”。</p></li>
</ul>
<div class="rmdcaution">
<p>
开发者在其它任务里直接调用 Host
API，即便发现功能正常，也仅是偶然现象，无法保证总是正常。
</p>
</div>
</div>
<div id="ble-设备地址-ch-overview-ble-addr" class="section level2 hasAnchor" number="3.12">
<h2><span class="header-section-number">3.12</span> BLE 设备地址 {ch-overview-ble-addr}<a href="ch-overview.html#ble-设备地址-ch-overview-ble-addr" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>BLE 设备地址长度为 6 字节，外加 1 个比特表示地址类型。BLE 规范定义了若干种地址类型：</p>
<ol style="list-style-type: decimal">
<li><p>公共地址（Public Address，地址类型为 0）</p>
<p>指从 IEEE 注册机构（IEEE Registration Authority）获得的全球唯一的 EUI-48 地址。</p></li>
<li><p>随机地址（Random Address，地址类型为 1）</p>
<p>以下几种随机地址类型通过最高的 2 个比特区分。</p>
<ol style="list-style-type: decimal">
<li><p>静态设备地址（最高 2 个比特为 0b11）</p>
<p>可随机生成，可以每次上电后重新生成<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>，但是整个上电周期内不能改变。</p></li>
<li><p>私有地址</p>
<p>共有两种私有地址。</p>
<ol style="list-style-type: decimal">
<li><p>可解析私有地址（最高 2 个比特为 0b01）</p></li>
<li><p>不可解析私有地址（最高 2 个比特为 0b00）</p></li>
</ol></li>
</ol></li>
</ol>
<p>多数情况下四处广播设备的公共地址或者静态地址显然不是一个好主意，使用私有地址可有效地保护隐私。
有了可解析地址的概念后，设备的公共地址、静态地址就从逻辑上变成身份地址（Identity Address）。</p>
<div class="rmdcaution">
<p>
<em>INGCHIPS</em> 918xx/916xx
系列芯片没有公共地址，只能通过编程配置随机地址。
</p>
</div>
<p>使用蓝牙地址时要注意字节顺序。协议栈遵循下面的基本规律：</p>
<ul>
<li>API 使用大端模式</li>
<li>BLE 元事件使用小端模式<a href="#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a></li>
</ul>
<p>使用 <code>reverse_bd_addr</code> 可以翻转地址的字节顺序：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="ch-overview.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> reverse_bd_addr<span class="op">(</span></span>
<span id="cb7-2"><a href="ch-overview.html#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 待翻转的地址</span></span>
<span id="cb7-3"><a href="ch-overview.html#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">uint8_t</span> <span class="op">*</span>src<span class="op">,</span></span>
<span id="cb7-4"><a href="ch-overview.html#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 输出（不能与 src 相同）</span></span>
<span id="cb7-5"><a href="ch-overview.html#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> <span class="op">*</span> dest<span class="op">);</span></span></code></pre></div>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="3">
<li id="fn3"><p>如无特殊说明，本文所说的 App 皆指运行在芯片上的蓝牙程序。<a href="ch-overview.html#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>指示服务器端主动报告特征的值。<a href="ch-overview.html#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p><a href="https://www.bluetooth.com/16-bit-uuids-for-sdos/" class="uri">https://www.bluetooth.com/16-bit-uuids-for-sdos/</a><a href="ch-overview.html#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>私有事件（如 HCI_SUBEVENT_LE_VENDOR_PRO_CONNECTIONLESS_IQ_REPORT）除外。<a href="ch-overview.html#fnref6" class="footnote-back">↩︎</a></p></li>
<li id="fn7"><p>更准确地说，只是把一条 HCI 消息放入消息队列。<a href="ch-overview.html#fnref7" class="footnote-back">↩︎</a></p></li>
<li id="fn8"><p><a href="https://ingchips.github.io/blog/2021-01-25-zig-async/" class="uri">https://ingchips.github.io/blog/2021-01-25-zig-async/</a><a href="ch-overview.html#fnref8" class="footnote-back">↩︎</a></p></li>
<li id="fn9"><p>地址改变后，曾与之配对的设备无法自动重连。<a href="ch-overview.html#fnref9" class="footnote-back">↩︎</a></p></li>
<li id="fn10"><p>参照蓝牙核心规范。<a href="ch-overview.html#fnref10" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-features.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["pg_ble_stack.pdf", "pg_ble_stack.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
