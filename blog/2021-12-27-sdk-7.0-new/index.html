<!doctype html>
<html lang="en">
    <head>

        <title>SDK 7.0 更新说明 - INGCHIPS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="总结 SDK 7.0 新功能、解决的问题。"/>
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    </head>
    <body
        <div id="page" class="site">
  <header id="masthead" class="site-header outer">
  <div class="inner">
    <div class="site-header-inside">
      <div class="site-branding">
        
        
        <p class="site-logo"><a href="/"><img src="/images/logo_en.jpg" alt="INGCHIPS" /></a></p>
        
      </div><!-- .site-branding -->
      
      
      <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
        <div class="site-nav-inside">
          <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-close" aria-hidden="true"></span></button>
          <ul class="menu">
            
            <li class="menu-item">
              
              
<a class="" href="/">
  
  Home
  
</a>

              
            </li>
            
            <li class="menu-item">
              
              
<a class="" href="/docs/products">
  
  产品
  
</a>

              
            </li>
            
            <li class="menu-item">
              
              
<a class="" href="/docs/sdk">
  
  SDK
  
</a>

              
            </li>
            
            <li class="menu-item">
              
              
<a class="" href="/docs/">
  
  文档
  
</a>

              
            </li>
            
            <li class="menu-item has-children">
              
              
<a class="" href="/docs/sdk/apps/#web-apps">
  
  Web 工具
  
</a>

              
                
                <ul class="submenu">
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/callgraph">
  
  Callgraph (调用图)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index_cn.html">
  
  ING918/ING916 FOTA (空中升级)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/powerprofiler/">
  
  Online Power Profiler
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/air_trace/">
  
  Trace Logger
  
</a>

  </li>
  
</ul>

              
            </li>
            
            <li class="menu-item">
              
              
<a class="" href="/blog/">
  
  Blog
  
</a>

              
            </li>
            
            <li class="menu-item menu-button">
              
              
<a class="button" href="https://github.com/ingchips">
  
  GitHub
  
</a>

              
            </li>
            
          </ul>
        </div><!-- .site-nav-inside -->
      </nav><!-- .site-navigation -->
      <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
      
    </div><!-- .site-header-inside -->
  </div><!-- .inner -->
</header><!-- .site-header -->

  <main id="content" class="site-content">
      <article class="post post-full">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <header class="post-header has-gradient outer">
      
      
      <div class="inner-sm">
        <div class="post-meta">
          <time class="published" datetime="2021-12-27 00:00">December 27, 2021</time>
        </div>
        <h1 class="post-title">SDK 7.0 更新说明</h1>
        
        
      </div>
    </header>
    <div class="inner-md outer">
      <div class="post-content">
        <h2 id="highlights">Highlights:</h2>

<ul>
  <li>不包含 FreeRTOS 的 NoOS 软件包</li>
  <li>AoA 寻向 demo</li>
</ul>

<h2 id="1-软件包">1. 软件包</h2>

<ul>
  <li>
    <p>[<strong>新增</strong>] 针对 ING9188xx/ING9187xx 系列不包含 FreeRTOS 的 NoOS 软件包 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>

    <p>NoOS 软件包不包含 FreeRTOS，开发者可以选择其它的 RTOS，与 app 一起编译。
  我们针对蓝牙协议栈所需要的 RTOS 功能定义了通过 OS 接口，开发者只需要基于所选用的 RTOS 实现这个接口即可。
  SDK 里提供了基于 FreeRTOS 和 RT-Thread 的两个示例作为参考。</p>

    <p>可以考虑使用 NoOS 软件包的几种场景：</p>

    <ul>
      <li>需要使用更多的 FreeRTOS 功能/API</li>
      <li>现有系统使用了其它的 RTOS</li>
      <li>……</li>
    </ul>

    <p>具体使用方法详见文末介绍。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="highlighter-rouge">ll_hint_on_ce_len</code> 现在可用于中心角色 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 扩展广播每个广播事件进行跳频 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 优化 <code class="highlighter-rouge">mass_conn</code> 软件包的吞吐率 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
</ul>

<h2 id="2-库源代码">2. 库/源代码</h2>

<ul>
  <li>
    <p>[<strong>新增</strong>] 包含 FreeRTOS &amp; RT-Thread 源代码 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] 通过 OS 接口在 FreeRTOS &amp; RT-Thread 上的实现 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 微调 <code class="highlighter-rouge">power_ctrl.lib</code> <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 杂项更新: <code class="highlighter-rouge">compiler.h</code>, <code class="highlighter-rouge">ingsoc.h</code> <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
</ul>

<h2 id="3-示例">3. 示例</h2>

<ul>
  <li>
    <p>[<strong>新增</strong>] <code class="highlighter-rouge">Peripheral Console FreeRTOS/RT-Thread</code>: 演示了外置 RTOS + NoOS bundles 的使用方法 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="highlighter-rouge">Central CTE</code>: 发现并配置 CTE 服务 <span style="background:yellow">(<strong>7.0.0</strong>)</span></p>
  </li>
</ul>

<h2 id="4-文档">4. 文档</h2>
<ul>
  <li>[<strong>新增</strong>] Application Note: Direction Finding Solution <span style="background:yellow">(<strong>7.0.0</strong>)</span></li>
</ul>

<h2 id="5-工具">5. 工具</h2>

<ul>
  <li>[<strong>新增</strong>] 实时 AoA 寻向 demo <span style="background:yellow">(<strong>7.0.0</strong>)</span></li>
  <li>[<strong>更新</strong>] Wizard: 支持 NoOS 软件包 <span style="background:yellow">(<strong>7.0.1</strong>)</span></li>
  <li>[<strong>更新</strong>] 使用 Keil v5.36 重新编译 Coremark 分数提升到  2.13/MHz <span style="background:yellow">(<strong>7.0.0</strong>)</span></li>
</ul>

<h2 id="6-使用-noos-软件包">6. 使用 NoOS 软件包</h2>

<h3 id="61-新项目">6.1 新项目</h3>

<div class="note">
<strong>说明：</strong> SDK 提供了 FreeRTOS/RT-Thread 两种 RTOS 的示例程序，通用 OS 接口、
tickless 低功耗等已经实现，开发者可直接使用。
</div>

<ul>
  <li>
    <p>使用项目向导创建新项目时，RTOS 选项选择“No RTOS”:</p>

    <p><img src="../img/sdk_select_noos.png" alt="" /></p>
  </li>
  <li>
    <p>将 RTOS 源代码添加到项目，并配置编译选项</p>

    <p>以 RT-Thread Nano 为例，将 RT-Thread 的 <code class="highlighter-rouge">rtconfig.h</code> 复制一份到项目目录下，修改以下配置：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cp">#define RT_TICK_PER_SECOND  1024
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>实现通用 OS 接口</p>

    <p>通用 OS 接口的定义在 <code class="highlighter-rouge">port_gen_os_driver.h</code> 里，一共包含大约 20 个 API。platform.bin 从 <code class="highlighter-rouge">app_main</code>
  的返回值获取接口实现：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">const</span> <span class="n">gen_os_driver_t</span> <span class="n">gen_os_driver</span> <span class="o">=</span>
  <span class="p">{</span>
      <span class="p">.</span><span class="n">timer_create</span> <span class="o">=</span> <span class="p">...</span>
  <span class="p">};</span>
  <span class="kt">uintptr_t</span> <span class="nf">app_main</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="p">...</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gen_os_driver</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>实现 tickless 低功耗</p>

    <p>如果 app 需要使用省电功能，则需要实现 tickless 低功耗。—— 这是使用 NoOS 软件包开发 app 一个难点。</p>

    <p>tickless 低功耗在 RTOS 空闲任务（task, thread 等）里实现，总体逻辑如下：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="nf">idle_task</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">for</span> <span class="p">(;;)</span>
      <span class="p">{</span>
          <span class="n">timeout_tick</span> <span class="o">=</span> <span class="err">多少个</span><span class="n">tick</span><span class="err">无事可做</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">platform_pre_suppress_ticks_and_sleep_processing</span><span class="p">(</span><span class="n">timeout_tick</span><span class="p">)</span> <span class="o">&gt;</span> <span class="err">一定时间</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="err">调度器停止</span><span class="p">();</span>
              <span class="n">platform_pre_sleep_processing</span><span class="p">();</span>
              <span class="n">platform_post_sleep_processing</span><span class="p">();</span>
              <span class="n">tick_cnt</span> <span class="o">=</span> <span class="err">睡了多少</span><span class="n">tick</span><span class="p">();</span>
              <span class="err">补偿</span><span class="n">tick</span><span class="err">计数器</span><span class="p">();</span>
              <span class="err">重新开始产生</span><span class="n">tick</span><span class="err">中断</span><span class="p">();</span>
              <span class="err">调度器继续</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="n">platform_os_idle_resumed_hook</span><span class="p">();</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>其它区别</p>

    <p>使用 NoOS 软件包与使用内置 FreeRTOS 软件包的 app 的其它区别：</p>

    <ul>
      <li>ISR 使用的栈空间由 app 中断向量表给出，platform.bin 不再提供 <code class="highlighter-rouge">platform_install_isr_stack</code></li>
      <li>platform.bin 不再提供 <code class="highlighter-rouge">platform_get_heap_status</code>，开发者可自行实现</li>
      <li><code class="highlighter-rouge">PLATFORM_CFG_RTOS_ENH_TICK</code> 功能需要开发者在实现 tickless 低功耗时考虑</li>
    </ul>
  </li>
</ul>

<h3 id="62-移植已有项目">6.2 移植已有项目</h3>

<p>建议先新建一个 NoOS 项目，然后将已有代码添加到新项目。</p>

      </div><!-- .post-content -->
    </div><!-- .inner-md -->
  </article><!-- .post -->

  <!-- Next/previous post navigation TBD -->
  <!--
  <div class="inner-md outer">
    <nav class="read-next">
      <h2 class="read-next-title line-left">Read Next</h2>
      <div class="nav-links">
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Previous post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Previous Post Title</a></h3>
        </article>
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Next post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Next Post Title</a></h3>
        </article>
      </div>
    </nav>
  </div>
  -->

  </main><!-- .site-content -->
  <footer id="colophon" class="site-footer outer">
  <div class="inner">
    <div class="site-footer-inside">
      <p class="site-info">
        
        
        <span class="copyright">&copy; INGCHIPS 2021. All rights reserved.</span>
        
        
          
          
<a class="" href="https://www.stackbit.com" target="_blank" rel="noopener">
  
  Made with Stackbit
  
</a>

        
      </p><!-- .site-info -->
      
      
      <div class="social-links">
        
          
          
<a class="button button-icon" href="https://github.com/ingchips" target="_blank" rel="noopener">
  
  <span class="icon fab fa-github" aria-hidden="true"></span><span class="screen-reader-text">GitHub</span>
  
</a>

        
      </div><!-- .social-links -->
      
    </div><!-- .site-footer-inside -->
  </div><!-- .inner -->
</footer><!-- .site-footer -->

</div><!-- .site -->

        <!-- Scripts -->
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/prism.js" data-manual></script>
        <script src="/assets/js/main.js"></script>
    </body>
</html>
