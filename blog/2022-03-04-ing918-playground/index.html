<!doctype html>
<html lang="en">
    <head>

        <title>ING9188 开发板 Playground 半日游 - INGCHIPS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="ING9188 开发板 Playground 演示讲解。"/>
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    </head>
    <body
        <div id="page" class="site">
  <header id="masthead" class="site-header outer">

  <div class="inner">
    <div class="site-header-inside">
      <div class="site-branding">
        
        
        <p class="site-logo"><a href="/"><img src="/images/logo_en.jpg" alt="INGCHIPS" /></a></p>
        
      </div><!-- .site-branding -->

      <div id="box">
        <input id="in_search" type="search" name="search" placeholder="请输入关键字">
      </div>

      <script>
        let search_input = document.getElementById('in_search');
        if (search_input) {
          search_input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            window.open('https://www.bing.com/search?q=' + encodeURIComponent(search_input.value) + '%20site%3Aingchips.github.io');
            event.preventDefault();
            }
          });
        }
      </script>

      
      
      <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
        <div class="site-nav-inside">
          <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-close" aria-hidden="true"></span></button>
          <ul class="menu">
            
            <li class="menu-item">

              
<a class="" href="/">
  
  Home
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/products">
  
  产品
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/sdk">
  
  SDK
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/">
  
  文档
  
</a>

              
            </li>
            
            <li class="menu-item has-children">

              
<a class="" href="/docs/sdk/apps/#web-apps">
  
  Web 工具
  
</a>

              

                <ul class="submenu">
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/callgraph">
  
  Callgraph (调用图)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index_cn.html">
  
  ING918/ING916 FOTA (空中升级)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/powerprofiler/">
  
  Online Power Profiler
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/air_trace/">
  
  Trace Logger
  
</a>

  </li>
  
</ul>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/blog/">
  
  Blog
  
</a>

              
            </li>
            
            <li class="menu-item menu-button">

              
<a class="button" href="https://github.com/ingchips">
  
  GitHub
  
</a>

              
            </li>
            
          </ul>
        </div><!-- .site-nav-inside -->
      </nav><!-- .site-navigation -->
      <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
      
    </div><!-- .site-header-inside -->
  </div><!-- .inner -->
</header><!-- .site-header -->

  <main id="content" class="site-content">
      <article class="post post-full">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        }
      });
    </script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <header class="post-header has-gradient outer">
      
      
      <div class="inner-sm">
        <div class="post-meta">
          <time class="published" datetime="2022-03-04 00:00">March 04, 2022</time>
        </div>
        <h1 class="post-title">ING9188 开发板 Playground 半日游</h1>
        
        
      </div>
    </header>
    <div class="inner-md outer">
      <div class="post-content">
        <p>从特定角度看，SDK 上手仍然有一定难度，比如只是想实现一个极为简单的点亮 LED 功能，
需要安装开发环境、工具链，需要懂 C 语言，还需要阅读教程、查阅外设源代码。
与之对比，<a href="https://www.nodemcu.com/">NodeMCU</a>、<a href="https://micropython.org">MicroPython</a>、<a href="https://www.espruino.com">Espruino</a>
等系统使用了比 C 语言友好的 Lua、Python、JavaScript，不需要安装<strong>昂贵</strong>的开发工具，
对于点亮 LED 这种简单功能实现了开箱即用。</p>

<p>现在，我们为 ING9188 开发板推出了 <a href="/docs/getting-started/playground">Playground</a> 系统，
即使没有任何开发经验，不懂英语，也能体验桃芯科技。请先参照 <a href="/docs/getting-started/playground">文档</a> 准备好环境，
然后一起在这个游乐园里游历半日。</p>

<h2 id="灯灯灯">灯，灯，灯</h2>

<p>点亮一盏灯可称得上是嵌入式开发里的“Hello World”。Playground 里的开灯程序如下：</p>

<pre><code class="language-C">开灯
</code></pre>

<p>点击更新按钮，稍等片刻，开发板上整排 LED 全部点亮。这个不起眼的程序还有另外一种写法：</p>

<pre><code class="language-C">$(开灯)
</code></pre>

<p>为了最大限度地降低上手难度，Playground 支持用自然语言编程。把能想到的、开发板上可能实现的动作直接写到 <code class="highlighter-rouge">$(...)</code>
里试试看。比如，开灯，等待 1000 毫秒，然后关灯：</p>

<pre><code class="language-C">$(开灯);
$(等待 1000 毫秒);
$(关灯);
</code></pre>

<p>假如想让灯亮 1 秒，灭 1 秒，循环往复，显然不能不停地<strong>重复</strong>写 <code class="highlighter-rouge">$(开灯)</code>、<code class="highlighter-rouge">$(关灯)</code>、<code class="highlighter-rouge">$(开灯)</code>、<code class="highlighter-rouge">$(关灯)</code>……
<strong>重复</strong>性的工作应该由芯片里的处理器替我们完成：</p>

<pre><code class="language-C">重复(
    $(开灯);
    $(等待 1000 毫秒);
    $(关灯);
    $(再等 1000 毫秒);
)
</code></pre>

<p>单个灯也可以用自然语言控制。比如我们要让 0 号灯和 1 号灯交替亮灭，思路如下：</p>

<ol>
  <li>开 0 号灯，关 1 号灯</li>
  <li>延后 500 毫秒</li>
  <li>把 1 号灯打开，关掉 0 号灯</li>
  <li>再等会儿</li>
  <li>重复执行以上步骤</li>
</ol>

<p>于是代码就有了：</p>

<pre><code class="language-C">重复(
    $(开 0 号灯);
    $(关 1 号灯);
    $(延后 500 毫秒);
    $(把 1 号灯打开);
    $(关掉 0 号灯);
    $(再等会儿);
)
</code></pre>

<h2 id="蜂鸣器">蜂鸣器</h2>

<p>（粗略地，）蜂鸣器可以发出某个指定频率的声音，同样可以用自然语言控制它，比如：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="p">(</span><span class="err">发出</span> <span class="mi">400</span> <span class="n">Hz</span> <span class="err">的声音</span><span class="p">);</span>
<span class="err">$</span><span class="p">(</span><span class="err">等</span> <span class="mi">500</span> <span class="err">毫秒</span><span class="p">);</span>
<span class="err">$</span><span class="p">(</span><span class="err">停止发声</span><span class="p">);</span>
</code></pre></div></div>

<p>这段代码的功能显然就是发出半秒的单调声音。如果不嫌弃它的单调音质，那么可以让它演奏“最简单”的简谱：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="p">(</span><span class="err">演奏</span> <span class="mi">1155665</span><span class="o">-</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="彩灯">彩灯</h2>

<p>开发板上的彩灯可以以 RGB （红、绿、蓝三原色）、 HSL （<strong>色</strong>度、<strong>饱</strong>和度、<strong>亮</strong>度）两种模式控制，
RGB 的每个分量范围为 0 ~ 255，HSL 的每个分量范围为 0 ~ 1.0。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">设置红绿蓝</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="err">$</span><span class="p">(</span><span class="err">等候</span> <span class="mi">1000</span> <span class="err">毫秒</span><span class="p">);</span>
<span class="err">设置色饱亮</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="炫彩电压">“炫彩”电压</h2>

<p>芯片内的模拟数字转换器（ADC）可以测量电压。调节开发板上的可调电阻可以产生一个大致在 0V 到 2.5V 之间变化的电压供 ADC 测量。
开发板将芯片上的两个 ADC 连接到了这个电压信号上，开发板上印制了这两个 ADC 的序号，一个是 1，另一个是 4。
何不用色度来表示电压？先<strong>读取电压</strong>，除以 2.6，得到一个小于 1.0 的数值，设置为彩灯的色度。重复执行这个动作，
就能通过彩灯实时地看到电压的变化了。至于饱和度和亮度，可以随意选择数值，观察效果。代码如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">重复</span><span class="p">(</span><span class="err">设置色饱亮</span><span class="p">(</span><span class="err">读取电压</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);)</span>
</code></pre></div></div>

<p>将程序下载到开发板后，用小螺丝刀慢慢转动可调电阻，可以观察到颜色的变化。</p>

<h2 id="响应按键">响应按键</h2>

<p>现在我们想用某个按键（比如 1 号按键）控制灯的亮灭，<strong>按下时开灯</strong>，<strong>弹起时关灯</strong>，下面的代码显然是在实现这个功能：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">按键</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="err">按下时</span><span class="p">([]()</span> <span class="p">{</span> <span class="err">开灯</span><span class="p">;</span> <span class="p">});</span>
<span class="err">按键</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="err">弹起时</span><span class="p">([]()</span> <span class="p">{</span> <span class="err">关灯</span><span class="p">;</span> <span class="p">});</span>
</code></pre></div></div>

<p>还可以合并起来考虑，当这个<strong>按键的状态改变时</strong>，<strong>如果按下了</strong>就<strong>开灯</strong>，<strong>否则关灯</strong>。
下面的代码与我们的思路一般无二：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">按键</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="err">的状态改变时</span><span class="p">([](</span><span class="err">变量</span> <span class="err">按下了</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">如果</span> <span class="p">(</span><span class="err">按下了</span><span class="p">)</span>
        <span class="err">开灯</span><span class="p">;</span>
    <span class="err">否则</span>
        <span class="err">关灯</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>再设计一个程序用按键调节彩灯亮度，当<strong>按键按下时</strong>，增加一点亮度，如果亮度超过 1.0，就把亮度回 0。
为了实现这个功能，需要有一个东西（<strong>静态 变量</strong>）来保存亮度，亮度会变化，所以是<strong>变量</strong>；
又由于某些原因（不妨理解为为了防止我们的<strong>第一个</strong>变量被动态丢弃），需要说它是<strong>静态</strong>的。
下面的代码又是跟我们的设想一一对应：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">静态</span> <span class="err">变量</span> <span class="err">亮度</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="err">按键</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="err">按下时</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
    <span class="err">亮度</span> <span class="o">=</span> <span class="err">亮度</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">;</span>
    <span class="err">如果</span> <span class="p">(</span><span class="err">亮度</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="err">亮度</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
    <span class="err">设置色饱亮</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="err">亮度</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="气象站">气象站</h2>

<p>开发板上的环境传感器可以感知温度、湿度和气压。Playground 当然可以向串口 <code class="highlighter-rouge">输出</code> 信息。两者结合，
就可以开发一个气象站小程序：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">重复</span><span class="p">(</span>
    <span class="err">输出</span><span class="p">(</span><span class="err">现在的温度</span><span class="p">);</span>
    <span class="err">输出</span><span class="p">(</span><span class="err">现在的湿度</span><span class="p">);</span>
    <span class="err">输出</span><span class="p">(</span><span class="err">现在的气压</span><span class="p">);</span>
    <span class="err">$</span><span class="p">(</span><span class="err">休息</span> <span class="mi">1</span> <span class="err">秒</span><span class="p">);</span>
<span class="p">)</span>
</code></pre></div></div>

<p>用串口工具连接到开发板串口，就可以看到气象数据。串口参数：波特率 115200，8 比特数据位，1 比特停止位，无校验。</p>

<div class="important">
<strong>注意：</strong>用串口工具连接到开发板串口之后，即使正常关闭了串口工具，更新开发板时仍可能出现错误。
重新插拔开发板可解决。
</div>

<h2 id="定时执行">定时执行</h2>

<p>从另一个角度考虑气象站小程序，我们是想每秒输出一次信息，是要<strong>定时执行</strong>一个动作。比如每 1000 毫秒<strong>闪一下</strong> 0
号灯。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">定时执行</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="err">灯</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="err">闪一下</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="流水灯">流水灯</h2>

<p>现在设计一个流水灯：让 8 个灯按顺序亮起，仿佛一个亮点在开发板上流动。每个时刻（比如 50 毫秒）只有一个<strong>要亮的灯</strong>。
到下一个时刻：如果<strong>要亮的灯</strong>小于 7，就把<strong>要亮的灯</strong>加 1 切换到下一个，否则说明已经是最后一个灯了，于是回到第 0 号灯。
根据<strong>要亮的灯</strong>去<strong>控制各灯</strong>：序号正好是<strong>要亮的灯</strong>的那个要点亮，其它的熄灭。重新排版这段话，就得到如下代码：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">静态</span> <span class="err">变量</span> <span class="err">要亮的灯</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="err">定时执行</span><span class="p">([</span><span class="o">&amp;</span><span class="p">]()</span> <span class="p">{</span>
    <span class="err">如果</span> <span class="p">(</span><span class="err">要亮的灯</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
        <span class="err">要亮的灯</span> <span class="o">=</span> <span class="err">要亮的灯</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="err">否则</span>
        <span class="err">要亮的灯</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="err">控制各灯</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="err">变量</span> <span class="err">灯序号</span><span class="p">)</span> <span class="p">{</span>
        <span class="err">如果</span> <span class="p">(</span><span class="err">灯序号</span> <span class="err">等于</span> <span class="err">要亮的灯</span><span class="p">)</span>
            <span class="err">返回</span> <span class="err">灯</span><span class="o">::</span><span class="err">亮</span><span class="p">;</span>
        <span class="err">否则</span>
            <span class="err">返回</span> <span class="err">灯</span><span class="o">::</span><span class="err">灭</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="多任务多线程">多任务/多线程</h2>

<p>Playground 里可以<strong>创建新线程</strong>：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">创建新线程</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="err">一直</span><span class="p">(</span>
        <span class="err">设置色饱亮</span><span class="p">(</span><span class="err">读取电压</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
        <span class="err">$</span><span class="p">(</span><span class="err">暂停</span> <span class="mi">30</span> <span class="err">毫秒</span><span class="p">);</span>
    <span class="p">)</span>
<span class="p">});</span>
<span class="err">创建新线程</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="err">一直</span><span class="p">(</span>
        <span class="err">灯</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="err">闪一下</span><span class="p">;</span>
        <span class="err">$</span><span class="p">(</span><span class="err">暂停</span> <span class="mi">30</span> <span class="err">毫秒</span><span class="p">);</span>
    <span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="霹雳游侠流水灯">霹雳游侠流水灯</h2>

<p>上面的流水灯走到末尾时就跳回 0 号灯重新开始，是单向流动。现在加大难度：当流动到末尾时，掉转船头，反向流动。
于是，除了<strong>要亮的灯</strong>，还需要记录<strong>流动方向</strong>。下面的代码在一个新的线程里实现了这种“霹雳游侠流水灯”：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">创建新线程</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="err">变量</span> <span class="err">要亮的灯</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="err">变量</span> <span class="err">流动方向</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="err">重复</span><span class="p">(</span>
        <span class="err">要亮的灯</span> <span class="o">+=</span> <span class="err">流动方向</span><span class="p">;</span>
        <span class="err">如果</span> <span class="p">((</span><span class="err">要亮的灯</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="err">或者</span> <span class="p">(</span><span class="err">要亮的灯</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="err">流动方向</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="err">要亮的灯</span> <span class="o">+=</span> <span class="err">流动方向</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">控制各灯</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="err">变量</span> <span class="err">灯序号</span><span class="p">)</span> <span class="p">{</span> <span class="err">返回</span> <span class="err">灯序号</span> <span class="err">等于</span> <span class="err">要亮的灯</span><span class="p">;</span> <span class="p">});</span>
        <span class="err">$</span><span class="p">(</span><span class="err">等待</span> <span class="mi">50</span> <span class="err">毫秒</span><span class="p">);</span>
    <span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div>

<p>请注意，这里<strong>控制各灯</strong>的写法有所简化。</p>

<h2 id="高度指示灯">高度指示灯</h2>

<p>现在来开发一个具有一定实际功能的例子，高度指示灯：用亮灯数目表示开发板被举起的高度。
通常情况下（20 摄氏度、1 个标准大气压），空气密度取$1.205kg/m^3$，也就是说，在较小范围内，
每升高 10cm，气压下降大约 1 帕斯卡。几十厘米的升降很容易实现，所以可以每下降 1 帕斯卡就多点亮 1 个灯。
程序的思路如下：</p>

<ol>
  <li>开机后，记录<strong>现在的气压</strong>，做为<strong>基准气压</strong></li>
  <li>重复一下步骤：
    <ol>
      <li>计算<strong>基准气压</strong>与<strong>现在的气压</strong>之间的<strong>气压差</strong>;</li>
      <li>点亮从 0 号开始的一串灯，这串灯的灯序号小于等于<strong>气压差</strong>。</li>
    </ol>
  </li>
</ol>

<p>转换为程序：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="p">(</span><span class="err">稍等，传感器现在还不稳定</span><span class="p">);</span>
<span class="err">变量</span> <span class="err">基准气压</span> <span class="o">=</span> <span class="err">现在的气压</span><span class="p">;</span>
<span class="err">重复</span><span class="p">(</span>
    <span class="err">变量</span> <span class="err">气压差</span> <span class="o">=</span> <span class="err">基准气压</span> <span class="o">-</span> <span class="err">现在的气压</span><span class="p">;</span>
    <span class="err">控制各灯</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="err">变量</span> <span class="err">灯序号</span><span class="p">)</span> <span class="p">{</span> <span class="err">返回</span> <span class="err">灯序号</span> <span class="err">小于等于</span> <span class="err">气压差</span><span class="p">;</span> <span class="p">});</span>
<span class="p">)</span>
</code></pre></div></div>

<p>更新到开发板之后，缓缓举起开发板，看看预想的功能是否得以实现。</p>

<h2 id="保持稳定">保持稳定</h2>

<p>开关板上带有一个 3 轴加速度传感器，可以感知如图所示 X/Y/Z 三个轴向上的加速度，其中 Z 轴为垂直向下。将开发板平放，
Z 轴上的加速度分量大小等于重力加速度。在机体坐标系里，绕 X、Y、Z 三个轴的旋转角度分别称为横滚角（roll）、俯仰角（pitch）、偏航角（yaw）。
保持开发板静止，根据重力加速度在三个轴上的分量可以推算出横滚角和俯仰角。</p>

<p><img src="../img/board_pitch.png" alt="" /></p>

<p>现在使用俯仰角开发一个体感小游戏，目标：保持开发板水平静止。实现思路如下：</p>

<ol>
  <li>将<strong>现在的俯仰角</strong>转换为<strong>亮灯个数</strong>；</li>
  <li>如果<strong>亮灯个数</strong>为 0，说明为水平状态，彩灯亮红色鼓励；否则熄灭彩灯；</li>
  <li>如果角度为正数，说明机头上仰，从第 3 个开始向左逐个点亮 LED 灯；</li>
  <li>如果角度为负数，说明机头下沉，从第 4 个开始向右逐个点亮 LED 灯；</li>
  <li>每 50 毫秒重复执行上述步骤。</li>
</ol>

<p>使用<strong>灵敏度</strong>参数控制俯仰角向亮灯个数的转换：灵敏度越低，对角度越不敏感，游戏难度越低；反之越难。完整代码如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">定时执行</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="err">变量</span> <span class="err">灵敏度</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="err">变量</span> <span class="err">亮灯个数</span> <span class="o">=</span> <span class="p">(</span><span class="err">整数</span><span class="p">)(</span><span class="err">现在的俯仰角</span> <span class="o">*</span> <span class="err">灵敏度</span><span class="p">);</span>
    <span class="err">如果</span> <span class="p">(</span><span class="err">亮灯个数</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="err">设置红绿蓝</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="err">关灯</span><span class="p">;</span>
    <span class="p">}</span> <span class="err">否则</span> <span class="p">{</span>
        <span class="err">设置红绿蓝</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="err">控制各灯</span><span class="p">([</span><span class="o">=</span><span class="p">](</span><span class="err">变量</span> <span class="err">序号</span><span class="p">)</span> <span class="p">{</span>
            <span class="err">如果</span> <span class="p">(</span><span class="err">亮灯个数</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="err">返回</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="err">亮灯个数</span> <span class="o">&lt;=</span> <span class="err">序号</span><span class="p">)</span> <span class="err">并且</span> <span class="p">(</span><span class="err">序号</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">);</span>
            <span class="err">否则</span>
                <span class="err">返回</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;=</span> <span class="err">序号</span><span class="p">)</span> <span class="err">并且</span> <span class="p">(</span><span class="err">序号</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="o">-</span> <span class="err">亮灯个数</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>灵敏度</strong>取 0.5，表示大概每偏 2 度多亮 1 个灯，难度适中。</p>

<h2 id="蓝牙">蓝牙</h2>

<p>当然，一款蓝牙芯片肯定可以<strong>设置蓝牙名称</strong>：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">设置蓝牙名称</span><span class="p">(</span><span class="s">"我的蓝牙"</span><span class="p">);</span>
</code></pre></div></div>

<p>更新开发板之后，使用蓝牙工具（ING BLE、LightBlue、nRF Connect 等）可以看到名为“我的蓝牙”的设备。</p>

<h2 id="蓝牙服务">蓝牙服务</h2>

<p>蓝牙 Profile 完整描述了蓝牙设备“是什么东西”。一个 Profile 包含若干个服务，一个服务包含若干个特征。
无论服务还是特征，都有一个编号。蓝牙组织定义了一些通用的编号，根据编号按图索骥就知道了设备的功能，
比如 AAAA 表示体温计，BBBB 表示人机接口设备（键盘、鼠标等）。也可以自定义编号，
当然，这些编号所对应的功能“外人”是不知道的。</p>

<p>下面我们自定义一个编号为“111…”的服务，里面包含一个编号为“222…”特征。
每当这个特征被写入数据时，就去开关灯。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">设置蓝牙名称</span><span class="p">(</span><span class="s">"我的蓝牙"</span><span class="p">);</span>
<span class="err">定义服务</span><span class="p">(</span><span class="s">"11111111"</span><span class="p">);</span>
<span class="err">定义服务特征</span><span class="p">(</span><span class="s">"22222222"</span><span class="p">,</span> <span class="p">[](</span><span class="err">变量</span><span class="p">,</span> <span class="err">变量</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="p">(</span><span class="err">开关灯</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>更新开发板之后，用蓝牙工具（ING BLE、LightBlue、nRF Connect 等）连接到“我的蓝牙”这个设备，向
“222…”这个特征多次写入任意数值，可观察到灯在亮灭交替。</p>

<p>可以响应写入的数值，比如下面的例子：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">设置蓝牙名称</span><span class="p">(</span><span class="s">"我的蓝牙"</span><span class="p">);</span>
<span class="err">定义服务</span><span class="p">(</span><span class="s">"11111111"</span><span class="p">);</span>
<span class="err">定义服务特征</span><span class="p">(</span><span class="s">"22222222"</span><span class="p">,</span> <span class="p">[](</span><span class="err">变量</span> <span class="err">指令</span><span class="p">,</span> <span class="err">变量</span> <span class="err">长度</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">执行</span><span class="p">(</span><span class="err">指令</span><span class="p">,</span> <span class="err">长度</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>这时我们只能使用 nRF Connect 工具（感谢友商），向“222..”写入中文句子，看看会发生什么。</p>

<p><img src="../img/ble_service_cmd.png" alt="cmd" /></p>

<p>一个完整的自定义编号长度为 16 字节，从图中看出后面的数字不是我们指定的，这是有意为之：只要前面的几个数字容易辨认、区分即可，
其它数字无所谓。</p>

<p>下面的例子演示了如何从外部读取特征的数值。我们把数据的长度定为 2，第 1 个数值为摄氏温度的整数部分，第 2 个数值为随机数。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">设置蓝牙名称</span><span class="p">(</span><span class="s">"我的蓝牙"</span><span class="p">);</span>
    <span class="err">定义服务</span><span class="p">(</span><span class="s">"11111111"</span><span class="p">);</span>
    <span class="err">定义服务特征</span><span class="p">(</span><span class="s">"33333333"</span><span class="p">,</span>
        <span class="p">[]()</span> <span class="p">{</span> <span class="err">返回</span> <span class="mi">2</span><span class="p">;</span> <span class="p">},</span>
        <span class="p">[](</span><span class="err">变量</span> <span class="err">数据</span><span class="p">,</span> <span class="err">变量</span> <span class="err">长度</span><span class="p">)</span> <span class="p">{</span>
            <span class="err">数据</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="err">整数</span><span class="p">)</span><span class="err">现在的温度</span><span class="p">;</span>
            <span class="err">数据</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="err">随机数</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">);</span>
</code></pre></div></div>

<p>使用蓝牙工具连接到“我的蓝牙”这个设备，多次读取“333…”这个特征，可观察到这两个值：</p>

<p><img src="../img/read_char_333.jpg" alt="" /></p>

<p>图中的温度值“15”为 16 进制，等于十进制的 21。</p>

<h2 id="使用英语">使用英语</h2>

<p>上面的演示代码都是用中文编写，可能略感“违和”。Playground 里同样可以使用英语编程，<code class="highlighter-rouge">demo/en.md</code>
为以上演示代码的英语版本。</p>

      </div><!-- .post-content -->
    </div><!-- .inner-md -->
  </article><!-- .post -->

  <!-- Next/previous post navigation TBD -->
  <!--
  <div class="inner-md outer">
    <nav class="read-next">
      <h2 class="read-next-title line-left">Read Next</h2>
      <div class="nav-links">
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Previous post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Previous Post Title</a></h3>
        </article>
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Next post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Next Post Title</a></h3>
        </article>
      </div>
    </nav>
  </div>
  -->

  </main><!-- .site-content -->
  <footer id="colophon" class="site-footer outer">
  <div class="inner">
    <div class="site-footer-inside">
      <p class="site-info">
        
        
        <span class="copyright">&copy; INGCHIPS 2021-2022. All rights reserved.</span>
        
        
          
          
<a class="" href="https://www.stackbit.com" target="_blank" rel="noopener">
  
  Made with Stackbit
  
</a>

        
      </p><!-- .site-info -->
      
      
      <div class="social-links">
        
          
          
<a class="button button-icon" href="https://github.com/ingchips" target="_blank" rel="noopener">
  
  <span class="icon fab fa-github" aria-hidden="true"></span><span class="screen-reader-text">GitHub</span>
  
</a>

        
      </div><!-- .social-links -->
      
    </div><!-- .site-footer-inside -->
  </div><!-- .inner -->
</footer><!-- .site-footer -->

</div><!-- .site -->

        <!-- Scripts -->
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/prism.js" data-manual></script>
        <script src="/assets/js/main.js"></script>
    </body>
</html>
