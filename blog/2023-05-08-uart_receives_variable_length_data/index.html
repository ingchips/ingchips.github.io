<!doctype html>
<html lang="en">
    <head>

        <title>UART接收变长字节数据 - INGCHIPS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="在嵌入式系统领域，尤其是涉及到串口通信时，通常需要考虑UART接收不定长字节数据。在这篇博客中，我们将主要探讨两种桃芯可实现UART接收变长字节数据的方法：UART+FIFO+DMA方式和UART+FIFO方式。"/>
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    </head>
    <body
        <div id="page" class="site">
  <header id="masthead" class="site-header outer">

  <div class="inner">
    <div class="site-header-inside">
      <div class="site-branding">
        
        
        <p class="site-logo"><a href="/"><img src="/images/logo_en.jpg" alt="INGCHIPS" /></a></p>
        
      </div><!-- .site-branding -->

      <div id="box">
        <input id="in_search" type="search" name="search" placeholder="搜索：输入并回车">
      </div>

      <script>
        let search_input = document.getElementById('in_search');
        if (search_input) {
          search_input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            window.open('https://www.bing.com/search?q=' + encodeURIComponent(search_input.value) + '%20site%3A' + window.location.hostname);
            event.preventDefault();
            }
          });
        }
      </script>

      
      
      <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
        <div class="site-nav-inside">
          <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-close" aria-hidden="true"></span></button>
          <ul class="menu">
            
            <li class="menu-item">

              
<a class="" href="/">
  
  Home
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/products">
  
  产品
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/sdk">
  
  SDK
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/">
  
  文档
  
</a>

              
            </li>
            
            <li class="menu-item has-children">

              
<a class="" href="/docs/sdk/apps/#web-apps">
  
  Web 工具
  
</a>

              

                <ul class="submenu">
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/callgraph">
  
  Callgraph (调用图)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index_cn.html">
  
  ING918/ING916 FOTA (空中升级)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/powerprofiler/">
  
  Online Power Profiler
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/air_trace/">
  
  Trace Logger
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/assertion_tool/index.html">
  
  ING918/ING916 Assertion Tool
  
</a>

  </li>
  
</ul>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/blog/">
  
  Blog
  
</a>

              
            </li>
            
            <li class="menu-item menu-button">

              
<a class="button" href="https://github.com/ingchips">
  
  GitHub
  
</a>

              
            </li>
            
          </ul>
        </div><!-- .site-nav-inside -->
      </nav><!-- .site-navigation -->
      <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
      
    </div><!-- .site-header-inside -->
  </div><!-- .inner -->
</header><!-- .site-header -->

  <main id="content" class="site-content">
      <article class="post post-full">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        }
      });
    </script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <header class="post-header has-gradient outer">
      
      
      <div class="inner-sm">
        <div class="post-meta">
          <time class="published" datetime="2023-05-08 00:00">May 08, 2023</time>
        </div>
        <h1 class="post-title">UART接收变长字节数据</h1>
        
        
      </div>
    </header>
    <div class="inner-md outer">
      <div class="post-content">
        <ul id="markdown-toc">
  <li><a href="#uart接收变长字节数据的使用场景及优势" id="markdown-toc-uart接收变长字节数据的使用场景及优势">UART接收变长字节数据的使用场景及优势</a></li>
  <li><a href="#uart接收变长字节数据的实现方式" id="markdown-toc-uart接收变长字节数据的实现方式">UART接收变长字节数据的实现方式</a></li>
  <li><a href="#桃芯可实现方案" id="markdown-toc-桃芯可实现方案">桃芯可实现方案</a>    <ul>
      <li><a href="#uartfifodma方式针对ing916系列" id="markdown-toc-uartfifodma方式针对ing916系列">UART+FIFO+DMA方式（针对ING916系列）</a>        <ul>
          <li><a href="#示例代码" id="markdown-toc-示例代码">示例代码</a></li>
        </ul>
      </li>
      <li><a href="#uartfifo方式针对ing918系列" id="markdown-toc-uartfifo方式针对ing918系列">UART+FIFO方式（针对ING918系列）</a>        <ul>
          <li><a href="#示例代码-1" id="markdown-toc-示例代码-1">示例代码</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#总结" id="markdown-toc-总结">总结</a></li>
</ul>

<p>在嵌入式系统领域，尤其是涉及到串口通信时，通常需要考虑UART接收不定长字节数据。在这篇博客中，我们将主要探讨两种<strong>桃芯可实现</strong>UART接收变长字节数据的方法：<em>UART+FIFO+DMA方式</em>和<em>UART+FIFO方式</em>。</p>

<p>我们将首先讨论UART接收变长字节数据的使用场景及优势，接着深入了解这两种方法的使用及需要注意的细节。</p>

<h2 id="uart接收变长字节数据的使用场景及优势">UART接收变长字节数据的使用场景及优势</h2>

<p>UART（通用异步收发器）是一种广泛应用于嵌入式系统的串行通信接口。在实际应用中，UART接收变长字节数据的场景很常见，如 <strong>传感器数据采集</strong> 、 <strong>控制指令的传输</strong> 等。这种场景的一个显著特点是 <strong>数据长度不固定</strong> ，可能会在不同的通信过程中发生变化。在这种情况下，使用UART接收变长字节数据具有以下优势：</p>

<ol>
  <li><strong>灵活性</strong>：可以根据实际需要动态调整接收数据的长度，适应不同场景的需求。</li>
  <li><strong>节省资源</strong>：只需要接收实际需要的数据，避免了接收固定长度数据时可能产生的资源浪费。</li>
  <li><strong>提高通信效率</strong>：变长字节数据可以根据实际数据量进行发送，减少了通信过程中的空闲时间，提高了通信效率。</li>
</ol>

<h2 id="uart接收变长字节数据的实现方式">UART接收变长字节数据的实现方式</h2>

<ul>
  <li>UART单字节中断接收</li>
  <li>UART+FIFO方式</li>
  <li>UART+DMA方式</li>
</ul>

<h2 id="桃芯可实现方案">桃芯可实现方案</h2>

<h3 id="uartfifodma方式针对ing916系列">UART+FIFO+DMA方式（针对ING916系列）</h3>

<p>UART+FIFO+DMA方式是通过使用DMA（直接存储器访问）控制器并结合UART模块内部的FIFO实现UART接收变长字节数据的方法。DMA控制器可以在不占用CPU资源的前提下，将接收到的数据直接传输到指定的内存地址。这种方式具有以下特点：</p>

<ol>
  <li><strong>实时性</strong>：DMA控制器可以实时监控UART接收缓冲区，一旦检测到数据接收完成，就立即进行数据传输，确保数据的实时性。</li>
  <li><strong>减轻CPU负担</strong>：借助DMA控制器，CPU无需参与数据传输过程，可以专注于执行其他任务。</li>
  <li><strong>高效性</strong>：DMA控制器可以在接收数据的同时进行数据传输，提高了系统的整体效率。</li>
  <li><strong>可靠性</strong>：传输过程之中CPU干预的次数降低，提高系统响应的速度，大大减少了传输过程中出错的概率。</li>
  <li><strong>降低低功耗</strong>：中断次数显著减少，MCU有更多的时间可以进入睡眠状态，大大地降低了功耗。</li>
</ol>

<p><strong>使用注意事项：</strong>
配置DMA控制器时，需要注意设置合适的传输数据长度以及目标内存地址，以确保数据正确传输。
使用UART+FIFO+DMA方式时，需要根据实际需要配置UART接收触发的条件，例如数据帧间隔时间、接收缓冲区数据量等。</p>

<h4 id="示例代码">示例代码</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define bsDMA_INT_C_MASK         1    
#define bsDMA_DST_REQ_SEL        4
#define bsDMA_SRC_REQ_SEL        8
#define bsDMA_DST_ADDR_CTRL      12
#define bsDMA_SRC_ADDR_CTRL      14
#define bsDMA_DST_MODE           16
#define bsDMA_SRC_MODE           17
#define bsDMA_DST_WIDTH          18
#define bsDMA_SRC_WIDTH          21
#define bsDMA_SRC_BURST_SIZE     24
</span>
<span class="cp">#define DMA_RX_CHANNEL_ID  1
#define DMA_TX_CHANNEL_ID  0
</span>
<span class="n">DMA_Descriptor</span> <span class="n">test</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">8</span><span class="p">)));</span>
<span class="kt">char</span> <span class="n">dst</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">src</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Finished to receive a frame!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup_peripheral_dma</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"setup_peripheral_dma</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">SYSCTRL_ClearClkGate</span><span class="p">(</span><span class="n">SYSCTRL_ITEM_APB_DMA</span><span class="p">);</span> 

    <span class="c1">//配置DMA接收</span>
    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">Ctrl</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_INT_C_MASK</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span><span class="n">bsDMA_DST_REQ_SEL</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_SRC_REQ_SEL</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_DST_ADDR_CTRL</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_SRC_ADDR_CTRL</span><span class="p">)</span>   <span class="c1">//DMA_ADDRESS_FIXED</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_DST_MODE</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_SRC_MODE</span><span class="p">)</span>     <span class="c1">//</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_DST_WIDTH</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_SRC_WIDTH</span><span class="p">)</span>
                                            <span class="o">|</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">bsDMA_SRC_BURST_SIZE</span><span class="p">);</span> <span class="c1">//4 transefers</span>

    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">SrcAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">DataRead</span><span class="p">;</span>
    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">DstAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">TranSize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>

    <span class="n">DMA_EnableChannel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//添加UART通过DMA发送的配置</span>
<span class="kt">void</span> <span class="nf">UART_trigger_DmaSend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span> 
    <span class="n">DMA_PrepareMem2Peripheral</span><span class="p">(</span>  <span class="o">&amp;</span><span class="n">test</span><span class="p">,</span>
                                <span class="n">SYSCTRL_DMA_UART0_TX</span><span class="p">,</span>
                                <span class="n">src</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">src</span><span class="p">),</span>
                                <span class="n">DMA_ADDRESS_INC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">DMA_EnableChannel</span><span class="p">(</span><span class="n">DMA_TX_CHANNEL_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">test</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup_peripheral_uart</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">FifoSelect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANS_INT_LEVEL</span> <span class="p">)</span> <span class="o">|</span>
                    <span class="p">(</span><span class="mh">0X7</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECV_INT_LEVEL</span>  <span class="p">)</span> <span class="p">;</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntMask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECEIVE_INTENAB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANSMIT_INTENAB</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TIMEOUT_INTENAB</span><span class="p">);</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECEIVE_ENABLE</span> <span class="o">|</span>
                <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANSMIT_ENABLE</span> <span class="o">|</span>
                <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_ENABLE</span>          <span class="o">|</span>
                <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_CTS_ENA</span>         <span class="o">|</span>
                <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RTS_ENA</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">uart_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"@%x #%x #%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span><span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntRaw</span><span class="p">,</span><span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">Interrupt</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">apUART_Get_all_raw_int_stat</span><span class="p">(</span><span class="n">APB_UART0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntClear</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

        <span class="c1">// rx timeout_int</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TIMEOUT_INTENAB</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">apUART_Check_RXFIFO_EMPTY</span><span class="p">(</span><span class="n">APB_UART0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">DataRead</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">DstAddr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
                <span class="n">dst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">DstAddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">dst</span><span class="p">;</span>
                    <span class="n">UART_trigger_DmaSend</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">DstAddr</span><span class="o">++</span><span class="p">;</span>

                <span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">TranSize</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">len=%d, dst = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">APB_DMA</span><span class="o">-&gt;</span><span class="n">Channels</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Descriptor</span><span class="p">.</span><span class="n">TranSize</span><span class="p">,</span><span class="n">dst</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">uart_peripherals_read_data</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//注册uart0中断</span>
    <span class="n">platform_set_irq_callback</span><span class="p">(</span><span class="n">PLATFORM_CB_IRQ_UART0</span><span class="p">,</span> <span class="n">uart_isr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setup_peripheral_uart</span><span class="p">();</span>
    <span class="n">setup_peripheral_dma</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="uartfifo方式针对ing918系列">UART+FIFO方式（针对ING918系列）</h3>

<p>UART+FIFO方式是仅依赖于UART模块内部的FIFO（先进先出）缓冲区实现接收变长字节数据的方法。在这种方式下，CPU需要定期检查UART接收缓冲区并读取数据。</p>

<p><strong>优势：</strong></p>

<ol>
  <li><strong>简单性</strong>：不需要额外的硬件资源（如DMA控制器），配置较为简单。</li>
  <li><strong>灵活性</strong>：可以根据实际需要动态调整CPU读取UART接收缓冲区的频率，以适应不同场景的需求。</li>
</ol>

<p><strong>劣势：</strong></p>

<ol>
  <li><strong>功耗</strong>：每当接收的数据达到<code class="highlighter-rouge">RXIFLSEL</code>时，就需要唤醒一次MCU，相对于使用DMA的方式而言，耗费了更多的资源，增加了系统功耗。</li>
</ol>

<p><strong>使用注意事项：</strong></p>

<p>使用UART+FIFO方式时，需要合理配置UART接收触发的条件，以确保数据的实时性与准确性。
CPU需要定期检查UART接收缓冲区并读取数据，这可能会占用一定的CPU资源。因此，在资源有限的情况下，需要权衡CPU资源分配。</p>

<h4 id="示例代码-1">示例代码</h4>

<p>假设完整的一帧数据长度为<code class="highlighter-rouge">256</code>字节，将<code class="highlighter-rouge">RXIFLSEL</code>设置为<code class="highlighter-rouge">16</code>，参考代码如下所示。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="n">dst</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">setup_peripheral_uart</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">FifoSelect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANS_INT_LEVEL</span> <span class="p">)</span> <span class="o">|</span>
                    <span class="p">(</span><span class="mh">0X10</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECV_INT_LEVEL</span>  <span class="p">)</span> <span class="p">;</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntMask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECEIVE_INTENAB</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANSMIT_INTENAB</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TIMEOUT_INTENAB</span><span class="p">);</span>
    <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECEIVE_ENABLE</span> <span class="o">|</span>
                <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TRANSMIT_ENABLE</span> <span class="o">|</span>
                <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_ENABLE</span>          <span class="o">|</span>
                <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_CTS_ENA</span>         <span class="o">|</span>
                <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RTS_ENA</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">uart_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">apUART_Get_all_raw_int_stat</span><span class="p">(</span><span class="n">APB_UART0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">IntClear</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

        <span class="c1">// rx int</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_RECEIVE_INTENAB</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">apUART_Check_RXFIFO_EMPTY</span><span class="p">(</span><span class="n">APB_UART0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">DataRead</span><span class="p">;</span>
                <span class="n">dst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
                <span class="n">index</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// rx timeout_int</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bsUART_TIMEOUT_INTENAB</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">apUART_Check_RXFIFO_EMPTY</span><span class="p">(</span><span class="n">APB_UART0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">APB_UART0</span><span class="o">-&gt;</span><span class="n">DataRead</span><span class="p">;</span>
                <span class="n">dst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
                <span class="n">index</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">dst = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">dst</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">uart_peripherals_read_data</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//注册uart0中断</span>
    <span class="n">platform_set_irq_callback</span><span class="p">(</span><span class="n">PLATFORM_CB_IRQ_UART0</span><span class="p">,</span> <span class="n">uart_isr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setup_peripheral_uart</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>

<p>总之，UART接收变长字节数据在嵌入式系统中具有广泛的应用场景，具有很高的<strong>灵活性</strong>和<strong>通信效率</strong>。通过比较<em>UART+DMA方式</em>、<em>UART+FIFO方式</em>以及<em>UART+FIFO+DMA</em>方式，我们可以选择适合自己项目需求的实现方法。在实际应用中，需要根据实际情况权衡各种因素，如实时性、CPU负担、硬件资源等，从而选择最合适的UART接收变长字节数据的实现方式。</p>


      </div><!-- .post-content -->
    </div><!-- .inner-md -->
  </article><!-- .post -->

  <!-- Next/previous post navigation TBD -->
  <!--
  <div class="inner-md outer">
    <nav class="read-next">
      <h2 class="read-next-title line-left">Read Next</h2>
      <div class="nav-links">
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Previous post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Previous Post Title</a></h3>
        </article>
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Next post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Next Post Title</a></h3>
        </article>
      </div>
    </nav>
  </div>
  -->

  </main><!-- .site-content -->
  <footer id="colophon" class="site-footer outer">
  <div class="inner">
    <div class="site-footer-inside">
      <p class="site-info">
        
        
        <span class="copyright">&copy; INGCHIPS 2021-2023. All rights reserved.</span>
        
        
          
          
<a class="" href="https://www.stackbit.com" target="_blank" rel="noopener">
  
  Made with Stackbit
  
</a>

        
      </p><!-- .site-info -->
      
      
      <div class="social-links">
        
          
          
<a class="button button-icon" href="https://github.com/ingchips" target="_blank" rel="noopener">
  
  <span class="icon fab fa-github" aria-hidden="true"></span><span class="screen-reader-text">GitHub</span>
  
</a>

        
      </div><!-- .social-links -->
      
    </div><!-- .site-footer-inside -->
  </div><!-- .inner -->
</footer><!-- .site-footer -->

</div><!-- .site -->

        <!-- Scripts -->
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/prism.js" data-manual></script>
        <script src="/assets/js/main.js"></script>
    </body>
</html>
