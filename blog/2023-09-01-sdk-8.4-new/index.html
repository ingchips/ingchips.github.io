<!doctype html>
<html lang="en">
    <head>

        <title>SDK 8.4 更新说明 - INGCHIPS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="总结 SDK 8.4 新功能。"/>
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    </head>
    <body
        <div id="page" class="site">
  <header id="masthead" class="site-header outer">

  <div class="inner">
    <div class="site-header-inside">
      <div class="site-branding">
        
        
        <p class="site-logo"><a href="/"><img src="/images/logo_en.jpg" alt="INGCHIPS" /></a></p>
        
      </div><!-- .site-branding -->

      <div id="box">
        <input id="in_search" type="search" name="search" placeholder="搜索：输入并回车">
      </div>

      <script>
        let search_input = document.getElementById('in_search');
        if (search_input) {
          search_input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            window.open('https://www.bing.com/search?q=' + encodeURIComponent(search_input.value) + '%20site%3A' + window.location.hostname);
            event.preventDefault();
            }
          });
        }
      </script>

      
      
      <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
        <div class="site-nav-inside">
          <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-close" aria-hidden="true"></span></button>
          <ul class="menu">
            
            <li class="menu-item">

              
<a class="" href="/">
  
  Home
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/products">
  
  产品
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/sdk">
  
  SDK
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/">
  
  文档
  
</a>

              
            </li>
            
            <li class="menu-item has-children">

              
<a class="" href="/docs/sdk/apps/#web-apps">
  
  Web 工具
  
</a>

              

                <ul class="submenu">
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/callgraph">
  
  Callgraph (调用图)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index_cn.html">
  
  ING918/ING916 FOTA (空中升级)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/powerprofiler/">
  
  Online Power Profiler
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/air_trace/">
  
  Trace Logger
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/assertion_tool/index.html">
  
  ING918/ING916 Assertion Tool
  
</a>

  </li>
  
</ul>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/blog/">
  
  Blog
  
</a>

              
            </li>
            
            <li class="menu-item menu-button">

              
<a class="button" href="https://github.com/ingchips">
  
  GitHub
  
</a>

              
            </li>
            
          </ul>
        </div><!-- .site-nav-inside -->
      </nav><!-- .site-navigation -->
      <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
      
    </div><!-- .site-header-inside -->
  </div><!-- .inner -->
</header><!-- .site-header -->

  <main id="content" class="site-content">
      <article class="post post-full">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
        }
      });
    </script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <header class="post-header has-gradient outer">
      
      
      <div class="inner-sm">
        <div class="post-meta">
          <time class="published" datetime="2023-09-01 00:00">September 01, 2023</time>
        </div>
        <h1 class="post-title">SDK 8.4 更新说明</h1>
        
        
      </div>
    </header>
    <div class="inner-md outer">
      <div class="post-content">
        <ul id="markdown-toc">
  <li><a href="#v843" id="markdown-toc-v843">v8.4.3</a>    <ul>
      <li><a href="#1-软件包" id="markdown-toc-1-软件包">1. 软件包</a></li>
      <li><a href="#2-外设驱动" id="markdown-toc-2-外设驱动">2. 外设驱动</a></li>
      <li><a href="#3-示例" id="markdown-toc-3-示例">3. 示例</a></li>
      <li><a href="#4-工具" id="markdown-toc-4-工具">4. 工具</a></li>
    </ul>
  </li>
  <li><a href="#v843-1" id="markdown-toc-v843-1">v8.4.3</a>    <ul>
      <li><a href="#1-软件包-1" id="markdown-toc-1-软件包-1">1. 软件包</a></li>
    </ul>
  </li>
  <li><a href="#v842" id="markdown-toc-v842">v8.4.2</a>    <ul>
      <li><a href="#1-软件包-2" id="markdown-toc-1-软件包-2">1. 软件包</a></li>
      <li><a href="#2-外设驱动-1" id="markdown-toc-2-外设驱动-1">2. 外设驱动</a></li>
    </ul>
  </li>
  <li><a href="#v841" id="markdown-toc-v841">v8.4.1</a>    <ul>
      <li><a href="#1-软件包-3" id="markdown-toc-1-软件包-3">1. 软件包</a></li>
      <li><a href="#2-外设驱动-2" id="markdown-toc-2-外设驱动-2">2. 外设驱动</a></li>
      <li><a href="#3-工具" id="markdown-toc-3-工具">3. 工具</a></li>
    </ul>
  </li>
  <li><a href="#v840" id="markdown-toc-v840">v8.4.0</a>    <ul>
      <li><a href="#1-软件包-4" id="markdown-toc-1-软件包-4">1. 软件包</a></li>
      <li><a href="#2-外设驱动-3" id="markdown-toc-2-外设驱动-3">2. 外设驱动</a></li>
      <li><a href="#3-示例-1" id="markdown-toc-3-示例-1">3. 示例</a></li>
      <li><a href="#4-工具-1" id="markdown-toc-4-工具-1">4. 工具</a></li>
    </ul>
  </li>
</ul>

<div class="important">
<strong>已知问题（局限性）:</strong>
<ul>
<li>ING916XX 使用内部 RC 为主时钟时，如果要使用省电模式，则 RC 频率暂时只能配置为 24MHz。
</li>
</ul></div>

<h2 id="v843">v8.4.3</h2>

<h3 id="1-软件包">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916: 优化省电性能</p>

    <p>每个工作周期电量修消耗降低 ~1μC （具体数值受频率等因素的影响）。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916: 同时允许 <code class="language-plaintext highlighter-rouge">BLE_ONLY_SLEEP</code> 和 <code class="language-plaintext highlighter-rouge">DEEP_SLEEP</code> 时频繁重启</p>
  </li>
</ul>

<h3 id="2-外设驱动">2. 外设驱动</h3>

<ul>
  <li>[<strong>修正</strong>] ING916: <code class="language-plaintext highlighter-rouge">PINCTRL_DisableAllInputs</code> 里的溢出问题</li>
</ul>

<h3 id="3-示例">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] Peripheral Console (…): 在 ING916 上允许 <code class="language-plaintext highlighter-rouge">BLE_ONLY_SLEEP</code></li>
</ul>

<h3 id="4-工具">4. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Cube</p>

    <p>修正了为 USB 生成的代码。现在允许一个数字管脚用作两种功能（GPIO 及另一种外设的输入），
  并给出警告。</p>
  </li>
</ul>

<h2 id="v843-1">v8.4.3</h2>

<h3 id="1-软件包-1">1. 软件包</h3>

<ul>
  <li>[<strong>修正</strong>] v8.4.1~v8.4.2 ING916 睡眠状态下底电流时大时小的问题 (涉及 <em>mini</em> 和 <em>noos_mini</em> 软件包)</li>
</ul>

<h2 id="v842">v8.4.2</h2>

<h3 id="1-软件包-2">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] v8.4.1 ING916 睡眠状态下底电流变大的问题 (涉及 <em>mini</em> 和 <em>noos_mini</em> 软件包)</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code></p>

    <p>现在，每次调用 <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code> 时，将调整下次的校准时间至 <code class="language-plaintext highlighter-rouge">PLATFORM_CFG_32K_CALI_PERIOD</code>
  之后。旧版本调用 <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code> 不会影响下次的校准时间。</p>
  </li>
</ul>

<h3 id="2-外设驱动-1">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] Sofware d/h/m/s RTC</p>

    <p>为 ING918xx 增加了一套基于 <code class="language-plaintext highlighter-rouge">platform_set_timer</code> 等 API 实现的天、时、分、秒计时器，
  接口与 ING916XX RTC 兼容。对于 ING916xx，可通过 <code class="language-plaintext highlighter-rouge">SOFTWARE_RTC_DHMS</code> 编译开关选择硬件方式或者软件方式。</p>

    <p>两种实现方式的区别：</p>

    <ol>
      <li>
        <p>对于软件方式，使用 <code class="language-plaintext highlighter-rouge">RTC_SoftSetISR</code> 设置“中断”处理函数，而非 <code class="language-plaintext highlighter-rouge">platform_set_irq_callback</code>；</p>
      </li>
      <li>
        <p>对于软件方式，除了 <code class="language-plaintext highlighter-rouge">RTC_SoftSetISR</code>， 所有 API 只在协议栈初始化之后（<code class="language-plaintext highlighter-rouge">PLATFORM_CB_EVT_PROFILE_INIT</code> 事件）方可使用；</p>
      </li>
      <li>
        <p>软件方式不需要调整（Trim），其精度由软件包内置周期性校准功能保证；</p>
      </li>
      <li>
        <p>软件方式下的“中断”实际就是 <code class="language-plaintext highlighter-rouge">platform_set_timer</code> 等的回调函数，“抖动”比硬件方式大。</p>
      </li>
    </ol>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: 提供更多的 GPIO 唤醒方式</p>

    <p>详见 <a href="https://ingchips.github.io/drafts/pg_ing916/ch-gpio.html#%E7%9D%A1%E7%9C%A0%E5%94%A4%E9%86%92%E6%BA%90">外设开发者手册-睡眠唤醒源</a>。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">RTC_Trim</code></p>

    <p><code class="language-plaintext highlighter-rouge">RTC_Trim</code> 实现了完整的 ING916xx RTC 数字调校功能。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: 更多的 KeyScan API</p>

    <p>增加了 Loop 中断、FIFO 相关的接口。</p>
  </li>
</ul>

<h2 id="v841">v8.4.1</h2>

<h3 id="1-软件包-3">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] Raw Package API: 当接收的数据包的数据长度为 0 时报错</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916: 将更多的代码移动到 RAM 以降低功耗 (限 <em>mini</em> 和 <em>noos_mini</em> 软件包)</p>

    <p>该更新针对空包维持连接状态优化了功耗。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] BLE 协议栈 API: <code class="language-plaintext highlighter-rouge">btstack_reset</code></p>

    <p>可完整复位协议栈。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] platform event: <code class="language-plaintext highlighter-rouge">PLATFORM_CB_EVT_HCI_RECV</code></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] platform API: <code class="language-plaintext highlighter-rouge">platform_get_link_layer_interf</code></p>

    <p>借助以上两个接口可完整暴露 Controller 的功能，为开发 BLE Dongle 带来可能。后续版本将提供示例。</p>
  </li>
</ul>

<h3 id="2-外设驱动-2">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] ING916xx: Flash 写保护接口 <code class="language-plaintext highlighter-rouge">flash_enable_write_protection</code></p>

    <p>通过此接口可将 ING916xx 内置的 Flash 的全部或者一部分置为写保护状态。再次向写保护区域写入数据时，需要先解除写保护。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: USB BPS 头文件中增加 <code class="language-plaintext highlighter-rouge">bsp_usb_disable</code></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">KEYSCAN_Initialize</code> 对 GPIO 上下拉的配置。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_SelectMemoryBlocks</code> 潜在的睡眠电流达 20uA 的问题</p>
  </li>
</ul>

<h3 id="3-工具">3. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Downloader: 为 ING916 增加 Flash 写保护选项。</p>

    <p><img src="../img/flash_write_protection.png" alt="" /></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916 Flash 下载算法</p>

    <p>更新后的 ING916 Flash 下载算法行为如下：</p>

    <ul>
      <li>开始下载时，解除写保护。</li>
    </ul>
  </li>
</ul>

<h2 id="v840">v8.4.0</h2>

<h3 id="1-软件包-4">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] SM：配对设备数量超出存储容量时不报错</p>

    <p>过去，当超出存储容量时，SM 模块仍会在 SM_EVENT_STATE_CHANGED 事件中报告 <code class="language-plaintext highlighter-rouge">SM_FINAL_PAIRED</code> 等成功信息；
  现在，SM 模块将在 SM_EVENT_STATE_CHANGED 事件中报告 <code class="language-plaintext highlighter-rouge">SM_FINAL_FAIL_OUT_OF_STORAGE</code>。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] Controller：使用可解析地址的定向广播时的兼容性</p>

    <p>当向可解析地址发送定向广播时，旧版本存在兼容性问题，导致无法与某些设备建立连接。现已修复。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 键值存储模块（kv_storage）现在允许自定义后端实现</p>

    <p>默认的 KV 后端在写入时通过 <code class="language-plaintext highlighter-rouge">f_kv_write_to_nvm</code> 回调一并写入所有数据。
  如果发现默认的 KV 实现方式不合适，可以在 <code class="language-plaintext highlighter-rouge">app_main</code> 里调用 <code class="language-plaintext highlighter-rouge">kv_init_backend</code>，传入自定义的后端接口。</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="nf">kv_init_backend</span><span class="p">(</span><span class="k">const</span> <span class="n">kv_backend_t</span> <span class="o">*</span><span class="n">backend</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>自定义后端带来了灵活性，比如利用 <code class="language-plaintext highlighter-rouge">kv_value_modified_of_key</code> 接口可实现小颗粒度（K-V 对）的精细化存储。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] Host：使用公共地址（public address）时无法配对</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">platform_switch_app</code> 功能异常</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: BLE_ONLY_SLEEP 睡眠模式的稳定性问题</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 提供更多的定时器接口</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">platform_get_timer_counter</code></li>
      <li><code class="language-plaintext highlighter-rouge">platform_set_abs_timer</code></li>
      <li><code class="language-plaintext highlighter-rouge">platform_delete_timer</code></li>
    </ul>

    <p>相比原来单一的 <code class="language-plaintext highlighter-rouge">platform_set_timer</code>，现在的接口可实现更多功能，比如准确模拟周期性定时器。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] GAP API：<code class="language-plaintext highlighter-rouge">gap_set_callback_for_next_hci</code></p>

    <p>具体用途将在后续版本中演示。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] SM API：<code class="language-plaintext highlighter-rouge">sm_register_external_ltk_callback</code></p>

    <p>一些 BLE 应用可能会以自定义的方式协商 LTK（比如 Find My）。通过此 API 注册回调，
  可将这种外部生成的 LTK 传递给 SM 层。</p>

    <div class="note">
  <strong>注意：</strong>此 API 处于实验阶段，后续版本可能修改。</div>
  </li>
  <li>
    <p>[<strong>新增</strong>] 链路层配置项：<code class="language-plaintext highlighter-rouge">LL_CFG_FEATURE_SET_MASK</code></p>

    <p>有时需要“模仿”其它 BLE 设备的链路层协议流程，而支持的特性对后续的链路层协议流程影响很大。
  为此增加了链路层特性掩码，方便开发者即时调整上报给对端设备的链路层特性。例如，模仿只支持加密和 2M PHY
  两种特性的设备：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">feature_mask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
  <span class="p">{</span>
      <span class="mh">0x01</span><span class="p">,</span>       <span class="c1">// 比特 0: LE Encryption</span>
      <span class="mh">0x01</span><span class="p">,</span>       <span class="c1">// 比特 8: LE 2M PHY</span>
  <span class="p">};</span>

  <span class="c1">//...</span>
  <span class="n">ll_config</span><span class="p">(</span><span class="n">LL_CFG_FEATURE_SET_MASK</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">feature_mask</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>注意，这里只是修改了 Feature Exchange 流程的上报值，对链路层的实际功能没有影响。</p>
  </li>
</ul>

<h3 id="2-外设驱动-3">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_EnableConfigClocksAfterWakeup</code> 与 Flash 读保护功能冲突</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_CacheControl</code> 无法配置 D-Cache 的问题</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">apSSP_DeviceParametersSet</code> 参数范围溢出时寄存器配置异常</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">ADC_GetVol</code> 遇到最大读数时返回值错误</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: ADC/PDM 的时钟分频范围</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916xx: 将 PLL 的输出分频并输出到指定的管脚</p>

    <p>新增了两个相关的接口：</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">SYSCTRL_EnableClockOutput</code></li>
      <li><code class="language-plaintext highlighter-rouge">PINCTRL_SelClockOutput</code></li>
    </ul>
  </li>
</ul>

<h3 id="3-示例-1">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">HID Keyboard</code>：演示里 <code class="language-plaintext highlighter-rouge">kv_init_backend</code> 的用法</li>
</ul>

<h3 id="4-工具-1">4. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] Cube: 修正了一些问题，增加 PLL 分频输出相关功能</li>
</ul>

      </div><!-- .post-content -->
    </div><!-- .inner-md -->
  </article><!-- .post -->

  <!-- Next/previous post navigation TBD -->
  <!--
  <div class="inner-md outer">
    <nav class="read-next">
      <h2 class="read-next-title line-left">Read Next</h2>
      <div class="nav-links">
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Previous post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Previous Post Title</a></h3>
        </article>
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Next post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Next Post Title</a></h3>
        </article>
      </div>
    </nav>
  </div>
  -->

  </main><!-- .site-content -->
  <footer id="colophon" class="site-footer outer">
  <div class="inner">
    <div class="site-footer-inside">
      <p class="site-info">
        
        
        <span class="copyright">&copy; INGCHIPS 2021-2023. All rights reserved.</span>
        
        
          
          
<a class="" href="https://www.stackbit.com" target="_blank" rel="noopener">
  
  Made with Stackbit
  
</a>

        
      </p><!-- .site-info -->
      
      
      <div class="social-links">
        
          
          
<a class="button button-icon" href="https://github.com/ingchips" target="_blank" rel="noopener">
  
  <span class="icon fab fa-github" aria-hidden="true"></span><span class="screen-reader-text">GitHub</span>
  
</a>

        
      </div><!-- .social-links -->
      
    </div><!-- .site-footer-inside -->
  </div><!-- .inner -->
</footer><!-- .site-footer -->

</div><!-- .site -->

        <!-- Scripts -->
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/prism.js" data-manual></script>
        <script src="/assets/js/main.js"></script>
    </body>
</html>
