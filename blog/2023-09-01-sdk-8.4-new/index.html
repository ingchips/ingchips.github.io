<!doctype html>
<html lang="en">
    <head>

        <title>SDK 8.4 更新说明 - INGCHIPS</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="总结 SDK 8.4 新功能。"/>
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    </head>
    <body
        <div id="page" class="site">
  <header id="masthead" class="site-header outer">

  <div class="inner">
    <div class="site-header-inside">
      <div class="site-branding">
        
        
        <p class="site-logo"><a href="/"><img src="/images/logo_en.jpg" alt="INGCHIPS" /></a></p>
        
      </div><!-- .site-branding -->

      <div id="box">
        <input id="in_search" type="search" name="search" placeholder="搜索：输入并回车">
      </div>

      <script>
        let search_input = document.getElementById('in_search');
        if (search_input) {
          search_input.addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
            window.open('https://www.bing.com/search?q=' + encodeURIComponent(search_input.value) + '%20site%3A' + window.location.hostname);
            event.preventDefault();
            }
          });
        }
      </script>

      
      
      <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
        <div class="site-nav-inside">
          <button id="menu-close" class="menu-toggle"><span class="screen-reader-text">Open Menu</span><span class="icon-close" aria-hidden="true"></span></button>
          <ul class="menu">
            
            <li class="menu-item">

              
<a class="" href="/">
  
  Home
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/products">
  
  产品
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/sdk">
  
  SDK
  
</a>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/docs/">
  
  文档
  
</a>

              
            </li>
            
            <li class="menu-item has-children">

              
<a class="" href="/docs/sdk/apps/#web-apps">
  
  Web 工具
  
</a>

              

                <ul class="submenu">
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/callgraph">
  
  Callgraph (调用图)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index.html">
  
  ING918/ING916 FOTA
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/ing918_ota/index_cn.html">
  
  ING918/ING916 FOTA (中文版)
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/powerprofiler/">
  
  Online Power Profiler
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/air_trace/">
  
  Trace Logger
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/assertion_tool/index.html">
  
  ING918/ING916 Assertion Tool
  
</a>

  </li>
  
  <li class="menu-item">
    
    
<a class="" href="/web_apps/assertion_tool/index_cn.html">
  
  ING918/ING916 Assertion Tool (中文版)
  
</a>

  </li>
  
</ul>

              
            </li>
            
            <li class="menu-item">

              
<a class="" href="/blog/">
  
  Blog
  
</a>

              
            </li>
            
            <li class="menu-item menu-button">

              
<a class="button" href="https://github.com/ingchips">
  
  GitHub
  
</a>

              
            </li>
            
          </ul>
        </div><!-- .site-nav-inside -->
      </nav><!-- .site-navigation -->
      <button id="menu-open" class="menu-toggle"><span class="screen-reader-text">Close Menu</span><span class="icon-menu" aria-hidden="true"></span></button>
      
    </div><!-- .site-header-inside -->
  </div><!-- .inner -->
</header><!-- .site-header -->

  <main id="content" class="site-content">
    <div class="inner outer">
  <div class="docs-content">
    <article class="post post-full">
      <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
              inlineMath: [ ['$','$'], ["\\(","\\)"] ],
              displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
          }
        });
      </script>
      <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <header class="post-header has-gradient outer">
        
        
        <div class="inner-sm">
          <div class="post-meta">
            <time class="published" datetime="2023-09-01 00:00">September 01, 2023</time>
          </div>
          <h1 class="post-title">SDK 8.4 更新说明</h1>
          
          
        </div>
      </header>
      <div class="inner-md outer">
        <div class="post-content">
          <h2 id="highlights">Highlights</h2>

<ul>
  <li><a href="/blog/2023-11-02-axf-tool/">Axf Tool</a></li>
  <li>v5.4 PAwR (实验性，仅限 ING916)</li>
  <li>连接的中止、重建和切换 (实验性)</li>
  <li>LE Secure Connection 配对 (实验性)</li>
</ul>

<div class="important">
<strong>已知问题（局限性）:</strong>
<ul>
<li>ING916XX 使用内部 RC 为主时钟时，如果要使用省电模式，则 RC 频率暂时只能配置为 24MHz。</li>
</ul></div>

<h2 id="v8417">v8.4.17</h2>

<h3 id="1-软件包">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_rt_rc_auto_tune2</code> (NoOS 软件包)</p>

    <p>旧版本 NoOS 软件包中，<code class="language-plaintext highlighter-rouge">platform_rt_rc_auto_tune2</code> 会使用通过 OS 接口里的 <code class="language-plaintext highlighter-rouge">enter_critical</code> 和 <code class="language-plaintext highlighter-rouge">leave_critical</code>，
  因此该函数无法在 <code class="language-plaintext highlighter-rouge">app_main</code> 里使用。</p>

    <p>新版本中已做改进，可以在 <code class="language-plaintext highlighter-rouge">app_main</code> 里使用。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING918: <code class="language-plaintext highlighter-rouge">gap_vendor_tx_continuous_wave</code> 功能异常</p>

    <p>v8.4.15 修复射频时钟门控时，引入了新问题：<code class="language-plaintext highlighter-rouge">gap_vendor_tx_continuous_wave()</code>
  未打开射频时钟，不能发送信号。现已修复。</p>
  </li>
</ul>

<h3 id="2-工具">2. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Wizard：提供 ING916 BQB RF 测试程序</p>

    <p><img src="../img/bqb_rf_bin.png" alt="" /></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] BQB RF 测试工具：新增发送功率模式设置，改善报错信息。</p>

    <p>发送功率模式（”Power Mode”）设置如下图：</p>

    <p><img src="../img/bqb_rf_power_mode.png" alt="" /></p>

    <p>说明：ING918 不支持通过工具功率模式设置，请通过下载不同的程序切换功率模式。</p>
  </li>
</ul>

<h2 id="v8416">v8.4.16</h2>

<h3 id="1-软件包-1">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] Platform 事件 <code class="language-plaintext highlighter-rouge">PLATFORM_CB_EVT_ON_IDLE_TASK_RESUMED</code></p>

    <p>该事件出现说明 RTOS 功能已完全从睡眠中恢复，所有 API 都可以正常使用。</p>
  </li>
  <li>[<strong>修正</strong>] Controller: 潜在的内存数据异常</li>
  <li>
    <p>[<strong>修正</strong>] ING918: RTOS 睡眠时间计算错误 (v8.4.6 引入)</p>

    <p>v8.4.6~v8.4.15 RTOS 睡眠时间计算错误，睡眠时间偏小，功耗偏大。</p>
  </li>
  <li>[<strong>修正</strong>] Controller: 当多个加密或者 CCM 命令排队时会出现断言 (assertion)</li>
  <li>[<strong>修正</strong>] Controller: 当使能广播时可能出现断言 (assertion)</li>
  <li>[<strong>修正</strong>] SM: 如果在 <code class="language-plaintext highlighter-rouge">SM_FINAL_...</code> 事件的处理函数中调用了 SM API 将导致内存泄露</li>
  <li>
    <p>[<strong>修正</strong>] ING916: 快速深睡眠未考虑 <code class="language-plaintext highlighter-rouge">buck_en</code> 设置</p>

    <p>旧版本快速深睡眠一律按照 BUCK 使能处理，现在会考虑 BUCK 的实际状态（<code class="language-plaintext highlighter-rouge">SYSCTRL_EnableBuckDCDC()</code>）。</p>
  </li>
</ul>

<h3 id="2-库函数">2. 库函数</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916 ADC: 检测校准数据是否正常，忽略异常数据</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916: <code class="language-plaintext highlighter-rouge">ADC_ftInitCali</code></p>

    <p>原接口 <code class="language-plaintext highlighter-rouge">ADC_ftInit</code> 仍保留，但不建议使用。</p>
  </li>
</ul>

<h3 id="3-工具">3. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] Cube: UART/SPI 相关编辑功能</li>
</ul>

<h2 id="v8415">v8.4.15</h2>

<h3 id="1-软件包-2">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] SM: 若设置为 <code class="language-plaintext highlighter-rouge">SM_AUTHREQ_NO_BONDING</code>，配对时总是上报 <code class="language-plaintext highlighter-rouge">SM_FINAL_FAIL_OUT_OF_STORAGE</code></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916: 配对流程意外中断 （涉及 <code class="language-plaintext highlighter-rouge">typical</code>, <code class="language-plaintext highlighter-rouge">mass_conn</code>, <code class="language-plaintext highlighter-rouge">mini</code> 及相应的 NoOS 软件包）</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] 当开启扫描时，可能出现 0x3D 为错误码的连接断开</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] SM 主角色端：发送的 AUTH_REQ 总是为 <code class="language-plaintext highlighter-rouge">BONDING</code></p>

    <p>旧版本里通过 <code class="language-plaintext highlighter-rouge">sm_set_authentication_requirements</code> 或者 <code class="language-plaintext highlighter-rouge">sm_config_conn</code> 设置的 <code class="language-plaintext highlighter-rouge">auth_req</code>
  对于SM 主角色不生效。现已正常生效。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING918: 在第 1 个 BLE 活动之前，射频时钟未门控，电流偏大</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ATT: 当发送的 Indication 未收到确认时连接断开，将出现内存泄露</p>

    <p>此问题将进一步导致 HardFault 等其它问题。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] SM: 开启可解析地址或不可解析地址生成功能时，存在内存泄露</p>

    <p>长时间运行，最终会导致操作系统的 Heap 耗尽。</p>
  </li>
</ul>

<h3 id="2-库函数-1">2. 库函数</h3>

<ul>
  <li>[<strong>新增</strong>] 为支持 Zephyr 而增加了一些必要的文件</li>
</ul>

<h3 id="3-工具-1">3. 工具</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] Cube: 编辑 ING916 SPI 时程序卡死</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">icsdw.py</code>: 支持通过 J-Link 下载</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 为 Keil 更新了 SVD 文件，包含了所有外设的寄存器</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] Axf Tool: 改善 dump 文件的解析；分析 FreeRTOS 定时器</p>
  </li>
</ul>

<h2 id="v8414">v8.4.14</h2>

<h3 id="1-软件包-3">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] 某些软件包 PING 特性不完整</p>

    <p>由于编译选项设置有误，导致 ING918 exp/noos_exp 软件包及 ING916 所有软件包 PING 特性不完整，
  仅能发送 1 次 PING 请求。现已修复。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 改善多连接的任务调度</p>

    <p>多连接情况下，发生 0x08, 0x28 等原因的连接断开的概率明显减少。</p>

    <p>目前此功能默认关闭。请使用以下代码开启：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">platform_config</span><span class="p">(</span><span class="n">PLATFORM_CFG_LL_DBG_FLAGS</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="2-库函数-2">2. 库函数</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916xx: ADC 驱动开启编译优化时整数溢出</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: 提高 <code class="language-plaintext highlighter-rouge">flash_prepare_factory_data</code> 的鲁棒性</p>

    <p>旧版本里，如果 <code class="language-plaintext highlighter-rouge">flash_prepare_factory_data</code> 执行期间意外断电，
  再次启动后其它模块获取的工厂数据是错的；现在，该函数会对数据做校验：如果校验失败，会再次准备数据，从而保证后续使用的数据总是正确的。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] <code class="language-plaintext highlighter-rouge">btstack_sync</code>: 建立连接时未检查 <code class="language-plaintext highlighter-rouge">COMMAND_STATUS</code></p>
  </li>
</ul>

<h3 id="3-工具-2">3. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] tracer: 增加设备地址、连接断开搜索功能</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] tracer: 某些文件数据正常但是无法解析</p>
  </li>
</ul>

<h2 id="v8413">v8.4.13</h2>

<h3 id="1-软件包-4">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916: 扫描时可能出现 <code class="language-plaintext highlighter-rouge">[ASSERTION] @ dtble.c:320</code></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] API: <code class="language-plaintext highlighter-rouge">ll_get_capabilities</code>, <code class="language-plaintext highlighter-rouge">btstack_get_capabilities</code></p>

    <p>分别用来获取链路层和 Host 的能力参数，如最大连接数。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">le_device_db</code> 可存储的配对设备数增加为 <code class="language-plaintext highlighter-rouge">max(10, 最大连接数)</code></p>

    <p>注意：内置的键值存储实现目前总大小为 1024 字节，最多只能存储 10 个设备。当需要保存更多的配对设备，
  请使用 <code class="language-plaintext highlighter-rouge">kv_init_backend</code> 实现更大的键值存储。</p>
  </li>
</ul>

<h3 id="2-工具-1">2. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Tracer：文件解析效率提升</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] Wizard：查看、修改链路层特性标志位 (Link Link Feature bits)</p>

    <p><img src="../img/menu_ll_features.png" alt="" /></p>

    <p>选择 “Link Layer Features …” 菜单，可以查看当前软件包支持的链路层特性。
  如果新建工程时使用了 “COPY to my project” 的方式，这些特性标志就是可以修改的。</p>

    <p><strong>注意</strong>：修改这些标志可能没有任何效果，或者产生的效果与预期不一致。
  一个可能的应用场景：使用传统广播时，如果希望进入连接状态时使用信道选择算法 #1，那么可以在这里关闭算法 #2 特性。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] axf_tool: 补充了缺少的文件，改善了对 M4 的支持</p>
  </li>
</ul>

<h2 id="v8412">v8.4.12</h2>

<h3 id="1-软件包-5">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916: <code class="language-plaintext highlighter-rouge">gap_vendor_tx_continuous_wave</code> 无法停止发射</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] Host/Controller 所使用的随机地址可能不一致</p>

    <p>当 <code class="language-plaintext highlighter-rouge">gap_set_adv_set_random_addr</code> 发生错误时：</p>

    <ul>
      <li>原来的行为：Host 使用新地址，Controller 使用旧地址，两个地址不一致</li>
      <li>现在的行为：Host 和 Controller 都使用旧地址，两个地址保持一致</li>
    </ul>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">sysSetPublicDeviceAddr</code> 现在可以在任意位置调用</p>

    <p>对于广播，新的地址将在再次启动广播时生效。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] L2CAP 无法正确处理 <code class="language-plaintext highlighter-rouge">CONNECTION_PARAMETER_UPDATE_REQUEST</code></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING918XX：使用 EXT_INT 唤醒时，唤醒过程中可能死机（v8.4.6 引入）</p>
  </li>
</ul>

<h3 id="2-示例">2. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] <em>Ext. Raw Packet Tx/Rx</em>: 演示将 ING916 用做简易频偏测试仪</li>
</ul>

<h2 id="v8411">v8.4.11</h2>

<h3 id="1-软件包-6">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] API: <code class="language-plaintext highlighter-rouge">gap_read_white_lists_size</code></p>

    <p>通过该接口可读取白名单的大小。</p>

    <p>建议使用 v8.4.13 提供的 <code class="language-plaintext highlighter-rouge">ll_get_capabilities</code>，使用更方便。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] SM: 现已支持 LE Secure Connection 配对的并发 (<em>experimental</em>)</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] SM: 收到 Pairing Failed 数据包时立即弹出 SM_FINAL_FAIL_PROTOCOL 代码</p>

    <p>原行为：（假设连接一直保持）大约 30 秒后弹出 SM_FINAL_FAIL_TIMEOUT 代码。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: Platform 提供的持久化寄存器扩展为 5 比特</p>

    <p>相关 API <code class="language-plaintext highlighter-rouge">platform_write_persistent_reg</code> 和 <code class="language-plaintext highlighter-rouge">platform_read_persistent_reg</code>。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] <code class="language-plaintext highlighter-rouge">ll_channel_monitor_run</code>: 大约每 20 次必然出现一次接收失败</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_rt_rc_tune()</code>: 放松使用限制</p>

    <ul>
      <li>
        <p>原行为：写入调谐值并<strong>开始</strong>校准。</p>

        <p>如果在 <code class="language-plaintext highlighter-rouge">app_main</code> 里调用该函数，可能导致校准逻辑异常、死机。</p>
      </li>
      <li>
        <p>现在的行为：写入调谐值并<strong>完成</strong>校准。</p>

        <p>现在可以在任意位置调用，但是函数的运行时间比旧版本长。</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="2-库函数-3">2. 库函数</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">flash_prepare_factory_data</code></p>

    <p>现已兼容 NoOS 软件包。</p>
  </li>
</ul>

<h3 id="3-示例">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] <em>UART GATT Console</em>: 演示 <code class="language-plaintext highlighter-rouge">gap_read_white_lists_size</code> 的用法</li>
</ul>

<h3 id="4-工具">4. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">gen_files</code>: 提高运行速度</li>
</ul>

<h2 id="v8410">v8.4.10</h2>

<h3 id="1-软件包-7">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] API: <code class="language-plaintext highlighter-rouge">gap_disconnect2</code></p>

    <p>通过该接口可以设置断开原因。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] API: <code class="language-plaintext highlighter-rouge">ll_get_states</code></p>

    <p>通过该接口可以获取 Controller 当前的工作状态。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] GATT Client: 防止因 API 使用不当而出现内存问题</p>
  </li>
</ul>

<h3 id="2-外设驱动">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">PINCTRL_SelSpiPins</code></p>

    <p>建议使用该函数为 SPI 配置所有的输入、输出管脚。不要再使用 <code class="language-plaintext highlighter-rouge">PINCTRL_SelSpiIn</code>。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING918xx: <em>power_ctrl.lib</em> 改为使用 Keil 4 编译以便兼容 Gnu 工具链</p>
  </li>
</ul>

<h3 id="3-示例-1">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] <em>UART GATT Console</em>: 演示了 <code class="language-plaintext highlighter-rouge">ll_get_states</code> 的用法</li>
</ul>

<h3 id="4-工具-1">4. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] Cube: 修正了关于 PCAP, SPI 的几个问题</li>
</ul>

<h2 id="v849">v8.4.9</h2>

<h3 id="1-软件包-8">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] ING916 LL Privacy (<em>experimental</em>)</p>

    <p>ING916 <em>exp</em> 软件包已支持 LL Privacy。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] 使用内置的 kv 实现时，<code class="language-plaintext highlighter-rouge">le_device_db</code> 无法正确遍历设备记录</p>

    <p>此缺陷由 v8.4.6 引入，可导致以下现象：</p>

    <ul>
      <li>只能保存一个配对设备；</li>
      <li><code class="language-plaintext highlighter-rouge">le_device_db_find</code> 无法找到已配对设备。</li>
    </ul>
  </li>
</ul>

<h3 id="2-外设驱动-1">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916：USB ISO 模式下只在偶数帧发送数据</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916：无法获取正确的 PCAP DMA 地址</p>
  </li>
</ul>

<h3 id="3-示例-2">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] HID Mouse: 演示 LL Privacy</li>
  <li>[<strong>修正</strong>] I/O Over BLE: ING916 的兼容性</li>
</ul>

<h3 id="4-工具-2">4. 工具</h3>

<ul>
  <li>[<strong>修正</strong>] Afx Tool: 不支持 ING916 <em>mini</em> 软件包</li>
  <li>[<strong>更新</strong>] Wizard: 切换型号时将删除多余的 .asm 文件，减少报错</li>
</ul>

<h2 id="v848">v8.4.8</h2>

<h3 id="1-软件包-9">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING918: 启用 SM 时出现 HardFault</p>

    <p>编译器在优化时连续的非对齐访问时错误地使用了不支持非对齐访问机器指令，导致 HardFault。新版本已规避。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916 配置项：<code class="language-plaintext highlighter-rouge">PLATFORM_CFG_AUTO_REDUCE_CLOCK_FREQ</code></p>

    <p>ING916 启用省电模式后，会在下列位置、状态自动调低 CPU 时钟频率：</p>

    <ul>
      <li>默认的 IDLE 过程；</li>
      <li>进入 DEEP SLEEP、DEEPER SLEEP 等省电状态时。</li>
    </ul>

    <p>此配置项默认为开启（旧版本相当于始终为开启状态）。关闭自动降频功能不利于省电，但有利于系统实时性。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] <code class="language-plaintext highlighter-rouge">platform_create_us_timer</code>, <code class="language-plaintext highlighter-rouge">platform_cancel_us_timer</code></p>

    <p>通过以上 API 可以微秒为单位设置定时器。此定时器与 <code class="language-plaintext highlighter-rouge">platform_set_timer</code> 类似，但存在以下区别：</p>

    <ol>
      <li>精度更高；</li>
      <li>定时器回调是在中断处理程序中调用。</li>
    </ol>

    <p>注意：虽然 API 以微秒为单位，但是并不保证实际精度能达到微秒级。</p>
  </li>
</ul>

<h3 id="2-工具-2">2. 工具</h3>

<ul>
  <li>[<strong>修正</strong>] Cube: ING916 定时器时钟分频的默认值</li>
</ul>

<h2 id="v847">v8.4.7</h2>

<h3 id="1-软件包-10">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] SM: <code class="language-plaintext highlighter-rouge">sm_config</code> 现在支持多次调用，动态更新参数。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] SM 事件 <code class="language-plaintext highlighter-rouge">SM_EVENT_IRK_DHK_RESULT</code></p>
  </li>
</ul>

<h3 id="2-外设驱动-2">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916：<code class="language-plaintext highlighter-rouge">SYSCTRL_SelectKeyScanClk</code></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916：<code class="language-plaintext highlighter-rouge">KEYSCAN_InitializeScanParameter</code></p>
  </li>
</ul>

<h3 id="3-库函数">3. 库函数</h3>

<ul>
  <li>[<strong>更新</strong>] ING918：ADC 校准</li>
</ul>

<h3 id="2-工具-3">2. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Axf Tool: 只支持当前版本</p>

    <p>为了防止安装包迅速变大，从此版本开始，不再支持在命令行里指定历史版本。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] Tracer：支持 BLE 5.4；增加 HCI MSC</p>

    <p>现已支持 BLE 5.4。新增了 HCI 消息序列图生成功能；MSC 现在有两种样式供选择：</p>

    <p><img src="../img/tracer_menu_msc.png" alt="" /></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING918: Downloader Flash Dump 功能</p>
  </li>
</ul>

<h2 id="v846">v8.4.6</h2>

<h3 id="1-软件包-11">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916: <code class="language-plaintext highlighter-rouge">DEEP_SLEEP</code> 增加了一种快速模式</p>

    <p>此模式下 PMU 保持开启。与已有的慢速模式相比，可以在更短时间内完成睡眠、唤醒流程，但底电流略大。
  当睡眠时间小于 <code class="language-plaintext highlighter-rouge">PLATFORM_CFG_DEEP_SLEEP_TIME_REDUCTION</code> 时，系统会自动尝试快速模式。</p>

    <p>相应增加了 <code class="language-plaintext highlighter-rouge">PLATFORM_CFG_FAST_DEEP_SLEEP_TIME_REDUCTION</code> 配置项，默认值为 ~2ms。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] SM: 特定情况下重新配对 IRK 未更新</p>

    <p>当已经与某设备配对，该设备再次发起配对，且同时满足以下条件时，SM 未更新已经存在的 IRK，导致重新配对后无法正常重连：</p>

    <ul>
      <li>该设备的身份地址（identity address）类型为 public；</li>
      <li>重新配对时，该设备更新了它的 IRK。</li>
    </ul>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916: Host 支持的并发连接数为 4 (<em>typical</em> 软件包)</p>

    <p>自 v8.3.7 起，<em>typical</em> 软件包支持的最大并发连接数修改为 5，但是
  v8.3.7 ~ v8.4.5 只修改 Controller 的最大并发连接数，Host 仍为 4。现已统一为 5。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">ll_set_max_conn_number</code></p>

    <p>旧版本中，该函数设置的最大连接数仅为提示性参数，影响内存分配、任务调度等。现在，设置最大连接数为 N 后
  （N 必须小于等于该软件包所定义的最大并发连接数），则 Controller 所允许的最大并发连接数就是 N。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] 连接的中止、重建和切换功能 (<em>experimental</em>)</p>

    <p>通过链路层 API <code class="language-plaintext highlighter-rouge">ll_conn_abort</code> 可直接中止一个连接，中止后 Controller 将先上报
  <code class="language-plaintext highlighter-rouge">HCI_SUBEVENT_LE_VENDOR_CONNECTION_ABORTED</code> 事件，其中包含了该连接的所有链路层参数，
  然后上报 <code class="language-plaintext highlighter-rouge">HCI_EVENT_DISCONNECTION_COMPLETE</code> 事件驱动上层断开连接。</p>

    <p>利用 <code class="language-plaintext highlighter-rouge">HCI_SUBEVENT_LE_VENDOR_CONNECTION_ABORTED</code> 事件里携带的信息调用 <code class="language-plaintext highlighter-rouge">ll_create_conn</code>
  可与对端设备重建该连接。—— 对端设备对此过程无感知。如果先由设备 A 中止连接，再由设备 B
  重建，这个连接就从设备 A <strong>切换</strong> 到了设备 B。</p>

    <p><code class="language-plaintext highlighter-rouge">ll_create_conn</code> 函数签名也已更新以支持连接重建，考虑到这个接口可以还会更新，所以已从 <code class="language-plaintext highlighter-rouge">extension</code> 包中移除。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_api.h</code>：“32k 时钟”更名为“实时时钟”</p>

    <p>相关配置项的名称同步修改，以下 3 个相关函数也同步更名：</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">函数原名</th>
          <th style="text-align: left">函数现名称</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code></td>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_calibrate_rt_clk</code></td>
        </tr>
        <tr>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_32k_rc_tune</code></td>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_rt_rc_tune</code></td>
        </tr>
        <tr>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_32k_rc_auto_tune</code></td>
          <td style="text-align: left"><code class="language-plaintext highlighter-rouge">platform_rt_rc_auto_tune</code></td>
        </tr>
      </tbody>
    </table>

    <div class="note">
  <strong>兼容性说明：</strong>原名称仍以“别名”的形式保留，现有代码仍可正常编译。</div>

    <p>新增 <code class="language-plaintext highlighter-rouge">platform_rt_rc_auto_tune2</code> 可将实时 RC 时钟调谐到指定频率。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING918: 实时 RC 时钟源调谐为 50kHz</p>

    <p>相应地，<code class="language-plaintext highlighter-rouge">RTC_CLK_FREQ</code> 也改为 50kHz。一般情况下，现有项目的源代码不需要修改。
  如果代码中使用了另外定义的常量 32768，比如将时间换算为周期数时隐式使用了 32768，那么需要修改：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// 关机 1.5s 后重启</span>
  <span class="n">platform_shutdown</span><span class="p">(</span><span class="mi">49152</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div>    </div>

    <p><a href="#ing918如何使用-32k-外部晶体作为实时时钟源">“对于使用 32k 外部晶体作为实时时钟源的项目，应该怎么办？”</a></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] SM: 支持 LE Secure Connections Pairing (<em>experimental</em>)</p>

    <p>示例请参考 HID Keyboard 和 Pairing with OOB。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916 platform.bin 结构</p>

    <p>更新之后：</p>

    <ul>
      <li>platform.bin 的第一个扇区仅用于存放中断向量表和 <code class="language-plaintext highlighter-rouge">struct platform_info</code>，未用的空间由 0xFF 填充；</li>
      <li>0x02003000 处保存了中断向量表的起始地址，其值为 0x02002000。</li>
    </ul>

    <p>借助这种结构开发者可以完全接管系统的启动过程，实现 <a href="/blog/2023-11-23-ing916-2nd-bootloader">二级 Bootloader</a> 等功能。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916：意外地睡眠过长时间</p>
  </li>
</ul>

<h3 id="2-外设驱动-3">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] ING916: <code class="language-plaintext highlighter-rouge">flash_read_uid</code></p>

    <p>用该接口读取 Flash 的唯一 ID。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916: <code class="language-plaintext highlighter-rouge">PCAP_ClearFifo</code>, <code class="language-plaintext highlighter-rouge">PWM_SetIntTrigLevel</code></p>

    <p>分别用来清空 PWM/PCAP 的 FIFO、设置 FIFO 中断触发深度。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916：<code class="language-plaintext highlighter-rouge">apSSP_SetTransferControlDummyCnt</code></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916：QDEC/KeyScan 在某些编译器下的警告</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916：<code class="language-plaintext highlighter-rouge">RTC_IsModificationDone</code> 总是返回 0</p>
  </li>
</ul>

<h3 id="3-库函数-1">3. 库函数</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING918：伴随 50kHz 实时时钟更新 power control 库</p>

    <p>更新后的库兼容 32k 实时时钟。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_util.c</code>: 支持新的 ING918 platform.bin 结构</p>
  </li>
</ul>

<h3 id="4-示例">4. 示例</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] PAwR：演示了 PAwR 相关的所有 API 和事件的用法。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] UART Console：演示了连接的中止和重建。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] HID Keyboard：键盘状态显示</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] HID Keyboard：演示 LE Secure Connection 配对</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] Pairing with OOB: 演示了 OOB 配对的用法</p>
  </li>
</ul>

<h3 id="5-工具">5. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] 针对“实时时钟”同步更新 Cube</li>
</ul>

<h2 id="v845">v8.4.5</h2>

<h3 id="1-软件包-12">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916: 将更多的内存块映射为 SYS RAM (<em>mini</em> &amp; <em>noos_mini</em>)</p>

    <p>ING916 除 Cache 外共有 64KiB 内存，部分内存选择映射为 SYS RAM 或 SHARE RAM。旧版本中，
  SYS、SHARE 各 32KiB。从 v8.4.5 开始，在 noos_mini 和 mini 软件包分别配置 56 KiB SYS RAM 和 8 KiB SHARE RAM；
  在其它软件包里，SYS、SHARE 仍各为 32 KiB。</p>

    <p>关于 ING916 内存的 <a href="https://ingchips.github.io/drafts/pg_ing916/ch-sysctrl.html#ram-%E7%9B%B8%E5%85%B3">更多信息</a>。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] <code class="language-plaintext highlighter-rouge">platform_call_on_stack</code></p>

    <p>ING916 处理能力强大，但 RAM 相对较小。进行复杂运算处理时（尤其是移植已有算法时），往往出现栈空间不足的情况。
  为此我们提供了这个新的 API，可以临时切换到的一个单独的栈空间上完成函数调用。例如，临时借用 D-Cache：</p>

    <pre><code class="language-C">  SYSCTRL_CacheControl(SYSCTRL_MEM_BLOCK_AS_CACHE, SYSCTRL_MEM_BLOCK_AS_SYS_MEM);
  {
      platform_call_on_stack(complex_algorithm_function, NULL,
                             SYSCTRL_D_CACHE_AS_MEM_BASE_ADDR, 8192);
  }
  SYSCTRL_CacheControl(SYSCTRL_MEM_BLOCK_AS_CACHE, SYSCTRL_MEM_BLOCK_AS_CACHE);
</code></pre>
  </li>
  <li>
    <p>[<strong>新增</strong>] <code class="language-plaintext highlighter-rouge">ll_create_conn</code>  (<em>extension</em> &amp; <em>exp</em>)</p>

    <p>借助这个 API，开发者可以在 BLE 标准定义的连接建立方法（如广播、PAwR）之外，设计其它方法建立连接，
  比如 Direct Connection。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916 软件包 <em>exp</em> &amp; <em>noos_exp</em>：开始提供 PAwR API (实验性)</p>
  </li>
</ul>

<h3 id="2-外设驱动-4">2. 外设驱动</h3>

<ul>
  <li>[<strong>修正</strong>] ING916: <code class="language-plaintext highlighter-rouge">GIO_EnableDeepSleepWakeupSource</code> 允许禁用上下拉</li>
</ul>

<h3 id="3-示例-3">3. 示例</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Voice Remote Control：改为使用 <a href="https://github.com/google/libsbc">Google 开源的 libsbc</a></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] BLE RPC 相关代码，版本号升级为 2</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] HID Keyboard：<code class="language-plaintext highlighter-rouge">key_impl.c</code></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] Direct Connection：演示了 <code class="language-plaintext highlighter-rouge">ll_create_conn</code> 的用法</p>
  </li>
</ul>

<h3 id="4-工具-3">4. 工具</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] GUI 版 Downloader 使用串口下载时可能锁死</p>

    <p>旧版本当设置为非批量下载且不启动程序时，下载完成后用户界面会锁死，无法操作。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <em>ing_usb.exe</em>: 全面支持下载；修正了几个问题</p>

    <p>现在 <code class="language-plaintext highlighter-rouge">-d flash_download.ini</code> 下载功能更加完善，支持除批量下载时的脚本功能以外的全部功能。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] 可执行文件和 Dump 分析工具 Axf Tool</p>

    <p><a href="/blog/2023-11-02-axf-tool/">详情</a>。</p>
  </li>
</ul>

<h2 id="v844">v8.4.4</h2>

<h3 id="1-软件包-13">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] ING916: 优化省电性能</p>

    <p>每个工作周期电量修消耗降低 ~1μC （具体数值受频率等因素的影响）。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916: 同时允许 <code class="language-plaintext highlighter-rouge">BLE_ONLY_SLEEP</code> 和 <code class="language-plaintext highlighter-rouge">DEEP_SLEEP</code> 时频繁重启</p>
  </li>
</ul>

<h3 id="2-外设驱动-5">2. 外设驱动</h3>

<ul>
  <li>[<strong>修正</strong>] ING916: <code class="language-plaintext highlighter-rouge">PINCTRL_DisableAllInputs</code> 里的溢出问题</li>
</ul>

<h3 id="3-示例-4">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] Peripheral Console (…): 在 ING916 上允许 <code class="language-plaintext highlighter-rouge">BLE_ONLY_SLEEP</code></li>
</ul>

<h3 id="4-工具-4">4. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Cube</p>

    <p>修正了为 USB 生成的代码。现在允许一个数字管脚用作两种功能（GPIO 及另一种外设的输入），
  并给出警告。</p>
  </li>
</ul>

<h2 id="v843">v8.4.3</h2>

<h3 id="1-软件包-14">1. 软件包</h3>

<ul>
  <li>[<strong>修正</strong>] v8.4.1~v8.4.2 ING916 睡眠状态下底电流时大时小的问题 (涉及 <em>mini</em> 和 <em>noos_mini</em> 软件包)</li>
</ul>

<h2 id="v842">v8.4.2</h2>

<h3 id="1-软件包-15">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] v8.4.1 ING916 睡眠状态下底电流变大的问题 (涉及 <em>mini</em> 和 <em>noos_mini</em> 软件包)</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code></p>

    <p>现在，每次调用 <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code> 时，将调整下次的校准时间至 <code class="language-plaintext highlighter-rouge">PLATFORM_CFG_32K_CALI_PERIOD</code>
  之后。旧版本调用 <code class="language-plaintext highlighter-rouge">platform_calibrate_32k</code> 不会影响下次的校准时间。</p>
  </li>
</ul>

<h3 id="2-外设驱动-6">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] Sofware d/h/m/s RTC</p>

    <p>为 ING918xx 增加了一套基于 <code class="language-plaintext highlighter-rouge">platform_set_timer</code> 等 API 实现的天、时、分、秒计时器，
  接口与 ING916XX RTC 兼容。对于 ING916xx，可通过 <code class="language-plaintext highlighter-rouge">SOFTWARE_RTC_DHMS</code> 编译开关选择硬件方式或者软件方式。</p>

    <p>两种实现方式的区别：</p>

    <ol>
      <li>
        <p>对于软件方式，使用 <code class="language-plaintext highlighter-rouge">RTC_SoftSetISR</code> 设置“中断”处理函数，而非 <code class="language-plaintext highlighter-rouge">platform_set_irq_callback</code>；</p>
      </li>
      <li>
        <p>对于软件方式，除了 <code class="language-plaintext highlighter-rouge">RTC_SoftSetISR</code>， 所有 API 只在协议栈初始化之后（<code class="language-plaintext highlighter-rouge">PLATFORM_CB_EVT_PROFILE_INIT</code> 事件）方可使用；</p>
      </li>
      <li>
        <p>软件方式不需要调整（Trim），其精度由软件包内置周期性校准功能保证；</p>
      </li>
      <li>
        <p>软件方式下的“中断”实际就是 <code class="language-plaintext highlighter-rouge">platform_set_timer</code> 等的回调函数，“抖动”比硬件方式大。</p>
      </li>
    </ol>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: 提供更多的 GPIO 唤醒方式</p>

    <p>详见 <a href="https://ingchips.github.io/drafts/pg_ing916/ch-gpio.html#%E7%9D%A1%E7%9C%A0%E5%94%A4%E9%86%92%E6%BA%90">外设开发者手册-睡眠唤醒源</a>。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">RTC_Trim</code></p>

    <p><code class="language-plaintext highlighter-rouge">RTC_Trim</code> 实现了完整的 ING916xx RTC 数字调校功能。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: 更多的 KeyScan API</p>

    <p>增加了 Loop 中断、FIFO 相关的接口。</p>
  </li>
</ul>

<h2 id="v841">v8.4.1</h2>

<h3 id="1-软件包-16">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] Raw Package API: 当接收的数据包的数据长度为 0 时报错</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916: 将更多的代码移动到 RAM 以降低功耗 (限 <em>mini</em> 和 <em>noos_mini</em> 软件包)</p>

    <p>该更新针对空包维持连接状态优化了功耗。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] BLE 协议栈 API: <code class="language-plaintext highlighter-rouge">btstack_reset</code></p>

    <p>可完整复位协议栈。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] platform event: <code class="language-plaintext highlighter-rouge">PLATFORM_CB_EVT_HCI_RECV</code></p>
  </li>
  <li>
    <p>[<strong>新增</strong>] platform API: <code class="language-plaintext highlighter-rouge">platform_get_link_layer_interf</code></p>

    <p>借助以上两个接口可完整暴露 Controller 的功能，为开发 BLE Dongle 带来可能。后续版本将提供示例。</p>
  </li>
</ul>

<h3 id="2-外设驱动-7">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>新增</strong>] ING916xx: Flash 写保护接口 <code class="language-plaintext highlighter-rouge">flash_enable_write_protection</code></p>

    <p>通过此接口可将 ING916xx 内置的 Flash 的全部或者一部分置为写保护状态。再次向写保护区域写入数据时，需要先解除写保护。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916xx: USB BPS 头文件中增加 <code class="language-plaintext highlighter-rouge">bsp_usb_disable</code></p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">KEYSCAN_Initialize</code> 对 GPIO 上下拉的配置。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_SelectMemoryBlocks</code> 潜在的睡眠电流达 20uA 的问题</p>
  </li>
</ul>

<h3 id="3-工具-3">3. 工具</h3>

<ul>
  <li>
    <p>[<strong>更新</strong>] Downloader: 为 ING916 增加 Flash 写保护选项。</p>

    <p><img src="../img/flash_write_protection.png" alt="" /></p>
  </li>
  <li>
    <p>[<strong>更新</strong>] ING916 Flash 下载算法</p>

    <p>更新后的 ING916 Flash 下载算法行为如下：</p>

    <ul>
      <li>开始下载时，解除写保护。</li>
    </ul>
  </li>
</ul>

<h2 id="v840">v8.4.0</h2>

<h3 id="1-软件包-17">1. 软件包</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] SM：配对设备数量超出存储容量时不报错</p>

    <p>过去，当超出存储容量时，SM 模块仍会在 SM_EVENT_STATE_CHANGED 事件中报告 <code class="language-plaintext highlighter-rouge">SM_FINAL_PAIRED</code> 等成功信息；
  现在，SM 模块将在 SM_EVENT_STATE_CHANGED 事件中报告 <code class="language-plaintext highlighter-rouge">SM_FINAL_FAIL_OUT_OF_STORAGE</code>。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] Controller：使用可解析地址的定向广播时的兼容性</p>

    <p>当向可解析地址发送定向广播时，旧版本存在兼容性问题，导致无法与某些设备建立连接。现已修复。</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 键值存储模块（kv_storage）现在允许自定义后端实现</p>

    <p>默认的 KV 后端在写入时通过 <code class="language-plaintext highlighter-rouge">f_kv_write_to_nvm</code> 回调一并写入所有数据。
  如果发现默认的 KV 实现方式不合适，可以在 <code class="language-plaintext highlighter-rouge">app_main</code> 里调用 <code class="language-plaintext highlighter-rouge">kv_init_backend</code>，传入自定义的后端接口。</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">void</span> <span class="nf">kv_init_backend</span><span class="p">(</span><span class="k">const</span> <span class="n">kv_backend_t</span> <span class="o">*</span><span class="n">backend</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>自定义后端带来了灵活性，比如利用 <code class="language-plaintext highlighter-rouge">kv_value_modified_of_key</code> 接口可实现小颗粒度（K-V 对）的精细化存储。</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] Host：使用公共地址（public address）时无法配对</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">platform_switch_app</code> 功能异常</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: BLE_ONLY_SLEEP 睡眠模式的稳定性问题</p>
  </li>
  <li>
    <p>[<strong>更新</strong>] 提供更多的定时器接口</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">platform_get_timer_counter</code></li>
      <li><code class="language-plaintext highlighter-rouge">platform_set_abs_timer</code></li>
      <li><code class="language-plaintext highlighter-rouge">platform_delete_timer</code></li>
    </ul>

    <p>相比原来单一的 <code class="language-plaintext highlighter-rouge">platform_set_timer</code>，现在的接口可实现更多功能，比如准确模拟周期性定时器。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] GAP API：<code class="language-plaintext highlighter-rouge">gap_set_callback_for_next_hci</code></p>

    <p>具体用途将在后续版本中演示。</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] SM API：<code class="language-plaintext highlighter-rouge">sm_register_external_ltk_callback</code></p>

    <p>一些 BLE 应用可能会以自定义的方式协商 LTK（比如 Find My）。通过此 API 注册回调，
  可将这种外部生成的 LTK 传递给 SM 层。</p>

    <div class="note">
  <strong>注意：</strong>此 API 处于实验阶段，后续版本可能修改。</div>
  </li>
  <li>
    <p>[<strong>新增</strong>] 链路层配置项：<code class="language-plaintext highlighter-rouge">LL_CFG_FEATURE_SET_MASK</code></p>

    <p>有时需要“模仿”其它 BLE 设备的链路层协议流程，而支持的特性对后续的链路层协议流程影响很大。
  为此增加了链路层特性掩码，方便开发者即时调整上报给对端设备的链路层特性。例如，模仿只支持加密和 2M PHY
  两种特性的设备：</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">feature_mask</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
  <span class="p">{</span>
      <span class="mh">0x01</span><span class="p">,</span>       <span class="c1">// 比特 0: LE Encryption</span>
      <span class="mh">0x01</span><span class="p">,</span>       <span class="c1">// 比特 8: LE 2M PHY</span>
  <span class="p">};</span>

  <span class="c1">//...</span>
  <span class="n">ll_config</span><span class="p">(</span><span class="n">LL_CFG_FEATURE_SET_MASK</span><span class="p">,</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">feature_mask</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>注意，这里只是修改了 Feature Exchange 流程的上报值，对链路层的实际功能没有影响。</p>
  </li>
</ul>

<h3 id="2-外设驱动-8">2. 外设驱动</h3>

<ul>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_EnableConfigClocksAfterWakeup</code> 与 Flash 读保护功能冲突</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">SYSCTRL_CacheControl</code> 无法配置 D-Cache 的问题</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">apSSP_DeviceParametersSet</code> 参数范围溢出时寄存器配置异常</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: <code class="language-plaintext highlighter-rouge">ADC_GetVol</code> 遇到最大读数时返回值错误</p>
  </li>
  <li>
    <p>[<strong>修正</strong>] ING916xx: ADC/PDM 的时钟分频范围</p>
  </li>
  <li>
    <p>[<strong>新增</strong>] ING916xx: 将 PLL 的输出分频并输出到指定的管脚</p>

    <p>新增了两个相关的接口：</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">SYSCTRL_EnableClockOutput</code></li>
      <li><code class="language-plaintext highlighter-rouge">PINCTRL_SelClockOutput</code></li>
    </ul>
  </li>
</ul>

<h3 id="3-示例-5">3. 示例</h3>

<ul>
  <li>[<strong>更新</strong>] <code class="language-plaintext highlighter-rouge">HID Keyboard</code>：演示里 <code class="language-plaintext highlighter-rouge">kv_init_backend</code> 的用法</li>
</ul>

<h3 id="4-工具-5">4. 工具</h3>

<ul>
  <li>[<strong>更新</strong>] Cube: 修正了一些问题，增加 PLL 分频输出相关功能</li>
</ul>

<h2 id="ing918如何使用-32k-外部晶体作为实时时钟源">ING918：如何使用 32k 外部晶体作为实时时钟源</h2>

<p>同旧版本一样，将实时时钟源切换到 32k 外部晶体。避免使用 <code class="language-plaintext highlighter-rouge">RTC_CLK_FREQ</code>，可以定义一个新的常量，
比如 <code class="language-plaintext highlighter-rouge">#define RT_OSC_CLK_FREQ 32768</code>。软件包与实时时钟源频率无关，受影响的主要是 FreeRTOS，
所以分两种情况。</p>

<ul>
  <li>
    <p><strong>情况 1.</strong> 使用了内置 FreeRTOS 的软件包</p>

    <ul>
      <li>
        <p>如果关注 Tick、<code class="language-plaintext highlighter-rouge">pdMS_TO_TICKS</code> 等的准确度，</p>

        <ul>
          <li>
            <p>改为使用 NoOS 的软件包，自行编译 FreeRTOS：将 <code class="language-plaintext highlighter-rouge">configSYSTICK_CLOCK_HZ</code> 定义为 <code class="language-plaintext highlighter-rouge">RT_OSC_CLK_FREQ</code>，或者，</p>
          </li>
          <li>
            <p>自定义函数完成 Tick 与毫秒的换算。</p>
          </li>
        </ul>
      </li>
      <li>
        <p>如果不关注，那么可以继续使用。</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>情况 2.</strong> 使用了 NoOS 软件包：确认 SYSTICK 时钟频率配置为 <code class="language-plaintext highlighter-rouge">RT_OSC_CLK_FREQ</code>。</p>
  </li>
</ul>

        </div><!-- .post-content -->
      </div><!-- .inner-md -->
    </article><!-- .post -->

    <nav id="page-nav" class="page-nav">
      <div id="page-nav-inside" class="page-nav-inside sticky">
        <h2 class="page-nav-title">Jump to Section</h2>
      </div><!-- .page-nav-inside -->
    </nav><!-- .page-nav -->
  </div>
</div>

  <!-- Next/previous post navigation TBD -->
  <!--
  <div class="inner-md outer">
    <nav class="read-next">
      <h2 class="read-next-title line-left">Read Next</h2>
      <div class="nav-links">
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Previous post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Previous Post Title</a></h3>
        </article>
        <article class="post">
          <div class="post-meta">
            <time class="published" datetime="">Next post date</time>
          </div>
          <h3 class="post-title"><a href="#" rel="bookmark">Next Post Title</a></h3>
        </article>
      </div>
    </nav>
  </div>
  -->

  </main><!-- .site-content -->
  <footer id="colophon" class="site-footer outer">
  <div class="inner">
    <div class="site-footer-inside">
      <p class="site-info">
        
        
        <span class="copyright">&copy; INGCHIPS 2021-2023. All rights reserved.</span>
        
        
          
          
<a class="" href="https://www.stackbit.com" target="_blank" rel="noopener">
  
  Made with Stackbit
  
</a>

        
      </p><!-- .site-info -->
      
      
      <div class="social-links">
        
          
          
<a class="button button-icon" href="https://github.com/ingchips" target="_blank" rel="noopener">
  
  <span class="icon fab fa-github" aria-hidden="true"></span><span class="screen-reader-text">GitHub</span>
  
</a>

        
      </div><!-- .social-links -->
      
    </div><!-- .site-footer-inside -->
  </div><!-- .inner -->
</footer><!-- .site-footer -->

</div><!-- .site -->

        <!-- Scripts -->
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/prism.js" data-manual></script>
        <script src="/assets/js/main.js"></script>
    </body>
</html>
