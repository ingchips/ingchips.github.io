<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>13 串行外围设备接口（SPI） | ING20XX 系列芯片外设开发者手册</title>
  <meta name="description" content="ING20XX 系列芯片开发者手册." />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="13 串行外围设备接口（SPI） | ING20XX 系列芯片外设开发者手册" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="ING20XX 系列芯片开发者手册." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="13 串行外围设备接口（SPI） | ING20XX 系列芯片外设开发者手册" />
  
  <meta name="twitter:description" content="ING20XX 系列芯片开发者手册." />
  

<meta name="author" content="Ingchips Technology Co., Ltd." />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ch-qdec.html"/>
<link rel="next" href="ch-sysctrl.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ING20XX 系列芯片开发者手册</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 版本历史</a></li>
<li class="chapter" data-level="2" data-path="ch-overview.html"><a href="ch-overview.html"><i class="fa fa-check"></i><b>2</b> 概览</a>
<ul>
<li class="chapter" data-level="2.1" data-path="ch-overview.html"><a href="ch-overview.html#缩略语及术语"><i class="fa fa-check"></i><b>2.1</b> 缩略语及术语</a></li>
<li class="chapter" data-level="2.2" data-path="ch-overview.html"><a href="ch-overview.html#参考文档"><i class="fa fa-check"></i><b>2.2</b> 参考文档</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ch-adc.html"><a href="ch-adc.html"><i class="fa fa-check"></i><b>3</b> ADC简介</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ch-adc.html"><a href="ch-adc.html#功能描述"><i class="fa fa-check"></i><b>3.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="ch-adc.html"><a href="ch-adc.html#特点"><i class="fa fa-check"></i><b>3.1.1</b> 特点</a></li>
<li class="chapter" data-level="3.1.2" data-path="ch-adc.html"><a href="ch-adc.html#adc模式"><i class="fa fa-check"></i><b>3.1.2</b> ADC模式</a></li>
<li class="chapter" data-level="3.1.3" data-path="ch-adc.html"><a href="ch-adc.html#adc输入模式"><i class="fa fa-check"></i><b>3.1.3</b> ADC输入模式</a></li>
<li class="chapter" data-level="3.1.4" data-path="ch-adc.html"><a href="ch-adc.html#adc转换模式"><i class="fa fa-check"></i><b>3.1.4</b> ADC转换模式</a></li>
<li class="chapter" data-level="3.1.5" data-path="ch-adc.html"><a href="ch-adc.html#adc通道"><i class="fa fa-check"></i><b>3.1.5</b> ADC通道</a></li>
<li class="chapter" data-level="3.1.6" data-path="ch-adc.html"><a href="ch-adc.html#采样率"><i class="fa fa-check"></i><b>3.1.6</b> 采样率</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ch-adc.html"><a href="ch-adc.html#使用方法"><i class="fa fa-check"></i><b>3.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="ch-adc.html"><a href="ch-adc.html#时钟配置"><i class="fa fa-check"></i><b>3.2.1</b> 时钟配置</a></li>
<li class="chapter" data-level="3.2.2" data-path="ch-adc.html"><a href="ch-adc.html#adc参数配置"><i class="fa fa-check"></i><b>3.2.2</b> ADC参数配置</a></li>
<li class="chapter" data-level="3.2.3" data-path="ch-adc.html"><a href="ch-adc.html#adc数据处理"><i class="fa fa-check"></i><b>3.2.3</b> ADC数据处理</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ch-adc.html"><a href="ch-adc.html#编程指南"><i class="fa fa-check"></i><b>3.3</b> 编程指南</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="ch-adc.html"><a href="ch-adc.html#驱动接口"><i class="fa fa-check"></i><b>3.3.1</b> 驱动接口</a></li>
<li class="chapter" data-level="3.3.2" data-path="ch-adc.html"><a href="ch-adc.html#代码示例"><i class="fa fa-check"></i><b>3.3.2</b> 代码示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="ch-asdm.html"><a href="ch-asdm.html"><i class="fa fa-check"></i><b>4</b> ASDM简介</a>
<ul>
<li class="chapter" data-level="4.1" data-path="ch-asdm.html"><a href="ch-asdm.html#功能描述-1"><i class="fa fa-check"></i><b>4.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="ch-asdm.html"><a href="ch-asdm.html#特点-1"><i class="fa fa-check"></i><b>4.1.1</b> 特点</a></li>
<li class="chapter" data-level="4.1.2" data-path="ch-asdm.html"><a href="ch-asdm.html#性能"><i class="fa fa-check"></i><b>4.1.2</b> 性能</a></li>
<li class="chapter" data-level="4.1.3" data-path="ch-asdm.html"><a href="ch-asdm.html#引脚定义"><i class="fa fa-check"></i><b>4.1.3</b> 引脚定义</a></li>
<li class="chapter" data-level="4.1.4" data-path="ch-asdm.html"><a href="ch-asdm.html#采样率-1"><i class="fa fa-check"></i><b>4.1.4</b> 采样率</a></li>
<li class="chapter" data-level="4.1.5" data-path="ch-asdm.html"><a href="ch-asdm.html#模块功能简述"><i class="fa fa-check"></i><b>4.1.5</b> 模块功能简述</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="ch-asdm.html"><a href="ch-asdm.html#使用方法-1"><i class="fa fa-check"></i><b>4.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="ch-asdm.html"><a href="ch-asdm.html#时钟配置-1"><i class="fa fa-check"></i><b>4.2.1</b> 时钟配置</a></li>
<li class="chapter" data-level="4.2.2" data-path="ch-asdm.html"><a href="ch-asdm.html#设置电压偏置和vref输出滤波"><i class="fa fa-check"></i><b>4.2.2</b> 设置电压偏置和Vref输出滤波</a></li>
<li class="chapter" data-level="4.2.3" data-path="ch-asdm.html"><a href="ch-asdm.html#初始化配置"><i class="fa fa-check"></i><b>4.2.3</b> 初始化配置</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="ch-asdm.html"><a href="ch-asdm.html#编程指南-1"><i class="fa fa-check"></i><b>4.3</b> 编程指南</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="ch-asdm.html"><a href="ch-asdm.html#驱动接口-1"><i class="fa fa-check"></i><b>4.3.1</b> 驱动接口</a></li>
<li class="chapter" data-level="4.3.2" data-path="ch-asdm.html"><a href="ch-asdm.html#代码示例-1"><i class="fa fa-check"></i><b>4.3.2</b> 代码示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="ch-dma.html"><a href="ch-dma.html"><i class="fa fa-check"></i><b>5</b> DMA简介</a>
<ul>
<li class="chapter" data-level="5.1" data-path="ch-dma.html"><a href="ch-dma.html#功能描述-2"><i class="fa fa-check"></i><b>5.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="ch-dma.html"><a href="ch-dma.html#特点-2"><i class="fa fa-check"></i><b>5.1.1</b> 特点</a></li>
<li class="chapter" data-level="5.1.2" data-path="ch-dma.html"><a href="ch-dma.html#搬运方式"><i class="fa fa-check"></i><b>5.1.2</b> 搬运方式</a></li>
<li class="chapter" data-level="5.1.3" data-path="ch-dma.html"><a href="ch-dma.html#搬运类型"><i class="fa fa-check"></i><b>5.1.3</b> 搬运类型</a></li>
<li class="chapter" data-level="5.1.4" data-path="ch-dma.html"><a href="ch-dma.html#中断类型"><i class="fa fa-check"></i><b>5.1.4</b> 中断类型</a></li>
<li class="chapter" data-level="5.1.5" data-path="ch-dma.html"><a href="ch-dma.html#数据地址类型"><i class="fa fa-check"></i><b>5.1.5</b> 数据地址类型</a></li>
<li class="chapter" data-level="5.1.6" data-path="ch-dma.html"><a href="ch-dma.html#数据方式"><i class="fa fa-check"></i><b>5.1.6</b> 数据方式</a></li>
<li class="chapter" data-level="5.1.7" data-path="ch-dma.html"><a href="ch-dma.html#数据位宽"><i class="fa fa-check"></i><b>5.1.7</b> 数据位宽</a></li>
<li class="chapter" data-level="5.1.8" data-path="ch-dma.html"><a href="ch-dma.html#总线仲裁"><i class="fa fa-check"></i><b>5.1.8</b> 总线仲裁</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="ch-dma.html"><a href="ch-dma.html#使用方法-2"><i class="fa fa-check"></i><b>5.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="ch-dma.html"><a href="ch-dma.html#方法概述"><i class="fa fa-check"></i><b>5.2.1</b> 方法概述</a></li>
<li class="chapter" data-level="5.2.2" data-path="ch-dma.html"><a href="ch-dma.html#注意点"><i class="fa fa-check"></i><b>5.2.2</b> 注意点</a></li>
<li class="chapter" data-level="5.2.3" data-path="ch-dma.html"><a href="ch-dma.html#握手请求"><i class="fa fa-check"></i><b>5.2.3</b> 握手请求</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="ch-dma.html"><a href="ch-dma.html#编程指南-2"><i class="fa fa-check"></i><b>5.3</b> 编程指南</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="ch-dma.html"><a href="ch-dma.html#驱动接口-2"><i class="fa fa-check"></i><b>5.3.1</b> 驱动接口</a></li>
<li class="chapter" data-level="5.3.2" data-path="ch-dma.html"><a href="ch-dma.html#代码示例-2"><i class="fa fa-check"></i><b>5.3.2</b> 代码示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="ch-gpio.html"><a href="ch-gpio.html"><i class="fa fa-check"></i><b>6</b> 通用输入输出（GPIO）</a>
<ul>
<li class="chapter" data-level="6.1" data-path="ch-gpio.html"><a href="ch-gpio.html#功能概述"><i class="fa fa-check"></i><b>6.1</b> 功能概述</a></li>
<li class="chapter" data-level="6.2" data-path="ch-gpio.html"><a href="ch-gpio.html#使用说明"><i class="fa fa-check"></i><b>6.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="ch-gpio.html"><a href="ch-gpio.html#设置-io-方向"><i class="fa fa-check"></i><b>6.2.1</b> 设置 IO 方向</a></li>
<li class="chapter" data-level="6.2.2" data-path="ch-gpio.html"><a href="ch-gpio.html#读取输入"><i class="fa fa-check"></i><b>6.2.2</b> 读取输入</a></li>
<li class="chapter" data-level="6.2.3" data-path="ch-gpio.html"><a href="ch-gpio.html#设置输出"><i class="fa fa-check"></i><b>6.2.3</b> 设置输出</a></li>
<li class="chapter" data-level="6.2.4" data-path="ch-gpio.html"><a href="ch-gpio.html#配置中断请求"><i class="fa fa-check"></i><b>6.2.4</b> 配置中断请求</a></li>
<li class="chapter" data-level="6.2.5" data-path="ch-gpio.html"><a href="ch-gpio.html#处理中断状态"><i class="fa fa-check"></i><b>6.2.5</b> 处理中断状态</a></li>
<li class="chapter" data-level="6.2.6" data-path="ch-gpio.html"><a href="ch-gpio.html#输入去抖"><i class="fa fa-check"></i><b>6.2.6</b> 输入去抖</a></li>
<li class="chapter" data-level="6.2.7" data-path="ch-gpio.html"><a href="ch-gpio.html#低功耗保持状态"><i class="fa fa-check"></i><b>6.2.7</b> 低功耗保持状态</a></li>
<li class="chapter" data-level="6.2.8" data-path="ch-gpio.html"><a href="ch-gpio.html#睡眠唤醒源"><i class="fa fa-check"></i><b>6.2.8</b> 睡眠唤醒源</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="ch-iic.html"><a href="ch-iic.html"><i class="fa fa-check"></i><b>7</b> I2C总线</a>
<ul>
<li class="chapter" data-level="7.1" data-path="ch-iic.html"><a href="ch-iic.html#功能概述-1"><i class="fa fa-check"></i><b>7.1</b> 功能概述</a></li>
<li class="chapter" data-level="7.2" data-path="ch-iic.html"><a href="ch-iic.html#使用说明-1"><i class="fa fa-check"></i><b>7.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="ch-iic.html"><a href="ch-iic.html#iic_i2c_blocking"><i class="fa fa-check"></i><b>7.2.1</b> 方法1（blocking）</a></li>
<li class="chapter" data-level="7.2.2" data-path="ch-iic.html"><a href="ch-iic.html#iic_i2c_interrupt"><i class="fa fa-check"></i><b>7.2.2</b> 方法2（Interrupt）</a></li>
<li class="chapter" data-level="7.2.3" data-path="ch-iic.html"><a href="ch-iic.html#时钟配置-2"><i class="fa fa-check"></i><b>7.2.3</b> 时钟配置</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ch-I2S.html"><a href="ch-I2S.html"><i class="fa fa-check"></i><b>8</b> I2S简介</a>
<ul>
<li class="chapter" data-level="8.1" data-path="ch-I2S.html"><a href="ch-I2S.html#功能描述-3"><i class="fa fa-check"></i><b>8.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="ch-I2S.html"><a href="ch-I2S.html#特点-3"><i class="fa fa-check"></i><b>8.1.1</b> 特点</a></li>
<li class="chapter" data-level="8.1.2" data-path="ch-I2S.html"><a href="ch-I2S.html#i2s角色"><i class="fa fa-check"></i><b>8.1.2</b> I2S角色</a></li>
<li class="chapter" data-level="8.1.3" data-path="ch-I2S.html"><a href="ch-I2S.html#i2s工作模式"><i class="fa fa-check"></i><b>8.1.3</b> I2S工作模式</a></li>
<li class="chapter" data-level="8.1.4" data-path="ch-I2S.html"><a href="ch-I2S.html#串行数据"><i class="fa fa-check"></i><b>8.1.4</b> 串行数据</a></li>
<li class="chapter" data-level="8.1.5" data-path="ch-I2S.html"><a href="ch-I2S.html#时钟分频"><i class="fa fa-check"></i><b>8.1.5</b> 时钟分频</a></li>
<li class="chapter" data-level="8.1.6" data-path="ch-I2S.html"><a href="ch-I2S.html#i2s存储器"><i class="fa fa-check"></i><b>8.1.6</b> I2S存储器</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="ch-I2S.html"><a href="ch-I2S.html#使用方法-3"><i class="fa fa-check"></i><b>8.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="ch-I2S.html"><a href="ch-I2S.html#方法概述-1"><i class="fa fa-check"></i><b>8.2.1</b> 方法概述</a></li>
<li class="chapter" data-level="8.2.2" data-path="ch-I2S.html"><a href="ch-I2S.html#注意点-1"><i class="fa fa-check"></i><b>8.2.2</b> 注意点</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="ch-I2S.html"><a href="ch-I2S.html#编程指南-4"><i class="fa fa-check"></i><b>8.3</b> 编程指南</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="ch-I2S.html"><a href="ch-I2S.html#驱动接口-3"><i class="fa fa-check"></i><b>8.3.1</b> 驱动接口</a></li>
<li class="chapter" data-level="8.3.2" data-path="ch-I2S.html"><a href="ch-I2S.html#代码示例-3"><i class="fa fa-check"></i><b>8.3.2</b> 代码示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ch-keyscan.html"><a href="ch-keyscan.html"><i class="fa fa-check"></i><b>9</b> 硬件键盘扫描控制器（KEYSCAN）</a>
<ul>
<li class="chapter" data-level="9.1" data-path="ch-keyscan.html"><a href="ch-keyscan.html#功能概述-2"><i class="fa fa-check"></i><b>9.1</b> 功能概述</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="ch-keyscan.html"><a href="ch-keyscan.html#特性"><i class="fa fa-check"></i><b>9.1.1</b> 特性：</a></li>
<li class="chapter" data-level="9.1.2" data-path="ch-keyscan.html"><a href="ch-keyscan.html#功能简述"><i class="fa fa-check"></i><b>9.1.2</b> 功能简述</a></li>
<li class="chapter" data-level="9.1.3" data-path="ch-keyscan.html"><a href="ch-keyscan.html#lpkey模式"><i class="fa fa-check"></i><b>9.1.3</b> LPkey模式</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="ch-keyscan.html"><a href="ch-keyscan.html#使用说明-2"><i class="fa fa-check"></i><b>9.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="ch-keyscan.html"><a href="ch-keyscan.html#键盘矩阵的软件描述"><i class="fa fa-check"></i><b>9.2.1</b> 键盘矩阵的软件描述</a></li>
<li class="chapter" data-level="9.2.2" data-path="ch-keyscan.html"><a href="ch-keyscan.html#keyscan模块初始化"><i class="fa fa-check"></i><b>9.2.2</b> KEYSCAN模块初始化</a></li>
<li class="chapter" data-level="9.2.3" data-path="ch-keyscan.html"><a href="ch-keyscan.html#获取扫描到的按键"><i class="fa fa-check"></i><b>9.2.3</b> 获取扫描到的按键</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="ch-keyscan.html"><a href="ch-keyscan.html#应用举例"><i class="fa fa-check"></i><b>9.3</b> 应用举例</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="ch-keyscan.html"><a href="ch-keyscan.html#初始化keyscan模块"><i class="fa fa-check"></i><b>9.3.1</b> 初始化KEYSCAN模块</a></li>
<li class="chapter" data-level="9.3.2" data-path="ch-keyscan.html"><a href="ch-keyscan.html#中断数据处理"><i class="fa fa-check"></i><b>9.3.2</b> 中断数据处理</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html"><i class="fa fa-check"></i><b>10</b> 管脚管理（PINCTRL）</a>
<ul>
<li class="chapter" data-level="10.1" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#功能概述-3"><i class="fa fa-check"></i><b>10.1</b> 功能概述</a></li>
<li class="chapter" data-level="10.2" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#使用说明-3"><i class="fa fa-check"></i><b>10.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#为外设配置-io-管脚"><i class="fa fa-check"></i><b>10.2.1</b> 为外设配置 IO 管脚</a></li>
<li class="chapter" data-level="10.2.2" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#ch-pinctrl-pull"><i class="fa fa-check"></i><b>10.2.2</b> 配置上拉、下拉</a></li>
<li class="chapter" data-level="10.2.3" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#配置驱动能力"><i class="fa fa-check"></i><b>10.2.3</b> 配置驱动能力</a></li>
<li class="chapter" data-level="10.2.4" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#配置天线切换控制管脚"><i class="fa fa-check"></i><b>10.2.4</b> 配置天线切换控制管脚</a></li>
<li class="chapter" data-level="10.2.5" data-path="ch-pinctrl.html"><a href="ch-pinctrl.html#pinctrl-config-analog"><i class="fa fa-check"></i><b>10.2.5</b> 配置模拟模式</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ch-pwm.html"><a href="ch-pwm.html"><i class="fa fa-check"></i><b>11</b> 增强型脉宽调制发生器（PWM）</a>
<ul>
<li class="chapter" data-level="11.1" data-path="ch-pwm.html"><a href="ch-pwm.html#pwm-工作模式"><i class="fa fa-check"></i><b>11.1</b> PWM 工作模式</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="ch-pwm.html"><a href="ch-pwm.html#最简单的模式up_without_died_zone"><i class="fa fa-check"></i><b>11.1.1</b> 最简单的模式：UP_WITHOUT_DIED_ZONE</a></li>
<li class="chapter" data-level="11.1.2" data-path="ch-pwm.html"><a href="ch-pwm.html#up_with_died_zone"><i class="fa fa-check"></i><b>11.1.2</b> UP_WITH_DIED_ZONE</a></li>
<li class="chapter" data-level="11.1.3" data-path="ch-pwm.html"><a href="ch-pwm.html#updown_without_died_zone"><i class="fa fa-check"></i><b>11.1.3</b> UPDOWN_WITHOUT_DIED_ZONE</a></li>
<li class="chapter" data-level="11.1.4" data-path="ch-pwm.html"><a href="ch-pwm.html#updown_with_died_zone"><i class="fa fa-check"></i><b>11.1.4</b> UPDOWN_WITH_DIED_ZONE</a></li>
<li class="chapter" data-level="11.1.5" data-path="ch-pwm.html"><a href="ch-pwm.html#single_without_died_zone"><i class="fa fa-check"></i><b>11.1.5</b> SINGLE_WITHOUT_DIED_ZONE</a></li>
<li class="chapter" data-level="11.1.6" data-path="ch-pwm.html"><a href="ch-pwm.html#dma-模式"><i class="fa fa-check"></i><b>11.1.6</b> DMA 模式</a></li>
<li class="chapter" data-level="11.1.7" data-path="ch-pwm.html"><a href="ch-pwm.html#输出控制"><i class="fa fa-check"></i><b>11.1.7</b> 输出控制</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="ch-pwm.html"><a href="ch-pwm.html#pcap"><i class="fa fa-check"></i><b>11.2</b> PCAP</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="ch-pwm.html"><a href="ch-pwm.html#ir模式"><i class="fa fa-check"></i><b>11.2.1</b> IR模式</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="ch-pwm.html"><a href="ch-pwm.html#pwm-使用说明"><i class="fa fa-check"></i><b>11.3</b> PWM 使用说明</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="ch-pwm.html"><a href="ch-pwm.html#启动与停止"><i class="fa fa-check"></i><b>11.3.1</b> 启动与停止</a></li>
<li class="chapter" data-level="11.3.2" data-path="ch-pwm.html"><a href="ch-pwm.html#配置工作模式"><i class="fa fa-check"></i><b>11.3.2</b> 配置工作模式</a></li>
<li class="chapter" data-level="11.3.3" data-path="ch-pwm.html"><a href="ch-pwm.html#配置门限"><i class="fa fa-check"></i><b>11.3.3</b> 配置门限</a></li>
<li class="chapter" data-level="11.3.4" data-path="ch-pwm.html"><a href="ch-pwm.html#输出控制-1"><i class="fa fa-check"></i><b>11.3.4</b> 输出控制</a></li>
<li class="chapter" data-level="11.3.5" data-path="ch-pwm.html"><a href="ch-pwm.html#综合示例"><i class="fa fa-check"></i><b>11.3.5</b> 综合示例</a></li>
<li class="chapter" data-level="11.3.6" data-path="ch-pwm.html"><a href="ch-pwm.html#使用-dma-实时更新配置"><i class="fa fa-check"></i><b>11.3.6</b> 使用 DMA 实时更新配置</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="ch-pwm.html"><a href="ch-pwm.html#pcap-使用说明"><i class="fa fa-check"></i><b>11.4</b> PCAP 使用说明</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="ch-pwm.html"><a href="ch-pwm.html#配置-pcap-模式"><i class="fa fa-check"></i><b>11.4.1</b> 配置 PCAP 模式</a></li>
<li class="chapter" data-level="11.4.2" data-path="ch-pwm.html"><a href="ch-pwm.html#读取计数器"><i class="fa fa-check"></i><b>11.4.2</b> 读取计数器</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="ch-pwm.html"><a href="ch-pwm.html#ir模式示例"><i class="fa fa-check"></i><b>11.5</b> IR模式示例</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="ch-pwm.html"><a href="ch-pwm.html#ir-发送模式"><i class="fa fa-check"></i><b>11.5.1</b> IR 发送模式</a></li>
<li class="chapter" data-level="11.5.2" data-path="ch-pwm.html"><a href="ch-pwm.html#ir接收模式"><i class="fa fa-check"></i><b>11.5.2</b> IR接收模式</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="ch-qdec.html"><a href="ch-qdec.html"><i class="fa fa-check"></i><b>12</b> QDEC简介</a>
<ul>
<li class="chapter" data-level="12.1" data-path="ch-qdec.html"><a href="ch-qdec.html#功能描述-4"><i class="fa fa-check"></i><b>12.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="ch-qdec.html"><a href="ch-qdec.html#特点-4"><i class="fa fa-check"></i><b>12.1.1</b> 特点</a></li>
<li class="chapter" data-level="12.1.2" data-path="ch-qdec.html"><a href="ch-qdec.html#正转和反转"><i class="fa fa-check"></i><b>12.1.2</b> 正转和反转</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="ch-qdec.html"><a href="ch-qdec.html#使用方法-4"><i class="fa fa-check"></i><b>12.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="ch-qdec.html"><a href="ch-qdec.html#方法概述-2"><i class="fa fa-check"></i><b>12.2.1</b> 方法概述</a></li>
<li class="chapter" data-level="12.2.2" data-path="ch-qdec.html"><a href="ch-qdec.html#注意点-2"><i class="fa fa-check"></i><b>12.2.2</b> 注意点</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="ch-qdec.html"><a href="ch-qdec.html#编程指南-5"><i class="fa fa-check"></i><b>12.3</b> 编程指南</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="ch-qdec.html"><a href="ch-qdec.html#驱动接口-4"><i class="fa fa-check"></i><b>12.3.1</b> 驱动接口</a></li>
<li class="chapter" data-level="12.3.2" data-path="ch-qdec.html"><a href="ch-qdec.html#代码示例-4"><i class="fa fa-check"></i><b>12.3.2</b> 代码示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="ch-spi.html"><a href="ch-spi.html"><i class="fa fa-check"></i><b>13</b> 串行外围设备接口（SPI）</a>
<ul>
<li class="chapter" data-level="13.1" data-path="ch-spi.html"><a href="ch-spi.html#功能概述-4"><i class="fa fa-check"></i><b>13.1</b> 功能概述</a></li>
<li class="chapter" data-level="13.2" data-path="ch-spi.html"><a href="ch-spi.html#使用说明-4"><i class="fa fa-check"></i><b>13.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="ch-spi.html"><a href="ch-spi.html#时钟以及io配置"><i class="fa fa-check"></i><b>13.2.1</b> 时钟以及IO配置</a></li>
<li class="chapter" data-level="13.2.2" data-path="ch-spi.html"><a href="ch-spi.html#模块初始化-1"><i class="fa fa-check"></i><b>13.2.2</b> 模块初始化</a></li>
<li class="chapter" data-level="13.2.3" data-path="ch-spi.html"><a href="ch-spi.html#中断配置-1"><i class="fa fa-check"></i><b>13.2.3</b> 中断配置</a></li>
<li class="chapter" data-level="13.2.4" data-path="ch-spi.html"><a href="ch-spi.html#编程指南-6"><i class="fa fa-check"></i><b>13.2.4</b> 编程指南</a></li>
<li class="chapter" data-level="13.2.5" data-path="ch-spi.html"><a href="ch-spi.html#其他配置"><i class="fa fa-check"></i><b>13.2.5</b> 其他配置</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html"><i class="fa fa-check"></i><b>14</b> 系统控制（SYSCTRL）</a>
<ul>
<li class="chapter" data-level="14.1" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#功能概述-5"><i class="fa fa-check"></i><b>14.1</b> 功能概述</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#外设标识"><i class="fa fa-check"></i><b>14.1.1</b> 外设标识</a></li>
<li class="chapter" data-level="14.1.2" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#时钟树"><i class="fa fa-check"></i><b>14.1.2</b> 时钟树</a></li>
<li class="chapter" data-level="14.1.3" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#dma-规划"><i class="fa fa-check"></i><b>14.1.3</b> DMA 规划</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#使用说明-5"><i class="fa fa-check"></i><b>14.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#外设复位"><i class="fa fa-check"></i><b>14.2.1</b> 外设复位</a></li>
<li class="chapter" data-level="14.2.2" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#时钟门控"><i class="fa fa-check"></i><b>14.2.2</b> 时钟门控</a></li>
<li class="chapter" data-level="14.2.3" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#时钟配置-4"><i class="fa fa-check"></i><b>14.2.3</b> 时钟配置</a></li>
<li class="chapter" data-level="14.2.4" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#dma-规划-1"><i class="fa fa-check"></i><b>14.2.4</b> DMA 规划</a></li>
<li class="chapter" data-level="14.2.5" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#唤醒后的时钟配置"><i class="fa fa-check"></i><b>14.2.5</b> 唤醒后的时钟配置</a></li>
<li class="chapter" data-level="14.2.6" data-path="ch-sysctrl.html"><a href="ch-sysctrl.html#ram-相关"><i class="fa fa-check"></i><b>14.2.6</b> RAM 相关</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="ch-timer.html"><a href="ch-timer.html"><i class="fa fa-check"></i><b>15</b> 定时器（TIMER）</a>
<ul>
<li class="chapter" data-level="15.1" data-path="ch-timer.html"><a href="ch-timer.html#功能概述-6"><i class="fa fa-check"></i><b>15.1</b> 功能概述</a></li>
<li class="chapter" data-level="15.2" data-path="ch-timer.html"><a href="ch-timer.html#使用说明-6"><i class="fa fa-check"></i><b>15.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="ch-timer.html"><a href="ch-timer.html#设置timer工作模式"><i class="fa fa-check"></i><b>15.2.1</b> 设置TIMER工作模式</a></li>
<li class="chapter" data-level="15.2.2" data-path="ch-timer.html"><a href="ch-timer.html#获取时钟频率"><i class="fa fa-check"></i><b>15.2.2</b> 获取时钟频率</a></li>
<li class="chapter" data-level="15.2.3" data-path="ch-timer.html"><a href="ch-timer.html#重载值"><i class="fa fa-check"></i><b>15.2.3</b> 重载值</a></li>
<li class="chapter" data-level="15.2.4" data-path="ch-timer.html"><a href="ch-timer.html#使能timer"><i class="fa fa-check"></i><b>15.2.4</b> 使能TIMER</a></li>
<li class="chapter" data-level="15.2.5" data-path="ch-timer.html"><a href="ch-timer.html#获取timer的比较值"><i class="fa fa-check"></i><b>15.2.5</b> 获取TIMER的比较值</a></li>
<li class="chapter" data-level="15.2.6" data-path="ch-timer.html"><a href="ch-timer.html#获取timer的计数器值"><i class="fa fa-check"></i><b>15.2.6</b> 获取TIMER的计数器值</a></li>
<li class="chapter" data-level="15.2.7" data-path="ch-timer.html"><a href="ch-timer.html#计时器暂停"><i class="fa fa-check"></i><b>15.2.7</b> 计时器暂停</a></li>
<li class="chapter" data-level="15.2.8" data-path="ch-timer.html"><a href="ch-timer.html#配置中断请求-1"><i class="fa fa-check"></i><b>15.2.8</b> 配置中断请求</a></li>
<li class="chapter" data-level="15.2.9" data-path="ch-timer.html"><a href="ch-timer.html#处理中断状态-1"><i class="fa fa-check"></i><b>15.2.9</b> 处理中断状态</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="ch-timer.html"><a href="ch-timer.html#使用示例"><i class="fa fa-check"></i><b>15.3</b> 使用示例</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="ch-timer.html"><a href="ch-timer.html#使用计时器功能及暂停功能"><i class="fa fa-check"></i><b>15.3.1</b> 使用计时器功能及暂停功能</a></li>
<li class="chapter" data-level="15.3.2" data-path="ch-timer.html"><a href="ch-timer.html#使用timer的pwm功能"><i class="fa fa-check"></i><b>15.3.2</b> 使用TIMER的PWM功能</a></li>
<li class="chapter" data-level="15.3.3" data-path="ch-timer.html"><a href="ch-timer.html#通道0产生2个周期性中断"><i class="fa fa-check"></i><b>15.3.3</b> 通道0产生2个周期性中断</a></li>
<li class="chapter" data-level="15.3.4" data-path="ch-timer.html"><a href="ch-timer.html#产生2路对齐的pwm信号"><i class="fa fa-check"></i><b>15.3.4</b> 产生2路对齐的PWM信号</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="ch-uart.html"><a href="ch-uart.html"><i class="fa fa-check"></i><b>16</b> 通用异步收发传输器（UART）</a>
<ul>
<li class="chapter" data-level="16.1" data-path="ch-uart.html"><a href="ch-uart.html#功能概述-7"><i class="fa fa-check"></i><b>16.1</b> 功能概述</a></li>
<li class="chapter" data-level="16.2" data-path="ch-uart.html"><a href="ch-uart.html#使用说明-7"><i class="fa fa-check"></i><b>16.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="ch-uart.html"><a href="ch-uart.html#设置波特率"><i class="fa fa-check"></i><b>16.2.1</b> 设置波特率</a></li>
<li class="chapter" data-level="16.2.2" data-path="ch-uart.html"><a href="ch-uart.html#获取波特率"><i class="fa fa-check"></i><b>16.2.2</b> 获取波特率</a></li>
<li class="chapter" data-level="16.2.3" data-path="ch-uart.html"><a href="ch-uart.html#ch-uart-initial"><i class="fa fa-check"></i><b>16.2.3</b> UART初始化</a></li>
<li class="chapter" data-level="16.2.4" data-path="ch-uart.html"><a href="ch-uart.html#uart轮询模式"><i class="fa fa-check"></i><b>16.2.4</b> UART轮询模式</a></li>
<li class="chapter" data-level="16.2.5" data-path="ch-uart.html"><a href="ch-uart.html#uart中断使能禁用"><i class="fa fa-check"></i><b>16.2.5</b> UART中断使能/禁用</a></li>
<li class="chapter" data-level="16.2.6" data-path="ch-uart.html"><a href="ch-uart.html#处理中断状态-2"><i class="fa fa-check"></i><b>16.2.6</b> 处理中断状态</a></li>
<li class="chapter" data-level="16.2.7" data-path="ch-uart.html"><a href="ch-uart.html#uart-fifo中断触发逻辑"><i class="fa fa-check"></i><b>16.2.7</b> UART FIFO中断触发逻辑</a></li>
<li class="chapter" data-level="16.2.8" data-path="ch-uart.html"><a href="ch-uart.html#发送数据"><i class="fa fa-check"></i><b>16.2.8</b> 发送数据</a></li>
<li class="chapter" data-level="16.2.9" data-path="ch-uart.html"><a href="ch-uart.html#接收数据"><i class="fa fa-check"></i><b>16.2.9</b> 接收数据</a></li>
<li class="chapter" data-level="16.2.10" data-path="ch-uart.html"><a href="ch-uart.html#dma传输模式使能"><i class="fa fa-check"></i><b>16.2.10</b> DMA传输模式使能</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="ch-uart.html"><a href="ch-uart.html#示例代码"><i class="fa fa-check"></i><b>16.3</b> 示例代码</a>
<ul>
<li class="chapter" data-level="16.3.1" data-path="ch-uart.html"><a href="ch-uart.html#uart接收变长字节数据"><i class="fa fa-check"></i><b>16.3.1</b> UART接收变长字节数据</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="ch-usb.html"><a href="ch-usb.html"><i class="fa fa-check"></i><b>17</b> 通用串行总线 (USB)</a>
<ul>
<li class="chapter" data-level="17.1" data-path="ch-usb.html"><a href="ch-usb.html#功能概述-8"><i class="fa fa-check"></i><b>17.1</b> 功能概述</a></li>
<li class="chapter" data-level="17.2" data-path="ch-usb.html"><a href="ch-usb.html#使用说明-8"><i class="fa fa-check"></i><b>17.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="ch-usb.html"><a href="ch-usb.html#usb软件结构"><i class="fa fa-check"></i><b>17.2.1</b> USB软件结构</a></li>
<li class="chapter" data-level="17.2.2" data-path="ch-usb.html"><a href="ch-usb.html#usb-device-状态"><i class="fa fa-check"></i><b>17.2.2</b> USB Device 状态</a></li>
<li class="chapter" data-level="17.2.3" data-path="ch-usb.html"><a href="ch-usb.html#设置-io"><i class="fa fa-check"></i><b>17.2.3</b> 设置 IO</a></li>
<li class="chapter" data-level="17.2.4" data-path="ch-usb.html"><a href="ch-usb.html#设置-phy"><i class="fa fa-check"></i><b>17.2.4</b> 设置 PHY</a></li>
<li class="chapter" data-level="17.2.5" data-path="ch-usb.html"><a href="ch-usb.html#usb-模块初始化"><i class="fa fa-check"></i><b>17.2.5</b> USB 模块初始化</a></li>
<li class="chapter" data-level="17.2.6" data-path="ch-usb.html"><a href="ch-usb.html#event-handler"><i class="fa fa-check"></i><b>17.2.6</b> event handler</a></li>
<li class="chapter" data-level="17.2.7" data-path="ch-usb.html"><a href="ch-usb.html#常用driver-api"><i class="fa fa-check"></i><b>17.2.7</b> 常用driver API</a></li>
<li class="chapter" data-level="17.2.8" data-path="ch-usb.html"><a href="ch-usb.html#使用场景"><i class="fa fa-check"></i><b>17.2.8</b> 使用场景</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="ch-watchdog.html"><a href="ch-watchdog.html"><i class="fa fa-check"></i><b>18</b> 看门狗（WATCHDOG）</a>
<ul>
<li class="chapter" data-level="18.1" data-path="ch-watchdog.html"><a href="ch-watchdog.html#功能概述-9"><i class="fa fa-check"></i><b>18.1</b> 功能概述</a></li>
<li class="chapter" data-level="18.2" data-path="ch-watchdog.html"><a href="ch-watchdog.html#使用说明-9"><i class="fa fa-check"></i><b>18.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="ch-watchdog.html"><a href="ch-watchdog.html#配置看门狗"><i class="fa fa-check"></i><b>18.2.1</b> 配置看门狗</a></li>
<li class="chapter" data-level="18.2.2" data-path="ch-watchdog.html"><a href="ch-watchdog.html#重启看门狗"><i class="fa fa-check"></i><b>18.2.2</b> 重启看门狗</a></li>
<li class="chapter" data-level="18.2.3" data-path="ch-watchdog.html"><a href="ch-watchdog.html#清除中断"><i class="fa fa-check"></i><b>18.2.3</b> 清除中断</a></li>
<li class="chapter" data-level="18.2.4" data-path="ch-watchdog.html"><a href="ch-watchdog.html#禁用看门狗"><i class="fa fa-check"></i><b>18.2.4</b> 禁用看门狗</a></li>
<li class="chapter" data-level="18.2.5" data-path="ch-watchdog.html"><a href="ch-watchdog.html#暂停看门狗"><i class="fa fa-check"></i><b>18.2.5</b> 暂停看门狗</a></li>
<li class="chapter" data-level="18.2.6" data-path="ch-watchdog.html"><a href="ch-watchdog.html#处理中断状态-3"><i class="fa fa-check"></i><b>18.2.6</b> 处理中断状态</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="ch-eflash.html"><a href="ch-eflash.html"><i class="fa fa-check"></i><b>19</b> 内置 Flash（EFlash）</a>
<ul>
<li class="chapter" data-level="19.1" data-path="ch-eflash.html"><a href="ch-eflash.html#功能概述-10"><i class="fa fa-check"></i><b>19.1</b> 功能概述</a></li>
<li class="chapter" data-level="19.2" data-path="ch-eflash.html"><a href="ch-eflash.html#使用说明-10"><i class="fa fa-check"></i><b>19.2</b> 使用说明</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="ch-eflash.html"><a href="ch-eflash.html#擦除并写入新数据"><i class="fa fa-check"></i><b>19.2.1</b> 擦除并写入新数据</a></li>
<li class="chapter" data-level="19.2.2" data-path="ch-eflash.html"><a href="ch-eflash.html#不擦除直接写入数据"><i class="fa fa-check"></i><b>19.2.2</b> 不擦除直接写入数据</a></li>
<li class="chapter" data-level="19.2.3" data-path="ch-eflash.html"><a href="ch-eflash.html#单独擦除"><i class="fa fa-check"></i><b>19.2.3</b> 单独擦除</a></li>
<li class="chapter" data-level="19.2.4" data-path="ch-eflash.html"><a href="ch-eflash.html#flash-数据升级"><i class="fa fa-check"></i><b>19.2.4</b> Flash 数据升级</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="ch-rtimer.html"><a href="ch-rtimer.html"><i class="fa fa-check"></i><b>20</b> RTIMER简介 （Reduce Timer）</a>
<ul>
<li class="chapter" data-level="20.1" data-path="ch-rtimer.html"><a href="ch-rtimer.html#功能描述-5"><i class="fa fa-check"></i><b>20.1</b> 功能描述</a>
<ul>
<li class="chapter" data-level="20.1.1" data-path="ch-rtimer.html"><a href="ch-rtimer.html#特性-1"><i class="fa fa-check"></i><b>20.1.1</b> 特性</a></li>
<li class="chapter" data-level="20.1.2" data-path="ch-rtimer.html"><a href="ch-rtimer.html#工作模式"><i class="fa fa-check"></i><b>20.1.2</b> 工作模式</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="ch-rtimer.html"><a href="ch-rtimer.html#使用方法-5"><i class="fa fa-check"></i><b>20.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="20.2.1" data-path="ch-rtimer.html"><a href="ch-rtimer.html#api参考"><i class="fa fa-check"></i><b>20.2.1</b> API参考</a></li>
<li class="chapter" data-level="20.2.2" data-path="ch-rtimer.html"><a href="ch-rtimer.html#使用示例-1"><i class="fa fa-check"></i><b>20.2.2</b> 使用示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="ch-pte.html"><a href="ch-pte.html"><i class="fa fa-check"></i><b>21</b> PTE简介 （Peripheral-Trigger-Engine）</a>
<ul>
<li class="chapter" data-level="21.1" data-path="ch-pte.html"><a href="ch-pte.html#pte功能描述"><i class="fa fa-check"></i><b>21.1</b> PTE功能描述</a>
<ul>
<li class="chapter" data-level="21.1.1" data-path="ch-pte.html"><a href="ch-pte.html#特性-2"><i class="fa fa-check"></i><b>21.1.1</b> 特性</a></li>
<li class="chapter" data-level="21.1.2" data-path="ch-pte.html"><a href="ch-pte.html#pte外设通道连接特性"><i class="fa fa-check"></i><b>21.1.2</b> PTE外设通道连接特性</a></li>
<li class="chapter" data-level="21.1.3" data-path="ch-pte.html"><a href="ch-pte.html#pte模块通道的使能和分组"><i class="fa fa-check"></i><b>21.1.3</b> PTE模块通道的使能和分组</a></li>
<li class="chapter" data-level="21.1.4" data-path="ch-pte.html"><a href="ch-pte.html#pte事件接收器"><i class="fa fa-check"></i><b>21.1.4</b> PTE事件接收器</a></li>
<li class="chapter" data-level="21.1.5" data-path="ch-pte.html"><a href="ch-pte.html#pte任务发布器"><i class="fa fa-check"></i><b>21.1.5</b> PTE任务发布器</a></li>
<li class="chapter" data-level="21.1.6" data-path="ch-pte.html"><a href="ch-pte.html#pte分组"><i class="fa fa-check"></i><b>21.1.6</b> PTE分组</a></li>
</ul></li>
<li class="chapter" data-level="21.2" data-path="ch-pte.html"><a href="ch-pte.html#使用方法-6"><i class="fa fa-check"></i><b>21.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="21.2.1" data-path="ch-pte.html"><a href="ch-pte.html#api介绍"><i class="fa fa-check"></i><b>21.2.1</b> API介绍</a></li>
<li class="chapter" data-level="21.2.2" data-path="ch-pte.html"><a href="ch-pte.html#示例代码-1"><i class="fa fa-check"></i><b>21.2.2</b> 示例代码</a></li>
<li class="chapter" data-level="21.2.3" data-path="ch-pte.html"><a href="ch-pte.html#使用示例-2"><i class="fa fa-check"></i><b>21.2.3</b> 使用示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22" data-path="ch-gpiote.html"><a href="ch-gpiote.html"><i class="fa fa-check"></i><b>22</b> GPIOTE简介 （GPIO tasks and events）</a>
<ul>
<li class="chapter" data-level="22.1" data-path="ch-gpiote.html"><a href="ch-gpiote.html#gpiote-功能描述"><i class="fa fa-check"></i><b>22.1</b> GPIOTE 功能描述</a>
<ul>
<li class="chapter" data-level="22.1.1" data-path="ch-gpiote.html"><a href="ch-gpiote.html#模块特性"><i class="fa fa-check"></i><b>22.1.1</b> 模块特性</a></li>
<li class="chapter" data-level="22.1.2" data-path="ch-gpiote.html"><a href="ch-gpiote.html#连接特性"><i class="fa fa-check"></i><b>22.1.2</b> 连接特性</a></li>
<li class="chapter" data-level="22.1.3" data-path="ch-gpiote.html"><a href="ch-gpiote.html#设计概述"><i class="fa fa-check"></i><b>22.1.3</b> 设计概述</a></li>
</ul></li>
<li class="chapter" data-level="22.2" data-path="ch-gpiote.html"><a href="ch-gpiote.html#使用方法-7"><i class="fa fa-check"></i><b>22.2</b> 使用方法</a>
<ul>
<li class="chapter" data-level="22.2.1" data-path="ch-gpiote.html"><a href="ch-gpiote.html#api概述"><i class="fa fa-check"></i><b>22.2.1</b> API概述</a></li>
<li class="chapter" data-level="22.2.2" data-path="ch-gpiote.html"><a href="ch-gpiote.html#使用示例-3"><i class="fa fa-check"></i><b>22.2.2</b> 使用示例</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ING20XX 系列芯片外设开发者手册</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ch-spi" class="section level1 hasAnchor" number="13">
<h1><span class="header-section-number">13</span> 串行外围设备接口（SPI）<a href="ch-spi.html#ch-spi" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>SPI全称为Serial Peripheral interface即串行外围设备接口。 SPI是一种高速同步的通信总线。一般使用四个IO：SDI（数据输入），SDO（数据输出），SCK（时钟），CS（片选）。针对Flash的QSPI则还需要使用额外的两个IO：WP（写保护），HOLD（保持）。</p>
<div id="功能概述-4" class="section level2 hasAnchor" number="13.1">
<h2><span class="header-section-number">13.1</span> 功能概述<a href="ch-spi.html#功能概述-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>两个SPI模块</li>
<li>支持SPI主(Master)&amp;从(Slave)模式</li>
<li>支持Quad SPI，可以从外挂Flash执行代码</li>
<li>独立的RX&amp;TX FIFO，深度为8个word</li>
<li>支持DMA</li>
<li>支持XIP(SPI0)</li>
</ul>
</div>
<div id="使用说明-4" class="section level2 hasAnchor" number="13.2">
<h2><span class="header-section-number">13.2</span> 使用说明<a href="ch-spi.html#使用说明-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="时钟以及io配置" class="section level3 hasAnchor" number="13.2.1">
<h3><span class="header-section-number">13.2.1</span> 时钟以及IO配置<a href="ch-spi.html#时钟以及io配置" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>使用模块之前，需要打开相应的时钟，并且配置IO（查看对应datasheet获取可用的IO）：</p>
<ol style="list-style-type: decimal">
<li>通过<code>SYSCTRL_ClearClkGateMulti</code>打开SPI时钟，例如SPI1则需要打开<code>SYSCTRL_ITEM_APB_SPI1</code>。</li>
<li>配置IO的输入功能<code>PINCTRL_SelSpiIn</code>，没有使用到的IO可以使用IO_NOT_A_PIN替代。</li>
<li>使用<code>PINCTRL_SetPadMux</code>配置IO的输出功能。</li>
<li>对于Slave的输入，例如CLK需要保持默认低电平，则使用<code>PINCTRL_Pull</code>配置IO的上拉功能。</li>
<li>打开SPI中断<code>platform_set_irq_callback</code>。</li>
<li>对于时钟大于20M的使用场景，IO的选择有特殊要求，请参考<code>高速时钟和IO映射</code>。</li>
</ol>
<p>以SPI1为例，高速IO可以为：</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb143-1"><a href="ch-spi.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_CLK         GIO_GPIO_7</span></span>
<span id="cb143-2"><a href="ch-spi.html#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_MOSI        GIO_GPIO_8</span></span>
<span id="cb143-3"><a href="ch-spi.html#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_MISO        GIO_GPIO_9</span></span>
<span id="cb143-4"><a href="ch-spi.html#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_CS          GIO_GPIO_10</span></span>
<span id="cb143-5"><a href="ch-spi.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_WP          GIO_GPIO_11</span></span>
<span id="cb143-6"><a href="ch-spi.html#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MIC_HOLD        GIO_GPIO_12</span></span></code></pre></div>
<p>下述示例可以将指定IO映射到SPI1的Master模式：</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb144-1"><a href="ch-spi.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_peripherals_spi_pin<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb144-2"><a href="ch-spi.html#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb144-3"><a href="ch-spi.html#cb144-3" aria-hidden="true" tabindex="-1"></a>    SYSCTRL_ClearClkGateMulti<span class="op">(</span>    <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> SYSCTRL_ITEM_APB_SPI1<span class="op">)</span></span>
<span id="cb144-4"><a href="ch-spi.html#cb144-4" aria-hidden="true" tabindex="-1"></a>                                <span class="op">|</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> SYSCTRL_ITEM_APB_PinCtrl<span class="op">));</span></span>
<span id="cb144-5"><a href="ch-spi.html#cb144-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-6"><a href="ch-spi.html#cb144-6" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SelSpiIn<span class="op">(</span>SPI_PORT_1<span class="op">,</span> SPI_MIC_CLK<span class="op">,</span> SPI_MIC_CS<span class="op">,</span> SPI_MIC_HOLD<span class="op">,</span></span>
<span id="cb144-7"><a href="ch-spi.html#cb144-7" aria-hidden="true" tabindex="-1"></a>                     SPI_MIC_WP<span class="op">,</span> SPI_MIC_MISO<span class="op">,</span> SPI_MIC_MOSI<span class="op">);</span></span>
<span id="cb144-8"><a href="ch-spi.html#cb144-8" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_CLK<span class="op">,</span> IO_SOURCE_SPI1_CLK_OUT<span class="op">);</span></span>
<span id="cb144-9"><a href="ch-spi.html#cb144-9" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_CS<span class="op">,</span> IO_SOURCE_SPI1_CSN_OUT<span class="op">);</span></span>
<span id="cb144-10"><a href="ch-spi.html#cb144-10" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_MOSI<span class="op">,</span> IO_SOURCE_SPI1_MOSI_OUT<span class="op">);</span></span>
<span id="cb144-11"><a href="ch-spi.html#cb144-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-12"><a href="ch-spi.html#cb144-12" aria-hidden="true" tabindex="-1"></a>    platform_set_irq_callback<span class="op">(</span>PLATFORM_CB_IRQ_APBSPI<span class="op">,</span> peripherals_spi_isr<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb144-13"><a href="ch-spi.html#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果是Slave模式，则需要额外配置默认上拉，并且输入输出IO有区别：</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb145-1"><a href="ch-spi.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_peripherals_spi_pin<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb145-2"><a href="ch-spi.html#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb145-3"><a href="ch-spi.html#cb145-3" aria-hidden="true" tabindex="-1"></a>    SYSCTRL_ClearClkGateMulti<span class="op">(</span>    <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> SYSCTRL_ITEM_APB_SPI1<span class="op">)</span></span>
<span id="cb145-4"><a href="ch-spi.html#cb145-4" aria-hidden="true" tabindex="-1"></a>                                <span class="op">|</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> SYSCTRL_ITEM_APB_PinCtrl<span class="op">)));</span></span>
<span id="cb145-5"><a href="ch-spi.html#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="ch-spi.html#cb145-6" aria-hidden="true" tabindex="-1"></a>    PINCTRL_Pull<span class="op">(</span>SPI_MIC_CLK<span class="op">,</span>PINCTRL_PULL_DOWN<span class="op">);</span></span>
<span id="cb145-7"><a href="ch-spi.html#cb145-7" aria-hidden="true" tabindex="-1"></a>    PINCTRL_Pull<span class="op">(</span>SPI_MIC_CS<span class="op">,</span>PINCTRL_PULL_UP<span class="op">);</span></span>
<span id="cb145-8"><a href="ch-spi.html#cb145-8" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SelSpiIn<span class="op">(</span>SPI_PORT_1<span class="op">,</span> SPI_MIC_CLK<span class="op">,</span> SPI_MIC_CS<span class="op">,</span> SPI_MIC_HOLD<span class="op">,</span></span>
<span id="cb145-9"><a href="ch-spi.html#cb145-9" aria-hidden="true" tabindex="-1"></a>                     SPI_MIC_WP<span class="op">,</span> SPI_MIC_MISO<span class="op">,</span> SPI_MIC_MOSI<span class="op">);</span></span>
<span id="cb145-10"><a href="ch-spi.html#cb145-10" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_CLK<span class="op">,</span> IO_SOURCE_SPI1_CLK_OUT<span class="op">);</span></span>
<span id="cb145-11"><a href="ch-spi.html#cb145-11" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_MISO<span class="op">,</span> IO_SOURCE_SPI1_MISO_OUT<span class="op">);</span></span>
<span id="cb145-12"><a href="ch-spi.html#cb145-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-13"><a href="ch-spi.html#cb145-13" aria-hidden="true" tabindex="-1"></a>    platform_set_irq_callback<span class="op">(</span>PLATFORM_CB_IRQ_APBSPI<span class="op">,</span> peripherals_spi_isr<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb145-14"><a href="ch-spi.html#cb145-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="模块初始化-1" class="section level3 hasAnchor" number="13.2.2">
<h3><span class="header-section-number">13.2.2</span> 模块初始化<a href="ch-spi.html#模块初始化-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>模块的初始化通过<code>apSSP_DeviceParametersSet</code>和结构体<code>apSSP_sDeviceControlBlock</code>实现，结构体各个参数为：</p>
<ul>
<li><code>eSclkDiv</code>：时钟分频因子，决定了SPI的时钟速率。该参数和SPI模块时钟有关，在默认配置下，SPI模块时钟为24M，<code>eSclkDiv</code>可以直接使用<code>SPI_INTERFACETIMINGSCLKDIV_DEFAULT_xx</code>宏定义。对于更高的时钟，需要首先提高SPI模块时钟，然后再计算<code>eSclkDiv</code>，计算公式和配置方式请参考章节<code>其他配置</code>-&gt;<code>时钟配置</code>。</li>
<li><code>eSCLKPhase</code>：上升沿还是下降沿采样，参考<code>SPI_TransFmt_CPHA_e</code>。</li>
<li><code>eSCLKPolarity</code>：时钟默认是低电平还是高电平，参考<code>SPI_TransFmt_CPOL_e</code>。</li>
<li><code>eLsbMsbOrder</code>：bit传输顺序是LSB还是MSB，默认是MSB，参考<code>SPI_TransFmt_LSB_e</code>。</li>
<li><code>eDataSize</code>：每个传输单位的bit个数，8/16/32bit，参考<code>SPI_TransFmt_DataLen_e</code>。</li>
<li><code>eMasterSlaveMode</code>：选择是Master还是Slave模式，参考<code>SPI_TransFmt_SlvMode_e</code>。</li>
<li><code>eReadWriteMode</code>：选择传输模式：只读/只写/同时读写，参考<code>SPI_TransCtrl_TransMode_e</code>。</li>
<li><code>eQuadMode</code>：选择是普通SPI还是QSPI，参考<code>SPI_TransCtrl_DualQuad_e</code>。</li>
<li><code>eWriteTransCnt</code>：每次发送的单位个数，每个单位<code>eDataSize</code>个bit，达到单位个数后，CS将会拉高，代表一次传输结束。</li>
<li><code>eReadTransCnt</code>：每次接收的单位个数，每个单位<code>eDataSize</code>个bit，达到单位个数后，CS将会拉高，代表一次传输结束。</li>
<li><code>eAddrEn</code>：是否需要在数据之前发送地址，只适用Master，参考<code>SPI_TransCtrl_AddrEn_e</code>。</li>
<li><code>eCmdEn</code>：是否需要在数据之前发送命令，只适用Master，参考<code>SPI_TransCtrl_CmdEn_e</code>。</li>
<li><code>eInterruptMask</code>：需要打开的SPI中断类型，比如SPI传输结束中断和FIFO中断，参考<code>bsSPI_INTREN_xx</code>。</li>
<li><code>TxThres</code>：触发TX FIFO中断的门限值，比如可以为<code>eWriteTransCnt/2</code>，参考<code>apSSP_SetTxThres</code>。</li>
<li><code>RxThres</code>：触发RX FIFO中断的门限值，比如可以为<code>eReadTransCnt/2</code>，参考<code>apSSP_SetRxThres</code>。</li>
<li><code>SlaveDataOnly</code>：Slave模式下生效，如果只有数据，需要设置为打开，如果包含地址<code>eAddrEn</code>或者命令<code>eCmdEn</code>，需要设置改参数为DISABLE，参考<code>SPI_TransCtrl_SlvDataOnly_e</code>。</li>
<li><code>eAddrLen</code>：如果打开了<code>eAddrEn</code>，需要选择地址长度，参考<code>SPI_TransFmt_AddrLen_e</code>。</li>
</ul>
<p>具体使用请参考<code>编程指南</code>。</p>
</div>
<div id="中断配置-1" class="section level3 hasAnchor" number="13.2.3">
<h3><span class="header-section-number">13.2.3</span> 中断配置<a href="ch-spi.html#中断配置-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>通过<code>eInterruptMask</code>打开需要的中断:</p>
<ul>
<li><code>bsSPI_INTREN_ENDINTEN</code>：传输结束（CS拉高）之后会触发该中断。</li>
<li><code>bsSPI_INTREN_TXFIFOINTEN</code>：到达<code>TxThres</code>门限值之后，触发FIFO中断。</li>
<li><code>bsSPI_INTREN_RXFIFOINTEN</code>：到达<code>RxThres</code>门限值之后，触发FIFO中断。
<ul>
<li>通过<code>apSSP_GetDataNumInRxFifo</code>来判断当前FIFO中有效数据的个数。使用<code>apSSP_ReadFIFO</code>来读取FIFO中的数据，直到FIFO为空。</li>
</ul></li>
</ul>
</div>
<div id="编程指南-6" class="section level3 hasAnchor" number="13.2.4">
<h3><span class="header-section-number">13.2.4</span> 编程指南<a href="ch-spi.html#编程指南-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>以下提供不同场景下的代码实现供参考。</p>
<div id="场景1同时读写不使用dma" class="section level4 hasAnchor" number="13.2.4.1">
<h4><span class="header-section-number">13.2.4.1</span> 场景1：同时读写，不使用DMA<a href="ch-spi.html#场景1同时读写不使用dma" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>其中SPI主（Master）和SPI从（Slave）配置为同时读写模式，CPU操作读写，没有使用DMA 配置之前需要决定使用的IO，如果是普通模式，则不需要SPI_MIC_WP和SPI_MIC_HOLD。</p>
<div id="master配置-5" class="section level5 hasAnchor" number="13.2.4.1.1">
<h5><span class="header-section-number">13.2.4.1.1</span> Master配置<a href="ch-spi.html#master配置-5" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ul>
<li><p>配置IO，参考<code>时钟以及IO配置</code>。</p></li>
<li><p>模块初始化：</p>
<p>假设每个传输单元是32bit，则mode 0下的Master模式初始化配置为：</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb146-1"><a href="ch-spi.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MASTER_PARAM(DataLen) { SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M, \</span></span>
<span id="cb146-2"><a href="ch-spi.html#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_CPHA_ODD_SCLK_EDGES, SPI_CPOL_SCLK_LOW_IN_IDLE_STATES, \</span></span>
<span id="cb146-3"><a href="ch-spi.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_LSB_MOST_SIGNIFICANT_BIT_FIRST, SPI_DATALEN_32_BITS, \</span></span>
<span id="cb146-4"><a href="ch-spi.html#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_SLVMODE_MASTER_MODE, SPI_TRANSMODE_WRITE_READ_SAME_TIME, \</span></span>
<span id="cb146-5"><a href="ch-spi.html#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_DUALQUAD_REGULAR_MODE, DataLen, DataLen, \</span></span>
<span id="cb146-6"><a href="ch-spi.html#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_ADDREN_DISABLE, SPI_CMDEN_DISABLE, (1 &lt;&lt; bsSPI_INTREN_ENDINTEN), \</span></span>
<span id="cb146-7"><a href="ch-spi.html#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="pp">0, 0, SPI_SLVDATAONLY_ENABLE, SPI_ADDRLEN_1_BYTE }</span></span></code></pre></div>
<p>使用API<code>apSSP_DeviceParametersSet</code>来初始化SPI模块：</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb147-1"><a href="ch-spi.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define DATA_LEN (SPI_FIFO_DEPTH)</span></span>
<span id="cb147-2"><a href="ch-spi.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_peripherals_spi_module<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb147-3"><a href="ch-spi.html#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb147-4"><a href="ch-spi.html#cb147-4" aria-hidden="true" tabindex="-1"></a>    apSSP_sDeviceControlBlock pParam <span class="op">=</span> SPI_MASTER_PARAM<span class="op">(</span>DATA_LEN<span class="op">);</span></span>
<span id="cb147-5"><a href="ch-spi.html#cb147-5" aria-hidden="true" tabindex="-1"></a>    apSSP_DeviceParametersSet<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="op">&amp;</span>pParam<span class="op">);</span></span>
<span id="cb147-6"><a href="ch-spi.html#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>中断实现</p>
<p>该示例中只打开了SPI ENDINT中断，该中断触发标志传输结束，清除中断状态</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb148-1"><a href="ch-spi.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> peripherals_spi_isr<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb148-2"><a href="ch-spi.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb148-3"><a href="ch-spi.html#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stat <span class="op">=</span> apSSP_GetIntRawStatus<span class="op">(</span>APB_SSP1<span class="op">);</span></span>
<span id="cb148-4"><a href="ch-spi.html#cb148-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-5"><a href="ch-spi.html#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>stat <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">))</span></span>
<span id="cb148-6"><a href="ch-spi.html#cb148-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb148-7"><a href="ch-spi.html#cb148-7" aria-hidden="true" tabindex="-1"></a>    apSSP_ClearIntStatus<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">);</span></span>
<span id="cb148-8"><a href="ch-spi.html#cb148-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>  </span>
<span id="cb148-9"><a href="ch-spi.html#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>发送数据</p>
<p>发送数据需要填充数据到TX FIFO并且触发传输：</p>
<ul>
<li>使用<code>apSSP_WriteFIFO</code>写入需要传输的数据，通过<code>apSSP_TxFifoFull</code>来判断TX FIFO状态，写入数据直到FIFO变满。FIFO的深度为8，超过8个数据可以分为多次发送。</li>
<li><code>apSSP_WriteCmd</code>来触发传输，此场景中<code>eAddrEn</code>或者<code>eCmdEn</code>都是关闭的，但是仍然需要填充一个任意数据（比如0x00）来触发传输。</li>
<li>使用<code>apSSP_GetSPIActiveStatus</code>等待发送结束，或者查看对应中断。</li>
<li>发送的数据格式和长度需要和<code>eDataSize</code>等参数对应。</li>
</ul>
<div class="sourceCode" id="cb149"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb149-1"><a href="ch-spi.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> write_data<span class="op">[</span>DATA_LEN<span class="op">];</span></span>
<span id="cb149-2"><a href="ch-spi.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_send_data<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb149-3"><a href="ch-spi.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb149-4"><a href="ch-spi.html#cb149-4" aria-hidden="true" tabindex="-1"></a>  apSSP_WriteCmd<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">);</span><span class="co">//trigger transfer</span></span>
<span id="cb149-5"><a href="ch-spi.html#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> DATA_LEN<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb149-6"><a href="ch-spi.html#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb149-7"><a href="ch-spi.html#cb149-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>apSSP_TxFifoFull<span class="op">(</span>APB_SSP1<span class="op">)){</span> <span class="cf">break</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb149-8"><a href="ch-spi.html#cb149-8" aria-hidden="true" tabindex="-1"></a>    apSSP_WriteFIFO<span class="op">(</span>APB_SSP1<span class="op">,</span> write_data<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb149-9"><a href="ch-spi.html#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb149-10"><a href="ch-spi.html#cb149-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span>apSSP_GetSPIActiveStatus<span class="op">(</span>APB_SSP1<span class="op">));</span></span>
<span id="cb149-11"><a href="ch-spi.html#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>接收数据</p>
<p>在SPI发送结束后，通过<code>apSSP_GetDataNumInRxFifo</code>查看并读取RX FIFO中的数据。</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb150-1"><a href="ch-spi.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> read_data<span class="op">[</span>DATA_LEN<span class="op">];</span></span>
<span id="cb150-2"><a href="ch-spi.html#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> num <span class="op">=</span> apSSP_GetDataNumInRxFifo<span class="op">(</span>APB_SSP1<span class="op">);</span></span>
<span id="cb150-3"><a href="ch-spi.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb150-4"><a href="ch-spi.html#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb150-5"><a href="ch-spi.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  apSSP_ReadFIFO<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="op">&amp;</span>read_data<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb150-6"><a href="ch-spi.html#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>使用流程</p>
<ul>
<li>设置IO，setup_peripherals_spi_pin()。</li>
<li>初始化SPI，setup_peripherals_spi_module()。</li>
<li>在需要时候发送SPI数据，peripherals_spi_send_data()。</li>
<li>检查中断状态。</li>
</ul></li>
</ul>
</div>
<div id="slave配置-5" class="section level5 hasAnchor" number="13.2.4.1.2">
<h5><span class="header-section-number">13.2.4.1.2</span> Slave配置<a href="ch-spi.html#slave配置-5" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ul>
<li><p>配置IO，参考<code>时钟以及IO配置</code>。</p></li>
<li><p>模块初始化：</p>
<p>Slave的初始化和Master相同，只需要将mode切换为<code>SPI_SLVMODE_SLAVE_MODE</code>：</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb151-1"><a href="ch-spi.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_SLAVE_PARAM(DataLen) { SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M, \</span></span>
<span id="cb151-2"><a href="ch-spi.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_CPHA_ODD_SCLK_EDGES, SPI_CPOL_SCLK_LOW_IN_IDLE_STATES, \</span></span>
<span id="cb151-3"><a href="ch-spi.html#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_LSB_MOST_SIGNIFICANT_BIT_FIRST, SPI_DATALEN_32_BITS, \</span></span>
<span id="cb151-4"><a href="ch-spi.html#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_SLVMODE_SLAVE_MODE, SPI_TRANSMODE_WRITE_READ_SAME_TIME, \</span></span>
<span id="cb151-5"><a href="ch-spi.html#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_DUALQUAD_REGULAR_MODE, DataLen, DataLen, \</span></span>
<span id="cb151-6"><a href="ch-spi.html#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_ADDREN_DISABLE, SPI_CMDEN_DISABLE, (1 &lt;&lt; bsSPI_INTREN_ENDINTEN), \</span></span>
<span id="cb151-7"><a href="ch-spi.html#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="pp">0, 0, SPI_SLVDATAONLY_ENABLE, SPI_ADDRLEN_1_BYTE }</span></span></code></pre></div>
<p>调用<code>apSSP_DeviceParametersSet</code>来初始化SPI模块：</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb152-1"><a href="ch-spi.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_peripherals_spi_module<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb152-2"><a href="ch-spi.html#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb152-3"><a href="ch-spi.html#cb152-3" aria-hidden="true" tabindex="-1"></a>    apSSP_sDeviceControlBlock pParam <span class="op">=</span> SPI_SLAVE_PARAM<span class="op">(</span>DATA_LEN<span class="op">);</span></span>
<span id="cb152-4"><a href="ch-spi.html#cb152-4" aria-hidden="true" tabindex="-1"></a>    apSSP_DeviceParametersSet<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="op">&amp;</span>pParam<span class="op">);</span></span>
<span id="cb152-5"><a href="ch-spi.html#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>发送数据</p>
<p>Slave的待发送数据需要提前放到TX FIFO中。 比如在初始化之后，就可以往FIFO中填充发送数据，同时需要判断<code>apSSP_TxFifoFull</code>：</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb153-1"><a href="ch-spi.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> DATA_LEN<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb153-2"><a href="ch-spi.html#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb153-3"><a href="ch-spi.html#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>apSSP_TxFifoFull<span class="op">(</span>APB_SSP1<span class="op">)){</span> <span class="cf">break</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb153-4"><a href="ch-spi.html#cb153-4" aria-hidden="true" tabindex="-1"></a>  apSSP_WriteFIFO<span class="op">(</span>APB_SSP1<span class="op">,</span> write_data<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb153-5"><a href="ch-spi.html#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>接收数据</p>
<p>Slave的数据接收需要在中断中进行，<code>bsSPI_INTREN_ENDINTEN</code>中断代表传输结束，此时可以读取RX FIFO中的内容，如果数据长度大于FIFO深度，则需要打开<code>RxThres</code>，在FIFO中断中读取接收数据，或者使用DMA方式，否则数据会丢失。</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a href="ch-spi.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> peripherals_spi_isr<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb154-2"><a href="ch-spi.html#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb154-3"><a href="ch-spi.html#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stat <span class="op">=</span> apSSP_GetIntRawStatus<span class="op">(</span>APB_SSP1<span class="op">),</span> i<span class="op">;</span></span>
<span id="cb154-4"><a href="ch-spi.html#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>stat <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">))</span></span>
<span id="cb154-5"><a href="ch-spi.html#cb154-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb154-6"><a href="ch-spi.html#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> num <span class="op">=</span> apSSP_GetDataNumInRxFifo<span class="op">(</span>APB_SSP1<span class="op">);</span></span>
<span id="cb154-7"><a href="ch-spi.html#cb154-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb154-8"><a href="ch-spi.html#cb154-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb154-9"><a href="ch-spi.html#cb154-9" aria-hidden="true" tabindex="-1"></a>      apSSP_ReadFIFO<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="op">&amp;</span>read_data<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb154-10"><a href="ch-spi.html#cb154-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-11"><a href="ch-spi.html#cb154-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-12"><a href="ch-spi.html#cb154-12" aria-hidden="true" tabindex="-1"></a>    apSSP_ClearIntStatus<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">);</span></span>
<span id="cb154-13"><a href="ch-spi.html#cb154-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-14"><a href="ch-spi.html#cb154-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb154-15"><a href="ch-spi.html#cb154-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>使用流程</p>
<ul>
<li>设置IO，setup_peripherals_spi_pin()。</li>
<li>初始化SPI，setup_peripherals_spi_module()。</li>
<li>观察SPI中断，中断触发代表当前传输结束。</li>
</ul></li>
</ul>
</div>
</div>
<div id="场景2同时读写使用dma" class="section level4 hasAnchor" number="13.2.4.2">
<h4><span class="header-section-number">13.2.4.2</span> 场景2：同时读写，使用DMA<a href="ch-spi.html#场景2同时读写使用dma" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>其中SPI主从配置为同时读写模式，同时使用DMA进行读写。 配置之前需要决定使用的IO，如果是普通模式，则不需要SPI_MIC_WP和SPI_MIC_HOLD。</p>
<div id="master配置-6" class="section level5 hasAnchor" number="13.2.4.2.1">
<h5><span class="header-section-number">13.2.4.2.1</span> Master配置<a href="ch-spi.html#master配置-6" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ul>
<li><p>配置IO，参考<code>时钟以及IO配置</code>。</p></li>
<li><p>模块初始化，参考场景1<code>Master配置</code>。</p></li>
<li><p>DMA初始化</p>
<p>使用之前需要初始化DMA模块：</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb155-1"><a href="ch-spi.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> setup_peripherals_dma_module<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb155-2"><a href="ch-spi.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb155-3"><a href="ch-spi.html#cb155-3" aria-hidden="true" tabindex="-1"></a>    SYSCTRL_ClearClkGateMulti<span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> SYSCTRL_ClkGate_APB_DMA<span class="op">);</span></span>
<span id="cb155-4"><a href="ch-spi.html#cb155-4" aria-hidden="true" tabindex="-1"></a>    DMA_Reset<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb155-5"><a href="ch-spi.html#cb155-5" aria-hidden="true" tabindex="-1"></a>    DMA_Reset<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb155-6"><a href="ch-spi.html#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>DMA设置</p>
<ol style="list-style-type: decimal">
<li>设置DMA将指定地址的数据搬运到SPI1 TX FIFO，并打开DMA。 SPI1启动后，搬运自动开始：</li>
</ol>
<div class="sourceCode" id="cb156"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb156-1"><a href="ch-spi.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_dma_to_txfifo<span class="op">(</span><span class="dt">int</span> channel_id<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>src<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span>
<span id="cb156-2"><a href="ch-spi.html#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb156-3"><a href="ch-spi.html#cb156-3" aria-hidden="true" tabindex="-1"></a>    DMA_Descriptor descriptor __attribute__<span class="op">((</span>aligned <span class="op">(</span><span class="dv">8</span><span class="op">)));</span></span>
<span id="cb156-4"><a href="ch-spi.html#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="ch-spi.html#cb156-5" aria-hidden="true" tabindex="-1"></a>    descriptor<span class="op">.</span>Next <span class="op">=</span> <span class="op">(</span>DMA_Descriptor <span class="op">*)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-6"><a href="ch-spi.html#cb156-6" aria-hidden="true" tabindex="-1"></a>    DMA_PrepareMem2Peripheral<span class="op">(&amp;</span>descriptor<span class="op">,</span>SYSCTRL_DMA_SPI1_TX<span class="op">,</span></span>
<span id="cb156-7"><a href="ch-spi.html#cb156-7" aria-hidden="true" tabindex="-1"></a>                              src<span class="op">,</span>size<span class="op">,</span>DMA_ADDRESS_INC<span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb156-8"><a href="ch-spi.html#cb156-8" aria-hidden="true" tabindex="-1"></a>    DMA_EnableChannel<span class="op">(</span>channel_id<span class="op">,</span> <span class="op">&amp;</span>descriptor<span class="op">);</span></span>
<span id="cb156-9"><a href="ch-spi.html#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>设置DMA将SPI1 RX FIFO的数据搬运到指定地址：</li>
</ol>
<div class="sourceCode" id="cb157"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb157-1"><a href="ch-spi.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_rxfifo_to_dma<span class="op">(</span><span class="dt">int</span> channel_id<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>dst<span class="op">,</span> <span class="dt">int</span> size<span class="op">)</span></span>
<span id="cb157-2"><a href="ch-spi.html#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb157-3"><a href="ch-spi.html#cb157-3" aria-hidden="true" tabindex="-1"></a>    DMA_Descriptor descriptor __attribute__<span class="op">((</span>aligned <span class="op">(</span><span class="dv">8</span><span class="op">)));</span></span>
<span id="cb157-4"><a href="ch-spi.html#cb157-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-5"><a href="ch-spi.html#cb157-5" aria-hidden="true" tabindex="-1"></a>    descriptor<span class="op">.</span>Next <span class="op">=</span> <span class="op">(</span>DMA_Descriptor <span class="op">*)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb157-6"><a href="ch-spi.html#cb157-6" aria-hidden="true" tabindex="-1"></a>    DMA_PreparePeripheral2Mem<span class="op">(&amp;</span>descriptor<span class="op">,</span>dst<span class="op">,</span>SYSCTRL_DMA_SPI1_RX<span class="op">,</span></span>
<span id="cb157-7"><a href="ch-spi.html#cb157-7" aria-hidden="true" tabindex="-1"></a>                              size<span class="op">,</span>DMA_ADDRESS_INC<span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb157-8"><a href="ch-spi.html#cb157-8" aria-hidden="true" tabindex="-1"></a>    DMA_EnableChannel<span class="op">(</span>channel_id<span class="op">,</span> <span class="op">&amp;</span>descriptor<span class="op">);</span></span>
<span id="cb157-9"><a href="ch-spi.html#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>中断实现</p>
<p>该示例中只打开了SPI ENDINT中断，该中断触发标志传输结束，清除中断状态</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb158-1"><a href="ch-spi.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> peripherals_spi_isr<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb158-2"><a href="ch-spi.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb158-3"><a href="ch-spi.html#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stat <span class="op">=</span> apSSP_GetIntRawStatus<span class="op">(</span>APB_SSP1<span class="op">);</span></span>
<span id="cb158-4"><a href="ch-spi.html#cb158-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-5"><a href="ch-spi.html#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>stat <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">))</span></span>
<span id="cb158-6"><a href="ch-spi.html#cb158-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb158-7"><a href="ch-spi.html#cb158-7" aria-hidden="true" tabindex="-1"></a>    apSSP_ClearIntStatus<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">);</span></span>
<span id="cb158-8"><a href="ch-spi.html#cb158-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>  </span>
<span id="cb158-9"><a href="ch-spi.html#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>接收数据配置</p>
<ol style="list-style-type: decimal">
<li>首先需要打开 SPI 模块中的DMA功能<code>apSSP_SetRxDmaEn</code>。</li>
<li>设置每次传输时接收和发射的个数，改参数已经在模块初始化中设置过了，此处为可选项，如果需要更新，可以通过<code>apSSP_SetTransferControlRdTranCnt</code>和<code>apSSP_SetTransferControlWrTranCnt</code>来更新。注意：该场景下，发射和接收的个数需要相同。</li>
<li>配置DMA。</li>
</ol>
<div class="sourceCode" id="cb159"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb159-1"><a href="ch-spi.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_DMA_RX_CHANNEL   (1)</span><span class="co">//DMA channel 1</span></span>
<span id="cb159-2"><a href="ch-spi.html#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> read_data<span class="op">[</span>DATA_LEN<span class="op">];</span></span>
<span id="cb159-3"><a href="ch-spi.html#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="ch-spi.html#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_read_data<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb159-5"><a href="ch-spi.html#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb159-6"><a href="ch-spi.html#cb159-6" aria-hidden="true" tabindex="-1"></a>  apSSP_SetRxDmaEn<span class="op">(</span>APB_SSP1<span class="op">,</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb159-7"><a href="ch-spi.html#cb159-7" aria-hidden="true" tabindex="-1"></a>  apSSP_SetTransferControlRdTranCnt<span class="op">(</span>APB_SSP1<span class="op">,</span>DATA_LEN<span class="op">);</span></span>
<span id="cb159-8"><a href="ch-spi.html#cb159-8" aria-hidden="true" tabindex="-1"></a>  peripherals_spi_rxfifo_to_dma<span class="op">(</span>SPI_DMA_RX_CHANNEL<span class="op">,</span> read_data<span class="op">,</span></span>
<span id="cb159-9"><a href="ch-spi.html#cb159-9" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>read_data<span class="op">));</span></span>
<span id="cb159-10"><a href="ch-spi.html#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>发送数据配置</p>
<p>类似于接收，发射需要打开SPI的DMA功能，并且配置DMA。</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb160-1"><a href="ch-spi.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_DMA_TX_CHANNEL   (0)</span><span class="co">//DMA channel 0</span></span>
<span id="cb160-2"><a href="ch-spi.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> write_data<span class="op">[</span>DATA_LEN<span class="op">];</span></span>
<span id="cb160-3"><a href="ch-spi.html#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="ch-spi.html#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_push_data<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb160-5"><a href="ch-spi.html#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb160-6"><a href="ch-spi.html#cb160-6" aria-hidden="true" tabindex="-1"></a>  apSSP_SetTxDmaEn<span class="op">(</span>APB_SSP1<span class="op">,</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb160-7"><a href="ch-spi.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  apSSP_SetTransferControlWrTranCnt<span class="op">(</span>APB_SSP1<span class="op">,</span>DATA_LEN<span class="op">);</span></span>
<span id="cb160-8"><a href="ch-spi.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  peripherals_spi_dma_to_txfifo<span class="op">(</span>SPI_DMA_TX_CHANNEL<span class="op">,</span> write_data<span class="op">,</span></span>
<span id="cb160-9"><a href="ch-spi.html#cb160-9" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>write_data<span class="op">));</span></span>
<span id="cb160-10"><a href="ch-spi.html#cb160-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>发送数据</p>
<ol style="list-style-type: decimal">
<li>在需要发送数据时，通过DMA填充待发射数据到TX FIFO。</li>
<li>配置接收数据的DMA，同时读写模式下，发射和接收同步进行。</li>
<li>配置命令触发传输。</li>
<li>等待发射结束<code>apSSP_GetSPIActiveStatus</code>，关闭DMA功能。</li>
</ol>
<div class="sourceCode" id="cb161"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb161-1"><a href="ch-spi.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> peripherals_spi_send_data<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb161-2"><a href="ch-spi.html#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb161-3"><a href="ch-spi.html#cb161-3" aria-hidden="true" tabindex="-1"></a>  peripherals_spi_read_data<span class="op">();</span></span>
<span id="cb161-4"><a href="ch-spi.html#cb161-4" aria-hidden="true" tabindex="-1"></a>  peripherals_spi_push_data<span class="op">();</span></span>
<span id="cb161-5"><a href="ch-spi.html#cb161-5" aria-hidden="true" tabindex="-1"></a>  apSSP_WriteCmd<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="bn">0x00</span><span class="op">,</span> <span class="bn">0x00</span><span class="op">);</span><span class="co">//trigger transfer</span></span>
<span id="cb161-6"><a href="ch-spi.html#cb161-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span>apSSP_GetSPIActiveStatus<span class="op">(</span>APB_SSP1<span class="op">));</span></span>
<span id="cb161-7"><a href="ch-spi.html#cb161-7" aria-hidden="true" tabindex="-1"></a>  apSSP_SetTxDmaEn<span class="op">(</span>APB_SSP1<span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb161-8"><a href="ch-spi.html#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>使用流程</p>
<ul>
<li>设置IO，setup_peripherals_spi_pin()。</li>
<li>初始化SPI，setup_peripherals_spi_module()。</li>
<li>初始化DMA，setup_peripherals_dma_module()。</li>
<li>在需要时候发送SPI数据，peripherals_spi_send_data()。</li>
<li>检查中断状态。</li>
</ul></li>
</ul>
</div>
<div id="slave配置-6" class="section level5 hasAnchor" number="13.2.4.2.2">
<h5><span class="header-section-number">13.2.4.2.2</span> Slave配置<a href="ch-spi.html#slave配置-6" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ul>
<li><p>配置IO，参考<code>时钟以及IO配置</code>。</p></li>
<li><p>模块初始化，参考场景1<code>Slave配置</code>。</p></li>
<li><p>DMA初始化，与Master的DMA初始化相同，参考<code>setup_peripherals_dma_module</code>。</p></li>
<li><p>DMA设置，与Master的DMA设置相同，参考<code>peripherals_spi_dma_to_txfifo</code> 和<code>peripherals_spi_rxfifo_to_dma</code>。</p></li>
<li><p>接收数据配置，与Master相同，参考<code>peripherals_spi_read_data</code>。</p></li>
<li><p>发送数据配置，与Master相同，参考<code>peripherals_spi_push_data</code>。</p></li>
<li><p>传输前准备</p>
<ol style="list-style-type: decimal">
<li>对于Slave，如果需要在第一次传输时发送数据，则需要提前将需要发送的数据配置到DMA，配置<code>peripherals_spi_push_data</code>。</li>
<li>使用<code>peripherals_spi_read_data</code>配置接收DMA，等待Master传输。</li>
</ol>
<div class="sourceCode" id="cb162"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb162-1"><a href="ch-spi.html#cb162-1" aria-hidden="true" tabindex="-1"></a>peripherals_spi_read_data<span class="op">();</span></span>
<span id="cb162-2"><a href="ch-spi.html#cb162-2" aria-hidden="true" tabindex="-1"></a>peripherals_spi_push_data<span class="op">();</span></span></code></pre></div></li>
<li><p>中断实现</p>
<ol style="list-style-type: decimal">
<li><code>bsSPI_INTREN_ENDINTEN</code>的触发代表当前传输结束。</li>
<li>检查接收数据。</li>
<li>如果需要准备下一次传输，使用<code>peripherals_spi_read_data</code>建立接收DMA。</li>
<li>如果需要准备下一次传输，准备发送数据，使用<code>peripherals_spi_push_data</code>建立发射DMA。</li>
<li>清除中断标志。</li>
</ol>
<div class="sourceCode" id="cb163"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb163-1"><a href="ch-spi.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> peripherals_spi_isr<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb163-2"><a href="ch-spi.html#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb163-3"><a href="ch-spi.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stat <span class="op">=</span> apSSP_GetIntRawStatus<span class="op">(</span>APB_SSP1<span class="op">);</span></span>
<span id="cb163-4"><a href="ch-spi.html#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="ch-spi.html#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>stat <span class="op">&amp;</span> <span class="op">(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">))</span></span>
<span id="cb163-6"><a href="ch-spi.html#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb163-7"><a href="ch-spi.html#cb163-7" aria-hidden="true" tabindex="-1"></a>    peripherals_spi_read_data<span class="op">();</span></span>
<span id="cb163-8"><a href="ch-spi.html#cb163-8" aria-hidden="true" tabindex="-1"></a>    peripherals_spi_push_data<span class="op">();</span></span>
<span id="cb163-9"><a href="ch-spi.html#cb163-9" aria-hidden="true" tabindex="-1"></a>    apSSP_ClearIntStatus<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> bsSPI_INTREN_ENDINTEN<span class="op">);</span></span>
<span id="cb163-10"><a href="ch-spi.html#cb163-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>  </span>
<span id="cb163-11"><a href="ch-spi.html#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
<li><p>使用流程</p>
<ul>
<li>设置IO，setup_peripherals_spi_pin()。</li>
<li>初始化SPI，setup_peripherals_spi_module()。</li>
<li>初始化DMA，setup_peripherals_dma_module()。</li>
<li>设置接收DMA，peripherals_spi_read_data()。</li>
<li>设置发射DMA，peripherals_spi_push_data()。</li>
<li>观察SPI中断，中断触发代表当前接收结束。</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="其他配置" class="section level3 hasAnchor" number="13.2.5">
<h3><span class="header-section-number">13.2.5</span> 其他配置<a href="ch-spi.html#其他配置" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="时钟配置pparam.esclkdiv" class="section level4 hasAnchor" number="13.2.5.1">
<h4><span class="header-section-number">13.2.5.1</span> 时钟配置（pParam.eSclkDiv）<a href="ch-spi.html#时钟配置pparam.esclkdiv" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="默认配置" class="section level5 hasAnchor" number="13.2.5.1.1">
<h5><span class="header-section-number">13.2.5.1.1</span> 默认配置<a href="ch-spi.html#默认配置" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>对于默认配置，SPI时钟的配置通过 <code>pParam.eSclkDiv</code> 来实现，计算公式为：<span class="math inline">\((spi\quad interface\quad clock)/(2\times(eSclkDiv + 1))\)</span>，其中默认配置下，<code>spi interface clock</code> 为24M，因此可以得到不同时钟下的<code>eSclkDiv</code>：</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a href="ch-spi.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_DEFAULT_6M    (1)</span></span>
<span id="cb164-2"><a href="ch-spi.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_DEFAULT_4M    (2)</span></span>
<span id="cb164-3"><a href="ch-spi.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_DEFAULT_3M    (3)</span></span>
<span id="cb164-4"><a href="ch-spi.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M4   (4)</span></span>
<span id="cb164-5"><a href="ch-spi.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M    (5)</span></span></code></pre></div>
</div>
<div id="高速时钟配置" class="section level5 hasAnchor" number="13.2.5.1.2">
<h5><span class="header-section-number">13.2.5.1.2</span> 高速时钟配置<a href="ch-spi.html#高速时钟配置" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>SPI0和SPI1的高速时钟配置有一些不同，<strong>注意：高速时钟需要使用特定的IO，请查看<code>SPI高速时钟和pin的映射</code></strong>。</p>
<div id="spi0" class="section level6 hasAnchor" number="13.2.5.1.2.1">
<h6><span class="header-section-number">13.2.5.1.2.1</span> SPI0<a href="ch-spi.html#spi0" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>对于更高的时钟，需要在配置<code>pParam.eSclkDiv</code>之前打开额外配置，打开方式如下</p>
<ul>
<li><p>首先通过<code>SYSCTRL_GetPLLClk()</code>获取PLL时钟，此处假设为336M。</p></li>
<li><p>切换SPI0到高速时钟<code>SYSCTRL_SelectSpiClk(SPI_PORT_0,SYSCTRL_CLK_HCLK+1)</code>,此处的入参代表分频比2，即最终的<code>spi interface clock</code>为<span class="math inline">\(336/2 = 168.0M\)</span>。</p></li>
<li><p>通过计算公式<span class="math inline">\((spi\quad interface\quad clock)/(2\times(eSclkDiv + 1))\)</span> 得到不同时钟下的<code>eSclkDiv</code>。</p></li>
<li><p>通过<code>SYSCTRL_GetClk(SYSCTRL_ITEM_AHB_SPI0)</code>来确认interface clock是否生效。</p></li>
</ul>
<p>在以上举例中，可以使用以下宏定义来配置<code>pParam.eSclkDiv</code></p>
<div class="sourceCode" id="cb165"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb165-1"><a href="ch-spi.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_SPI0_21M    (1)</span></span>
<span id="cb165-2"><a href="ch-spi.html#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_SPI0_14M    (2)</span></span></code></pre></div>
<p>以下的API可以实现相同的功能，假设PLL时钟为336M，入参为21000000(21M),则该API可以完成SPI0时钟配置，并且返回<code>eSclkDiv</code>。<strong>入参需要和PLL成倍数关系</strong>。</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb166-1"><a href="ch-spi.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> setup_peripherals_spi_0_high_speed_interface_clk<span class="op">(</span><span class="dt">uint32_t</span> spiClk<span class="op">)</span></span>
<span id="cb166-2"><a href="ch-spi.html#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb166-3"><a href="ch-spi.html#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//for spi0 only</span></span>
<span id="cb166-4"><a href="ch-spi.html#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> eSclkDiv <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb166-5"><a href="ch-spi.html#cb166-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> spiIntfClk<span class="op">;</span></span>
<span id="cb166-6"><a href="ch-spi.html#cb166-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> pllClk <span class="op">=</span> SYSCTRL_GetPLLClk<span class="op">()</span>；</span>
<span id="cb166-7"><a href="ch-spi.html#cb166-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-8"><a href="ch-spi.html#cb166-8" aria-hidden="true" tabindex="-1"></a>    SYSCTRL_SelectSpiClk<span class="op">(</span>SPI_PORT_0<span class="op">,</span>SYSCTRL_CLK_PLL_DIV_1<span class="op">+</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb166-9"><a href="ch-spi.html#cb166-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-10"><a href="ch-spi.html#cb166-10" aria-hidden="true" tabindex="-1"></a>    spiIntfClk <span class="op">=</span> SYSCTRL_GetClk<span class="op">(</span>SYSCTRL_ITEM_AHB_SPI0<span class="op">);</span></span>
<span id="cb166-11"><a href="ch-spi.html#cb166-11" aria-hidden="true" tabindex="-1"></a>    eSclkDiv <span class="op">=</span> <span class="op">((</span>spiIntfClk<span class="op">/</span>spiClk<span class="op">)/</span><span class="dv">2</span><span class="op">)-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb166-12"><a href="ch-spi.html#cb166-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-13"><a href="ch-spi.html#cb166-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> eSclkDiv<span class="op">;</span></span>
<span id="cb166-14"><a href="ch-spi.html#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>调用方式为：</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb167-1"><a href="ch-spi.html#cb167-1" aria-hidden="true" tabindex="-1"></a>pParam<span class="op">.</span>eSclkDiv <span class="op">=</span> setup_peripherals_spi_0_high_speed_interface_clk<span class="op">(</span><span class="dv">21000000</span><span class="op">);</span></span></code></pre></div>
</div>
<div id="spi1" class="section level6 hasAnchor" number="13.2.5.1.2.2">
<h6><span class="header-section-number">13.2.5.1.2.2</span> SPI1<a href="ch-spi.html#spi1" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>对于更高的时钟，需要在配置<code>pParam.eSclkDiv</code>之前打开HCLK配置，打开方式如下：</p>
<ul>
<li><p>首先查看HCLK频率:<code>SYSCTRL_GetHClk()</code>。</p>
<ul>
<li>如果有需要可以使用<code>SYSCTRL_SelectHClk(SYSCTRL_CLK_PLL_DIV_1+3);</code>来修改HCLK时钟。修改方法为，首先使用<code>SYSCTRL_GetPLLClk()</code>获取PLL时钟，入参为分频比，假如PLL时钟为336M，则<code>SYSCTRL_CLK_PLL_DIV_1+6</code>为7分频，最终HClk为336/7=48M。</li>
</ul></li>
<li><p>将SPI1时钟切换到HCLK:<code>SYSCTRL_SelectSpiClk(SPI_PORT_1,SYSCTRL_CLK_HCLK)</code>。</p></li>
<li><p>通过计算公式<span class="math inline">\((spi\quad interface\quad clock)/(2\times(eSclkDiv + 1))\)</span> 得到不同时钟下的<code>eSclkDiv</code>。</p></li>
<li><p>通过<code>SYSCTRL_GetClk(SYSCTRL_ITEM_APB_SPI1)</code>来确认interface clock是否生效。</p></li>
</ul>
<p>假设HCLK为112M（即<code>spi interface clock</code>），通过计算公式可以得到不同时钟下的<code>eSclkDiv</code>为：</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb168-1"><a href="ch-spi.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_SPI1_19M    (2)</span></span>
<span id="cb168-2"><a href="ch-spi.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_INTERFACETIMINGSCLKDIV_SPI1_14M    (3)</span></span></code></pre></div>
<p>以下的API可以实现相同的功能，假设HCLK时钟为112M，入参为14000000(14M),则该API可以完成SPI1时钟配置，并且返回<code>eSclkDiv</code>。<strong>入参需要和HCLK成倍数关系</strong></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb169-1"><a href="ch-spi.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint8_t</span> setup_peripherals_spi_1_high_speed_interface_clk<span class="op">(</span><span class="dt">uint32_t</span> spiClk<span class="op">)</span></span>
<span id="cb169-2"><a href="ch-spi.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb169-3"><a href="ch-spi.html#cb169-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> eSclkDiv <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb169-4"><a href="ch-spi.html#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> spiIntfClk<span class="op">;</span></span>
<span id="cb169-5"><a href="ch-spi.html#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> hClk <span class="op">=</span> SYSCTRL_GetHClk<span class="op">();</span></span>
<span id="cb169-6"><a href="ch-spi.html#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="ch-spi.html#cb169-7" aria-hidden="true" tabindex="-1"></a>    SYSCTRL_SelectSpiClk<span class="op">(</span>SPI_PORT_1<span class="op">,</span>SYSCTRL_CLK_HCLK<span class="op">);</span></span>
<span id="cb169-8"><a href="ch-spi.html#cb169-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-9"><a href="ch-spi.html#cb169-9" aria-hidden="true" tabindex="-1"></a>    spiIntfClk <span class="op">=</span> SYSCTRL_GetClk<span class="op">(</span>SYSCTRL_ITEM_APB_SPI1<span class="op">);</span></span>
<span id="cb169-10"><a href="ch-spi.html#cb169-10" aria-hidden="true" tabindex="-1"></a>    eSclkDiv <span class="op">=</span> <span class="op">((</span>spiIntfClk<span class="op">/</span>spiClk<span class="op">)/</span><span class="dv">2</span><span class="op">)-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb169-11"><a href="ch-spi.html#cb169-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-12"><a href="ch-spi.html#cb169-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> eSclkDiv<span class="op">;</span></span>
<span id="cb169-13"><a href="ch-spi.html#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>调用方式为：</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb170-1"><a href="ch-spi.html#cb170-1" aria-hidden="true" tabindex="-1"></a>pParam<span class="op">.</span>eSclkDiv <span class="op">=</span> setup_peripherals_spi_1_high_speed_interface_clk<span class="op">(</span><span class="dv">14000000</span><span class="op">);</span></span></code></pre></div>
</div>
</div>
</div>
<div id="qspi-使用" class="section level4 hasAnchor" number="13.2.5.2">
<h4><span class="header-section-number">13.2.5.2</span> QSPI 使用<a href="ch-spi.html#qspi-使用" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>QSPI的bit顺序以及MOSI/MISO的含义和普通SPI不同，但大部分读写的配置是共享的。 使用QSPI需要在普通SPI的配置的基础上，做一些额外修改：</p>
<div id="io-配置" class="section level5 hasAnchor" number="13.2.5.2.1">
<h5><span class="header-section-number">13.2.5.2.1</span> IO 配置<a href="ch-spi.html#io-配置" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>QSPI用到了CLK,CS,MOSI,MISO,HOLD,WP,主从都需要配置为输入输出：</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb171-1"><a href="ch-spi.html#cb171-1" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SelSpiIn<span class="op">(</span>SPI_PORT_1<span class="op">,</span> SPI_MIC_CLK<span class="op">,</span> SPI_MIC_CS<span class="op">,</span> SPI_MIC_HOLD<span class="op">,</span></span>
<span id="cb171-2"><a href="ch-spi.html#cb171-2" aria-hidden="true" tabindex="-1"></a>                     SPI_MIC_WP<span class="op">,</span> SPI_MIC_MISO<span class="op">,</span> SPI_MIC_MOSI<span class="op">);</span></span>
<span id="cb171-3"><a href="ch-spi.html#cb171-3" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_CLK<span class="op">,</span> IO_SOURCE_SPI1_CLK_OUT<span class="op">);</span></span>
<span id="cb171-4"><a href="ch-spi.html#cb171-4" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_CS<span class="op">,</span> IO_SOURCE_SPI1_CSN_OUT<span class="op">);</span></span>
<span id="cb171-5"><a href="ch-spi.html#cb171-5" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_MOSI<span class="op">,</span> IO_SOURCE_SPI1_MOSI_OUT<span class="op">);</span></span>
<span id="cb171-6"><a href="ch-spi.html#cb171-6" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_MISO<span class="op">,</span> IO_SOURCE_SPI1_MISO_OUT<span class="op">);</span></span>
<span id="cb171-7"><a href="ch-spi.html#cb171-7" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_WP<span class="op">,</span> IO_SOURCE_SPI1_WP_OUT<span class="op">);</span></span>
<span id="cb171-8"><a href="ch-spi.html#cb171-8" aria-hidden="true" tabindex="-1"></a>    PINCTRL_SetPadMux<span class="op">(</span>SPI_MIC_HOLD<span class="op">,</span> IO_SOURCE_SPI1_HOLD_OUT<span class="op">);</span></span></code></pre></div>
<p>对于Slave，则还需要额外配置CS的内部上拉：</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb172-1"><a href="ch-spi.html#cb172-1" aria-hidden="true" tabindex="-1"></a>    PINCTRL_Pull<span class="op">(</span>SPI_MIC_CLK<span class="op">,</span>PINCTRL_PULL_DOWN<span class="op">);</span></span>
<span id="cb172-2"><a href="ch-spi.html#cb172-2" aria-hidden="true" tabindex="-1"></a>    PINCTRL_Pull<span class="op">(</span>SPI_MIC_CS<span class="op">,</span>PINCTRL_PULL_UP<span class="op">);</span></span></code></pre></div>
</div>
<div id="qspi-master" class="section level5 hasAnchor" number="13.2.5.2.2">
<h5><span class="header-section-number">13.2.5.2.2</span> QSPI Master<a href="ch-spi.html#qspi-master" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<div id="pparam-配置" class="section level6 hasAnchor" number="13.2.5.2.2.1">
<h6><span class="header-section-number">13.2.5.2.2.1</span> pParam 配置<a href="ch-spi.html#pparam-配置" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>QSPI的部分<code>pParam</code>参数需要修改为如下，同时<code>Addr</code>和<code>Cmd</code>需要打开：</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb173-1"><a href="ch-spi.html#cb173-1" aria-hidden="true" tabindex="-1"></a>    pParam<span class="op">.</span>eQuadMode <span class="op">=</span> SPI_DUALQUAD_QUAD_IO_MODE<span class="op">;</span></span>
<span id="cb173-2"><a href="ch-spi.html#cb173-2" aria-hidden="true" tabindex="-1"></a>    pParam<span class="op">.</span>SlaveDataOnly <span class="op">=</span> SPI_SLVDATAONLY_DISABLE<span class="op">;</span></span>
<span id="cb173-3"><a href="ch-spi.html#cb173-3" aria-hidden="true" tabindex="-1"></a>    pParam<span class="op">.</span>eAddrEn <span class="op">=</span> SPI_ADDREN_ENABLE<span class="op">;</span></span>
<span id="cb173-4"><a href="ch-spi.html#cb173-4" aria-hidden="true" tabindex="-1"></a>    pParam<span class="op">.</span>eCmdEn <span class="op">=</span> SPI_CMDEN_ENABLE<span class="op">;</span></span></code></pre></div>
<p>此外，Master还需要配置<code>pParam.eReadWriteMode</code>, 例如：</p>
<ul>
<li><code>SPI_TRANSMODE_WRITE_READ</code>： 读和写顺序执行，比如首先利用四线完成写操作，然后再读。</li>
<li><code>SPI_TRANSMODE_WRITE_DUMMY_READ</code>： 先写后读，在Write和Read之间添加dummy（默认为8个clk cycle）。</li>
</ul>
<p>对于Slave，则读写顺序相反：</p>
<ul>
<li><code>SPI_TRANSMODE_READ_WRITE</code>：先读后写。</li>
<li><code>SPI_TRANSMODE_READ_DUMMY_WRITE</code>： 先读后写，在Read和Write之间添加dummy（默认为8个clk cycle）。</li>
</ul>
<p><code>SPI_TransCtrl_TransMode_e</code>定义了可以使用的<code>pParam.eReadWriteMode</code>。</p>
<p>配置参数举例：</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb174-1"><a href="ch-spi.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_MASTER_PARAM(DataLen) { SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M, \</span></span>
<span id="cb174-2"><a href="ch-spi.html#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_CPHA_ODD_SCLK_EDGES, SPI_CPOL_SCLK_LOW_IN_IDLE_STATES, \</span></span>
<span id="cb174-3"><a href="ch-spi.html#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_LSB_MOST_SIGNIFICANT_BIT_FIRST, SPI_DATALEN_32_BITS, SPI_SLVMODE_MASTER_MODE, \</span></span>
<span id="cb174-4"><a href="ch-spi.html#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_TRANSMODE_WRITE_DUMMY_READ, SPI_DUALQUAD_QUAD_IO_MODE, DataLen, DataLen, \</span></span>
<span id="cb174-5"><a href="ch-spi.html#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_ADDREN_ENABLE, SPI_CMDEN_ENABLE, (1 &lt;&lt; bsSPI_INTREN_ENDINTEN), \</span></span>
<span id="cb174-6"><a href="ch-spi.html#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="pp">0, 0, SPI_SLVDATAONLY_DISABLE, SPI_ADDRLEN_1_BYTE }</span></span>
<span id="cb174-7"><a href="ch-spi.html#cb174-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-8"><a href="ch-spi.html#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define SPI_SLAVE_PARAM(DataLen) { SPI_INTERFACETIMINGSCLKDIV_DEFAULT_2M, \</span></span>
<span id="cb174-9"><a href="ch-spi.html#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_CPHA_ODD_SCLK_EDGES, SPI_CPOL_SCLK_LOW_IN_IDLE_STATES, \</span></span>
<span id="cb174-10"><a href="ch-spi.html#cb174-10" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_LSB_MOST_SIGNIFICANT_BIT_FIRST, SPI_DATALEN_32_BITS, SPI_SLVMODE_SLAVE_MODE, \</span></span>
<span id="cb174-11"><a href="ch-spi.html#cb174-11" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_TRANSMODE_READ_DUMMY_WRITE, SPI_DUALQUAD_QUAD_IO_MODE, DataLen, DataLen, \</span></span>
<span id="cb174-12"><a href="ch-spi.html#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="pp">SPI_ADDREN_ENABLE, SPI_CMDEN_ENABLE, (1 &lt;&lt; bsSPI_INTREN_ENDINTEN), \</span></span>
<span id="cb174-13"><a href="ch-spi.html#cb174-13" aria-hidden="true" tabindex="-1"></a><span class="pp">0, 0, SPI_SLVDATAONLY_DISABLE, SPI_ADDRLEN_1_BYTE }</span></span></code></pre></div>
</div>
<div id="dummy-cnt-配置" class="section level6 hasAnchor" number="13.2.5.2.2.2">
<h6><span class="header-section-number">13.2.5.2.2.2</span> Dummy cnt 配置<a href="ch-spi.html#dummy-cnt-配置" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p><code>pParam.eReadWriteMode</code>中指定了dummy的位置，通过<code>apSSP_SetTransferControlDummyCnt</code>配置dummy个数。</p>
<p>API的入参为dummy cnt，通过以下关系转换成API CLK的dummy cycles。</p>
<p><span class="math inline">\(cycles = (dummy \quad cnt + 1) \times ((pParam.eDataSize) / (spi \quad io \quad width))\)</span></p>
<table>
<thead>
<tr class="header">
<th>dummy cnt + 1</th>
<th>pParam.eDataSize</th>
<th>spi io width</th>
<th>cycles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>8</td>
<td>1(single)</td>
<td>8</td>
</tr>
<tr class="even">
<td>1</td>
<td>32</td>
<td>4(quad-qspi)</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>以上述的参数配置为例，则下述API可以将dummy cycle配置为16：</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb175-1"><a href="ch-spi.html#cb175-1" aria-hidden="true" tabindex="-1"></a>apSSP_SetTransferControlDummyCnt<span class="op">(</span>APB_SSP1<span class="op">,</span> <span class="dv">1</span><span class="op">);</span><span class="co">//dummy cnt = 1;</span></span></code></pre></div>
<p>注意，额外的配置需要在<code>apSSP_DeviceParametersSet</code>之后以避免参数覆盖。</p>
</div>
<div id="addr-格式" class="section level6 hasAnchor" number="13.2.5.2.2.3">
<h6><span class="header-section-number">13.2.5.2.2.3</span> Addr 格式<a href="ch-spi.html#addr-格式" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>QSPI的Command和Addr通过<code>apSSP_WriteCmd</code>配置，首先发送Command，Command固定占用MOSI的8个cycle， 然后发送Addr，Addr的长度通过<code>pParam.eAddrLen</code>配置，发送格式通过<code>apSSP_SetTransferControlAddrFmt</code>配置。</p>
<ul>
<li>SPI_ADDRFMT_SINGLE_MODE: 默认配置，Addr只占用MOSI</li>
<li>SPI_ADDRFMT_QUAD_MODE：Addr以QSPI的模式发送，占用MOSI,MISO,WP,HOLD</li>
</ul>
<p>该API只适用于SPI Master。 假如Addr配置为3字节以及QUAD MODE，则传输格式为：</p>
<p><img src="img/SPI/QSPI.PNG" title="QSPI" /></p>
</div>
<div id="qspi-读取和xip" class="section level6 hasAnchor" number="13.2.5.2.2.4">
<h6><span class="header-section-number">13.2.5.2.2.4</span> QSPI 读取和XIP<a href="ch-spi.html#qspi-读取和xip" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>当通过SPI外接FLASH模块的时候，可以通过芯片内置功能直接读取FLASH内容而不需要操作SPI。该功能只支持SPI0。</p>
<p>操作步骤为，</p>
<ul>
<li><p>首先打开时钟并且配置SPI IO， 参考<code>时钟以及IO配置</code>。对于QSPI，请参考QSPI的<code>IO配置</code>。</p>
<p>IO必须使用<code>高速时钟和IO映射</code>中SPI0的指定IO。</p></li>
<li><p>然后需要额外打开SPI的直接读取功能（不需要其他的SPI模块配置）</p></li>
</ul>
<div class="sourceCode" id="cb176"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb176-1"><a href="ch-spi.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> apSSP_SetMemAccessCmd<span class="op">(</span>SSP_TypeDef <span class="op">*</span>SPI_BASE<span class="op">,</span> apSSP_sDeviceMemRdCmd cmd<span class="op">);</span></span></code></pre></div>
<p>cmd用来选择FLASH的读取命令，该命令需要查看对应的FLASH手册来获取。<code>apSSP_sDeviceMemRdCmd</code>中 列出了所有支持的读取命令以及该命令的格式：</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb177-1"><a href="ch-spi.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span></span>
<span id="cb177-2"><a href="ch-spi.html#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb177-3"><a href="ch-spi.html#cb177-3" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_03 <span class="op">=</span> <span class="dv">0</span> <span class="op">,</span><span class="co">//read command 0x03 + 3bytes address(regular mode) + data (regular mode)</span></span>
<span id="cb177-4"><a href="ch-spi.html#cb177-4" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_0B <span class="op">=</span> <span class="dv">1</span> <span class="op">,</span><span class="co">//read command 0x0B + 3bytes address(regular mode) + 1byte dummy + data (regular mode)</span></span>
<span id="cb177-5"><a href="ch-spi.html#cb177-5" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_3B <span class="op">=</span> <span class="dv">2</span> <span class="op">,</span><span class="co">//read command 0x3B + 3bytes address(regular mode) + 1byte dummy + data (dual mode)</span></span>
<span id="cb177-6"><a href="ch-spi.html#cb177-6" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_6B <span class="op">=</span> <span class="dv">3</span> <span class="op">,</span><span class="co">//read command 0x6B + 3bytes address(regular mode) + 1byte dummy + data (quad mode)</span></span>
<span id="cb177-7"><a href="ch-spi.html#cb177-7" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_BB <span class="op">=</span> <span class="dv">4</span> <span class="op">,</span><span class="co">//read command 0xBB + 3bytes + 1byte 0 address(dual mode) + data (dual mode)</span></span>
<span id="cb177-8"><a href="ch-spi.html#cb177-8" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_EB <span class="op">=</span> <span class="dv">5</span> <span class="op">,</span><span class="co">//read command 0xEB + 3bytes + 1byte 0 address(quad mode) + 2bytes dummy + data (quad mode)</span></span>
<span id="cb177-9"><a href="ch-spi.html#cb177-9" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_13 <span class="op">=</span> <span class="dv">8</span> <span class="op">,</span><span class="co">//read command 0x13 + 4bytes address(regular mode) + data (regular mode)</span></span>
<span id="cb177-10"><a href="ch-spi.html#cb177-10" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_0C <span class="op">=</span> <span class="dv">9</span> <span class="op">,</span><span class="co">//read command 0x0C + 4bytes address(regular mode) + 1byte dummy + data (regular mode)</span></span>
<span id="cb177-11"><a href="ch-spi.html#cb177-11" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_3C <span class="op">=</span> <span class="dv">10</span><span class="op">,</span><span class="co">//read command 0x3C + 4bytes address(regular mode) + 1byte dummy + data (dual mode)</span></span>
<span id="cb177-12"><a href="ch-spi.html#cb177-12" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_6C <span class="op">=</span> <span class="dv">11</span><span class="op">,</span><span class="co">//read command 0x6C + 4bytes address(regular mode) + 1byte dummy + data (quad mode)</span></span>
<span id="cb177-13"><a href="ch-spi.html#cb177-13" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_BC <span class="op">=</span> <span class="dv">12</span><span class="op">,</span><span class="co">//read command 0xBC + 4bytes + 1byte 0 address(dual mode) + data (dual mode)</span></span>
<span id="cb177-14"><a href="ch-spi.html#cb177-14" aria-hidden="true" tabindex="-1"></a>  SPI_MEMRD_CMD_EC <span class="op">=</span> <span class="dv">13</span><span class="op">,</span><span class="co">//read command 0xEC + 4bytes + 1byte 0 address(quad mode) + 2bytes dummy + data (quad mode)</span></span>
<span id="cb177-15"><a href="ch-spi.html#cb177-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>apSSP_sDeviceMemRdCmd<span class="op">;</span></span></code></pre></div>
<p>以SPI_MEMRD_CMD_EB为例，该命令的格式为：command(0xEB)+address(4bytes)+dummy(2bytes)+data(quad mode) <img src="img/SPI/EBH.PNG" title="0xEB" /></p>
<ul>
<li>直接读取外置FLASH的内容</li>
</ul>
<p>外置FLASH的内容映射在<code>AHB_QSPI_MEM_BASE</code>开始的连续空间（32MB）。</p>
<ul>
<li>使用举例：</li>
</ul>
<div class="sourceCode" id="cb178"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb178-1"><a href="ch-spi.html#cb178-1" aria-hidden="true" tabindex="-1"></a>setup_peripherals_spi_pin<span class="op">();</span></span>
<span id="cb178-2"><a href="ch-spi.html#cb178-2" aria-hidden="true" tabindex="-1"></a>apSSP_SetMemAccessCmd<span class="op">(</span>AHB_SSP0<span class="op">,</span> SPI_MEMRD_CMD_EB<span class="op">);</span></span>
<span id="cb178-3"><a href="ch-spi.html#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="co">// read by *((uint8_t*)AHB_QSPI_MEM_BASE + i), i=[0,32MB)</span></span></code></pre></div>
<ul>
<li>XIP</li>
</ul>
<p>通过SPI模块下载程序到外置FLASH模块，然后跳转到外置FLASH地址来执行代码。</p>
</div>
</div>
<div id="qspi-slave" class="section level5 hasAnchor" number="13.2.5.2.3">
<h5><span class="header-section-number">13.2.5.2.3</span> QSPI Slave<a href="ch-spi.html#qspi-slave" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Addr只适用于Master，当作为Slave的时候，只支持Command命令。Slave在QSPI下集成了
两个Command:</p>
<ul>
<li><p>QSPI read only: 0x0E</p>
<p>格式固定为：Command(单线，8bit) + Dummy(单线，8bit) + read Data(四线)</p></li>
<li><p>QSPI write only: 0x54</p>
<p>格式固定为：Command(单线，8bit) + Dummy(单线，8bit) + write Data(四线)</p></li>
</ul>
<p>当使用这两个Command的时候，Master需要按照上述格式配置。</p>
</div>
</div>
<div id="高速时钟和io映射" class="section level4 hasAnchor" number="13.2.5.3">
<h4><span class="header-section-number">13.2.5.3</span> 高速时钟和IO映射<a href="ch-spi.html#高速时钟和io映射" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>只有SPI0支持XIP，最大时钟速率和VBAT有关：</p>
<table>
<thead>
<tr class="header">
<th>Function</th>
<th>SPI0</th>
<th>SPI1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>XIP</td>
<td>最大速率：96M（取决于VBAT）</td>
<td>不支持</td>
</tr>
</tbody>
</table>
<p>SPI0和SPI1最大可以支持的时钟在不同场景下有区别：</p>
<table>
<thead>
<tr class="header">
<th>Function</th>
<th>SPI0</th>
<th>SPI1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Master</td>
<td>传输中只有读或者写：96M</td>
<td>24M</td>
</tr>
<tr class="even">
<td>Master</td>
<td>传输中既有读也有写：48M</td>
<td>24M</td>
</tr>
<tr class="odd">
<td>Slave</td>
<td>24M</td>
<td>24M</td>
</tr>
</tbody>
</table>
<p>高速时钟对IO能力有要求，因此对于时钟大于20M的情况，需要使用以下固定的IO，其中SPI0的IO映射固定。对于SPI1，SCLK必须使用IO7，其他IO8/9/10/11/12可以任意配置。</p>
<table>
<thead>
<tr class="header">
<th>SPI0</th>
<th>SPI1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GPIO36:CS</td>
<td>GPIO7: SCLK</td>
</tr>
<tr class="even">
<td>GPIO37:SCLK</td>
<td>GPIO8: CS/HOLD/WP/MISO/MOSI</td>
</tr>
<tr class="odd">
<td>GPIO38:HOLD</td>
<td>GPIO9: CS/HOLD/WP/MISO/MOSI</td>
</tr>
<tr class="even">
<td>GPIO39:WP</td>
<td>GPIO10:CS/HOLD/WP/MISO/MOSI</td>
</tr>
<tr class="odd">
<td>GPIO40:MISO</td>
<td>GPIO11:CS/HOLD/WP/MISO/MOSI</td>
</tr>
<tr class="even">
<td>GPIO41:MOSI</td>
<td>GPIO12:CS/HOLD/WP/MISO/MOSI</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ch-qdec.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ch-sysctrl.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["pg_ing20.pdf", "pg_ing20.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
