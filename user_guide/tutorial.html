<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Tutorials | INGCHIPS SDK User Guide</title>
  <meta name="description" content="This is the user guide of INGCHIPS SDK." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Tutorials | INGCHIPS SDK User Guide" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="./img/sdk_overview.png" />
  <meta property="og:description" content="This is the user guide of INGCHIPS SDK." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Tutorials | INGCHIPS SDK User Guide" />
  
  <meta name="twitter:description" content="This is the user guide of INGCHIPS SDK." />
  <meta name="twitter:image" content="./img/sdk_overview.png" />

<meta name="author" content="v1.2" />


<meta name="date" content="2021-09-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="core-tools.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">User Guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#scope"><i class="fa fa-check"></i><b>2.1</b> Scope</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#architecture"><i class="fa fa-check"></i><b>2.2</b> Architecture</a><ul>
<li class="chapter" data-level="2.2.1" data-path="intro.html"><a href="intro.html#apps-built-with-c"><i class="fa fa-check"></i><b>2.2.1</b> Apps built with <code>C</code></a></li>
<li class="chapter" data-level="2.2.2" data-path="intro.html"><a href="intro.html#apps-built-with-nim"><i class="fa fa-check"></i><b>2.2.2</b> Apps built with <code>Nim</code></a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#abbreviations-terminology"><i class="fa fa-check"></i><b>2.3</b> Abbreviations &amp; Terminology</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#references"><i class="fa fa-check"></i><b>2.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tutorial.html"><a href="tutorial.html"><i class="fa fa-check"></i><b>3</b> Tutorials</a><ul>
<li class="chapter" data-level="3.1" data-path="tutorial.html"><a href="tutorial.html#ch1-hello-world"><i class="fa fa-check"></i><b>3.1</b> Hello World</a><ul>
<li class="chapter" data-level="3.1.1" data-path="tutorial.html"><a href="tutorial.html#development-tool-page"><i class="fa fa-check"></i><b>3.1.1</b> <code>Development Tool</code> Page</a></li>
<li class="chapter" data-level="3.1.2" data-path="tutorial.html"><a href="tutorial.html#choose-chip-series-page"><i class="fa fa-check"></i><b>3.1.2</b> <code>Choose Chip Series</code> Page</a></li>
<li class="chapter" data-level="3.1.3" data-path="tutorial.html"><a href="tutorial.html#choose-project-type-page"><i class="fa fa-check"></i><b>3.1.3</b> <code>Choose Project Type</code> Page</a></li>
<li class="chapter" data-level="3.1.4" data-path="tutorial.html"><a href="tutorial.html#role-of-your-device-page"><i class="fa fa-check"></i><b>3.1.4</b> <code>Role of Your Device</code> Page</a></li>
<li class="chapter" data-level="3.1.5" data-path="tutorial.html"><a href="tutorial.html#peripheral-setup-page"><i class="fa fa-check"></i><b>3.1.5</b> <code>Peripheral Setup</code> Page</a></li>
<li class="chapter" data-level="3.1.6" data-path="tutorial.html"><a href="tutorial.html#security-privacy-page"><i class="fa fa-check"></i><b>3.1.6</b> <code>Security &amp; Privacy</code> Page</a></li>
<li class="chapter" data-level="3.1.7" data-path="tutorial.html"><a href="tutorial.html#firmare-over-the-air-page"><i class="fa fa-check"></i><b>3.1.7</b> <code>Firmare Over-The-Air</code> Page</a></li>
<li class="chapter" data-level="3.1.8" data-path="tutorial.html"><a href="tutorial.html#common-functions-page"><i class="fa fa-check"></i><b>3.1.8</b> <code>Common Functions</code> Page</a></li>
<li class="chapter" data-level="3.1.9" data-path="tutorial.html"><a href="tutorial.html#build-your-project"><i class="fa fa-check"></i><b>3.1.9</b> Build your project</a></li>
<li class="chapter" data-level="3.1.10" data-path="tutorial.html"><a href="tutorial.html#download"><i class="fa fa-check"></i><b>3.1.10</b> Download</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="tutorial.html"><a href="tutorial.html#ibeacon"><i class="fa fa-check"></i><b>3.2</b> iBeacon</a><ul>
<li class="chapter" data-level="3.2.1" data-path="tutorial.html"><a href="tutorial.html#setup-advertising-data"><i class="fa fa-check"></i><b>3.2.1</b> Setup Advertising Data</a></li>
<li class="chapter" data-level="3.2.2" data-path="tutorial.html"><a href="tutorial.html#try-it"><i class="fa fa-check"></i><b>3.2.2</b> Try It</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="tutorial.html"><a href="tutorial.html#thermometer"><i class="fa fa-check"></i><b>3.3</b> Thermometer</a><ul>
<li class="chapter" data-level="3.3.1" data-path="tutorial.html"><a href="tutorial.html#setup-advertising-data-1"><i class="fa fa-check"></i><b>3.3.1</b> Setup Advertising Data</a></li>
<li class="chapter" data-level="3.3.2" data-path="tutorial.html"><a href="tutorial.html#setup-gatt-profile"><i class="fa fa-check"></i><b>3.3.2</b> Setup GATT Profile</a></li>
<li class="chapter" data-level="3.3.3" data-path="tutorial.html"><a href="tutorial.html#write-the-code"><i class="fa fa-check"></i><b>3.3.3</b> Write the Code</a></li>
<li class="chapter" data-level="3.3.4" data-path="tutorial.html"><a href="tutorial.html#notification"><i class="fa fa-check"></i><b>3.3.4</b> Notification</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="tutorial.html"><a href="tutorial.html#thermometer-with-fota"><i class="fa fa-check"></i><b>3.4</b> Thermometer with FOTA</a><ul>
<li class="chapter" data-level="3.4.1" data-path="tutorial.html"><a href="tutorial.html#device-with-fota"><i class="fa fa-check"></i><b>3.4.1</b> Device with FOTA</a></li>
<li class="chapter" data-level="3.4.2" data-path="tutorial.html"><a href="tutorial.html#make-a-new-version"><i class="fa fa-check"></i><b>3.4.2</b> Make a New Version</a></li>
<li class="chapter" data-level="3.4.3" data-path="tutorial.html"><a href="tutorial.html#fota-server"><i class="fa fa-check"></i><b>3.4.3</b> FOTA Server</a></li>
<li class="chapter" data-level="3.4.4" data-path="tutorial.html"><a href="tutorial.html#try-it-1"><i class="fa fa-check"></i><b>3.4.4</b> Try It</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="tutorial.html"><a href="tutorial.html#ibeacon-scanner"><i class="fa fa-check"></i><b>3.5</b> iBeacon Scanner</a><ul>
<li class="chapter" data-level="3.5.1" data-path="tutorial.html"><a href="tutorial.html#distance-estimation"><i class="fa fa-check"></i><b>3.5.1</b> Distance Estimation</a></li>
<li class="chapter" data-level="3.5.2" data-path="tutorial.html"><a href="tutorial.html#concurrent-advertising-scanning"><i class="fa fa-check"></i><b>3.5.2</b> Concurrent Advertising &amp; Scanning</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="tutorial.html"><a href="tutorial.html#notification-indication"><i class="fa fa-check"></i><b>3.6</b> Notification &amp; Indication</a><ul>
<li class="chapter" data-level="3.6.1" data-path="tutorial.html"><a href="tutorial.html#inter-task-comm"><i class="fa fa-check"></i><b>3.6.1</b> Inter-task Communication</a></li>
<li class="chapter" data-level="3.6.2" data-path="tutorial.html"><a href="tutorial.html#timer"><i class="fa fa-check"></i><b>3.6.2</b> Timer</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="tutorial.html"><a href="tutorial.html#throughput"><i class="fa fa-check"></i><b>3.7</b> Throughput</a><ul>
<li class="chapter" data-level="3.7.1" data-path="tutorial.html"><a href="tutorial.html#theoretical-peak-throughput"><i class="fa fa-check"></i><b>3.7.1</b> Theoretical Peak Throughput</a></li>
<li class="chapter" data-level="3.7.2" data-path="tutorial.html"><a href="tutorial.html#test-throughput"><i class="fa fa-check"></i><b>3.7.2</b> Test Throughput</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="tutorial.html"><a href="tutorial.html#dual-role-ble-gateway"><i class="fa fa-check"></i><b>3.8</b> Dual Role &amp; BLE Gateway</a><ul>
<li class="chapter" data-level="3.8.1" data-path="tutorial.html"><a href="tutorial.html#use-ingwizard-to-create-a-peripheral-app"><i class="fa fa-check"></i><b>3.8.1</b> Use <code>ingWizard</code> to create a peripheral app</a></li>
<li class="chapter" data-level="3.8.2" data-path="tutorial.html"><a href="tutorial.html#define-thermometer-data"><i class="fa fa-check"></i><b>3.8.2</b> Define Thermometer Data</a></li>
<li class="chapter" data-level="3.8.3" data-path="tutorial.html"><a href="tutorial.html#scan-for-thermometers"><i class="fa fa-check"></i><b>3.8.3</b> Scan for Thermometers</a></li>
<li class="chapter" data-level="3.8.4" data-path="tutorial.html"><a href="tutorial.html#discover-services"><i class="fa fa-check"></i><b>3.8.4</b> Discover Services</a></li>
<li class="chapter" data-level="3.8.5" data-path="tutorial.html"><a href="tutorial.html#data-handling"><i class="fa fa-check"></i><b>3.8.5</b> Data Handling</a></li>
<li class="chapter" data-level="3.8.6" data-path="tutorial.html"><a href="tutorial.html#robustness"><i class="fa fa-check"></i><b>3.8.6</b> Robustness</a></li>
<li class="chapter" data-level="3.8.7" data-path="tutorial.html"><a href="tutorial.html#prepare-thermometers"><i class="fa fa-check"></i><b>3.8.7</b> Prepare Thermometers</a></li>
<li class="chapter" data-level="3.8.8" data-path="tutorial.html"><a href="tutorial.html#test"><i class="fa fa-check"></i><b>3.8.8</b> Test</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="tutorial.html"><a href="tutorial.html#hello-nim"><i class="fa fa-check"></i><b>3.9</b> Hello, Nim</a><ul>
<li class="chapter" data-level="3.9.1" data-path="tutorial.html"><a href="tutorial.html#create-a-nim-project"><i class="fa fa-check"></i><b>3.9.1</b> Create a <code>Nim</code> Project</a></li>
<li class="chapter" data-level="3.9.2" data-path="tutorial.html"><a href="tutorial.html#create-advertising-data"><i class="fa fa-check"></i><b>3.9.2</b> Create Advertising Data</a></li>
<li class="chapter" data-level="3.9.3" data-path="tutorial.html"><a href="tutorial.html#create-profile-data"><i class="fa fa-check"></i><b>3.9.3</b> Create Profile Data</a></li>
<li class="chapter" data-level="3.9.4" data-path="tutorial.html"><a href="tutorial.html#benefits-of-adopting-nim"><i class="fa fa-check"></i><b>3.9.4</b> Benefits of Adopting <code>Nim</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="core-tools.html"><a href="core-tools.html"><i class="fa fa-check"></i><b>4</b> Core Tools</a><ul>
<li class="chapter" data-level="4.1" data-path="core-tools.html"><a href="core-tools.html#ingwizard"><i class="fa fa-check"></i><b>4.1</b> ingWizard</a></li>
<li class="chapter" data-level="4.2" data-path="core-tools.html"><a href="core-tools.html#ch2-downloader"><i class="fa fa-check"></i><b>4.2</b> Downloader</a><ul>
<li class="chapter" data-level="4.2.1" data-path="core-tools.html"><a href="core-tools.html#introduction"><i class="fa fa-check"></i><b>4.2.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2.2" data-path="core-tools.html"><a href="core-tools.html#script-mass-prod"><i class="fa fa-check"></i><b>4.2.2</b> Scripting &amp; Mass Production</a></li>
<li class="chapter" data-level="4.2.3" data-path="core-tools.html"><a href="core-tools.html#flash-read-protection"><i class="fa fa-check"></i><b>4.2.3</b> Flash Read Protection</a></li>
<li class="chapter" data-level="4.2.4" data-path="core-tools.html"><a href="core-tools.html#python-version"><i class="fa fa-check"></i><b>4.2.4</b> Python Version</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="core-tools.html"><a href="core-tools.html#ingtracer"><i class="fa fa-check"></i><b>4.3</b> ingTracer</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html"><i class="fa fa-check"></i><b>5</b> Dive Into SDK</a><ul>
<li class="chapter" data-level="5.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#memory-management"><i class="fa fa-check"></i><b>5.1</b> Memory Management</a><ul>
<li class="chapter" data-level="5.1.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#global-variables"><i class="fa fa-check"></i><b>5.1.1</b> Global Variables</a></li>
<li class="chapter" data-level="5.1.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#using-stack"><i class="fa fa-check"></i><b>5.1.2</b> Using Stack</a></li>
<li class="chapter" data-level="5.1.3" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#using-heap"><i class="fa fa-check"></i><b>5.1.3</b> Using Heap</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#multitasking"><i class="fa fa-check"></i><b>5.2</b> Multitasking</a></li>
<li class="chapter" data-level="5.3" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#interrupt-management"><i class="fa fa-check"></i><b>5.3</b> Interrupt Management</a></li>
<li class="chapter" data-level="5.4" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#power-management"><i class="fa fa-check"></i><b>5.4</b> Power Management</a></li>
<li class="chapter" data-level="5.5" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#cmsis-api"><i class="fa fa-check"></i><b>5.5</b> CMSIS API</a></li>
<li class="chapter" data-level="5.6" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#debugging-tracing"><i class="fa fa-check"></i><b>5.6</b> Debugging &amp; Tracing</a><ul>
<li class="chapter" data-level="5.6.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#tips-on-segger-rtt"><i class="fa fa-check"></i><b>5.6.1</b> Tips on SEGGER RTT</a></li>
<li class="chapter" data-level="5.6.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#memory-dump"><i class="fa fa-check"></i><b>5.6.2</b> Memory Dump</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="api-ref.html"><a href="api-ref.html"><i class="fa fa-check"></i><b>6</b> Platform API Reference</a><ul>
<li class="chapter" data-level="6.1" data-path="api-ref.html"><a href="api-ref.html#platform_32k_rc_auto_tune"><i class="fa fa-check"></i><b>6.1</b> <code>platform_32k_rc_auto_tune</code></a><ul>
<li class="chapter" data-level="6.1.1" data-path="api-ref.html"><a href="api-ref.html#prototype"><i class="fa fa-check"></i><b>6.1.1</b> Prototype</a></li>
<li class="chapter" data-level="6.1.2" data-path="api-ref.html"><a href="api-ref.html#parameters"><i class="fa fa-check"></i><b>6.1.2</b> Parameters</a></li>
<li class="chapter" data-level="6.1.3" data-path="api-ref.html"><a href="api-ref.html#return-value"><i class="fa fa-check"></i><b>6.1.3</b> Return Value</a></li>
<li class="chapter" data-level="6.1.4" data-path="api-ref.html"><a href="api-ref.html#remarks"><i class="fa fa-check"></i><b>6.1.4</b> Remarks</a></li>
<li class="chapter" data-level="6.1.5" data-path="api-ref.html"><a href="api-ref.html#example"><i class="fa fa-check"></i><b>6.1.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="api-ref.html"><a href="api-ref.html#platform_32k_rc_tune"><i class="fa fa-check"></i><b>6.2</b> <code>platform_32k_rc_tune</code></a><ul>
<li class="chapter" data-level="6.2.1" data-path="api-ref.html"><a href="api-ref.html#prototype-1"><i class="fa fa-check"></i><b>6.2.1</b> Prototype</a></li>
<li class="chapter" data-level="6.2.2" data-path="api-ref.html"><a href="api-ref.html#parameters-1"><i class="fa fa-check"></i><b>6.2.2</b> Parameters</a></li>
<li class="chapter" data-level="6.2.3" data-path="api-ref.html"><a href="api-ref.html#return-value-1"><i class="fa fa-check"></i><b>6.2.3</b> Return Value</a></li>
<li class="chapter" data-level="6.2.4" data-path="api-ref.html"><a href="api-ref.html#remarks-1"><i class="fa fa-check"></i><b>6.2.4</b> Remarks</a></li>
<li class="chapter" data-level="6.2.5" data-path="api-ref.html"><a href="api-ref.html#example-1"><i class="fa fa-check"></i><b>6.2.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="api-ref.html"><a href="api-ref.html#platform_config"><i class="fa fa-check"></i><b>6.3</b> <code>platform_config</code></a><ul>
<li class="chapter" data-level="6.3.1" data-path="api-ref.html"><a href="api-ref.html#prototype-2"><i class="fa fa-check"></i><b>6.3.1</b> Prototype</a></li>
<li class="chapter" data-level="6.3.2" data-path="api-ref.html"><a href="api-ref.html#parameters-2"><i class="fa fa-check"></i><b>6.3.2</b> Parameters</a></li>
<li class="chapter" data-level="6.3.3" data-path="api-ref.html"><a href="api-ref.html#return-value-2"><i class="fa fa-check"></i><b>6.3.3</b> Return Value</a></li>
<li class="chapter" data-level="6.3.4" data-path="api-ref.html"><a href="api-ref.html#remarks-2"><i class="fa fa-check"></i><b>6.3.4</b> Remarks</a></li>
<li class="chapter" data-level="6.3.5" data-path="api-ref.html"><a href="api-ref.html#example-2"><i class="fa fa-check"></i><b>6.3.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="api-ref.html"><a href="api-ref.html#platform_get_heap_status"><i class="fa fa-check"></i><b>6.4</b> <code>platform_get_heap_status</code></a><ul>
<li class="chapter" data-level="6.4.1" data-path="api-ref.html"><a href="api-ref.html#prototype-3"><i class="fa fa-check"></i><b>6.4.1</b> Prototype</a></li>
<li class="chapter" data-level="6.4.2" data-path="api-ref.html"><a href="api-ref.html#parameters-3"><i class="fa fa-check"></i><b>6.4.2</b> Parameters</a></li>
<li class="chapter" data-level="6.4.3" data-path="api-ref.html"><a href="api-ref.html#return-value-3"><i class="fa fa-check"></i><b>6.4.3</b> Return Value</a></li>
<li class="chapter" data-level="6.4.4" data-path="api-ref.html"><a href="api-ref.html#remarks-3"><i class="fa fa-check"></i><b>6.4.4</b> Remarks</a></li>
<li class="chapter" data-level="6.4.5" data-path="api-ref.html"><a href="api-ref.html#example-3"><i class="fa fa-check"></i><b>6.4.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="api-ref.html"><a href="api-ref.html#platform_get_us_time"><i class="fa fa-check"></i><b>6.5</b> <code>platform_get_us_time</code></a><ul>
<li class="chapter" data-level="6.5.1" data-path="api-ref.html"><a href="api-ref.html#prototype-4"><i class="fa fa-check"></i><b>6.5.1</b> Prototype</a></li>
<li class="chapter" data-level="6.5.2" data-path="api-ref.html"><a href="api-ref.html#parameters-4"><i class="fa fa-check"></i><b>6.5.2</b> Parameters</a></li>
<li class="chapter" data-level="6.5.3" data-path="api-ref.html"><a href="api-ref.html#return-value-4"><i class="fa fa-check"></i><b>6.5.3</b> Return Value</a></li>
<li class="chapter" data-level="6.5.4" data-path="api-ref.html"><a href="api-ref.html#remarks-4"><i class="fa fa-check"></i><b>6.5.4</b> Remarks</a></li>
<li class="chapter" data-level="6.5.5" data-path="api-ref.html"><a href="api-ref.html#example-4"><i class="fa fa-check"></i><b>6.5.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="api-ref.html"><a href="api-ref.html#platform_get_version"><i class="fa fa-check"></i><b>6.6</b> <code>platform_get_version</code></a><ul>
<li class="chapter" data-level="6.6.1" data-path="api-ref.html"><a href="api-ref.html#prototype-5"><i class="fa fa-check"></i><b>6.6.1</b> Prototype</a></li>
<li class="chapter" data-level="6.6.2" data-path="api-ref.html"><a href="api-ref.html#parameters-5"><i class="fa fa-check"></i><b>6.6.2</b> Parameters</a></li>
<li class="chapter" data-level="6.6.3" data-path="api-ref.html"><a href="api-ref.html#return-value-5"><i class="fa fa-check"></i><b>6.6.3</b> Return Value</a></li>
<li class="chapter" data-level="6.6.4" data-path="api-ref.html"><a href="api-ref.html#remarks-5"><i class="fa fa-check"></i><b>6.6.4</b> Remarks</a></li>
<li class="chapter" data-level="6.6.5" data-path="api-ref.html"><a href="api-ref.html#example-5"><i class="fa fa-check"></i><b>6.6.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="api-ref.html"><a href="api-ref.html#platform_hrng"><i class="fa fa-check"></i><b>6.7</b> <code>platform_hrng</code></a><ul>
<li class="chapter" data-level="6.7.1" data-path="api-ref.html"><a href="api-ref.html#prototype-6"><i class="fa fa-check"></i><b>6.7.1</b> Prototype</a></li>
<li class="chapter" data-level="6.7.2" data-path="api-ref.html"><a href="api-ref.html#parameters-6"><i class="fa fa-check"></i><b>6.7.2</b> Parameters</a></li>
<li class="chapter" data-level="6.7.3" data-path="api-ref.html"><a href="api-ref.html#return-value-6"><i class="fa fa-check"></i><b>6.7.3</b> Return Value</a></li>
<li class="chapter" data-level="6.7.4" data-path="api-ref.html"><a href="api-ref.html#remarks-6"><i class="fa fa-check"></i><b>6.7.4</b> Remarks</a></li>
<li class="chapter" data-level="6.7.5" data-path="api-ref.html"><a href="api-ref.html#example-6"><i class="fa fa-check"></i><b>6.7.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="api-ref.html"><a href="api-ref.html#platform_install_isr_stack"><i class="fa fa-check"></i><b>6.8</b> <code>platform_install_isr_stack</code></a><ul>
<li class="chapter" data-level="6.8.1" data-path="api-ref.html"><a href="api-ref.html#prototype-7"><i class="fa fa-check"></i><b>6.8.1</b> Prototype</a></li>
<li class="chapter" data-level="6.8.2" data-path="api-ref.html"><a href="api-ref.html#parameters-7"><i class="fa fa-check"></i><b>6.8.2</b> Parameters</a></li>
<li class="chapter" data-level="6.8.3" data-path="api-ref.html"><a href="api-ref.html#return-value-7"><i class="fa fa-check"></i><b>6.8.3</b> Return Value</a></li>
<li class="chapter" data-level="6.8.4" data-path="api-ref.html"><a href="api-ref.html#remarks-7"><i class="fa fa-check"></i><b>6.8.4</b> Remarks</a></li>
<li class="chapter" data-level="6.8.5" data-path="api-ref.html"><a href="api-ref.html#example-7"><i class="fa fa-check"></i><b>6.8.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="api-ref.html"><a href="api-ref.html#platform_printf"><i class="fa fa-check"></i><b>6.9</b> <code>platform_printf</code></a><ul>
<li class="chapter" data-level="6.9.1" data-path="api-ref.html"><a href="api-ref.html#prototype-8"><i class="fa fa-check"></i><b>6.9.1</b> Prototype</a></li>
<li class="chapter" data-level="6.9.2" data-path="api-ref.html"><a href="api-ref.html#parameters-8"><i class="fa fa-check"></i><b>6.9.2</b> Parameters</a></li>
<li class="chapter" data-level="6.9.3" data-path="api-ref.html"><a href="api-ref.html#return-value-8"><i class="fa fa-check"></i><b>6.9.3</b> Return Value</a></li>
<li class="chapter" data-level="6.9.4" data-path="api-ref.html"><a href="api-ref.html#remarks-8"><i class="fa fa-check"></i><b>6.9.4</b> Remarks</a></li>
<li class="chapter" data-level="6.9.5" data-path="api-ref.html"><a href="api-ref.html#example-8"><i class="fa fa-check"></i><b>6.9.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="api-ref.html"><a href="api-ref.html#platform_raise_assertion"><i class="fa fa-check"></i><b>6.10</b> <code>platform_raise_assertion</code></a><ul>
<li class="chapter" data-level="6.10.1" data-path="api-ref.html"><a href="api-ref.html#prototype-9"><i class="fa fa-check"></i><b>6.10.1</b> Prototype</a></li>
<li class="chapter" data-level="6.10.2" data-path="api-ref.html"><a href="api-ref.html#parameters-9"><i class="fa fa-check"></i><b>6.10.2</b> Parameters</a></li>
<li class="chapter" data-level="6.10.3" data-path="api-ref.html"><a href="api-ref.html#return-value-9"><i class="fa fa-check"></i><b>6.10.3</b> Return Value</a></li>
<li class="chapter" data-level="6.10.4" data-path="api-ref.html"><a href="api-ref.html#remarks-9"><i class="fa fa-check"></i><b>6.10.4</b> Remarks</a></li>
<li class="chapter" data-level="6.10.5" data-path="api-ref.html"><a href="api-ref.html#example-9"><i class="fa fa-check"></i><b>6.10.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.11" data-path="api-ref.html"><a href="api-ref.html#platform_rand"><i class="fa fa-check"></i><b>6.11</b> <code>platform_rand</code></a><ul>
<li class="chapter" data-level="6.11.1" data-path="api-ref.html"><a href="api-ref.html#prototype-10"><i class="fa fa-check"></i><b>6.11.1</b> Prototype</a></li>
<li class="chapter" data-level="6.11.2" data-path="api-ref.html"><a href="api-ref.html#parameters-10"><i class="fa fa-check"></i><b>6.11.2</b> Parameters</a></li>
<li class="chapter" data-level="6.11.3" data-path="api-ref.html"><a href="api-ref.html#return-value-10"><i class="fa fa-check"></i><b>6.11.3</b> Return Value</a></li>
<li class="chapter" data-level="6.11.4" data-path="api-ref.html"><a href="api-ref.html#remarks-10"><i class="fa fa-check"></i><b>6.11.4</b> Remarks</a></li>
<li class="chapter" data-level="6.11.5" data-path="api-ref.html"><a href="api-ref.html#example-10"><i class="fa fa-check"></i><b>6.11.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="api-ref.html"><a href="api-ref.html#platform_read_info"><i class="fa fa-check"></i><b>6.12</b> <code>platform_read_info</code></a><ul>
<li class="chapter" data-level="6.12.1" data-path="api-ref.html"><a href="api-ref.html#prototype-11"><i class="fa fa-check"></i><b>6.12.1</b> Prototype</a></li>
<li class="chapter" data-level="6.12.2" data-path="api-ref.html"><a href="api-ref.html#parameters-11"><i class="fa fa-check"></i><b>6.12.2</b> Parameters</a></li>
<li class="chapter" data-level="6.12.3" data-path="api-ref.html"><a href="api-ref.html#return-value-11"><i class="fa fa-check"></i><b>6.12.3</b> Return Value</a></li>
<li class="chapter" data-level="6.12.4" data-path="api-ref.html"><a href="api-ref.html#remarks-11"><i class="fa fa-check"></i><b>6.12.4</b> Remarks</a></li>
<li class="chapter" data-level="6.12.5" data-path="api-ref.html"><a href="api-ref.html#example-11"><i class="fa fa-check"></i><b>6.12.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.13" data-path="api-ref.html"><a href="api-ref.html#platform_read_persistent_reg"><i class="fa fa-check"></i><b>6.13</b> <code>platform_read_persistent_reg</code></a><ul>
<li class="chapter" data-level="6.13.1" data-path="api-ref.html"><a href="api-ref.html#prototype-12"><i class="fa fa-check"></i><b>6.13.1</b> Prototype</a></li>
<li class="chapter" data-level="6.13.2" data-path="api-ref.html"><a href="api-ref.html#parameters-12"><i class="fa fa-check"></i><b>6.13.2</b> Parameters</a></li>
<li class="chapter" data-level="6.13.3" data-path="api-ref.html"><a href="api-ref.html#return-value-12"><i class="fa fa-check"></i><b>6.13.3</b> Return Value</a></li>
<li class="chapter" data-level="6.13.4" data-path="api-ref.html"><a href="api-ref.html#remarks-12"><i class="fa fa-check"></i><b>6.13.4</b> Remarks</a></li>
<li class="chapter" data-level="6.13.5" data-path="api-ref.html"><a href="api-ref.html#example-12"><i class="fa fa-check"></i><b>6.13.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.14" data-path="api-ref.html"><a href="api-ref.html#platform_reset"><i class="fa fa-check"></i><b>6.14</b> <code>platform_reset</code></a><ul>
<li class="chapter" data-level="6.14.1" data-path="api-ref.html"><a href="api-ref.html#prototype-13"><i class="fa fa-check"></i><b>6.14.1</b> Prototype</a></li>
<li class="chapter" data-level="6.14.2" data-path="api-ref.html"><a href="api-ref.html#parameters-13"><i class="fa fa-check"></i><b>6.14.2</b> Parameters</a></li>
<li class="chapter" data-level="6.14.3" data-path="api-ref.html"><a href="api-ref.html#return-value-13"><i class="fa fa-check"></i><b>6.14.3</b> Return Value</a></li>
<li class="chapter" data-level="6.14.4" data-path="api-ref.html"><a href="api-ref.html#remarks-13"><i class="fa fa-check"></i><b>6.14.4</b> Remarks</a></li>
<li class="chapter" data-level="6.14.5" data-path="api-ref.html"><a href="api-ref.html#example-13"><i class="fa fa-check"></i><b>6.14.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.15" data-path="api-ref.html"><a href="api-ref.html#platform_set_evt_callback"><i class="fa fa-check"></i><b>6.15</b> <code>platform_set_evt_callback</code></a><ul>
<li class="chapter" data-level="6.15.1" data-path="api-ref.html"><a href="api-ref.html#prototype-14"><i class="fa fa-check"></i><b>6.15.1</b> Prototype</a></li>
<li class="chapter" data-level="6.15.2" data-path="api-ref.html"><a href="api-ref.html#parameters-14"><i class="fa fa-check"></i><b>6.15.2</b> Parameters</a></li>
<li class="chapter" data-level="6.15.3" data-path="api-ref.html"><a href="api-ref.html#return-value-14"><i class="fa fa-check"></i><b>6.15.3</b> Return Value</a></li>
<li class="chapter" data-level="6.15.4" data-path="api-ref.html"><a href="api-ref.html#remarks-14"><i class="fa fa-check"></i><b>6.15.4</b> Remarks</a></li>
<li class="chapter" data-level="6.15.5" data-path="api-ref.html"><a href="api-ref.html#example-14"><i class="fa fa-check"></i><b>6.15.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.16" data-path="api-ref.html"><a href="api-ref.html#platform_set_irq_callback"><i class="fa fa-check"></i><b>6.16</b> <code>platform_set_irq_callback</code></a><ul>
<li class="chapter" data-level="6.16.1" data-path="api-ref.html"><a href="api-ref.html#prototype-15"><i class="fa fa-check"></i><b>6.16.1</b> Prototype</a></li>
<li class="chapter" data-level="6.16.2" data-path="api-ref.html"><a href="api-ref.html#parameters-15"><i class="fa fa-check"></i><b>6.16.2</b> Parameters</a></li>
<li class="chapter" data-level="6.16.3" data-path="api-ref.html"><a href="api-ref.html#return-value-15"><i class="fa fa-check"></i><b>6.16.3</b> Return Value</a></li>
<li class="chapter" data-level="6.16.4" data-path="api-ref.html"><a href="api-ref.html#remarks-15"><i class="fa fa-check"></i><b>6.16.4</b> Remarks</a></li>
<li class="chapter" data-level="6.16.5" data-path="api-ref.html"><a href="api-ref.html#example-15"><i class="fa fa-check"></i><b>6.16.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.17" data-path="api-ref.html"><a href="api-ref.html#platform_shutdown"><i class="fa fa-check"></i><b>6.17</b> <code>platform_shutdown</code></a><ul>
<li class="chapter" data-level="6.17.1" data-path="api-ref.html"><a href="api-ref.html#prototype-16"><i class="fa fa-check"></i><b>6.17.1</b> Prototype</a></li>
<li class="chapter" data-level="6.17.2" data-path="api-ref.html"><a href="api-ref.html#parameters-16"><i class="fa fa-check"></i><b>6.17.2</b> Parameters</a></li>
<li class="chapter" data-level="6.17.3" data-path="api-ref.html"><a href="api-ref.html#return-value-16"><i class="fa fa-check"></i><b>6.17.3</b> Return Value</a></li>
<li class="chapter" data-level="6.17.4" data-path="api-ref.html"><a href="api-ref.html#remarks-16"><i class="fa fa-check"></i><b>6.17.4</b> Remarks</a></li>
<li class="chapter" data-level="6.17.5" data-path="api-ref.html"><a href="api-ref.html#example-16"><i class="fa fa-check"></i><b>6.17.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.18" data-path="api-ref.html"><a href="api-ref.html#api-switch-app"><i class="fa fa-check"></i><b>6.18</b> <code>platform_switch_app</code></a><ul>
<li class="chapter" data-level="6.18.1" data-path="api-ref.html"><a href="api-ref.html#prototype-17"><i class="fa fa-check"></i><b>6.18.1</b> Prototype</a></li>
<li class="chapter" data-level="6.18.2" data-path="api-ref.html"><a href="api-ref.html#parameters-17"><i class="fa fa-check"></i><b>6.18.2</b> Parameters</a></li>
<li class="chapter" data-level="6.18.3" data-path="api-ref.html"><a href="api-ref.html#return-value-17"><i class="fa fa-check"></i><b>6.18.3</b> Return Value</a></li>
<li class="chapter" data-level="6.18.4" data-path="api-ref.html"><a href="api-ref.html#remarks-17"><i class="fa fa-check"></i><b>6.18.4</b> Remarks</a></li>
<li class="chapter" data-level="6.18.5" data-path="api-ref.html"><a href="api-ref.html#example-17"><i class="fa fa-check"></i><b>6.18.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.19" data-path="api-ref.html"><a href="api-ref.html#platform_write_persistent_reg"><i class="fa fa-check"></i><b>6.19</b> <code>platform_write_persistent_reg</code></a><ul>
<li class="chapter" data-level="6.19.1" data-path="api-ref.html"><a href="api-ref.html#prototype-18"><i class="fa fa-check"></i><b>6.19.1</b> Prototype</a></li>
<li class="chapter" data-level="6.19.2" data-path="api-ref.html"><a href="api-ref.html#parameters-18"><i class="fa fa-check"></i><b>6.19.2</b> Parameters</a></li>
<li class="chapter" data-level="6.19.3" data-path="api-ref.html"><a href="api-ref.html#return-value-18"><i class="fa fa-check"></i><b>6.19.3</b> Return Value</a></li>
<li class="chapter" data-level="6.19.4" data-path="api-ref.html"><a href="api-ref.html#remarks-18"><i class="fa fa-check"></i><b>6.19.4</b> Remarks</a></li>
<li class="chapter" data-level="6.19.5" data-path="api-ref.html"><a href="api-ref.html#example-18"><i class="fa fa-check"></i><b>6.19.5</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="6.20" data-path="api-ref.html"><a href="api-ref.html#syssetpublicdeviceaddr"><i class="fa fa-check"></i><b>6.20</b> <code>sysSetPublicDeviceAddr</code></a><ul>
<li class="chapter" data-level="6.20.1" data-path="api-ref.html"><a href="api-ref.html#prototype-19"><i class="fa fa-check"></i><b>6.20.1</b> Prototype</a></li>
<li class="chapter" data-level="6.20.2" data-path="api-ref.html"><a href="api-ref.html#parameters-19"><i class="fa fa-check"></i><b>6.20.2</b> Parameters</a></li>
<li class="chapter" data-level="6.20.3" data-path="api-ref.html"><a href="api-ref.html#return-value-19"><i class="fa fa-check"></i><b>6.20.3</b> Return Value</a></li>
<li class="chapter" data-level="6.20.4" data-path="api-ref.html"><a href="api-ref.html#remarks-19"><i class="fa fa-check"></i><b>6.20.4</b> Remarks</a></li>
<li class="chapter" data-level="6.20.5" data-path="api-ref.html"><a href="api-ref.html#example-19"><i class="fa fa-check"></i><b>6.20.5</b> Example</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="revision-history.html"><a href="revision-history.html"><i class="fa fa-check"></i><b>7</b> Revision History</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">INGCHIPS SDK User Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tutorial" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Tutorials</h1>
<p>Following step-by-step tutorials show the basic usage of core tools and concepts of the SDK.</p>
<div id="ch1-hello-world" class="section level2">
<h2><span class="header-section-number">3.1</span> Hello World</h2>
<p>In this tutorial, we are going to create a device which is
advertising its name, “Hello, 世界”.</p>
<p>Start <code>ingWizard</code> from start menu and select menu item <code>Project</code> -&gt; <code>New Project ...</code>.
This brings up the project wizard. This first page shown by the wizard is
<code>Development Tool</code> (see Figure <a href="tutorial.html#fig:ch1-welcome">3.1</a>).</p>
<div id="development-tool-page" class="section level3">
<h3><span class="header-section-number">3.1.1</span> <code>Development Tool</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-welcome"></span>
<img src="img/welcome.png" alt="Choose Project Type" width="70%" />
<p class="caption">
Figure 3.1: Choose Project Type
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:ch1-welcome">3.1</a>):</p>
<ol style="list-style-type: decimal">
<li>Choose IDE/Toolchain</li>
<li>Choose a project name</li>
<li>Choose where to store your project</li>
</ol>
<p><code>ingWizard</code> provides below handy functionality:</p>
<ul>
<li><p>If <code>Git</code> is used for software configuration management, select <code>Setup .gitignore</code>;</p></li>
<li><p>If <code>Visual Studio Code</code> is the preferred code editor, select <code>Setup Visual Studio Code</code>.</p></li>
</ul>
<p>Then press <code>Next</code> to proceed to the next page, <code>Choose Chip Series</code>.</p>
</div>
<div id="choose-chip-series-page" class="section level3">
<h3><span class="header-section-number">3.1.2</span> <code>Choose Chip Series</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-wiz-series"></span>
<img src="img/ch1-wiz-series.png" alt="Choose Chip Series" width="70%" />
<p class="caption">
Figure 3.2: Choose Chip Series
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:ch1-wiz-series">3.2</a>), choose the target chip series of the project.
Then press <code>Next</code> to proceed to the next page, <code>Choose Project Type</code>.</p>
</div>
<div id="choose-project-type-page" class="section level3">
<h3><span class="header-section-number">3.1.3</span> <code>Choose Project Type</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:proj-type"></span>
<img src="img/proj_type.png" alt="Choose Project Type" width="70%" />
<p class="caption">
Figure 3.3: Choose Project Type
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:proj-type">3.3</a>):</p>
<ol style="list-style-type: decimal">
<li>Select <code>Typical</code></li>
<li>Select <code>Legacy</code> advertising type</li>
</ol>
<p><code>{block-on-ext-adv, note-text, type='rmdcaution'} Phones that support BLE 5.x extended advertising are still rare at present (2021-09-03) even if BLE 5.0 is declared as "supported",  so we use legacy advertising for better compatibility. Furthermore, legacy advertising can be changed to BLE 5.x extended advertising by toggling a single bit.</code></p>
<p>Then press <code>Next</code> to proceed to the next page, <code>Role of Your Device</code>.</p>
</div>
<div id="role-of-your-device-page" class="section level3">
<h3><span class="header-section-number">3.1.4</span> <code>Role of Your Device</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-role"></span>
<img src="img/role.png" alt="Role of Your Device" width="70%" />
<p class="caption">
Figure 3.4: Role of Your Device
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:ch1-role">3.4</a>), just select Peripheral, and press <code>Next</code> to proceed to the next page, <code>Peripheral Setup</code>.</p>
</div>
<div id="peripheral-setup-page" class="section level3">
<h3><span class="header-section-number">3.1.5</span> <code>Peripheral Setup</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-peripheral"></span>
<img src="img/peripheral.png" alt="Peripheral Setup" width="70%" />
<p class="caption">
Figure 3.5: Peripheral Setup
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:ch1-peripheral">3.5</a>), click <code>Setup Advertising Data</code> button,
which will bring up the advertising data editor (Figure <a href="tutorial.html#fig:ch1-hello-adv">3.6</a>).
In the editor, type <code>name</code>
to quickly search for the GAP advertising item <code>09 - «Complete Local Name»</code>,
and click <code>Add</code> to add it into our device’s advertising data.</p>
<p>Click the newly added <code>09 - «Complete Local Name»</code> item, then fill in
“Hello, 世界” in the data editor shown below and press Enter. <code>Data Preview</code> will
be updated and the whole advertising data is shown in raw bytes with a few
comments on each item. Obviously, Chinese characters are encoded in <code>UTF-8</code> properly.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-adv"></span>
<img src="img/hello_adv.png" alt="Edit Advertising Data" width="80%" />
<p class="caption">
Figure 3.6: Edit Advertising Data
</p>
</div>
<p>Now, click <code>OK</code> to go back to project wizard, and press <code>Next</code> to proceed
to the next page <code>Security &amp; Privacy</code>.</p>
</div>
<div id="security-privacy-page" class="section level3">
<h3><span class="header-section-number">3.1.6</span> <code>Security &amp; Privacy</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-wiz-security"></span>
<img src="img/ch1-wiz-security.png" alt="Firmare Over-The-Air" width="70%" />
<p class="caption">
Figure 3.7: Firmare Over-The-Air
</p>
</div>
<p>Leave all options as default (Figure <a href="tutorial.html#fig:ch1-wiz-security">3.7</a>), and press <code>Next</code> to proceed to the next page <code>Firmare Over-The-Air</code>.</p>
</div>
<div id="firmare-over-the-air-page" class="section level3">
<h3><span class="header-section-number">3.1.7</span> <code>Firmare Over-The-Air</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-fota"></span>
<img src="img/fota.png" alt="Firmare Over-The-Air" width="70%" />
<p class="caption">
Figure 3.8: Firmare Over-The-Air
</p>
</div>
<p>Leave all options as default (Figure <a href="tutorial.html#fig:ch1-hello-fota">3.8</a>), and press <code>Next</code> to proceed to the last page <code>Common Functions</code>.</p>
</div>
<div id="common-functions-page" class="section level3">
<h3><span class="header-section-number">3.1.8</span> <code>Common Functions</code> Page</h3>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-common"></span>
<img src="img/common.png" alt="Common Functions" width="70%" />
<p class="caption">
Figure 3.9: Common Functions
</p>
</div>
<p>On this page (Figure <a href="tutorial.html#fig:ch1-hello-common">3.9</a>), we also accept the default settings and press <code>Create</code>.
Now your project is created (Figure <a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>), and ready for building and downloading.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-proj-ready"></span>
<img src="img/proj_ready.png" alt="&quot;Hello, 世界&quot; is Ready" width="70%" />
<p class="caption">
Figure 3.10: “Hello, 世界” is Ready
</p>
</div>
</div>
<div id="build-your-project" class="section level3">
<h3><span class="header-section-number">3.1.9</span> Build your project</h3>
<p>Back to the main window of <code>ingWizard</code> (Figure <a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>),
click on your project to open it. Build your project in IDE.</p>
</div>
<div id="download" class="section level3">
<h3><span class="header-section-number">3.1.10</span> Download</h3>
<p>To download your project, Back to <code>ingWizard</code> (Figure <a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>),
right click on your project, and select <code>Download to Flash</code> from
the popup menu to start the downloader (Figure <a href="tutorial.html#fig:ch1-hello-downloader">3.11</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-downloader"></span>
<img src="img/downloader.png" alt="Download to Flash" width="70%" />
<p class="caption">
Figure 3.11: Download to Flash
</p>
</div>
<p>All settings in the downloader are ready except the UART port number.
In the downloader, configure the correct UART port and then click <code>Start</code>.</p>
<p>Once downloaded, check if you can find a device named “Hello, 世界” by LightBlue,
<code>INGdemo</code> (Figure <a href="tutorial.html#fig:ch1-hello-ingota">3.12</a>) or other apps. Note that, this device may
not be listed in the Bluetooth menu of system settings at present.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-hello-ingota"></span>
<img src="img/hello_ingota_2.png" alt="Hello, 世界" width="40%" />
<p class="caption">
Figure 3.12: Hello, 世界
</p>
</div>
</div>
</div>
<div id="ibeacon" class="section level2">
<h2><span class="header-section-number">3.2</span> iBeacon</h2>
<p>In this tutorial, let’s make an iBeacon.
iBeacon is a protocol developed by Apple<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a> and
introduced at the Apple Worldwide Developers Conference in 2013.
Beacons are a class of Bluetooth low energy (BLE) devices that broadcast their identifier to nearby
portable electronic devices. This technology enables smartphones, tablets and other devices to perform
actions when in close proximity to an iBeacon device.</p>
<p>Firstly, get a iBeacon scanning app from App Store. We will use an app called <code>Locate</code> in this
tutorial. <code>Locate</code> has a list of preconfigured proximity UUIDs, which includes an all 0s
Null UUID. We will use this Null UUID<a href="#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a>.</p>
<div id="setup-advertising-data" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Setup Advertising Data</h3>
<p>There are two items in iBeacon advertising packet.</p>
<ol style="list-style-type: decimal">
<li><p>Flags</p>
<p>Value is fixed to 0x06, i.e. two bits are set, LE General Discoverable Mode
&amp; BR/EDR Not Supported.</p></li>
<li><p>Manufacturer Specific Data</p>
<p>The contents of this item is shown in Table <a href="tutorial.html#tab:ch1-ibeacon">3.1</a></p></li>
</ol>
<table>
<caption><span id="tab:ch1-ibeacon">Table 3.1: </span> iBeacon Manufacturer Specific Data</caption>
<thead>
<tr class="header">
<th align="right">Size in Bytes</th>
<th align="left">Name</th>
<th align="left">Value</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="left">Company ID</td>
<td align="left">0x004C</td>
<td align="left">Company ID of Apple, Inc</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Beacon Type</td>
<td align="left">0x1502</td>
<td align="left">Value defined by Apple</td>
</tr>
<tr class="odd">
<td align="right">16</td>
<td align="left">Proximity UUID</td>
<td align="left"></td>
<td align="left">User defined value</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Major</td>
<td align="left"></td>
<td align="left">Group ID</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">Minor</td>
<td align="left"></td>
<td align="left">ID within a group</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">Measured Power</td>
<td align="left">in dBm</td>
<td align="left">Measured by an iPhone 5s at a 1 meter distance</td>
</tr>
</tbody>
</table>
<p>In order to make an iBeacon device, we can just follow the same steps as in the <a href="tutorial.html#ch1-hello-world">Hello World</a> example,
with only on exception that we need to configure the advertising package according to
the specification.</p>
<p>In the advertising data editor, add <code>0x01 - «Flags»</code> and <code>0xFF - «Manufacturer Specific Data»</code>.
Click <code>0x01 - «Flags»</code>, check <code>LE General Discoverable Mode</code> and <code>BR/EDR Not Supported</code>.
Click <code>0xFF - «Manufacturer Specific Data»</code>, then the <code>Edit as</code> button, a menu pops up and select
<code>iBeacon ...</code> (Figure <a href="tutorial.html#fig:ch1-edit-beacon-adv">3.13</a>) to open iBeacon manufacturer specific data
editor (Figure <a href="tutorial.html#fig:ch1-edit-beacon-content">3.14</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-edit-beacon-adv"></span>
<img src="img/beacon_adv2.png" alt="Edit iBeacon Advertising Data" width="70%" />
<p class="caption">
Figure 3.13: Edit iBeacon Advertising Data
</p>
</div>
<div class="figure" style="text-align: center"><span id="fig:ch1-edit-beacon-content"></span>
<img src="img/beacon_adv3.png" alt="Edit iBeacon Manufacturer Specific Data" width="50%" />
<p class="caption">
Figure 3.14: Edit iBeacon Manufacturer Specific Data
</p>
</div>
<p>Signal power can be set to any reasonable value (such as -50dBm), and we will calibrate it later with
the help of the <code>Locate</code> app.</p>
</div>
<div id="try-it" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Try It</h3>
<p>Let’s select GNU Arm Embedded Toolchain as our development environment on <code>Choose Project Type</code> page,
and the wizard will make everything ready
(Figure <a href="tutorial.html#fig:ch1-ibeacon-proj">3.15</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-ibeacon-proj"></span>
<img src="img/ch1-ibeacon-proj.png" alt="iBeacon Ready for GNU Arm Toolchain" width="40%" />
<p class="caption">
Figure 3.15: iBeacon Ready for GNU Arm Toolchain
</p>
</div>
<p>Click on the project to open a console, type <code>make</code><a href="#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a> to build it.
Back to <code>ingWizard</code>, follow the same steps to download it. Now we are able to find our newly
created iBeacon in <code>Locate</code>. (Figure <a href="tutorial.html#fig:ch1-locate-page1-small">3.16</a>)</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-locate-page1-small"></span>
<img src="img/locate_page1_small.jpg" alt="iBeacon in Locate app" width="40%" />
<p class="caption">
Figure 3.16: iBeacon in Locate app
</p>
</div>
<p>Tap on our device then we can calibrate signal power or check distance in real-time as shown in Figure
<a href="tutorial.html#fig:ch1-locate-page2-small">3.17</a>.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-locate-page2-small"></span>
<img src="img/locate_page2_small.jpg" alt="iBeacon Detailed Information in Locate app" width="40%" />
<p class="caption">
Figure 3.17: iBeacon Detailed Information in Locate app
</p>
</div>
<p>Once signal power is calibrated, we can right click on our project in <code>ingWizard</code>, and select <code>Edit Data</code> -&gt; <code>Advertising</code>
menu item to edit its advertising data with same editor that we are getting familiar with.
After advertising data is updated, rebuild the project and check if the distance is more accurate.</p>

<div class="rmdcaution">
According to the specification, proximity beacons
must use a non connectable undirected advertising PDU, using a fixed 100ms advertising interval.
In this tutorial, we are not going to touch the code, so advertising parameters are
not touched, either. To make these parameters fully meet the specification, please refer to
the corresponding host GAP APIs.
</div>

</div>
</div>
<div id="thermometer" class="section level2">
<h2><span class="header-section-number">3.3</span> Thermometer</h2>
<p>In this tutorial, we are going to make a <em>serious</em> BLE device, a thermometer.
Bluetooth SIG has already defined a GATT service called Health
Thermometer<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a>. This SDK contains a reference app called <code>INGdemo</code>, which can be
deployed to an <code>Android</code> or <code>iOS</code> device. Using <code>INGdemo</code>, we can check Bluetooth devices’ advertising
data, and if health thermometer service is found in a device, <code>INGdemo</code> can connect to it and
read temperature.</p>
<p>In this tutorial, you will learn how to:</p>
<ul>
<li>Broadcast supported services</li>
<li>Configure a GATT profile</li>
<li>Respond to the read request of a GATT characteristic</li>
</ul>
<div id="setup-advertising-data-1" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Setup Advertising Data</h3>
<p>Again, we follow the same steps as in the <a href="tutorial.html#ch1-hello-world">Hello World</a> example,
and on the <code>Peripheral Setup</code> page, we declare the thermometer service and create a
GATT profile. Add following three items into the advertising data:</p>
<ol style="list-style-type: decimal">
<li><p><code>Flags</code></p>
<p>Value is fixed to 0x06, i.e. two bits are set, LE General Discoverable Mode
&amp; BR/EDR Not Supported.</p></li>
<li><p><code>Complete List of 16-bit Service Class UUIDs</code></p>
<p>Add one service <code>0x1809 - Health Thermometer</code> as shown in Figure <a href="tutorial.html#fig:ch1-thermo-adv">3.18</a>.</p></li>
<li><p><code>Complete Local Name</code></p>
<p>Let’s name our device as “AccurateOne”.</p></li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:ch1-thermo-adv"></span>
<img src="img/ch1-thermo-adv.png" alt="Thermometer Advertising Data" width="70%" />
<p class="caption">
Figure 3.18: Thermometer Advertising Data
</p>
</div>
</div>
<div id="setup-gatt-profile" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Setup GATT Profile</h3>
<p>Back to the <code>Peripheral Setup</code> page and click <code>Setup ATT database ...</code> to open the GATT profile
editor. Add two service, General Access (0x1800) and Health Thermometer (0x1809).<br />
Delete all non-mandatory characteristics of General Access service. For Health Thermometer
service, keep two characteristics, i.e. temperature measurement and temperature type, and delete
the other two.</p>
<p>Next, edit each characteristic’s value:</p>
<ol style="list-style-type: decimal">
<li><p>Device Name of General Access:</p>
<p>Right click on the characteristic, select <code>Edit String Value ...</code> menu, and set the value
to “AccurateOne”.</p></li>
<li><p>Appearance of General Access:</p>
<p>Right click on the characteristic, select <code>Help</code> and the editor will open the corresponding
document on Bluetooth SIG website. Find the value for general thermometer (0x0300), then
click the <code>Edit</code> button and input <code>0x00, 0x03</code> into the data field.</p></li>
<li><p>Temperature Measurement of Health Thermometer</p>
<p>Check the document on Bluetooth SIG website.
click the <code>Edit</code> button and input five 0s (<code>0, 0, 0, 0, 0</code>) into the data field. Here the
first byte contains the flags showing that the following measurement is a <code>FLOAT</code>
value in units of Celsius. Check <code>read</code> and <code>dynamic</code> properties
(Figure <a href="tutorial.html#fig:ch1-thermo-edit-ch">3.19</a>).</p>
<p><code>FLOAT</code> type is IEEE-11073 32-bit float. Basically, it has a 24-bit mantissa, and
an 8-bit exponent (the most significant byte) in base <em>10</em>.</p></li>
<li><p>Temperature Type of Health Thermometer</p>
<p>Check the document on Bluetooth SIG website. Set it to any valid value by click the <code>Edit</code>
button.</p></li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:ch1-thermo-edit-ch"></span>
<img src="img/ch1-thermo-edit-ch.png" alt="Edit Temperature Measurement" width="70%" />
<p class="caption">
Figure 3.19: Edit Temperature Measurement
</p>
</div>
</div>
<div id="write-the-code" class="section level3">
<h3><span class="header-section-number">3.3.3</span> Write the Code</h3>
<p>After project is created, open <code>profile.c</code> in IDE, and the temperature measurement
characteristic handling function <code>att_read_callback</code> is automatically generated by <code>ingWizard</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="tutorial.html#cb3-1"></a><span class="dt">static</span> <span class="dt">uint16_t</span> att_read_callback(hci_con_handle_t connection_handle, </span>
<span id="cb3-2"><a href="tutorial.html#cb3-2"></a>                                  <span class="dt">uint16_t</span> att_handle, <span class="dt">uint16_t</span> offset, </span>
<span id="cb3-3"><a href="tutorial.html#cb3-3"></a>                                  <span class="dt">uint8_t</span> * buffer, <span class="dt">uint16_t</span> buffer_size)</span>
<span id="cb3-4"><a href="tutorial.html#cb3-4"></a>{</span>
<span id="cb3-5"><a href="tutorial.html#cb3-5"></a>    <span class="cf">switch</span> (att_handle)</span>
<span id="cb3-6"><a href="tutorial.html#cb3-6"></a>    {</span>
<span id="cb3-7"><a href="tutorial.html#cb3-7"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT:</span>
<span id="cb3-8"><a href="tutorial.html#cb3-8"></a>        <span class="cf">if</span> (buffer)</span>
<span id="cb3-9"><a href="tutorial.html#cb3-9"></a>        {</span>
<span id="cb3-10"><a href="tutorial.html#cb3-10"></a>            <span class="co">// add your code</span></span>
<span id="cb3-11"><a href="tutorial.html#cb3-11"></a>            <span class="cf">return</span> buffer_size;</span>
<span id="cb3-12"><a href="tutorial.html#cb3-12"></a>        }</span>
<span id="cb3-13"><a href="tutorial.html#cb3-13"></a>        <span class="cf">else</span></span>
<span id="cb3-14"><a href="tutorial.html#cb3-14"></a>            <span class="cf">return</span> <span class="dv">1</span>; <span class="co">// </span><span class="al">TODO</span><span class="co">: return required buffer size</span></span>
<span id="cb3-15"><a href="tutorial.html#cb3-15"></a></span>
<span id="cb3-16"><a href="tutorial.html#cb3-16"></a>    <span class="cf">default</span>:</span>
<span id="cb3-17"><a href="tutorial.html#cb3-17"></a></span>
<span id="cb3-18"><a href="tutorial.html#cb3-18"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb3-19"><a href="tutorial.html#cb3-19"></a>    }</span>
<span id="cb3-20"><a href="tutorial.html#cb3-20"></a>}</span></code></pre></div>
<p><code>att_read_callback</code> will be called twice or more when app reads a characteristic that has <code>dynamic</code>
property: one for querying required buffer size, and one for reading data. If data is large,
<code>att_read_callback</code> might be called more times, each reading a part of data specified by <code>offset</code>.</p>
<p>As discussed above, define a temperature measurement type:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="tutorial.html#cb4-1"></a><span class="kw">typedef</span> __packed <span class="kw">struct</span> gatt_temperature_meas</span>
<span id="cb4-2"><a href="tutorial.html#cb4-2"></a>{</span>
<span id="cb4-3"><a href="tutorial.html#cb4-3"></a>     uint8 flags;</span>
<span id="cb4-4"><a href="tutorial.html#cb4-4"></a>    sint32 mantissa:<span class="dv">24</span>;</span>
<span id="cb4-5"><a href="tutorial.html#cb4-5"></a>    sint32 exponent:<span class="dv">8</span>;</span>
<span id="cb4-6"><a href="tutorial.html#cb4-6"></a>} gatt_temperature_meas_t;</span>
<span id="cb4-7"><a href="tutorial.html#cb4-7"></a></span>
<span id="cb4-8"><a href="tutorial.html#cb4-8"></a><span class="dt">static</span> gatt_temperature_meas_t temperature_meas = {<span class="dv">0</span>};</span></code></pre></div>
<p>Now, we can complete the above <code>case HANDLE_TEMPERATURE_MEASUREMENT</code> clause:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="tutorial.html#cb5-1"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT:</span>
<span id="cb5-2"><a href="tutorial.html#cb5-2"></a>        <span class="cf">if</span> (buffer)</span>
<span id="cb5-3"><a href="tutorial.html#cb5-3"></a>        {</span>
<span id="cb5-4"><a href="tutorial.html#cb5-4"></a>            <span class="co">// simulate an &quot;accurate&quot; thermometer</span></span>
<span id="cb5-5"><a href="tutorial.html#cb5-5"></a>            temperature_meas.mantissa = rand() % <span class="dv">100</span>;</span>
<span id="cb5-6"><a href="tutorial.html#cb5-6"></a>            <span class="co">// output data</span></span>
<span id="cb5-7"><a href="tutorial.html#cb5-7"></a>            memcpy(buffer, ((uint8 *)&amp;temperature_meas) + offset, buffer_size);</span>
<span id="cb5-8"><a href="tutorial.html#cb5-8"></a>            <span class="cf">return</span> buffer_size;</span>
<span id="cb5-9"><a href="tutorial.html#cb5-9"></a>        }</span>
<span id="cb5-10"><a href="tutorial.html#cb5-10"></a>        <span class="cf">else</span></span>
<span id="cb5-11"><a href="tutorial.html#cb5-11"></a>            <span class="cf">return</span> <span class="kw">sizeof</span>(gatt_temperature_meas_t);</span></code></pre></div>
<p>Build &amp; download project, then connect to “AccurateOne” device in <code>INGdemo</code> app. Check if
temperature changes randomly each time <code>Refresh</code> button is pressed (Figure <a href="tutorial.html#fig:ch1-ingtemp">3.20</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-ingtemp"></span>
<img src="img/ch1-ingtemp-1.png" alt="Refresh Temperature Measurement" width="60%" />
<p class="caption">
Figure 3.20: Refresh Temperature Measurement
</p>
</div>
<div class="rmdnote">
<p>
A thermometer (a server) can use notification or indication procedure to notify (without acknowledge) or indicate (with acknowledge) a characteristic value, see [Thermometer with Notification]. In this example, “AccurateOne” does not use these two procedures, and sends its measurement passively.
</p>
</div>
</div>
<div id="notification" class="section level3">
<h3><span class="header-section-number">3.3.4</span> Notification</h3>
</div>
</div>
<div id="thermometer-with-fota" class="section level2">
<h2><span class="header-section-number">3.4</span> Thermometer with FOTA</h2>
<p>In this tutorial, we are going to add Firmware Over-The-Air update feature into our thermometer.
This SDK provides a FOTA reference design that is workable out-of-the-box. To make FOTA work,
at least three parties are involved, a device, an app, and an HTTP server. The <code>INGdemo</code> app
is already there, so in this tutorial, we will focus on the device and HTTP server.</p>
<div id="device-with-fota" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Device with FOTA</h3>
<p>Follow the same steps as in the previous <a href="tutorial.html#thermometer">Thermometer</a> example to create a new project,
say “ota”.</p>
<p>When editing advertising data, we can import data created in previous example by clicking
<code>Open File...</code> button of the editor. Advertising data is stored in
<code>$(ProjectPath)/data/advertising.adv</code>. Let’s change device’s name to “Clickety Click”.</p>
<p>When editing GATT profile database, we can import data created in previous example by clicking
<code>Open File...</code> button of the editor. GATT profile data is stored in
<code>$(ProjectPath)/data/gatt.profile</code>. Select <code>INGChips Service</code> from the drop-down menu of
<code>Add Service</code> button, and add “INGChips FOTA Service”. Next, edit characteristics value
of this service:</p>
<ol style="list-style-type: decimal">
<li><p>FOTA Version:</p>
<p>This identifies the full version number of our project. As shown in flash downloader,
a whole project is composed by two binaries, one is from SDK bundle, called platform binary,
and the other one is built from our project, called the app binary.
Platform binary contains the whole BLE stack
and a realtime OS FreeRTSO, with some additional functions handling SoC initialization,
interrupts, etc. FOTA version contains two sub-versions, one for each binary. Each sub-version
contains three fields:</p>
<ul>
<li><p>Major: A 16-bit field.</p></li>
<li><p>Minor: A 8-bit field.</p></li>
<li><p>Patch: Another 8-bit field.</p></li>
</ul>
<p>Each bundle has its own version (so as the platform binary), using the same numbering scheme,
which can be found on
<code>SDK</code> page of <code>Environment Options</code> dialog (use menu item <code>Tools</code> -&gt; <code>Environment Options</code> to
open this dialog). Suppose platform version is 1.0.1<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>,
and we would like our app’s version to
be 1.0.0, then we set this characteristic’s value to (Fig <a href="tutorial.html#fig:ch1-ota-version">3.21</a>):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="tutorial.html#cb6-1"></a><span class="bn">0x0001</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="co">// app version</span></span>
<span id="cb6-2"><a href="tutorial.html#cb6-2"></a><span class="bn">0x0001</span>, <span class="dv">0</span>, <span class="dv">1</span>  <span class="co">// platform version</span></span></code></pre></div></li>
<li><p>FOTA Control</p>
<p>This is control point during update. Set its value to <code>0</code> (i.e. <code>OTA_STATUS_DISABLED</code>),
which is the initial status of FOTA.</p></li>
</ol>
<div class="figure" style="text-align: center"><span id="fig:ch1-ota-version"></span>
<img src="img/ch1-ota-version.png" alt="Configure FOTA Version" width="60%" />
<p class="caption">
Figure 3.21: Configure FOTA Version
</p>
</div>
<p>Click <code>OK</code> to close GATT profile editor. (Note: do not click <code>Save</code>, unless you want to change
the file <code>$(ProjectPath)/data/gatt.profile</code> that is opened in editor.)</p>
<p>Back to project wizard, press <code>Next</code> to proceed to the next page <code>Firmare Over-The-Air</code>. On this
page, let’s check <code>FOTA</code>. Note that characteristics handles related to FOTA is
generated automatically by inspecting the GATT profile.
Then finish remaining steps on project wizard.</p>
<p>Open our brand-new project “ota”, copy the code from previous example to make
our thermometer respond to <code>Refresh</code> in <code>INGdemo</code> app.</p>
<p>Next, let’s make a new version.</p>
</div>
<div id="make-a-new-version" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Make a New Version</h3>
<p>New version of our “ota” will have a new name “Barba Trick”, and app version number is upgraded to
<code>2.0.0</code>. These data are saved in advertising and profile data respectively, so right click on
the project and use editors to update it. After data is updated, use <code>Save As ...</code> to save data
to another file in the same directory, for example, update advertising data and save it to
<code>$(ProjectPath)/data/advertising_2.adv</code>, and updated profile to
<code>$(ProjectPath)/data/gatt_2.profile</code>.</p>
<p>Use macro <code>V2</code> to control the actual advertising and profile data:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="tutorial.html#cb7-1"></a><span class="dt">const</span> <span class="dt">static</span> <span class="dt">uint8_t</span> adv_data[] = {</span>
<span id="cb7-2"><a href="tutorial.html#cb7-2"></a><span class="pp">#ifndef V2</span></span>
<span id="cb7-3"><a href="tutorial.html#cb7-3"></a>    <span class="pp">#include </span><span class="im">&quot;../data/advertising.adv&quot;</span></span>
<span id="cb7-4"><a href="tutorial.html#cb7-4"></a><span class="pp">#else</span></span>
<span id="cb7-5"><a href="tutorial.html#cb7-5"></a>    <span class="pp">#include </span><span class="im">&quot;../data/advertising_2.adv&quot;</span></span>
<span id="cb7-6"><a href="tutorial.html#cb7-6"></a><span class="pp">#endif</span></span>
<span id="cb7-7"><a href="tutorial.html#cb7-7"></a>};</span>
<span id="cb7-8"><a href="tutorial.html#cb7-8"></a></span>
<span id="cb7-9"><a href="tutorial.html#cb7-9"></a>......</span>
<span id="cb7-10"><a href="tutorial.html#cb7-10"></a></span>
<span id="cb7-11"><a href="tutorial.html#cb7-11"></a><span class="dt">const</span> <span class="dt">static</span> <span class="dt">uint8_t</span> profile_data[] = {</span>
<span id="cb7-12"><a href="tutorial.html#cb7-12"></a><span class="pp">#ifndef V2</span></span>
<span id="cb7-13"><a href="tutorial.html#cb7-13"></a>    <span class="pp">#include </span><span class="im">&quot;../data/gatt.profile&quot;</span></span>
<span id="cb7-14"><a href="tutorial.html#cb7-14"></a><span class="pp">#else</span></span>
<span id="cb7-15"><a href="tutorial.html#cb7-15"></a>    <span class="pp">#include </span><span class="im">&quot;../data/gatt_2.profile&quot;</span></span>
<span id="cb7-16"><a href="tutorial.html#cb7-16"></a><span class="pp">#endif</span></span>
<span id="cb7-17"><a href="tutorial.html#cb7-17"></a>};</span></code></pre></div>
<p>Rebuild the project with macro <code>V2</code> defined, copy <code>ota.bin</code> and <code>platform.bin</code> (in
<code>SDK_DIR/sdk/bundles/typical</code>) to an empty directory, say <code>ota_app_v2</code>.</p>
<p>Create a file named <code>manifest.json</code> in <code>ota_app_v2</code>, with follow data in it:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="tutorial.html#cb8-1"></a><span class="op">{</span></span>
<span id="cb8-2"><a href="tutorial.html#cb8-2"></a>    <span class="st">&quot;platform&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb8-3"><a href="tutorial.html#cb8-3"></a>                <span class="st">&quot;version&quot;</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb8-4"><a href="tutorial.html#cb8-4"></a>                <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;platform.bin&quot;</span><span class="op">,</span></span>
<span id="cb8-5"><a href="tutorial.html#cb8-5"></a>                <span class="st">&quot;address&quot;</span><span class="op">:</span> <span class="dv">16384</span></span>
<span id="cb8-6"><a href="tutorial.html#cb8-6"></a>    <span class="op">},</span></span>
<span id="cb8-7"><a href="tutorial.html#cb8-7"></a>    <span class="st">&quot;app&quot;</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb8-8"><a href="tutorial.html#cb8-8"></a>                <span class="st">&quot;version&quot;</span><span class="op">:</span> [<span class="dv">2</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb8-9"><a href="tutorial.html#cb8-9"></a>                <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;ota.bin&quot;</span><span class="op">,</span></span>
<span id="cb8-10"><a href="tutorial.html#cb8-10"></a>                <span class="st">&quot;address&quot;</span><span class="op">:</span> <span class="dv">163840</span></span>
<span id="cb8-11"><a href="tutorial.html#cb8-11"></a>    <span class="op">},</span></span>
<span id="cb8-12"><a href="tutorial.html#cb8-12"></a>    <span class="st">&quot;entry&quot;</span><span class="op">:</span> <span class="dv">16384</span><span class="op">,</span></span>
<span id="cb8-13"><a href="tutorial.html#cb8-13"></a>    <span class="st">&quot;bins&quot;</span><span class="op">:</span>[] </span>
<span id="cb8-14"><a href="tutorial.html#cb8-14"></a><span class="op">}</span></span></code></pre></div>
<p>Those addresses can be found in <code>Environment Options</code>. <code>entry</code> value is fixed to <code>0x4000</code>,
i.e. <code>16384</code>. Note that <code>json</code> do not accept the popular
<code>0xabcd</code> hexadecimal literals. <code>INGdemo</code> can download additional binaries specified by <code>bins</code>
to device. In this case, we don’t have such binaries, so this field is left as an empty array.</p>
<p>Then create a <code>readme</code> file for this update with some information about this update in it.</p>
<p>Now the FOTA package is ready. Make a <code>ota_app_v2.zip</code> ZIP archive of the whole <code>ota_app_v2</code>
directory. Note that <code>ota_app_v2</code> should not be made into a sub-directory in <code>ota_app_v2.zip</code>.
Table <a href="tutorial.html#tab:ch1-ota-package">3.2</a> summarize the files in the ZIP archive.</p>
<table>
<caption><span id="tab:ch1-ota-package">Table 3.2: </span> FOTA Package Summary</caption>
<thead>
<tr class="header">
<th align="left">File Name</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">readme</td>
<td align="left">Some information about this update</td>
</tr>
<tr class="even">
<td align="left">manifest.json</td>
<td align="left">Meta information</td>
</tr>
<tr class="odd">
<td align="left">platform.bin</td>
<td align="left">Platform binary</td>
</tr>
<tr class="even">
<td align="left">ota.bin</td>
<td align="left">App binary</td>
</tr>
</tbody>
</table>
<p>Back to IDE, rebuild the project leaving macro <code>V2</code> undefined, then download the project.</p>
</div>
<div id="fota-server" class="section level3">
<h3><span class="header-section-number">3.4.3</span> FOTA Server</h3>
<p><code>INGdemo</code> app needs a FOTA server URL, defined in <code>class Thermometer.FOTA_SERVER</code>.
Move <code>ota_app_v2.zip</code> to HTTP server’s document directory, and create a <code>latest.json</code> file,
which contains information about latest version. Its content is:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="tutorial.html#cb9-1"></a><span class="op">{</span></span>
<span id="cb9-2"><a href="tutorial.html#cb9-2"></a>    <span class="st">&quot;app&quot;</span><span class="op">:</span> [<span class="dv">2</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb9-3"><a href="tutorial.html#cb9-3"></a>    <span class="st">&quot;platform&quot;</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb9-4"><a href="tutorial.html#cb9-4"></a>    <span class="st">&quot;package&quot;</span><span class="op">:</span> <span class="st">&quot;ota_app_v2.zip&quot;</span></span>
<span id="cb9-5"><a href="tutorial.html#cb9-5"></a><span class="op">}</span></span></code></pre></div>
<p>Make sure that these two files can be accessed through URL <code>(FOTA_SERVER + latest.json)</code> and
<code>(FOTA_SERVER + ota_app_v2.zip)</code>.</p>
</div>
<div id="try-it-1" class="section level3">
<h3><span class="header-section-number">3.4.4</span> Try It</h3>
<p>Connect to “Clickety Click” in <code>INGdemo</code>, click <code>Update</code> (Figure <a href="tutorial.html#fig:ch1-fota-update">3.22</a>).
Since <code>platform.bin</code> is up-to-date,
only <code>app.bin</code> need to be updated, the whole update completes in a short time.
Return to the main page, scan again and check if our new version works, a device named
“Barba Trick” appearing. Connect to “Barba Trick”, firmware is up-to-date now.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-fota-update"></span>
<img src="img/ch1-fota-update.png" alt="Update Available for &quot;Clickety Click&quot;" width="40%" />
<p class="caption">
Figure 3.22: Update Available for “Clickety Click”
</p>
</div>
<div class="rmdnote">
<p>
This tutorial gives an example on FOTA implementation. Users are free to design a new FOTA solution, from version definition to FOTA service and characteristics. It also possible to develop a dedicated secondary app for FOTA.
</p>
<p>
<em>Security</em> must be considered.
</p>
</div>
</div>
</div>
<div id="ibeacon-scanner" class="section level2">
<h2><span class="header-section-number">3.5</span> iBeacon Scanner</h2>
<p>We already know to how to make iBeacon devices. In this tutorial, we are going to create
an iBeacon scanner.</p>
<p>A scanner plays a central role in Bluetooth pico network. As always, we create a new project
named “iscanner” in <code>ingWizard</code> (Fig <a href="tutorial.html#fig:ch1-proj-iscanner">3.23</a>).
On <code>Role of Your Device</code> page, select <em>Central</em>. A central
device almost always scans for something then performs other actions, and our new project
wizard automatically adds codes to start scanning.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-proj-iscanner"></span>
<img src="img/ch1-proj-iscanner.png" alt="&quot;iscanner&quot; Created for IAR Embedded Workbench" width="40%" />
<p class="caption">
Figure 3.23: “iscanner” Created for IAR Embedded Workbench
</p>
</div>
<p>Open this new project in IDE, and navigate to function <code>user_packet_handler</code>. We can see
there is an event called <code>GAP_EVENT_ADVERTISING_REPORT</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="tutorial.html#cb10-1"></a>    <span class="cf">case</span> GAP_EVENT_ADVERTISING_REPORT:</span>
<span id="cb10-2"><a href="tutorial.html#cb10-2"></a>        gap_get_advertisingReport(&amp;report, packet);</span>
<span id="cb10-3"><a href="tutorial.html#cb10-3"></a>        <span class="co">// add your code</span></span>
<span id="cb10-4"><a href="tutorial.html#cb10-4"></a>        ......</span>
<span id="cb10-5"><a href="tutorial.html#cb10-5"></a>        <span class="cf">break</span>;</span></code></pre></div>
<p>Each time this event is received, we can check if the advertising report contains
<code>0xFF - «Manufacturer Specific Data»</code>, and if it is an iBeacon packet. With the knowlegde
of making an iBeacon device, it is straight forward to define an iBeacon packet type
in <code>C</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="tutorial.html#cb11-1"></a><span class="kw">typedef</span> __packed <span class="kw">struct</span> ibeacon_adv</span>
<span id="cb11-2"><a href="tutorial.html#cb11-2"></a>{</span>
<span id="cb11-3"><a href="tutorial.html#cb11-3"></a>    <span class="dt">uint16_t</span> apple_id;</span>
<span id="cb11-4"><a href="tutorial.html#cb11-4"></a>    <span class="dt">uint16_t</span> id;</span>
<span id="cb11-5"><a href="tutorial.html#cb11-5"></a>    <span class="dt">uint8_t</span>  uuid[<span class="dv">16</span>];</span>
<span id="cb11-6"><a href="tutorial.html#cb11-6"></a>    <span class="dt">uint16_t</span> major;</span>
<span id="cb11-7"><a href="tutorial.html#cb11-7"></a>    <span class="dt">uint16_t</span> minor;</span>
<span id="cb11-8"><a href="tutorial.html#cb11-8"></a>    <span class="dt">int8_t</span>   ref_power;</span>
<span id="cb11-9"><a href="tutorial.html#cb11-9"></a>} ibeacon_adv_t;</span>
<span id="cb11-10"><a href="tutorial.html#cb11-10"></a></span>
<span id="cb11-11"><a href="tutorial.html#cb11-11"></a><span class="pp">#define APPLE_COMPANY_ID        0x004C</span></span>
<span id="cb11-12"><a href="tutorial.html#cb11-12"></a><span class="pp">#define IBEACON_ID              0x1502</span></span></code></pre></div>
<p><code>__packed</code> is an extended keyword to specify a data alignment of 1 for a data type. Fortunately, it is supported by both <em>ARM</em> and <em>IAR</em> compilers. Alternatively, one can use <code>#pragma pack</code> directive:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="tutorial.html#cb12-1"></a><span class="pp">#pragma pack (push, 1) </span></span>
<span id="cb12-2"><a href="tutorial.html#cb12-2"></a><span class="kw">typedef</span> <span class="kw">struct</span> ibeacon_adv</span>
<span id="cb12-3"><a href="tutorial.html#cb12-3"></a>{</span>
<span id="cb12-4"><a href="tutorial.html#cb12-4"></a>    ...</span>
<span id="cb12-5"><a href="tutorial.html#cb12-5"></a>} ibeacon_adv_t;</span>
<span id="cb12-6"><a href="tutorial.html#cb12-6"></a><span class="pp">#pragma pack (pop)</span></span></code></pre></div>
<p>Before proceeding, let’s create a helper function that converts an UUID to a string.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="tutorial.html#cb13-1"></a><span class="dt">const</span> <span class="dt">char</span> *format_uuid(<span class="dt">char</span> *buffer, <span class="dt">uint8_t</span> *uuid)</span>
<span id="cb13-2"><a href="tutorial.html#cb13-2"></a>{</span>
<span id="cb13-3"><a href="tutorial.html#cb13-3"></a>    sprintf(buffer, <span class="st">&quot;{%02X%02X%02X%02X-%02X%02X-%02X%02X-&quot;</span></span>
<span id="cb13-4"><a href="tutorial.html#cb13-4"></a>                    <span class="st">&quot;%02X%02X-%02X%02X%02X%02X%02X%02X}&quot;</span>, </span>
<span id="cb13-5"><a href="tutorial.html#cb13-5"></a>           uuid[<span class="dv">0</span>], uuid[<span class="dv">1</span>], uuid[<span class="dv">2</span>], uuid[<span class="dv">3</span>],</span>
<span id="cb13-6"><a href="tutorial.html#cb13-6"></a>           uuid[<span class="dv">4</span>], uuid[<span class="dv">5</span>], uuid[<span class="dv">6</span>], uuid[<span class="dv">7</span>], uuid[<span class="dv">8</span>], uuid[<span class="dv">9</span>],</span>
<span id="cb13-7"><a href="tutorial.html#cb13-7"></a>           uuid[<span class="dv">10</span>], uuid[<span class="dv">11</span>], uuid[<span class="dv">12</span>], uuid[<span class="dv">13</span>], uuid[<span class="dv">14</span>], uuid[<span class="dv">15</span>]);</span>
<span id="cb13-8"><a href="tutorial.html#cb13-8"></a>    <span class="cf">return</span> buffer;</span>
<span id="cb13-9"><a href="tutorial.html#cb13-9"></a>}</span></code></pre></div>
<div id="distance-estimation" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Distance Estimation</h3>
<p>The received signal strength indication (RSSI) is reported together with advertising data.
Generally, the intensity of electromagnetic waves radiating from a point source is
inversely proportional to the square of the distance from the source.
The well known equation for free space loss is:</p>
<p><span class="math display">\[ Loss = 32.45 + 20log(d) + 20log(f) \]</span></p>
<p>Where <span class="math inline">\(d\)</span> is in km, <span class="math inline">\(f\)</span> in MHz and <span class="math inline">\(Loss\)</span> in dB. By comparing RSSI and
measured power at a distance of 1 meter (<code>ref_power</code>),
we can grossly estimate the distance between the scanner and beacon using the free space
loss equation:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="tutorial.html#cb14-1"></a><span class="dt">double</span> estimate_distance(<span class="dt">int8_t</span> ref_power, <span class="dt">int8_t</span> rssi)</span>
<span id="cb14-2"><a href="tutorial.html#cb14-2"></a>{</span>
<span id="cb14-3"><a href="tutorial.html#cb14-3"></a>    <span class="cf">return</span> pow(<span class="dv">10</span>, (ref_power - rssi) / <span class="fl">20.0</span>);   </span>
<span id="cb14-4"><a href="tutorial.html#cb14-4"></a>}</span></code></pre></div>
<p>Now, we are able to make a fully functional iBeancon scanner in less than twenty lines:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="tutorial.html#cb15-1"></a>    <span class="dt">uint8_t</span> length;</span>
<span id="cb15-2"><a href="tutorial.html#cb15-2"></a>    ibeacon_adv_t *p_ibeacon;</span>
<span id="cb15-3"><a href="tutorial.html#cb15-3"></a>    <span class="dt">char</span> str_buffer[<span class="dv">80</span>];</span>
<span id="cb15-4"><a href="tutorial.html#cb15-4"></a>    ......</span>
<span id="cb15-5"><a href="tutorial.html#cb15-5"></a>    <span class="cf">case</span> GAP_EVENT_ADVERTISING_REPORT:</span>
<span id="cb15-6"><a href="tutorial.html#cb15-6"></a>        gap_get_advertisingReport(&amp;report, packet);</span>
<span id="cb15-7"><a href="tutorial.html#cb15-7"></a>        p_ibeacon = (ibeacon_adv_t *)ad_data_from_type(report.length, </span>
<span id="cb15-8"><a href="tutorial.html#cb15-8"></a>                       (<span class="dt">uint8_t</span> *)report.data, <span class="bn">0xff</span>, &amp;length);</span>
<span id="cb15-9"><a href="tutorial.html#cb15-9"></a></span>
<span id="cb15-10"><a href="tutorial.html#cb15-10"></a>        <span class="cf">if</span> ((length != <span class="kw">sizeof</span>(ibeacon_adv_t))</span>
<span id="cb15-11"><a href="tutorial.html#cb15-11"></a>            || (p_ibeacon-&gt;apple_id != APPLE_COMPANY_ID)</span>
<span id="cb15-12"><a href="tutorial.html#cb15-12"></a>            || (p_ibeacon-&gt;id != IBEACON_ID))</span>
<span id="cb15-13"><a href="tutorial.html#cb15-13"></a>            <span class="cf">break</span>;</span>
<span id="cb15-14"><a href="tutorial.html#cb15-14"></a>        </span>
<span id="cb15-15"><a href="tutorial.html#cb15-15"></a>        printf(<span class="st">&quot;%s %04X,%04X, %.1fm</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb15-16"><a href="tutorial.html#cb15-16"></a>                format_uuid(str_buffer, p_ibeacon-&gt;uuid), </span>
<span id="cb15-17"><a href="tutorial.html#cb15-17"></a>                p_ibeacon-&gt;major, p_ibeacon-&gt;minor,</span>
<span id="cb15-18"><a href="tutorial.html#cb15-18"></a>                estimate_distance(p_ibeacon-&gt;ref_power, report.rssi));</span>
<span id="cb15-19"><a href="tutorial.html#cb15-19"></a>        <span class="cf">break</span>;</span></code></pre></div>
<p>Use the <code>Locate</code> app to transmit iBeacon signal, and check if our device can found it (Figure <a href="tutorial.html#fig:ch1-iscanner">3.24</a>). Finaly, since RSSI value fluctuates,
one can add a low pass filter on RSSI to make
the estimation more stable.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-iscanner"></span>
<img src="img/ch1-iscanner.png" alt="iBeacon Scan Result" width="50%" />
<p class="caption">
Figure 3.24: iBeacon Scan Result
</p>
</div>
<div class="rmdnote">
<p>
Note that the size of this app’s binary increases dramatically. This is mainly because that Cortex-M3 don’t have a hardware floating-point unit and floating-point operations are all performed by library functions. <em>Think twice</em> before using floating-point operations.
</p>
</div>
</div>
<div id="concurrent-advertising-scanning" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Concurrent Advertising &amp; Scanning</h3>
<p>As an exercise, we can merge iBeacon project with this one, and check if our device can send iBeacon
signals while keeps scanning for other iBeacon devices.</p>
<div class="rmdnote">
<p>
Bluetooth radio uses TDD (Time Division Duplex) topology in which data transmission occur in one direction at one time and data reception occur at another time, and it’s impossible to receive its own iBeacon signal.
</p>
</div>
</div>
</div>
<div id="notification-indication" class="section level2">
<h2><span class="header-section-number">3.6</span> Notification &amp; Indication</h2>
<p>A server can use notification or indication procedure to notify (without
acknowledge) or indicate (with acknowledge) a characteristic value.
Now, let’s add notification and indication features to our thermometer we have created
in a previous tutorial.</p>
<p>To notify or indicate a characteristic value, we use <code>att_server_notify</code> and <code>att_server_indicate</code>
respectively. These two functions are only allowed to be called in <code>ATT_EVENT_CAN_SEND_NOW</code> event
from <code>ATT</code> module, which is requested by <code>att_server_request_can_send_now_event</code>. These APIs
must be called within the Bluetooth stack (<code>Host</code>) task.</p>
<p>Unsolicited notifications and indication may be triggered by a timer or interrupts, i.e. by sources
outside of Bluetooth stack task. To call these Bluetooth stack APIs, a inter-task communication
mechanism based on FreeRTOS messages is provided.</p>
<div id="inter-task-comm" class="section level3">
<h3><span class="header-section-number">3.6.1</span> Inter-task Communication</h3>
<p>Use <code>btstack_push_user_msg</code> to send a message into Bluetooth stack stack:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="tutorial.html#cb16-1"></a><span class="dt">uint32_t</span>  btstack_push_user_msg(<span class="dt">uint32_t</span> msg_id, <span class="dt">void</span> *data, <span class="dt">const</span> <span class="dt">uint16_t</span> len);</span></code></pre></div>
<p>This message will be passed to your <code>user_packet_handler</code> under event ID <code>BTSTACK_EVENT_USER_MSG</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="tutorial.html#cb17-1"></a><span class="dt">static</span> <span class="dt">void</span> user_packet_handler(<span class="dt">uint8_t</span> packet_type, <span class="dt">uint16_t</span> channel, </span>
<span id="cb17-2"><a href="tutorial.html#cb17-2"></a>                                <span class="dt">uint8_t</span> *packet, <span class="dt">uint16_t</span> size)</span>
<span id="cb17-3"><a href="tutorial.html#cb17-3"></a>{</span>
<span id="cb17-4"><a href="tutorial.html#cb17-4"></a>    <span class="dt">uint8_t</span> event = hci_event_packet_get_type(packet);</span>
<span id="cb17-5"><a href="tutorial.html#cb17-5"></a>    btstack_user_msg_t *p_user_msg;</span>
<span id="cb17-6"><a href="tutorial.html#cb17-6"></a>    <span class="cf">if</span> (packet_type != HCI_EVENT_PACKET) <span class="cf">return</span>;</span>
<span id="cb17-7"><a href="tutorial.html#cb17-7"></a></span>
<span id="cb17-8"><a href="tutorial.html#cb17-8"></a>    <span class="cf">switch</span> (event)</span>
<span id="cb17-9"><a href="tutorial.html#cb17-9"></a>    {</span>
<span id="cb17-10"><a href="tutorial.html#cb17-10"></a>    <span class="co">// ......</span></span>
<span id="cb17-11"><a href="tutorial.html#cb17-11"></a>    <span class="cf">case</span> BTSTACK_EVENT_USER_MSG:</span>
<span id="cb17-12"><a href="tutorial.html#cb17-12"></a>        p_user_msg = hci_event_packet_get_user_msg(packet);</span>
<span id="cb17-13"><a href="tutorial.html#cb17-13"></a>        user_msg_handler(p_user_msg-&gt;msg_id, p_user_msg-&gt;data, </span>
<span id="cb17-14"><a href="tutorial.html#cb17-14"></a>                         p_user_msg-&gt;len);</span>
<span id="cb17-15"><a href="tutorial.html#cb17-15"></a>        <span class="cf">break</span>;</span>
<span id="cb17-16"><a href="tutorial.html#cb17-16"></a>    <span class="co">// ......</span></span>
<span id="cb17-17"><a href="tutorial.html#cb17-17"></a>    }</span>
<span id="cb17-18"><a href="tutorial.html#cb17-18"></a>}</span></code></pre></div>
<p>Here, we delegate the handling of the user message to another function <code>user_msg_handler</code>. Note that
<code>user_msg_handler</code> is running in the context of Bluetooth stack task, and we are allowed to
call those Bluetooth stack APIs now.</p>
<p>Event <code>BTSTACK_EVENT_USER_MSG</code> is broacasted to all <code>HCI</code> event callback functions.</p>
</div>
<div id="timer" class="section level3">
<h3><span class="header-section-number">3.6.2</span> Timer</h3>
<p>Now let’s make our thermometer “AccurateOne” to update its value once per second. Firstly, create a
timer in initialization, such as in <code>app_main</code> or <code>setup_profile</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="tutorial.html#cb18-1"></a>TimerHandle_t app_timer = <span class="dv">0</span>;</span>
<span id="cb18-2"><a href="tutorial.html#cb18-2"></a></span>
<span id="cb18-3"><a href="tutorial.html#cb18-3"></a><span class="dt">uint32_t</span> setup_profile(<span class="dt">void</span> *data, <span class="dt">void</span> *user_data)</span>
<span id="cb18-4"><a href="tutorial.html#cb18-4"></a>{</span>
<span id="cb18-5"><a href="tutorial.html#cb18-5"></a>    app_timer = xTimerCreate(<span class="st">&quot;app&quot;</span>,</span>
<span id="cb18-6"><a href="tutorial.html#cb18-6"></a>								pdMS_TO_TICKS(<span class="dv">1000</span>),</span>
<span id="cb18-7"><a href="tutorial.html#cb18-7"></a>								pdTRUE,</span>
<span id="cb18-8"><a href="tutorial.html#cb18-8"></a>								NULL,</span>
<span id="cb18-9"><a href="tutorial.html#cb18-9"></a>								app_timer_callback);</span>
<span id="cb18-10"><a href="tutorial.html#cb18-10"></a>		<span class="co">// ...</span></span>
<span id="cb18-11"><a href="tutorial.html#cb18-11"></a>}</span></code></pre></div>
<p>Timer callback function is defined as:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="tutorial.html#cb19-1"></a><span class="pp">#define USER_MSG_ID_REQUEST_SEND            1</span></span>
<span id="cb19-2"><a href="tutorial.html#cb19-2"></a><span class="dt">static</span> <span class="dt">void</span> app_timer_callback(TimerHandle_t xTimer)</span>
<span id="cb19-3"><a href="tutorial.html#cb19-3"></a>{</span>
<span id="cb19-4"><a href="tutorial.html#cb19-4"></a>    <span class="cf">if</span> (temperture_notify_enable | temperture_indicate_enable)</span>
<span id="cb19-5"><a href="tutorial.html#cb19-5"></a>        btstack_push_user_msg(USER_MSG_ID_REQUEST_SEND, NULL, <span class="dv">0</span>);</span>
<span id="cb19-6"><a href="tutorial.html#cb19-6"></a>}</span></code></pre></div>
<p>This timer is started when we get <code>HCI_SUBEVENT_LE_CONNECTION_COMPLETE</code> in <code>HCI_EVENT_LE_META</code>, and
stopped when we get <code>HCI_EVENT_DISCONNECTION_COMPLETE</code>.</p>
<p>Here <code>temperture_notify_enable</code> and <code>temperture_indicate_enable</code> are two flags initialized as 0s
and set to <code>1</code> in <code>att_write_callback</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="tutorial.html#cb20-1"></a><span class="dt">static</span> <span class="dt">int</span> att_write_callback(hci_con_handle_t connection_handle, </span>
<span id="cb20-2"><a href="tutorial.html#cb20-2"></a>                              <span class="dt">uint16_t</span> att_handle, <span class="dt">uint16_t</span> transaction_mode, </span>
<span id="cb20-3"><a href="tutorial.html#cb20-3"></a>                              <span class="dt">uint16_t</span> offset, <span class="dt">uint8_t</span> *buffer, <span class="dt">uint16_t</span> buffer_size)</span>
<span id="cb20-4"><a href="tutorial.html#cb20-4"></a>{</span>
<span id="cb20-5"><a href="tutorial.html#cb20-5"></a>    <span class="cf">switch</span> (att_handle)</span>
<span id="cb20-6"><a href="tutorial.html#cb20-6"></a>    {</span>
<span id="cb20-7"><a href="tutorial.html#cb20-7"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT + <span class="dv">1</span>:</span>
<span id="cb20-8"><a href="tutorial.html#cb20-8"></a>        handle_send = connection_handle;</span>
<span id="cb20-9"><a href="tutorial.html#cb20-9"></a>        <span class="cf">switch</span> (*(<span class="dt">uint16_t</span> *)buffer)</span>
<span id="cb20-10"><a href="tutorial.html#cb20-10"></a>        {</span>
<span id="cb20-11"><a href="tutorial.html#cb20-11"></a>        <span class="cf">case</span> GATT_CLIENT_CHARACTERISTICS_CONFIGURATION_INDICATION:</span>
<span id="cb20-12"><a href="tutorial.html#cb20-12"></a>            temperture_indicate_enable = <span class="dv">1</span>;</span>
<span id="cb20-13"><a href="tutorial.html#cb20-13"></a>            <span class="cf">break</span>;</span>
<span id="cb20-14"><a href="tutorial.html#cb20-14"></a>        <span class="cf">case</span> GATT_CLIENT_CHARACTERISTICS_CONFIGURATION_NOTIFICATION:</span>
<span id="cb20-15"><a href="tutorial.html#cb20-15"></a>            temperture_notify_enable = <span class="dv">1</span>;</span>
<span id="cb20-16"><a href="tutorial.html#cb20-16"></a>            <span class="cf">break</span>;</span>
<span id="cb20-17"><a href="tutorial.html#cb20-17"></a>        }</span>
<span id="cb20-18"><a href="tutorial.html#cb20-18"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb20-19"><a href="tutorial.html#cb20-19"></a>    <span class="co">// ...</span></span>
<span id="cb20-20"><a href="tutorial.html#cb20-20"></a>    }</span>
<span id="cb20-21"><a href="tutorial.html#cb20-21"></a>}</span></code></pre></div>
<p>Here we store <code>connection_handle</code> to a global variable <code>handle_send</code> which will be used later.
The last piece of code is to handle message <code>USER_MSG_ID_REQUEST_SEND</code> in <code>user_msg_handler</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="tutorial.html#cb21-1"></a><span class="dt">static</span> <span class="dt">void</span> user_msg_handler(<span class="dt">uint32_t</span> msg_id, <span class="dt">void</span> *data, <span class="dt">uint16_t</span> size)</span>
<span id="cb21-2"><a href="tutorial.html#cb21-2"></a>{</span>
<span id="cb21-3"><a href="tutorial.html#cb21-3"></a>    <span class="cf">switch</span> (msg_id)</span>
<span id="cb21-4"><a href="tutorial.html#cb21-4"></a>    {</span>
<span id="cb21-5"><a href="tutorial.html#cb21-5"></a>    <span class="cf">case</span> USER_MSG_ID_REQUEST_SEND:</span>
<span id="cb21-6"><a href="tutorial.html#cb21-6"></a>        att_server_request_can_send_now_event(handle_send);</span>
<span id="cb21-7"><a href="tutorial.html#cb21-7"></a>        <span class="cf">break</span>;</span>
<span id="cb21-8"><a href="tutorial.html#cb21-8"></a>    }</span>
<span id="cb21-9"><a href="tutorial.html#cb21-9"></a>}</span></code></pre></div>
<p>And report temperature in <code>ATT_EVENT_CAN_SEND_NOW</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="tutorial.html#cb22-1"></a>...</span>
<span id="cb22-2"><a href="tutorial.html#cb22-2"></a><span class="cf">case</span> ATT_EVENT_CAN_SEND_NOW:</span>
<span id="cb22-3"><a href="tutorial.html#cb22-3"></a>    temperature_meas.mantissa = rand() % <span class="dv">100</span>;</span>
<span id="cb22-4"><a href="tutorial.html#cb22-4"></a>    <span class="cf">if</span> (temperture_notify_enable)</span>
<span id="cb22-5"><a href="tutorial.html#cb22-5"></a>    {</span>
<span id="cb22-6"><a href="tutorial.html#cb22-6"></a>        att_server_notify(handle_send, </span>
<span id="cb22-7"><a href="tutorial.html#cb22-7"></a>                          HANDLE_TEMPERATURE_MEASUREMENT, </span>
<span id="cb22-8"><a href="tutorial.html#cb22-8"></a>                          (<span class="dt">uint8_t</span>*)&amp;temperature_meas,</span>
<span id="cb22-9"><a href="tutorial.html#cb22-9"></a>                          <span class="kw">sizeof</span>(temperature_meas));</span>
<span id="cb22-10"><a href="tutorial.html#cb22-10"></a>    }</span>
<span id="cb22-11"><a href="tutorial.html#cb22-11"></a></span>
<span id="cb22-12"><a href="tutorial.html#cb22-12"></a>    <span class="cf">if</span> (temperture_indicate_enable)</span>
<span id="cb22-13"><a href="tutorial.html#cb22-13"></a>    {</span>
<span id="cb22-14"><a href="tutorial.html#cb22-14"></a>        att_server_indicate(handle_send, </span>
<span id="cb22-15"><a href="tutorial.html#cb22-15"></a>                          HANDLE_TEMPERATURE_MEASUREMENT, </span>
<span id="cb22-16"><a href="tutorial.html#cb22-16"></a>                          (<span class="dt">uint8_t</span>*)&amp;temperature_meas,</span>
<span id="cb22-17"><a href="tutorial.html#cb22-17"></a>                          <span class="kw">sizeof</span>(temperature_meas));</span>
<span id="cb22-18"><a href="tutorial.html#cb22-18"></a>    }</span>
<span id="cb22-19"><a href="tutorial.html#cb22-19"></a>    <span class="cf">break</span>;</span>
<span id="cb22-20"><a href="tutorial.html#cb22-20"></a>...</span></code></pre></div>
<p>Try to rebuild and download the project, and check if the temperature value shown in <code>INGdemo</code> changes once
per second.</p>
<div class="rmdnote">
<p>
There is a fully functional thermometer example, a.k.a <code>thermo_ota</code>, supporting FOTA, notification and indication.
</p>
</div>
</div>
</div>
<div id="throughput" class="section level2">
<h2><span class="header-section-number">3.7</span> Throughput</h2>
<p>BLE 5.0 introduces a new uncoded PHY with a sampling rate at 2M.</p>
<div id="theoretical-peak-throughput" class="section level3">
<h3><span class="header-section-number">3.7.1</span> Theoretical Peak Throughput</h3>
<p>Maximum payload length is 251 bytes for a Data Physical Channel PDU. Using 2M PHY, it takes 1048 μs to
transmit. And an empty Data Physical Channel PDU takes 44 μs to transmit.</p>
<p>To achieve maximum throughput on one direction, length of all PDUs on this direction should be 251 bytes,
while on the other direction, all PDUs should be empty. So, the transmission of 251 bytes takes a total
duration of</p>
<p><span class="math display">\[ 1048 + 44 + 150 * 2 = 1392 (\mu s) \]</span></p>
<p>Therefore, the theoretical peak throughput provided by link layer is</p>
<p><span class="math display">\[ 251 * 8 / 1392 * 1000000 \approx 1442.528 (kbps) \]</span></p>
<p>For an app working above GATT, I2CAP and ATT all have their own overhead. Typically,
GATT has a maximum effective payload of (251 - 7 =) 244 bytes. So, GATT could provide a
theoretical peak throughput of</p>
<p><span class="math display">\[ 244 * 8 / 1392 * 1000000 \approx 1402.298 (kbps) \]</span></p>
</div>
<div id="test-throughput" class="section level3">
<h3><span class="header-section-number">3.7.2</span> Test Throughput</h3>
<p>There are a pair of examples in SDK for throughput testing (Figure ).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-tpt"></span>
<img src="img/ch1-tpt.png" alt="Examples for Throughput Testing" width="60%" />
<p class="caption">
Figure 3.25: Examples for Throughput Testing
</p>
</div>
<div id="test-against-ingdemo" class="section level4">
<h4><span class="header-section-number">3.7.2.1</span> Test against <code>INGdemo</code></h4>
<p>Download <code>peripheral_throughput</code>. Use <code>INGdemo</code> to connect to <code>ING Tpt</code>, and open throughput testing
page. On this page, we can test throughput from master to slave, from slave to master, or
on both directions simultaneously.</p>
<p>Figure  shows that using a common low end Android phone with 2M PHY support,
we can achieve a 1M+ bps throughput over the air.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-tpt-app"></span>
<img src="img/ch1-tpt_app.png" alt="Througput on an Android Phone" width="30%" />
<p class="caption">
Figure 3.26: Througput on an Android Phone
</p>
</div>
</div>
<div id="test-against-our-own-app" class="section level4">
<h4><span class="header-section-number">3.7.2.2</span> Test against Our Own App</h4>
<p>Example <code>central_throughput</code> demonstrates the typical procedure for a BLE central device:</p>
<ol style="list-style-type: decimal">
<li>Scan and connect to a device that has throughput service declared in its advertising</li>
<li>Discover throughput service;</li>
<li>Discover characteristics of the service;</li>
<li>Discover descriptors of characteristics.</li>
</ol>
<p><code>INGChips Throughput Service</code> has two characteristics.</p>
<ul>
<li><p>Generic Output</p>
<p>By this characteristic, peripheral device send data to central device.</p>
<p>This characteristic has a <code>Client Characteristic Configuration</code> descriptor.</p></li>
<li><p>Generic Output</p>
<p>By this characteristic, central device send data to peripheral device.</p></li>
</ul>
<p>Download <code>central_throughput</code> to another board. This app has a UART command line interface to
host computer. Connect to a host computer, type “?” to check supported commands.
This app connects to <code>peripheral_throughput</code> automatically. Input command <code>start s-&gt;m</code>
or <code>start m-&gt;s</code> to
start testing throughput from peripheral to central, or from central to peripheral, receptively.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-cmd"></span>
<img src="img/ch1-cmd.png" alt="Command interface" width="40%" />
<p class="caption">
Figure 3.27: Command interface
</p>
</div>
<p>Figure  shows that using two boards, we have achieved a stable throughout at 1.2M+ bps over the air.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-board-tpt"></span>
<img src="img/ch1-board_tpt.png" alt="Througput Between Boards" width="70%" />
<p class="caption">
Figure 3.28: Througput Between Boards
</p>
</div>
<div class="rmdnote">
<p>
This throughput is tested over the air, a little bit lower than theoretical peak value, but much more practical.
</p>
</div>
</div>
</div>
</div>
<div id="dual-role-ble-gateway" class="section level2">
<h2><span class="header-section-number">3.8</span> Dual Role &amp; BLE Gateway</h2>
<p>In this tutorial, we are going to create a BLE gateway, which collects data from several peripheral
devices and reports data to a central device. When collecting data, this gateway is a central device,
while reporting data, it is a peripheral device, i.e., our app has two roles.</p>
<p>More specifically, our gateway only supports to collect data from thermometers. Let call it a
<code>smart_meter</code>.</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-smart-meter"></span>
<img src="img/ch1-smart-meter.png" alt="Smart Meter Overview" width="60%" />
<p class="caption">
Figure 3.29: Smart Meter Overview
</p>
</div>
<p><code>smart_meter</code> uses a generic string based output service for report data to a central device, such as
the <code>INGdemo</code> running on a smart phone. It also has a UART control interface connecting to a host
computer.</p>
<div class="rmdnote">
<p>
Checkout the example <code>peripheral_console</code> for how to do string input &amp; output.
</p>
<p>
Full functional <code>smart_meter</code> app is also provided as an example. Take this example as an reference while creating your own.
</p>
</div>
<p>Now, let’s create this BLE gateway.</p>
<div id="use-ingwizard-to-create-a-peripheral-app" class="section level3">
<h3><span class="header-section-number">3.8.1</span> Use <code>ingWizard</code> to create a peripheral app</h3>
<p>Use GUI editor to edit advertising data, naming our app as “ING Smart Meter”.</p>
<p>Use GUI editor to edit GATT Profile. Add <code>INGChips Console Service</code> into
GATT Profile (Figure ).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-smart-meter-gatt"></span>
<img src="img/ch1-smart-meter-gatt.png" alt="Smart Meter GATT Profile" width="60%" />
<p class="caption">
Figure 3.30: Smart Meter GATT Profile
</p>
</div>
</div>
<div id="define-thermometer-data" class="section level3">
<h3><span class="header-section-number">3.8.2</span> Define Thermometer Data</h3>
<p>A thermometer is identified by its device address and <code>id</code>. Each thermometer
uses its own connection identified by <code>conn_handle</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="tutorial.html#cb23-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> slave_info</span>
<span id="cb23-2"><a href="tutorial.html#cb23-2"></a>{</span>
<span id="cb23-3"><a href="tutorial.html#cb23-3"></a>    <span class="dt">uint8_t</span>     id;</span>
<span id="cb23-4"><a href="tutorial.html#cb23-4"></a>    bd_addr_t   addr;</span>
<span id="cb23-5"><a href="tutorial.html#cb23-5"></a>    <span class="dt">uint16_t</span>    conn_handle;</span>
<span id="cb23-6"><a href="tutorial.html#cb23-6"></a>    gatt_client_service_t                   service_thermo;</span>
<span id="cb23-7"><a href="tutorial.html#cb23-7"></a>    gatt_client_characteristic_t            temp_char;</span>
<span id="cb23-8"><a href="tutorial.html#cb23-8"></a>    gatt_client_characteristic_descriptor_t temp_desc;</span>
<span id="cb23-9"><a href="tutorial.html#cb23-9"></a>    gatt_client_notification_t              temp_notify;</span>
<span id="cb23-10"><a href="tutorial.html#cb23-10"></a>} slave_info_t;</span></code></pre></div>
<p>Define four thermometers.</p>
</div>
<div id="scan-for-thermometers" class="section level3">
<h3><span class="header-section-number">3.8.3</span> Scan for Thermometers</h3>
<p>Call two GAP APIs to start scanning. Once a device is found, check whether its device address
is one of the thermometers. If so, stop scanning and call
<code>gap_ext_create_connection</code> to connect.</p>
<p>After connection established, if there is any thermometer not connected, then start scanning again.</p>
</div>
<div id="discover-services" class="section level3">
<h3><span class="header-section-number">3.8.4</span> Discover Services</h3>
<p>After connection established, call <code>gatt_client</code> APIs to discover its services.</p>
<p>These APIs follow a similar logic like Android, iOS.</p>
</div>
<div id="data-handling" class="section level3">
<h3><span class="header-section-number">3.8.5</span> Data Handling</h3>
<p>Subscribe to thermometer’s <code>Temperature Measurement</code> characteristic. When a new measurement is
received, convert the value into a string and report it to a host computer. If our app is already
connected to a central device, forward this information to it through GATT characteristic.</p>
</div>
<div id="robustness" class="section level3">
<h3><span class="header-section-number">3.8.6</span> Robustness</h3>
<p>To make our app more <em>robust</em>:</p>
<ul>
<li><p>If disconnected from a thermometer, then start scanning;</p></li>
<li><p>If disconnected from a central device, then start advertising.</p></li>
</ul>
</div>
<div id="prepare-thermometers" class="section level3">
<h3><span class="header-section-number">3.8.7</span> Prepare Thermometers</h3>
<p>We can use example <code>thermo_ota</code> as thermometers. But we need to configure
different address for each one.</p>
<p>We can write a simple script for downloader to generate these addresses automatically:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode pascal"><code class="sourceCode pascal"><span id="cb24-1"><a href="tutorial.html#cb24-1"></a><span class="kw">procedure</span> OnStartBin(<span class="kw">const</span> BatchCounter, BinIndex: <span class="dt">Integer</span>;</span>
<span id="cb24-2"><a href="tutorial.html#cb24-2"></a>                     <span class="kw">var</span> Data: TBytes; <span class="kw">var</span> Abort: <span class="dt">Boolean</span>);</span>
<span id="cb24-3"><a href="tutorial.html#cb24-3"></a><span class="kw">begin</span></span>
<span id="cb24-4"><a href="tutorial.html#cb24-4"></a>  <span class="kw">if</span> BinIndex &lt;&gt; <span class="dv">6</span> <span class="kw">then</span> <span class="kw">Exit</span>;</span>
<span id="cb24-5"><a href="tutorial.html#cb24-5"></a>  Data[<span class="dv">0</span>] := BatchCounter;</span>
<span id="cb24-6"><a href="tutorial.html#cb24-6"></a><span class="kw">end</span>;</span></code></pre></div>
<p>For further information on downloader scripting, see <a href="core-tools.html#script-mass-prod">Scripting &amp; Mass Production</a>.</p>
</div>
<div id="test" class="section level3">
<h3><span class="header-section-number">3.8.8</span> Test</h3>
<p>Input command <code>start</code> on host computer to start our app (start scanning &amp; advertising).
Use <code>INGdemo</code> to connect to a device named “ING Smart Meter” and check temperature measurements.</p>
<p>Turn off and on one or more thermometers, and our app should be able to reconnect to them.</p>
</div>
</div>
<div id="hello-nim" class="section level2">
<h2><span class="header-section-number">3.9</span> Hello, Nim</h2>
<p>To use <code>Nim</code> to develop apps, <code>nim</code> and <code>Gnu Toolchain</code> are both required. <code>Nim</code> compiler
translates <code>Nim</code> source code into <code>C</code> source code, then <code>Gnu Toolchain</code> is invoked to
compile and link the translated <code>C</code> source code together with SDK, as shown in
Figure .</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-nim-build"></span>
<img src="img/ch1-nim-build.png" alt="Build a Nim App" width="80%" />
<p class="caption">
Figure 3.31: Build a Nim App
</p>
</div>
<p><code>Visual Studio Code</code> is recommended for <code>Nim</code> code editing and building. Let’s make a simple app using <code>Nim</code>.</p>
<div id="create-a-nim-project" class="section level3">
<h3><span class="header-section-number">3.9.1</span> Create a <code>Nim</code> Project</h3>
<p>On the <code>Develpment Tool</code> page, Select <code>Nim + Gnu Toolchain</code>. Select <code>By Code</code> for both
advertising &amp; ATT database generation (Figure ).</p>
<div class="figure" style="text-align: center"><span id="fig:ch1-nim-by-code"></span>
<img src="img/ch1-nim-by-code.png" alt="Use Code to Generate Data" width="60%" />
<p class="caption">
Figure 3.32: Use Code to Generate Data
</p>
</div>
<p><code>ingWizard</code> also support create these data for <code>Nim</code> apps. In this tutorial, we are going to
show that it is easy to create these data with
meta-programming<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a> in <code>Nim</code>.</p>
</div>
<div id="create-advertising-data" class="section level3">
<h3><span class="header-section-number">3.9.2</span> Create Advertising Data</h3>
<p>Using <code>Nim</code> module <code>btdatabuilder</code>, we can create advertising and GATT profile easily.</p>
<ul>
<li><p>Example 1: Create a device named “Hello, Nim”</p>
<pre class="nim"><code>let
  advData = ToArray([Flags({LEGeneralDiscoverableMode, BR_EDR_NotSupported}),
                     LocalName(&quot;Hello, Nim&quot;)])</code></pre></li>
<li><p>Example 2: Create an iBeacon</p>
<pre class="nim"><code>let
  advData = ToArray([Flags({LEGeneralDiscoverableMode, BR_EDR_NotSupported}),
                     iBeacon(&quot;{E9052F1E-9D67-4A6E-B2D7-459D132D6A94}&quot;,
                             0, 0, -50)])</code></pre></li>
</ul>
</div>
<div id="create-profile-data" class="section level3">
<h3><span class="header-section-number">3.9.3</span> Create Profile Data</h3>
<pre class="nim"><code>defineProfile([Service(SIG_UUID_SERVICE_GENERIC_ACCESS),
               Characteristic(SIG_UUID_CHARACT_GAP_DEVICE_NAME, ATT_PROPERTY_READ, 
                              &quot;Hello, Nim&quot;),
               Characteristic(SIG_UUID_CHARACT_GAP_APPEARANCE, ATT_PROPERTY_READ,
                              [0u8, 0]),
               Service(SIG_UUID_SERVICE_BATTERY_SERVICE),
               Characteristic(SIG_UUID_CHARACT_BATTERY_LEVEL, ATT_PROPERTY_READ,
                              [20u8], &quot;HANDLE_BATTERY_LEVEL&quot;)],
               &quot;profileData&quot;)</code></pre>
<p>Once above code got compiled, ATT database is stored in <code>profileData</code>, handle of battery level
characteristic is identified by a const <code>HANDLE_BATTERY_LEVEL</code>, and the offset (in byte)
of battery level value in ATT base (i.e. <code>profileData</code>) is identified by a const <code>HANDLE_BATTERY_LEVEL_OFFSET</code>.</p>
<p>We can use these variables and constants generated by macro <code>defineProfile</code> just as <em>normal</em>
ones. For example, let’s create a task that updates battery level pseudo randomly:</p>
<pre class="nim"><code>proc updateBatteryLevel(unused: pointer) {.noconv.} =
  while true:
    vTaskDelay(pdMS_TO_TICKS(1000))
    profileData[HANDLE_BATTERY_LEVEL_OFFSET] = rand_level()
...
discard xTaskCreate(updateBatteryLevel, &quot;b&quot;, 
                    configMINIMAL_STACK_SIZE, nil, 
                    configMAX_PRIORITIES - 1, nil)</code></pre>
<p>There are at least three ways to generate pseudo random number in <code>Nim</code>, use PRNG provided
by <code>C</code>’s stdlib, use PRNG provided by provided by <code>Nim</code>, or create our own PRNG.</p>
<ul>
<li>Use <code>C</code>’s PRNG</li>
</ul>
<pre class="nim"><code># It&#39;s easy to import C functions and use them
proc rand(): cint {. importc: &quot;rand&quot;, header: &quot;stdlib.h&quot;.}

proc rand_level(): uint8 = cast[uint8](rand() mod 101)</code></pre>
<ul>
<li>Use <code>Nim</code>’s PRNG</li>
</ul>
<pre class="nim"><code>import random
proc rand_level(): uint8 = cast[uint8](rand(0..100))</code></pre>
<ul>
<li>Create a simple PRNG</li>
</ul>
<pre class="nim"><code>proc rand_level(): uint8=
  var last {.global.} = 0u16
  last = (last * 173 + 31) and 0x7fffu16
  return cast[uint8](last mod 101)</code></pre>
<p>As we see, all three ways are easy in <code>Nim</code>.</p>
<div class="rmdnote">
<p>
<code>platform_hrng</code> can be used to initialized PRNG.
</p>
</div>
</div>
<div id="benefits-of-adopting-nim" class="section level3">
<h3><span class="header-section-number">3.9.4</span> Benefits of Adopting <code>Nim</code></h3>
<p><code>Nim</code> is as powerful as <code>C</code> because SDK provides bindings of all <code>C</code> APIs for <code>Nim</code>.
There are many benefits of adopting <code>Nim</code>, such as it supports meta-programming and it is
strongly typed.</p>
<ul>
<li><p><em>Meta-programming</em></p>
<p>With metaprogramming, we can create advertising and ATT database at compile time,
which has <code>0</code> overhead in runtime obviously.</p></li>
<li><p><em>Strongly Typed</em></p>
<p><code>Nim</code> is more strongly typed than <code>C</code>, which can help to make code safer.</p></li>
</ul>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="11">
<li id="fn11"><p><a href="https://developer.apple.com/ibeacon/" class="uri">https://developer.apple.com/ibeacon/</a><a href="tutorial.html#fnref11" class="footnote-back">↩︎</a></p></li>
<li id="fn12"><p>Note that UUID is not allowed to be all 0s in final products.<a href="tutorial.html#fnref12" class="footnote-back">↩︎</a></p></li>
<li id="fn13"><p><code>Makefile</code> follows the
syntax of GNU <code>make</code>.<a href="tutorial.html#fnref13" class="footnote-back">↩︎</a></p></li>
<li id="fn14"><p><a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.health_thermometer.xml" class="uri">https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.health_thermometer.xml</a><a href="tutorial.html#fnref14" class="footnote-back">↩︎</a></p></li>
<li id="fn15"><p>Apps can report a different version
in FOTA. It is not reqired to be same as in <code>Environment Options</code>.<a href="tutorial.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p><a href="https://en.wikipedia.org/wiki/Metaprogramming" class="uri">https://en.wikipedia.org/wiki/Metaprogramming</a><a href="tutorial.html#fnref16" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="core-tools.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["user_guide.pdf", "user_guide.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
