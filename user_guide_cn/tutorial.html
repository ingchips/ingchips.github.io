<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 教程 | INGCHIPS SDK 开发者用户手册</title>
  <meta name="description" content="本文是 INGCHIPS SDK 的开发者用户手册。" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="3 教程 | INGCHIPS SDK 开发者用户手册" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/./img/sdk_overview.png" />
  <meta property="og:description" content="本文是 INGCHIPS SDK 的开发者用户手册。" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 教程 | INGCHIPS SDK 开发者用户手册" />
  
  <meta name="twitter:description" content="本文是 INGCHIPS SDK 的开发者用户手册。" />
  <meta name="twitter:image" content="/./img/sdk_overview.png" />

<meta name="author" content="Ingchips Technology Co., Ltd." />


<meta name="date" content="2023-10-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="core-tools.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">User Guide</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> 欢迎</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> 简介</a>
<ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#范围"><i class="fa fa-check"></i><b>2.1</b> 范围</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#架构"><i class="fa fa-check"></i><b>2.2</b> 架构</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="intro.html"><a href="intro.html#rtos-软件包"><i class="fa fa-check"></i><b>2.2.1</b> RTOS 软件包</a></li>
<li class="chapter" data-level="2.2.2" data-path="intro.html"><a href="intro.html#noos-软件包"><i class="fa fa-check"></i><b>2.2.2</b> “NoOS” 软件包</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#缩略语和术语"><i class="fa fa-check"></i><b>2.3</b> 缩略语和术语</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#参考资料"><i class="fa fa-check"></i><b>2.4</b> 参考资料</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tutorial.html"><a href="tutorial.html"><i class="fa fa-check"></i><b>3</b> 教程</a>
<ul>
<li class="chapter" data-level="3.1" data-path="tutorial.html"><a href="tutorial.html#ch1-hello-world"><i class="fa fa-check"></i><b>3.1</b> 世界你好</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="tutorial.html"><a href="tutorial.html#development-tool-页面"><i class="fa fa-check"></i><b>3.1.1</b> <code>Development Tool</code> 页面</a></li>
<li class="chapter" data-level="3.1.2" data-path="tutorial.html"><a href="tutorial.html#choose-chip-series-页面"><i class="fa fa-check"></i><b>3.1.2</b> <code>Choose Chip Series</code> 页面</a></li>
<li class="chapter" data-level="3.1.3" data-path="tutorial.html"><a href="tutorial.html#choose-project-type-页面"><i class="fa fa-check"></i><b>3.1.3</b> <code>Choose Project Type</code> 页面</a></li>
<li class="chapter" data-level="3.1.4" data-path="tutorial.html"><a href="tutorial.html#role-of-your-device-页面"><i class="fa fa-check"></i><b>3.1.4</b> <code>Role of Your Device</code> 页面</a></li>
<li class="chapter" data-level="3.1.5" data-path="tutorial.html"><a href="tutorial.html#peripheral-setup-页面"><i class="fa fa-check"></i><b>3.1.5</b> <code>Peripheral Setup</code> 页面</a></li>
<li class="chapter" data-level="3.1.6" data-path="tutorial.html"><a href="tutorial.html#security-privacy-页面"><i class="fa fa-check"></i><b>3.1.6</b> <code>Security &amp; Privacy</code> 页面</a></li>
<li class="chapter" data-level="3.1.7" data-path="tutorial.html"><a href="tutorial.html#firmare-over-the-air-页面"><i class="fa fa-check"></i><b>3.1.7</b> <code>Firmare Over-The-Air</code> 页面</a></li>
<li class="chapter" data-level="3.1.8" data-path="tutorial.html"><a href="tutorial.html#common-functions-页面"><i class="fa fa-check"></i><b>3.1.8</b> <code>Common Functions</code> 页面</a></li>
<li class="chapter" data-level="3.1.9" data-path="tutorial.html"><a href="tutorial.html#编译您的项目"><i class="fa fa-check"></i><b>3.1.9</b> 编译您的项目</a></li>
<li class="chapter" data-level="3.1.10" data-path="tutorial.html"><a href="tutorial.html#下载"><i class="fa fa-check"></i><b>3.1.10</b> 下载</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="tutorial.html"><a href="tutorial.html#ibeacon"><i class="fa fa-check"></i><b>3.2</b> iBeacon</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="tutorial.html"><a href="tutorial.html#建立广播数据"><i class="fa fa-check"></i><b>3.2.1</b> 建立广播数据</a></li>
<li class="chapter" data-level="3.2.2" data-path="tutorial.html"><a href="tutorial.html#尝试应用"><i class="fa fa-check"></i><b>3.2.2</b> 尝试应用</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="tutorial.html"><a href="tutorial.html#温度计"><i class="fa fa-check"></i><b>3.3</b> 温度计</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="tutorial.html"><a href="tutorial.html#建立广播数据-1"><i class="fa fa-check"></i><b>3.3.1</b> 建立广播数据</a></li>
<li class="chapter" data-level="3.3.2" data-path="tutorial.html"><a href="tutorial.html#建立gatt配置文件"><i class="fa fa-check"></i><b>3.3.2</b> 建立GATT配置文件</a></li>
<li class="chapter" data-level="3.3.3" data-path="tutorial.html"><a href="tutorial.html#代码编写"><i class="fa fa-check"></i><b>3.3.3</b> 代码编写</a></li>
<li class="chapter" data-level="3.3.4" data-path="tutorial.html"><a href="tutorial.html#通知"><i class="fa fa-check"></i><b>3.3.4</b> 通知</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="tutorial.html"><a href="tutorial.html#fota温度计"><i class="fa fa-check"></i><b>3.4</b> FOTA温度计</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="tutorial.html"><a href="tutorial.html#fota设备"><i class="fa fa-check"></i><b>3.4.1</b> FOTA设备</a></li>
<li class="chapter" data-level="3.4.2" data-path="tutorial.html"><a href="tutorial.html#创建一个新版本"><i class="fa fa-check"></i><b>3.4.2</b> 创建一个新版本</a></li>
<li class="chapter" data-level="3.4.3" data-path="tutorial.html"><a href="tutorial.html#fota服务器"><i class="fa fa-check"></i><b>3.4.3</b> FOTA服务器</a></li>
<li class="chapter" data-level="3.4.4" data-path="tutorial.html"><a href="tutorial.html#尝试应用-1"><i class="fa fa-check"></i><b>3.4.4</b> 尝试应用</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="tutorial.html"><a href="tutorial.html#ibeacon扫描设备"><i class="fa fa-check"></i><b>3.5</b> iBeacon扫描设备</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="tutorial.html"><a href="tutorial.html#估算距离"><i class="fa fa-check"></i><b>3.5.1</b> 估算距离</a></li>
<li class="chapter" data-level="3.5.2" data-path="tutorial.html"><a href="tutorial.html#并发广播扫描"><i class="fa fa-check"></i><b>3.5.2</b> 并发广播&amp;扫描</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="tutorial.html"><a href="tutorial.html#通知指示"><i class="fa fa-check"></i><b>3.6</b> 通知&amp;指示</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="tutorial.html"><a href="tutorial.html#inter-task-comm"><i class="fa fa-check"></i><b>3.6.1</b> 任务间通信</a></li>
<li class="chapter" data-level="3.6.2" data-path="tutorial.html"><a href="tutorial.html#定时器"><i class="fa fa-check"></i><b>3.6.2</b> 定时器</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="tutorial.html"><a href="tutorial.html#吞吐量"><i class="fa fa-check"></i><b>3.7</b> 吞吐量</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="tutorial.html"><a href="tutorial.html#理论峰值吞吐量"><i class="fa fa-check"></i><b>3.7.1</b> 理论峰值吞吐量</a></li>
<li class="chapter" data-level="3.7.2" data-path="tutorial.html"><a href="tutorial.html#测试吞吐量"><i class="fa fa-check"></i><b>3.7.2</b> 测试吞吐量</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="tutorial.html"><a href="tutorial.html#双角色-ble网关"><i class="fa fa-check"></i><b>3.8</b> 双角色 &amp; BLE网关</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="tutorial.html"><a href="tutorial.html#用-ingwizard-创建一个外设app"><i class="fa fa-check"></i><b>3.8.1</b> 用 <code>ingWizard</code> 创建一个外设APP</a></li>
<li class="chapter" data-level="3.8.2" data-path="tutorial.html"><a href="tutorial.html#定义温度计数据"><i class="fa fa-check"></i><b>3.8.2</b> 定义温度计数据</a></li>
<li class="chapter" data-level="3.8.3" data-path="tutorial.html"><a href="tutorial.html#扫描温度计"><i class="fa fa-check"></i><b>3.8.3</b> 扫描温度计</a></li>
<li class="chapter" data-level="3.8.4" data-path="tutorial.html"><a href="tutorial.html#发现服务"><i class="fa fa-check"></i><b>3.8.4</b> 发现服务</a></li>
<li class="chapter" data-level="3.8.5" data-path="tutorial.html"><a href="tutorial.html#数据处理"><i class="fa fa-check"></i><b>3.8.5</b> 数据处理</a></li>
<li class="chapter" data-level="3.8.6" data-path="tutorial.html"><a href="tutorial.html#鲁棒性"><i class="fa fa-check"></i><b>3.8.6</b> 鲁棒性</a></li>
<li class="chapter" data-level="3.8.7" data-path="tutorial.html"><a href="tutorial.html#准备温度计"><i class="fa fa-check"></i><b>3.8.7</b> 准备温度计</a></li>
<li class="chapter" data-level="3.8.8" data-path="tutorial.html"><a href="tutorial.html#测试"><i class="fa fa-check"></i><b>3.8.8</b> 测试</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="tutorial.html"><a href="tutorial.html#hello-nim"><i class="fa fa-check"></i><b>3.9</b> Hello, Nim</a>
<ul>
<li class="chapter" data-level="3.9.1" data-path="tutorial.html"><a href="tutorial.html#创建一个-nim-app"><i class="fa fa-check"></i><b>3.9.1</b> 创建一个 <code>Nim</code> APP</a></li>
<li class="chapter" data-level="3.9.2" data-path="tutorial.html"><a href="tutorial.html#创建广播数据"><i class="fa fa-check"></i><b>3.9.2</b> 创建广播数据</a></li>
<li class="chapter" data-level="3.9.3" data-path="tutorial.html"><a href="tutorial.html#创建配置数据"><i class="fa fa-check"></i><b>3.9.3</b> 创建配置数据</a></li>
<li class="chapter" data-level="3.9.4" data-path="tutorial.html"><a href="tutorial.html#使用-nim-的好处"><i class="fa fa-check"></i><b>3.9.4</b> 使用 <code>Nim</code> 的好处</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="core-tools.html"><a href="core-tools.html"><i class="fa fa-check"></i><b>4</b> 核心工具</a>
<ul>
<li class="chapter" data-level="4.1" data-path="core-tools.html"><a href="core-tools.html#向导"><i class="fa fa-check"></i><b>4.1</b> 向导</a></li>
<li class="chapter" data-level="4.2" data-path="core-tools.html"><a href="core-tools.html#ch2-downloader"><i class="fa fa-check"></i><b>4.2</b> 下载器</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="core-tools.html"><a href="core-tools.html#介绍"><i class="fa fa-check"></i><b>4.2.1</b> 介绍</a></li>
<li class="chapter" data-level="4.2.2" data-path="core-tools.html"><a href="core-tools.html#script-mass-prod"><i class="fa fa-check"></i><b>4.2.2</b> 脚本与量产</a></li>
<li class="chapter" data-level="4.2.3" data-path="core-tools.html"><a href="core-tools.html#flash-读保护适用于-ing918xx"><i class="fa fa-check"></i><b>4.2.3</b> Flash 读保护（适用于 ING918xx）</a></li>
<li class="chapter" data-level="4.2.4" data-path="core-tools.html"><a href="core-tools.html#python-版本"><i class="fa fa-check"></i><b>4.2.4</b> Python 版本</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="core-tools.html"><a href="core-tools.html#ingtracer"><i class="fa fa-check"></i><b>4.3</b> Trace 工具</a></li>
<li class="chapter" data-level="4.4" data-path="core-tools.html"><a href="core-tools.html#ch2-axf-tool"><i class="fa fa-check"></i><b>4.4</b> Axf Tool</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html"><i class="fa fa-check"></i><b>5</b> 深入 SDK</a>
<ul>
<li class="chapter" data-level="5.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#内存管理"><i class="fa fa-check"></i><b>5.1</b> 内存管理</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#全局分配"><i class="fa fa-check"></i><b>5.1.1</b> 全局分配</a></li>
<li class="chapter" data-level="5.1.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#使用栈"><i class="fa fa-check"></i><b>5.1.2</b> 使用栈</a></li>
<li class="chapter" data-level="5.1.3" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#使用堆"><i class="fa fa-check"></i><b>5.1.3</b> 使用堆</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#多任务"><i class="fa fa-check"></i><b>5.2</b> 多任务</a></li>
<li class="chapter" data-level="5.3" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#中断管理"><i class="fa fa-check"></i><b>5.3</b> 中断管理</a></li>
<li class="chapter" data-level="5.4" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#功耗管理"><i class="fa fa-check"></i><b>5.4</b> 功耗管理</a></li>
<li class="chapter" data-level="5.5" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#cmsis-api"><i class="fa fa-check"></i><b>5.5</b> CMSIS API</a></li>
<li class="chapter" data-level="5.6" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#debugging-tracing"><i class="fa fa-check"></i><b>5.6</b> 调试与跟踪</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#有关-segger-rtt-的使用提示"><i class="fa fa-check"></i><b>5.6.1</b> 有关 SEGGER RTT 的使用提示</a></li>
<li class="chapter" data-level="5.6.2" data-path="dive-into-sdk.html"><a href="dive-into-sdk.html#内存转储"><i class="fa fa-check"></i><b>5.6.2</b> 内存转储</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="api-ref.html"><a href="api-ref.html"><i class="fa fa-check"></i><b>6</b> Platform API 参考</a>
<ul>
<li class="chapter" data-level="6.1" data-path="api-ref.html"><a href="api-ref.html#platform_32k_rc_auto_tune"><i class="fa fa-check"></i><b>6.1</b> <code>platform_32k_rc_auto_tune</code></a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="api-ref.html"><a href="api-ref.html#原型"><i class="fa fa-check"></i><b>6.1.1</b> 原型</a></li>
<li class="chapter" data-level="6.1.2" data-path="api-ref.html"><a href="api-ref.html#参数表"><i class="fa fa-check"></i><b>6.1.2</b> 参数表</a></li>
<li class="chapter" data-level="6.1.3" data-path="api-ref.html"><a href="api-ref.html#返回值"><i class="fa fa-check"></i><b>6.1.3</b> 返回值</a></li>
<li class="chapter" data-level="6.1.4" data-path="api-ref.html"><a href="api-ref.html#备注"><i class="fa fa-check"></i><b>6.1.4</b> 备注</a></li>
<li class="chapter" data-level="6.1.5" data-path="api-ref.html"><a href="api-ref.html#示例"><i class="fa fa-check"></i><b>6.1.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="api-ref.html"><a href="api-ref.html#platform_32k_rc_tune"><i class="fa fa-check"></i><b>6.2</b> <code>platform_32k_rc_tune</code></a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="api-ref.html"><a href="api-ref.html#原型-1"><i class="fa fa-check"></i><b>6.2.1</b> 原型</a></li>
<li class="chapter" data-level="6.2.2" data-path="api-ref.html"><a href="api-ref.html#参数表-1"><i class="fa fa-check"></i><b>6.2.2</b> 参数表</a></li>
<li class="chapter" data-level="6.2.3" data-path="api-ref.html"><a href="api-ref.html#返回值-1"><i class="fa fa-check"></i><b>6.2.3</b> 返回值</a></li>
<li class="chapter" data-level="6.2.4" data-path="api-ref.html"><a href="api-ref.html#备注-1"><i class="fa fa-check"></i><b>6.2.4</b> 备注</a></li>
<li class="chapter" data-level="6.2.5" data-path="api-ref.html"><a href="api-ref.html#示例-1"><i class="fa fa-check"></i><b>6.2.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="api-ref.html"><a href="api-ref.html#platform_config"><i class="fa fa-check"></i><b>6.3</b> <code>platform_config</code></a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="api-ref.html"><a href="api-ref.html#原型-2"><i class="fa fa-check"></i><b>6.3.1</b> 原型</a></li>
<li class="chapter" data-level="6.3.2" data-path="api-ref.html"><a href="api-ref.html#参数表-2"><i class="fa fa-check"></i><b>6.3.2</b> 参数表</a></li>
<li class="chapter" data-level="6.3.3" data-path="api-ref.html"><a href="api-ref.html#返回值-2"><i class="fa fa-check"></i><b>6.3.3</b> 返回值</a></li>
<li class="chapter" data-level="6.3.4" data-path="api-ref.html"><a href="api-ref.html#备注-2"><i class="fa fa-check"></i><b>6.3.4</b> 备注</a></li>
<li class="chapter" data-level="6.3.5" data-path="api-ref.html"><a href="api-ref.html#示例-2"><i class="fa fa-check"></i><b>6.3.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="api-ref.html"><a href="api-ref.html#platform_get_heap_status"><i class="fa fa-check"></i><b>6.4</b> <code>platform_get_heap_status</code></a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="api-ref.html"><a href="api-ref.html#原型-3"><i class="fa fa-check"></i><b>6.4.1</b> 原型</a></li>
<li class="chapter" data-level="6.4.2" data-path="api-ref.html"><a href="api-ref.html#参数表-3"><i class="fa fa-check"></i><b>6.4.2</b> 参数表</a></li>
<li class="chapter" data-level="6.4.3" data-path="api-ref.html"><a href="api-ref.html#返回值-3"><i class="fa fa-check"></i><b>6.4.3</b> 返回值</a></li>
<li class="chapter" data-level="6.4.4" data-path="api-ref.html"><a href="api-ref.html#备注-3"><i class="fa fa-check"></i><b>6.4.4</b> 备注</a></li>
<li class="chapter" data-level="6.4.5" data-path="api-ref.html"><a href="api-ref.html#示例-3"><i class="fa fa-check"></i><b>6.4.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="api-ref.html"><a href="api-ref.html#platform_get_us_time"><i class="fa fa-check"></i><b>6.5</b> <code>platform_get_us_time</code></a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="api-ref.html"><a href="api-ref.html#原型-4"><i class="fa fa-check"></i><b>6.5.1</b> 原型</a></li>
<li class="chapter" data-level="6.5.2" data-path="api-ref.html"><a href="api-ref.html#参数表-4"><i class="fa fa-check"></i><b>6.5.2</b> 参数表</a></li>
<li class="chapter" data-level="6.5.3" data-path="api-ref.html"><a href="api-ref.html#返回值-4"><i class="fa fa-check"></i><b>6.5.3</b> 返回值</a></li>
<li class="chapter" data-level="6.5.4" data-path="api-ref.html"><a href="api-ref.html#备注-4"><i class="fa fa-check"></i><b>6.5.4</b> 备注</a></li>
<li class="chapter" data-level="6.5.5" data-path="api-ref.html"><a href="api-ref.html#示例-4"><i class="fa fa-check"></i><b>6.5.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="api-ref.html"><a href="api-ref.html#platform_get_version"><i class="fa fa-check"></i><b>6.6</b> <code>platform_get_version</code></a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="api-ref.html"><a href="api-ref.html#原型-5"><i class="fa fa-check"></i><b>6.6.1</b> 原型</a></li>
<li class="chapter" data-level="6.6.2" data-path="api-ref.html"><a href="api-ref.html#参数表-5"><i class="fa fa-check"></i><b>6.6.2</b> 参数表</a></li>
<li class="chapter" data-level="6.6.3" data-path="api-ref.html"><a href="api-ref.html#返回值-5"><i class="fa fa-check"></i><b>6.6.3</b> 返回值</a></li>
<li class="chapter" data-level="6.6.4" data-path="api-ref.html"><a href="api-ref.html#备注-5"><i class="fa fa-check"></i><b>6.6.4</b> 备注</a></li>
<li class="chapter" data-level="6.6.5" data-path="api-ref.html"><a href="api-ref.html#示例-5"><i class="fa fa-check"></i><b>6.6.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="api-ref.html"><a href="api-ref.html#platform_hrng"><i class="fa fa-check"></i><b>6.7</b> <code>platform_hrng</code></a>
<ul>
<li class="chapter" data-level="6.7.1" data-path="api-ref.html"><a href="api-ref.html#原型-6"><i class="fa fa-check"></i><b>6.7.1</b> 原型</a></li>
<li class="chapter" data-level="6.7.2" data-path="api-ref.html"><a href="api-ref.html#参数表-6"><i class="fa fa-check"></i><b>6.7.2</b> 参数表</a></li>
<li class="chapter" data-level="6.7.3" data-path="api-ref.html"><a href="api-ref.html#返回值-6"><i class="fa fa-check"></i><b>6.7.3</b> 返回值</a></li>
<li class="chapter" data-level="6.7.4" data-path="api-ref.html"><a href="api-ref.html#备注-6"><i class="fa fa-check"></i><b>6.7.4</b> 备注</a></li>
<li class="chapter" data-level="6.7.5" data-path="api-ref.html"><a href="api-ref.html#示例-6"><i class="fa fa-check"></i><b>6.7.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="api-ref.html"><a href="api-ref.html#platform_install_isr_stack"><i class="fa fa-check"></i><b>6.8</b> <code>platform_install_isr_stack</code></a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="api-ref.html"><a href="api-ref.html#原型-7"><i class="fa fa-check"></i><b>6.8.1</b> 原型</a></li>
<li class="chapter" data-level="6.8.2" data-path="api-ref.html"><a href="api-ref.html#参数表-7"><i class="fa fa-check"></i><b>6.8.2</b> 参数表</a></li>
<li class="chapter" data-level="6.8.3" data-path="api-ref.html"><a href="api-ref.html#返回值-7"><i class="fa fa-check"></i><b>6.8.3</b> 返回值</a></li>
<li class="chapter" data-level="6.8.4" data-path="api-ref.html"><a href="api-ref.html#备注-7"><i class="fa fa-check"></i><b>6.8.4</b> 备注</a></li>
<li class="chapter" data-level="6.8.5" data-path="api-ref.html"><a href="api-ref.html#示例-7"><i class="fa fa-check"></i><b>6.8.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="api-ref.html"><a href="api-ref.html#platform_printf"><i class="fa fa-check"></i><b>6.9</b> <code>platform_printf</code></a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="api-ref.html"><a href="api-ref.html#原型-8"><i class="fa fa-check"></i><b>6.9.1</b> 原型</a></li>
<li class="chapter" data-level="6.9.2" data-path="api-ref.html"><a href="api-ref.html#参数表-8"><i class="fa fa-check"></i><b>6.9.2</b> 参数表</a></li>
<li class="chapter" data-level="6.9.3" data-path="api-ref.html"><a href="api-ref.html#返回值-8"><i class="fa fa-check"></i><b>6.9.3</b> 返回值</a></li>
<li class="chapter" data-level="6.9.4" data-path="api-ref.html"><a href="api-ref.html#备注-8"><i class="fa fa-check"></i><b>6.9.4</b> 备注</a></li>
<li class="chapter" data-level="6.9.5" data-path="api-ref.html"><a href="api-ref.html#示例-8"><i class="fa fa-check"></i><b>6.9.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="api-ref.html"><a href="api-ref.html#platform_raise_assertion"><i class="fa fa-check"></i><b>6.10</b> <code>platform_raise_assertion</code></a>
<ul>
<li class="chapter" data-level="6.10.1" data-path="api-ref.html"><a href="api-ref.html#原型-9"><i class="fa fa-check"></i><b>6.10.1</b> 原型</a></li>
<li class="chapter" data-level="6.10.2" data-path="api-ref.html"><a href="api-ref.html#参数表-9"><i class="fa fa-check"></i><b>6.10.2</b> 参数表</a></li>
<li class="chapter" data-level="6.10.3" data-path="api-ref.html"><a href="api-ref.html#返回值-9"><i class="fa fa-check"></i><b>6.10.3</b> 返回值</a></li>
<li class="chapter" data-level="6.10.4" data-path="api-ref.html"><a href="api-ref.html#备注-9"><i class="fa fa-check"></i><b>6.10.4</b> 备注</a></li>
<li class="chapter" data-level="6.10.5" data-path="api-ref.html"><a href="api-ref.html#示例-9"><i class="fa fa-check"></i><b>6.10.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.11" data-path="api-ref.html"><a href="api-ref.html#platform_rand"><i class="fa fa-check"></i><b>6.11</b> <code>platform_rand</code></a>
<ul>
<li class="chapter" data-level="6.11.1" data-path="api-ref.html"><a href="api-ref.html#原型-10"><i class="fa fa-check"></i><b>6.11.1</b> 原型</a></li>
<li class="chapter" data-level="6.11.2" data-path="api-ref.html"><a href="api-ref.html#参数表-10"><i class="fa fa-check"></i><b>6.11.2</b> 参数表</a></li>
<li class="chapter" data-level="6.11.3" data-path="api-ref.html"><a href="api-ref.html#返回值-10"><i class="fa fa-check"></i><b>6.11.3</b> 返回值</a></li>
<li class="chapter" data-level="6.11.4" data-path="api-ref.html"><a href="api-ref.html#备注-10"><i class="fa fa-check"></i><b>6.11.4</b> 备注</a></li>
<li class="chapter" data-level="6.11.5" data-path="api-ref.html"><a href="api-ref.html#示例-10"><i class="fa fa-check"></i><b>6.11.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="api-ref.html"><a href="api-ref.html#platform_read_info"><i class="fa fa-check"></i><b>6.12</b> <code>platform_read_info</code></a>
<ul>
<li class="chapter" data-level="6.12.1" data-path="api-ref.html"><a href="api-ref.html#原型-11"><i class="fa fa-check"></i><b>6.12.1</b> 原型</a></li>
<li class="chapter" data-level="6.12.2" data-path="api-ref.html"><a href="api-ref.html#参数表-11"><i class="fa fa-check"></i><b>6.12.2</b> 参数表</a></li>
<li class="chapter" data-level="6.12.3" data-path="api-ref.html"><a href="api-ref.html#返回值-11"><i class="fa fa-check"></i><b>6.12.3</b> 返回值</a></li>
<li class="chapter" data-level="6.12.4" data-path="api-ref.html"><a href="api-ref.html#备注-11"><i class="fa fa-check"></i><b>6.12.4</b> 备注</a></li>
<li class="chapter" data-level="6.12.5" data-path="api-ref.html"><a href="api-ref.html#示例-11"><i class="fa fa-check"></i><b>6.12.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.13" data-path="api-ref.html"><a href="api-ref.html#platform_read_persistent_reg"><i class="fa fa-check"></i><b>6.13</b> <code>platform_read_persistent_reg</code></a>
<ul>
<li class="chapter" data-level="6.13.1" data-path="api-ref.html"><a href="api-ref.html#原型-12"><i class="fa fa-check"></i><b>6.13.1</b> 原型</a></li>
<li class="chapter" data-level="6.13.2" data-path="api-ref.html"><a href="api-ref.html#参数表-12"><i class="fa fa-check"></i><b>6.13.2</b> 参数表</a></li>
<li class="chapter" data-level="6.13.3" data-path="api-ref.html"><a href="api-ref.html#返回值-12"><i class="fa fa-check"></i><b>6.13.3</b> 返回值</a></li>
<li class="chapter" data-level="6.13.4" data-path="api-ref.html"><a href="api-ref.html#备注-12"><i class="fa fa-check"></i><b>6.13.4</b> 备注</a></li>
<li class="chapter" data-level="6.13.5" data-path="api-ref.html"><a href="api-ref.html#示例-12"><i class="fa fa-check"></i><b>6.13.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.14" data-path="api-ref.html"><a href="api-ref.html#platform_reset"><i class="fa fa-check"></i><b>6.14</b> <code>platform_reset</code></a>
<ul>
<li class="chapter" data-level="6.14.1" data-path="api-ref.html"><a href="api-ref.html#原型-13"><i class="fa fa-check"></i><b>6.14.1</b> 原型</a></li>
<li class="chapter" data-level="6.14.2" data-path="api-ref.html"><a href="api-ref.html#参数表-13"><i class="fa fa-check"></i><b>6.14.2</b> 参数表</a></li>
<li class="chapter" data-level="6.14.3" data-path="api-ref.html"><a href="api-ref.html#返回值-13"><i class="fa fa-check"></i><b>6.14.3</b> 返回值</a></li>
<li class="chapter" data-level="6.14.4" data-path="api-ref.html"><a href="api-ref.html#备注-13"><i class="fa fa-check"></i><b>6.14.4</b> 备注</a></li>
<li class="chapter" data-level="6.14.5" data-path="api-ref.html"><a href="api-ref.html#示例-13"><i class="fa fa-check"></i><b>6.14.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.15" data-path="api-ref.html"><a href="api-ref.html#platform_set_evt_callback"><i class="fa fa-check"></i><b>6.15</b> <code>platform_set_evt_callback</code></a>
<ul>
<li class="chapter" data-level="6.15.1" data-path="api-ref.html"><a href="api-ref.html#原型-14"><i class="fa fa-check"></i><b>6.15.1</b> 原型</a></li>
<li class="chapter" data-level="6.15.2" data-path="api-ref.html"><a href="api-ref.html#参数表-14"><i class="fa fa-check"></i><b>6.15.2</b> 参数表</a></li>
<li class="chapter" data-level="6.15.3" data-path="api-ref.html"><a href="api-ref.html#返回值-14"><i class="fa fa-check"></i><b>6.15.3</b> 返回值</a></li>
<li class="chapter" data-level="6.15.4" data-path="api-ref.html"><a href="api-ref.html#备注-14"><i class="fa fa-check"></i><b>6.15.4</b> 备注</a></li>
<li class="chapter" data-level="6.15.5" data-path="api-ref.html"><a href="api-ref.html#示例-14"><i class="fa fa-check"></i><b>6.15.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.16" data-path="api-ref.html"><a href="api-ref.html#platform_set_irq_callback"><i class="fa fa-check"></i><b>6.16</b> <code>platform_set_irq_callback</code></a>
<ul>
<li class="chapter" data-level="6.16.1" data-path="api-ref.html"><a href="api-ref.html#原型-15"><i class="fa fa-check"></i><b>6.16.1</b> 原型</a></li>
<li class="chapter" data-level="6.16.2" data-path="api-ref.html"><a href="api-ref.html#参数表-15"><i class="fa fa-check"></i><b>6.16.2</b> 参数表</a></li>
<li class="chapter" data-level="6.16.3" data-path="api-ref.html"><a href="api-ref.html#返回值-15"><i class="fa fa-check"></i><b>6.16.3</b> 返回值</a></li>
<li class="chapter" data-level="6.16.4" data-path="api-ref.html"><a href="api-ref.html#备注-15"><i class="fa fa-check"></i><b>6.16.4</b> 备注</a></li>
<li class="chapter" data-level="6.16.5" data-path="api-ref.html"><a href="api-ref.html#示例-15"><i class="fa fa-check"></i><b>6.16.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.17" data-path="api-ref.html"><a href="api-ref.html#platform_shutdown"><i class="fa fa-check"></i><b>6.17</b> <code>platform_shutdown</code></a>
<ul>
<li class="chapter" data-level="6.17.1" data-path="api-ref.html"><a href="api-ref.html#原型-16"><i class="fa fa-check"></i><b>6.17.1</b> 原型</a></li>
<li class="chapter" data-level="6.17.2" data-path="api-ref.html"><a href="api-ref.html#参数表-16"><i class="fa fa-check"></i><b>6.17.2</b> 参数表</a></li>
<li class="chapter" data-level="6.17.3" data-path="api-ref.html"><a href="api-ref.html#返回值-16"><i class="fa fa-check"></i><b>6.17.3</b> 返回值</a></li>
<li class="chapter" data-level="6.17.4" data-path="api-ref.html"><a href="api-ref.html#备注-16"><i class="fa fa-check"></i><b>6.17.4</b> 备注</a></li>
<li class="chapter" data-level="6.17.5" data-path="api-ref.html"><a href="api-ref.html#示例-16"><i class="fa fa-check"></i><b>6.17.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.18" data-path="api-ref.html"><a href="api-ref.html#api-switch-app"><i class="fa fa-check"></i><b>6.18</b> <code>platform_switch_app</code></a>
<ul>
<li class="chapter" data-level="6.18.1" data-path="api-ref.html"><a href="api-ref.html#原型-17"><i class="fa fa-check"></i><b>6.18.1</b> 原型</a></li>
<li class="chapter" data-level="6.18.2" data-path="api-ref.html"><a href="api-ref.html#参数表-17"><i class="fa fa-check"></i><b>6.18.2</b> 参数表</a></li>
<li class="chapter" data-level="6.18.3" data-path="api-ref.html"><a href="api-ref.html#返回值-17"><i class="fa fa-check"></i><b>6.18.3</b> 返回值</a></li>
<li class="chapter" data-level="6.18.4" data-path="api-ref.html"><a href="api-ref.html#备注-17"><i class="fa fa-check"></i><b>6.18.4</b> 备注</a></li>
<li class="chapter" data-level="6.18.5" data-path="api-ref.html"><a href="api-ref.html#示例-17"><i class="fa fa-check"></i><b>6.18.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.19" data-path="api-ref.html"><a href="api-ref.html#platform_write_persistent_reg"><i class="fa fa-check"></i><b>6.19</b> <code>platform_write_persistent_reg</code></a>
<ul>
<li class="chapter" data-level="6.19.1" data-path="api-ref.html"><a href="api-ref.html#原型-18"><i class="fa fa-check"></i><b>6.19.1</b> 原型</a></li>
<li class="chapter" data-level="6.19.2" data-path="api-ref.html"><a href="api-ref.html#参数表-18"><i class="fa fa-check"></i><b>6.19.2</b> 参数表</a></li>
<li class="chapter" data-level="6.19.3" data-path="api-ref.html"><a href="api-ref.html#返回值-18"><i class="fa fa-check"></i><b>6.19.3</b> 返回值</a></li>
<li class="chapter" data-level="6.19.4" data-path="api-ref.html"><a href="api-ref.html#备注-18"><i class="fa fa-check"></i><b>6.19.4</b> 备注</a></li>
<li class="chapter" data-level="6.19.5" data-path="api-ref.html"><a href="api-ref.html#示例-18"><i class="fa fa-check"></i><b>6.19.5</b> 示例</a></li>
</ul></li>
<li class="chapter" data-level="6.20" data-path="api-ref.html"><a href="api-ref.html#syssetpublicdeviceaddr"><i class="fa fa-check"></i><b>6.20</b> <code>sysSetPublicDeviceAddr</code></a>
<ul>
<li class="chapter" data-level="6.20.1" data-path="api-ref.html"><a href="api-ref.html#原型-19"><i class="fa fa-check"></i><b>6.20.1</b> 原型</a></li>
<li class="chapter" data-level="6.20.2" data-path="api-ref.html"><a href="api-ref.html#参数表-19"><i class="fa fa-check"></i><b>6.20.2</b> 参数表</a></li>
<li class="chapter" data-level="6.20.3" data-path="api-ref.html"><a href="api-ref.html#返回值-19"><i class="fa fa-check"></i><b>6.20.3</b> 返回值</a></li>
<li class="chapter" data-level="6.20.4" data-path="api-ref.html"><a href="api-ref.html#备注-19"><i class="fa fa-check"></i><b>6.20.4</b> 备注</a></li>
<li class="chapter" data-level="6.20.5" data-path="api-ref.html"><a href="api-ref.html#示例-19"><i class="fa fa-check"></i><b>6.20.5</b> 示例</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="revision-history.html"><a href="revision-history.html"><i class="fa fa-check"></i><b>7</b> 版本历史</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">INGCHIPS SDK 开发者用户手册</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tutorial" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> 教程<a href="tutorial.html#tutorial" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>下面的教程将一步一步地讲解 SDK 里的基本概念，核心工具的使用方法。</p>
<div id="ch1-hello-world" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> 世界你好<a href="tutorial.html#ch1-hello-world" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在本教程里，我们将创建一个设备，发送的广播里带着它的名字：“Hello,
世界”。</p>
<p>从开始菜单里打开 <code>ingWizard</code>，选择菜单 <code>Project</code> -&gt; <code>New Project ...</code>。
这个菜单项会打开项目向导。向导的第一页是 <code>Development Tool</code> （见图
<a href="tutorial.html#fig:ch1-welcome">3.1</a>）。</p>
<div id="development-tool-页面" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> <code>Development Tool</code> 页面<a href="tutorial.html#development-tool-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-welcome"></span>
<img src="img/welcome.png" alt="选择项目类型" width="70%" />
<p class="caption">
Figure 3.1: 选择项目类型
</p>
</div>
<p>在这个页面 （图 <a href="tutorial.html#fig:ch1-welcome">3.1</a>）：</p>
<ol style="list-style-type: decimal">
<li>选择 IDE/工具链</li>
<li>设置项目名称</li>
<li>选择项目的存储位置</li>
</ol>
<p><code>ingWizard</code> 提供以下便利功能：</p>
<ul>
<li><p>如果需要用 <code>Git</code> 做软件版本管理，选择 <code>Setup .gitignore</code>；</p></li>
<li><p>如果准备使用 <code>Visual Studio Code</code> 作为代码编辑器，选择
<code>Setup Visual Studio Code</code>。</p></li>
</ul>
<p>然后点击 <code>Next</code> 按钮进入下一页，<code>Choose Chip Series</code>。</p>
</div>
<div id="choose-chip-series-页面" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> <code>Choose Chip Series</code> 页面<a href="tutorial.html#choose-chip-series-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-wiz-series"></span>
<img src="img/ch1-wiz-series.png" alt="Choose Chip Series" width="70%" />
<p class="caption">
Figure 3.2: Choose Chip Series
</p>
</div>
<p>在这个页面（图
<a href="tutorial.html#fig:ch1-wiz-series">3.2</a>）选择项目的目标芯片型号，然后点击 <code>Next</code>
进入下一页，<code>Choose Project Type</code>。</p>
</div>
<div id="choose-project-type-页面" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> <code>Choose Project Type</code> 页面<a href="tutorial.html#choose-project-type-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:proj-type"></span>
<img src="img/proj_type.png" alt="Choose Project Type" width="70%" />
<p class="caption">
Figure 3.3: Choose Project Type
</p>
</div>
<p>在这个页面（图 <a href="tutorial.html#fig:proj-type">3.3</a>），选择 <code>Typical</code>。</p>
<p>然后点击 <code>Next</code> 进入下一页，<code>Role of Your Device</code>。</p>
</div>
<div id="role-of-your-device-页面" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> <code>Role of Your Device</code> 页面<a href="tutorial.html#role-of-your-device-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-role"></span>
<img src="img/role.png" alt="Role of Your Device" width="70%" />
<p class="caption">
Figure 3.4: Role of Your Device
</p>
</div>
<p>在这个页面 （图 <a href="tutorial.html#fig:ch1-role">3.4</a>），选择 Peripheral，然后点击 <code>Next</code>
进入下一页，<code>Peripheral Setup</code>。</p>
</div>
<div id="peripheral-setup-页面" class="section level3 hasAnchor" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> <code>Peripheral Setup</code> 页面<a href="tutorial.html#peripheral-setup-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-peripheral"></span>
<img src="img/peripheral.png" alt="Peripheral Setup" width="70%" />
<p class="caption">
Figure 3.5: Peripheral Setup
</p>
</div>
<p>在这个页面（图 <a href="tutorial.html#fig:ch1-peripheral">3.5</a>），选择 <code>Legacy</code> 广播方式。</p>
<div class="rmdcaution">
<p>
支持 BLE 5.x 扩展广播的手机目前依然凤毛麟角，即使声称了“支持” BLE
5.0。为了更好的兼容性，这里我们选择 使用 <code>Legacy</code>
广播。此外，待项目创建之后，通过修改一个比特就能将 <code>Legacy</code>
广播切换成 BLE 5.x 扩展广播。
</p>
</div>
<p>点击 <code>Setup Advertising Data</code> 按钮， 打开广播数据编辑器（图
<a href="tutorial.html#fig:ch1-hello-adv">3.6</a>）。 在编辑器里，输入 <code>name</code> 可以快速定位到 GAP
广播项 <code>09 - «Complete Local Name»</code>，点击 <code>Add</code>
将这个项添加到设备的广播数据里。</p>
<p>点击刚刚添加的 <code>09 - «Complete Local Name»</code> 数据项，
然后将在下面的数据编辑框里输入 “Hello, 世界” 并按回车。 <code>Data Preview</code>
会更新，整个广播都将已原始字节流的形式显示其中。显而易见，工具对中文字符使用了
<code>UTF-8</code> 编码。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-adv"></span>
<img src="img/hello_adv.png" alt="Edit Advertising Data" width="80%" />
<p class="caption">
Figure 3.6: Edit Advertising Data
</p>
</div>
<p>现在点击 <code>OK</code> 回到项目向导，然后点击 <code>Next</code>
进入下一页，<code>Security &amp; Privacy</code>。</p>
</div>
<div id="security-privacy-页面" class="section level3 hasAnchor" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> <code>Security &amp; Privacy</code> 页面<a href="tutorial.html#security-privacy-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-wiz-security"></span>
<img src="img/ch1-wiz-security.png" alt="Firmare Over-The-Air" width="70%" />
<p class="caption">
Figure 3.7: Firmare Over-The-Air
</p>
</div>
<p>保持默认值（图 <a href="tutorial.html#fig:ch1-wiz-security">3.7</a>），然后点击 <code>Next</code>
进入下一页，<code>Firmare Over-The-Air</code>。</p>
</div>
<div id="firmare-over-the-air-页面" class="section level3 hasAnchor" number="3.1.7">
<h3><span class="header-section-number">3.1.7</span> <code>Firmare Over-The-Air</code> 页面<a href="tutorial.html#firmare-over-the-air-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-fota"></span>
<img src="img/fota.png" alt="Firmare Over-The-Air" width="70%" />
<p class="caption">
Figure 3.8: Firmare Over-The-Air
</p>
</div>
<p>保持默认值（图 <a href="tutorial.html#fig:ch1-hello-fota">3.8</a>），然后点击 <code>Next</code>
进入下一页，<code>Common Functions</code>.</p>
</div>
<div id="common-functions-页面" class="section level3 hasAnchor" number="3.1.8">
<h3><span class="header-section-number">3.1.8</span> <code>Common Functions</code> 页面<a href="tutorial.html#common-functions-页面" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-common"></span>
<img src="img/common.png" alt="Common Functions" width="70%" />
<p class="caption">
Figure 3.9: Common Functions
</p>
</div>
<p>在这一页（图 <a href="tutorial.html#fig:ch1-hello-common">3.9</a>），我们依然保持默认值不变，点击
<code>Create</code>。 现在项目创建好了（图
<a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>），可以随时编译、下载。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-proj-ready"></span>
<img src="img/proj_ready.png" alt="&quot;Hello, 世界&quot; is Ready" width="70%" />
<p class="caption">
Figure 3.10: “Hello, 世界” is Ready
</p>
</div>
</div>
<div id="编译您的项目" class="section level3 hasAnchor" number="3.1.9">
<h3><span class="header-section-number">3.1.9</span> 编译您的项目<a href="tutorial.html#编译您的项目" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>回到 <code>ingWizard</code> 的主窗口（图
<a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>），点击打开您的项目。在 IDE
里编译您的项目。</p>
</div>
<div id="下载" class="section level3 hasAnchor" number="3.1.10">
<h3><span class="header-section-number">3.1.10</span> 下载<a href="tutorial.html#下载" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>回到 <code>ingWizard</code> （图
<a href="tutorial.html#fig:ch1-hello-proj-ready">3.10</a>），右键点击您的项目，从弹出的快捷菜单中选择
<code>Download to Flash</code> 就可以打开下载工具（图
<a href="tutorial.html#fig:ch1-hello-downloader">3.11</a>）。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-downloader"></span>
<img src="img/downloader.png" alt="Download to Flash" width="70%" />
<p class="caption">
Figure 3.11: Download to Flash
</p>
</div>
<p>除了串口号，下载工具的所有设置都已就绪。设置串口口，然后点击 <code>Start</code>。</p>
<p>下载完成之后，用 LightBlue、<code>INGdemo</code> （图
<a href="tutorial.html#fig:ch1-hello-ingota">3.12</a>）或者其它 app 检查是否可以找到一个名为
“Hello,
世界”的设备。注意，这个设备目前可能无法在系统设置的蓝牙菜单里看到。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-hello-ingota"></span>
<img src="img/hello_ingota_2.png" alt="Hello, 世界" width="40%" />
<p class="caption">
Figure 3.12: Hello, 世界
</p>
</div>
</div>
</div>
<div id="ibeacon" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> iBeacon<a href="tutorial.html#ibeacon" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在本教程中，让我们创建一个iBeacon。iBeacon是由Apple<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a>
开发的协议，并在2013年的苹果全球开发者大会上发布。Beacons是一类低功耗蓝牙(BLE)设备，可以将其标识符广播到附近的便携式电子设备。这项技术使智能手机、平板电脑和其他设备在接近iBeacon设备时能够执行相应的操作。
首先，从app
Store下载一个iBeacon扫描应用程序。在本教程中，我们将使用一个名为
<code>Locate</code> 的应用程序。 <code>Locate</code>
有一个预配置的近距离UUID列表，其中包括一个全0 Null
UUID。我们将使用这个Null UUID<a href="#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a>。</p>
<div id="建立广播数据" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> 建立广播数据<a href="tutorial.html#建立广播数据" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>iBeacon广播包中有两个项目。</p>
<ol style="list-style-type: decimal">
<li><p>Flags</p>
<p>值固定为0x06，即设置了两位，LE General Discoverable Mode &amp; BR/EDR Not Supported。</p></li>
<li><p>Manufacturer Specific Data</p>
<p>本项目内容如表 <a href="tutorial.html#tab:ch1-ibeacon">3.1</a>所示</p></li>
</ol>
<table>
<caption><span id="tab:ch1-ibeacon">Table 3.1: </span> iBeacon厂商特定数据</caption>
<colgroup>
<col width="18%" />
<col width="18%" />
<col width="18%" />
<col width="45%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Size in Bytes</th>
<th align="left">Name</th>
<th align="left">Value</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2</td>
<td align="left">Company ID</td>
<td align="left">0x004C</td>
<td align="left">Company ID of Apple, Inc</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Beacon Type</td>
<td align="left">0x1502</td>
<td align="left">Value defined by Apple</td>
</tr>
<tr class="odd">
<td align="right">16</td>
<td align="left">Proximity UUID</td>
<td align="left"></td>
<td align="left">User defined value</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Major</td>
<td align="left"></td>
<td align="left">Group ID</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">Minor</td>
<td align="left"></td>
<td align="left">ID within a group</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">Measured Power</td>
<td align="left">in dBm</td>
<td align="left">Measured by an iPhone 5s at a 1 meter distance</td>
</tr>
</tbody>
</table>
<p>为了制作一个iBeacon设备，我们可以遵循[Hello
World]示例中的相同步骤，我们只有在个别情况下需要根据规范配置广播包。</p>
<p>在广播数据编辑器中，添加 <code>0x01 - «Flags»</code> 和
<code>0xFF - «Manufacturer Specific Data»</code> .单击 <code>0x01 - «Flags»</code> ，检查
<code>LE General Discoverable Mode</code> 和 <code>BR/EDR Not Supported</code>
。单击<code>0xFF - «Manufacturer Specific Data»</code> ，然后点击 <code>Edit as</code>
按钮，会有一个菜单弹出并选择 <code>iBeacon ...</code> (图<a href="tutorial.html#fig:ch1-edit-beacon-adv">3.13</a>) 来打开iBeacon厂商特定数据编辑器 (图
<a href="tutorial.html#fig:ch1-edit-beacon-content">3.14</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-edit-beacon-adv"></span>
<img src="img/beacon_adv2.png" alt="编辑iBeacon广播数据" width="70%" />
<p class="caption">
Figure 3.13: 编辑iBeacon广播数据
</p>
</div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-edit-beacon-content"></span>
<img src="img/beacon_adv3.png" alt="编辑iBeacon厂商特定数据" width="50%" />
<p class="caption">
Figure 3.14: 编辑iBeacon厂商特定数据
</p>
</div>
<p>信号功率可以设置为任何合理值(如-50dBm)，稍后我们将在 <code>Locate</code>
应用程序的帮助下对其进行校准。</p>
</div>
<div id="尝试应用" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> 尝试应用<a href="tutorial.html#尝试应用" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>让我们在 <code>Choose Project Type</code> 页面上选择GNU Arm Embedded
Toolchain作为我们的开发环境，向导会让一切准备就绪 (图 <a href="tutorial.html#fig:ch1-ibeacon-proj">3.15</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-ibeacon-proj"></span>
<img src="img/ch1-ibeacon-proj.png" alt="GNU Arm工具链iBeacon已就绪" width="40%" />
<p class="caption">
Figure 3.15: GNU Arm工具链iBeacon已就绪
</p>
</div>
<p>单击项目以打开控制台，输入 <code>make</code><a href="#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a>来构建它。回到 <code>ingWizard</code>
，按照相同的步骤将其下载。现在，我们可以在 <code>Locate</code>
中找到新创建的iBeacon设备。 (图 <a href="tutorial.html#fig:ch1-locate-page1-small">3.16</a>)</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-locate-page1-small"></span>
<img src="img/locate_page1_small.jpg" alt=" iBeacon本地locate APP界面" width="40%" />
<p class="caption">
Figure 3.16:  iBeacon本地locate APP界面
</p>
</div>
<p>点击我们的设备，我们就可以实时校准信号功率或检查距离，如图
<a href="tutorial.html#fig:ch1-locate-page2-small">3.17</a>所示。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-locate-page2-small"></span>
<img src="img/locate_page2_small.jpg" alt="iBeacon 在locate APP中的详细信息" width="40%" />
<p class="caption">
Figure 3.17: iBeacon 在locate APP中的详细信息
</p>
</div>
<p>一旦信号功率校准，我们可以在 <code>ingWizard</code> 中右键单击我们的项目，并选择
<code>Edit Data</code> -&gt; <code>Advertising</code>
菜单项，以用我们所熟悉的编辑器来编辑其广播数据。更新广播数据后，重新构建项目，检查距离是否更准确。</p>
<div class="rmdcaution">
<p>
根据规范，接近beacons必须使用一
个不可连接的无定向广播PDU，使用固定的100ms广播间隔。在本教程中，我们不会去修改代码，所以广播参数也不会被修改。为了使这些参数完全符合规范，请参考相应的主机GAP
APIs。
</p>
</div>
</div>
</div>
<div id="温度计" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> 温度计<a href="tutorial.html#温度计" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在本教程中，我们将制作一个 <em>重要</em>
的BLE设备，一个温度计。蓝牙SIG已经定义了一个称为健康温度计的GATT服务<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a>。这个SDK包含一个名为
<code>INGdemo</code> 的参考APP，它可以安装到 <code>Android</code> 或 <code>iOS</code> 设备上。使用
<code>INGdemo</code> ，我们可以查看蓝牙设备的广播数据，如果设备中有健康体温计功能，
<code>INGdemo</code> 可以连接设备并读取温度。</p>
<p>在本教程中，您将了解如何:</p>
<ul>
<li>广播所支持的服务</li>
<li>配置GATT配置文件</li>
<li>响应GATT特性的读请求</li>
</ul>
<div id="建立广播数据-1" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> 建立广播数据<a href="tutorial.html#建立广播数据-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>同样，我们遵循与[Hello World]示例中相同的步骤，并在 <code>Peripheral Setup</code>
页面上声明温度计服务并创建GATT配置文件。在广播数据中添加以下三项:</p>
<ol style="list-style-type: decimal">
<li><p><code>Flags</code></p>
<p>值固定为0x06，即设置了两位，LE General Discoverable Mode &amp; BR/EDR Not Supported。</p></li>
<li><p><code>Complete List of 16-bit Service Class UUIDs</code></p>
<p>添加一个如图<a href="tutorial.html#fig:ch1-thermo-adv">3.18</a>.所示的
<code>0x1809 - Health Thermometer</code> 服务。</p></li>
<li><p><code>Complete Local Name</code></p>
<p>让我们将设备命名为”AccurateOne”。</p></li>
</ol>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-thermo-adv"></span>
<img src="img/ch1-thermo-adv.png" alt="温度计广播数据" width="70%" />
<p class="caption">
Figure 3.18: 温度计广播数据
</p>
</div>
</div>
<div id="建立gatt配置文件" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> 建立GATT配置文件<a href="tutorial.html#建立gatt配置文件" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>返回 <code>Peripheral Setup</code> 页面，单击 <code>Setup ATT database ...</code>
打开GATT配置编辑器。添加两个服务，General Access (0x1800) 和Health
Thermometer (0x1809)。 删除General Access
service的所有非必选特性。对于Health Thermometer
service保留两个特性，即温度测量和温度类型，删除其他两个。</p>
<p>接下来，编辑每个特性的值:</p>
<ol style="list-style-type: decimal">
<li><p>Device Name of General Access:</p>
<p>右键单击特征，选择 <code>Edit String Value ...</code>
菜单，并设置值为”AccurateOne”。</p></li>
<li><p>Appearance of General Access:</p>
<p>右键单击特性，选择 <code>Help</code> ，编辑器将在Bluetooth
SIG网站上打开相应的文档。找到普通温度计的值(0x0300)，然后单击 <code>Edit</code>
按钮，并在数据字段中输入 <code>0x00, 0x03</code> 。</p></li>
<li><p>Temperature Measurement of Health Thermometer</p>
<p>请查看蓝牙SIG网站文档。点击 <code>Edit</code>
按钮并在data字段中输入5个0(<code>0, 0, 0, 0, 0</code>)。这里的第一个字节包含标志，表明之后的度量单位是一个以摄氏度为单位的
<code>FLOAT</code> 值。检查 <code>read</code> 和 <code>dynamic</code> 属性(图 <a href="tutorial.html#fig:ch1-thermo-edit-ch">3.19</a>)。</p>
<p><code>FLOAT</code> 类型为IEEE-11073
32位浮点。最基本的是，它有一个24位的尾数和一个8位的指数(最重要的字节)，以
<em>10</em> 为基数。</p></li>
<li><p>Temperature Type of Health Thermometer</p>
<p>请查看Bluetooth SIG网站文档。通过单击 <code>Edit</code>
按钮将其设置为任何有效值。</p></li>
</ol>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-thermo-edit-ch"></span>
<img src="img/ch1-thermo-edit-ch.png" alt="编辑温度测量" width="70%" />
<p class="caption">
Figure 3.19: 编辑温度测量
</p>
</div>
</div>
<div id="代码编写" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> 代码编写<a href="tutorial.html#代码编写" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>项目创建完成后，在IDE中打开 <code>profile.c</code> ，由 <code>ingWizard</code>
自动生成温度测量特征处理函数 <code>att_read_callback</code> 。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="tutorial.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint16_t</span> att_read_callback<span class="op">(</span>hci_con_handle_t connection_handle<span class="op">,</span></span>
<span id="cb4-2"><a href="tutorial.html#cb4-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">uint16_t</span> att_handle<span class="op">,</span> <span class="dt">uint16_t</span> offset<span class="op">,</span></span>
<span id="cb4-3"><a href="tutorial.html#cb4-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">uint8_t</span> <span class="op">*</span> buffer<span class="op">,</span> <span class="dt">uint16_t</span> buffer_size<span class="op">)</span></span>
<span id="cb4-4"><a href="tutorial.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-5"><a href="tutorial.html#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>att_handle<span class="op">)</span></span>
<span id="cb4-6"><a href="tutorial.html#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-7"><a href="tutorial.html#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT<span class="op">:</span></span>
<span id="cb4-8"><a href="tutorial.html#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>buffer<span class="op">)</span></span>
<span id="cb4-9"><a href="tutorial.html#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb4-10"><a href="tutorial.html#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">// add your code</span></span>
<span id="cb4-11"><a href="tutorial.html#cb4-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> buffer_size<span class="op">;</span></span>
<span id="cb4-12"><a href="tutorial.html#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-13"><a href="tutorial.html#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb4-14"><a href="tutorial.html#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// </span><span class="al">TODO</span><span class="co">: return required buffer size</span></span>
<span id="cb4-15"><a href="tutorial.html#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="tutorial.html#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb4-17"><a href="tutorial.html#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="tutorial.html#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-19"><a href="tutorial.html#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-20"><a href="tutorial.html#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当APP读取一个具有 <code>dynamic</code> 特点的特性， <code>att_read_callback</code>
会被调用两次或更多:一次用于查询所需的缓冲区大小，
一次用于读取数据。如果数据很大， <code>att_read_callback</code>
可能会被调用更多次，每次读取由 <code>offset</code> 指定的部分数据。</p>
<p>如上所述，定义一种温度测量类型:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="tutorial.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> __packed <span class="kw">struct</span> gatt_temperature_meas</span>
<span id="cb5-2"><a href="tutorial.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="tutorial.html#cb5-3" aria-hidden="true" tabindex="-1"></a>     uint8 flags<span class="op">;</span></span>
<span id="cb5-4"><a href="tutorial.html#cb5-4" aria-hidden="true" tabindex="-1"></a>    sint32 mantissa<span class="op">:</span><span class="dv">24</span><span class="op">;</span></span>
<span id="cb5-5"><a href="tutorial.html#cb5-5" aria-hidden="true" tabindex="-1"></a>    sint32 exponent<span class="op">:</span><span class="dv">8</span><span class="op">;</span></span>
<span id="cb5-6"><a href="tutorial.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> gatt_temperature_meas_t<span class="op">;</span></span>
<span id="cb5-7"><a href="tutorial.html#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="tutorial.html#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> gatt_temperature_meas_t temperature_meas <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span></code></pre></div>
<p>现在，我们可以完善上面的 <code>case HANDLE_TEMPERATURE_MEASUREMENT</code> 语句:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="tutorial.html#cb6-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT<span class="op">:</span></span>
<span id="cb6-2"><a href="tutorial.html#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>buffer<span class="op">)</span></span>
<span id="cb6-3"><a href="tutorial.html#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb6-4"><a href="tutorial.html#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="co">// simulate an &quot;accurate&quot; thermometer</span></span>
<span id="cb6-5"><a href="tutorial.html#cb6-5" aria-hidden="true" tabindex="-1"></a>            temperature_meas<span class="op">.</span>mantissa <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb6-6"><a href="tutorial.html#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// output data</span></span>
<span id="cb6-7"><a href="tutorial.html#cb6-7" aria-hidden="true" tabindex="-1"></a>            memcpy<span class="op">(</span>buffer<span class="op">,</span> <span class="op">((</span>uint8 <span class="op">*)&amp;</span>temperature_meas<span class="op">)</span> <span class="op">+</span> offset<span class="op">,</span> buffer_size<span class="op">);</span></span>
<span id="cb6-8"><a href="tutorial.html#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> buffer_size<span class="op">;</span></span>
<span id="cb6-9"><a href="tutorial.html#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-10"><a href="tutorial.html#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb6-11"><a href="tutorial.html#cb6-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">sizeof</span><span class="op">(</span>gatt_temperature_meas_t<span class="op">);</span></span></code></pre></div>
<p>构建并下载项目，然后在 <code>INGdemo</code>
app中连接到”AccurateOne”设备。检查每次按下 <code>Refresh</code>
按钮时温度是否随机变化 (图 <a href="tutorial.html#fig:ch1-ingtemp">3.20</a>).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-ingtemp"></span>
<img src="img/ch1-ingtemp-1.png" alt="刷新温度测量" width="60%" />
<p class="caption">
Figure 3.20: 刷新温度测量
</p>
</div>
<div class="rmdnote">
<p>
温度计(服务器)可以使用通知或指示过程来通知(不需要确认)或指示(需要确认)一个特征值，参见[带通知的温度计]。在本例中，“AccurateOne”不使用这两个过程，而是被动地发送其测量结果。
</p>
</div>
</div>
<div id="通知" class="section level3 hasAnchor" number="3.3.4">
<h3><span class="header-section-number">3.3.4</span> 通知<a href="tutorial.html#通知" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
</div>
<div id="fota温度计" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> FOTA温度计<a href="tutorial.html#fota温度计" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在本教程中，我们将在我们的温度计中添加无线固件升级（FOTA）功能。此SDK提供了一个可开箱即用的FOTA设计参考。要使FOTA工作，至少需要涉及三个部分，一个设备、一个APP和一个HTTP服务器。
<code>INGdemo</code> 应用已经有了，所以在本教程中，我们将重点关注设备和HTTP服务器。</p>
<div id="fota设备" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> FOTA设备<a href="tutorial.html#fota设备" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>按照与前面温度计示例相同的步骤创建一个新项目，命名为”ota”。</p>
<p>当编辑广播数据时，我们可以通过单击在编辑器中的 <code>Open File…</code>
按钮，来导入在前面例子中创建的数据。广播数据存储在
<code>$(ProjectPath)/data/advertising.adv</code> .让我们将设备命名为”clickty
Click”。</p>
<p>当编辑GATT协议数据库时，我们可以通过单击在编辑器中的打开文件
<code>Open File…</code> 按钮来导入在前面例子中创建的数据。GATT协议的数据存储在
<code>$(ProjectPath)/data/gatt.profile</code> .中。在 <code>Add Service</code>
按钮的下拉菜单中选择 <code>INGChips Service</code> ，添加”INGChips FOTA
Service”，接下来，编辑该服务的特征值:</p>
<ol style="list-style-type: decimal">
<li><p>FOTA Version:</p>
<p>FOTA Version确定了我们项目的完整版本号。如flash
downloader所示，整个项目由两个二进制文件组成，一个来自SDK
软件包，称为平台二进制文件；另一个来自我们的项目，称为APP二进制文件。FOTA版本包含两个子版本，它们分别对应一个二进制文件。每个子版本包含三个字段:</p>
<ul>
<li><p>Major: A 16-bit field.</p></li>
<li><p>Minor: A 8-bit field.</p></li>
<li><p>Patch: Another 8-bit field.</p></li>
</ul>
<p>每个软件包都有自己的版本(同平台二进制文件版本)，使用相同的编号方案，可以在
<code>SDK</code> 页面的 <code>Environment Options</code> 对话框中找到(使用菜单项 <code>Tools</code>
-&gt; <code>Environment Options</code>
打开此对话框)。假设平台版本为1.0.1，我们想要的APP版本为1.0.0，那么我们将该特征值设为(图 <a href="tutorial.html#fig:ch1-ota-version">3.21</a>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="tutorial.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bn">0x0001</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>  <span class="co">// platform version</span></span>
<span id="cb7-2"><a href="tutorial.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bn">0x0001</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// app version</span></span></code></pre></div></li>
<li><p>FOTA Control</p>
<p>这是升级期间的控制点。将其值设置为 <code>0</code> (即 <code>OTA_STATUS_DISABLED</code>
)，这是FOTA的初始状态。</p></li>
</ol>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-ota-version"></span>
<img src="img/ch1-ota-version.png" alt="FOTA版本设置" width="60%" />
<p class="caption">
Figure 3.21: FOTA版本设置
</p>
</div>
<p>单击 <code>OK</code> 关闭 <code>GATT</code> 协议编辑器。(注意:不要点击 <code>Save</code>
，除非你想改变已经在编辑器中打开的 <code>$(ProjectPath)/data/gatt.profile</code>
。)</p>
<p>回到项目向导，按下 <code>Next</code> 继续下一页的 <code>Firmare Over-The-Air</code>
。在这页上，我们勾选 <code>FOTA</code>
。注意，与FOTA相关的特征句柄是通过检查GATT协议自动生成的。然后在项目向导上完成其余步骤。</p>
<p>打开我们新的项目”ota”，从上一个例子复制代码来使我们的温度计在 <code>INGdemo</code>
APP中可以响应 <code>Refresh</code> 。</p>
<p>接下来，让我们制作一个新版本。</p>
</div>
<div id="创建一个新版本" class="section level3 hasAnchor" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> 创建一个新版本<a href="tutorial.html#创建一个新版本" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>我们”ota”的新版本命名为”Barba Trick”，APP版本号将升级到 <code>2.0.0</code>
。这些数据分别保存在广播数据和协议数据中，右键单击项目并使用编辑器更新它。数据升级以后，使用
<code>Save As ...</code>
将数据保存在相同路径下的另一个文件中。例如，更新广播数据并将其保存到
<code>$(ProjectPath)/data/advertising_2.adv</code> 。并更新GATT配置文件到
<code>$(ProjectPath)/data/gatt_2.profile</code> 。</p>
<p>用一个宏 <code>V2</code> 来控制实际用到的广播数据和协议数据：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="tutorial.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">static</span> <span class="dt">uint8_t</span> adv_data<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="tutorial.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef V2</span></span>
<span id="cb8-3"><a href="tutorial.html#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;../data/advertising.adv&quot;</span></span>
<span id="cb8-4"><a href="tutorial.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb8-5"><a href="tutorial.html#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;../data/advertising_2.adv&quot;</span></span>
<span id="cb8-6"><a href="tutorial.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-7"><a href="tutorial.html#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-8"><a href="tutorial.html#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="tutorial.html#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="op">......</span></span>
<span id="cb8-10"><a href="tutorial.html#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="tutorial.html#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">static</span> <span class="dt">uint8_t</span> profile_data<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-12"><a href="tutorial.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef V2</span></span>
<span id="cb8-13"><a href="tutorial.html#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;../data/gatt.profile&quot;</span></span>
<span id="cb8-14"><a href="tutorial.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb8-15"><a href="tutorial.html#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&quot;../data/gatt_2.profile&quot;</span></span>
<span id="cb8-16"><a href="tutorial.html#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-17"><a href="tutorial.html#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>用定义的 <code>V2</code> 宏重新编译项目，将 <code>ota.bin</code> 和 <code>platform.bin</code> (在
<code>SDK_DIR/sdk/bundles/typical</code> 中)复制到一个空路径下，<code>如ota_app_v2</code> 。</p>
<p>在 <code>ota_app_v2</code> 创建一个名为 <code>manifest.json</code> 的文件，包含以下数据:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="tutorial.html#cb9-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-2"><a href="tutorial.html#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;platform&quot;</span><span class="op">:</span> {</span>
<span id="cb9-3"><a href="tutorial.html#cb9-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;version&quot;</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb9-4"><a href="tutorial.html#cb9-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;platform.bin&quot;</span><span class="op">,</span></span>
<span id="cb9-5"><a href="tutorial.html#cb9-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;address&quot;</span><span class="op">:</span> <span class="dv">16384</span></span>
<span id="cb9-6"><a href="tutorial.html#cb9-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb9-7"><a href="tutorial.html#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;app&quot;</span><span class="op">:</span> {</span>
<span id="cb9-8"><a href="tutorial.html#cb9-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;version&quot;</span><span class="op">:</span> [<span class="dv">2</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb9-9"><a href="tutorial.html#cb9-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;ota.bin&quot;</span><span class="op">,</span></span>
<span id="cb9-10"><a href="tutorial.html#cb9-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;address&quot;</span><span class="op">:</span> <span class="dv">163840</span></span>
<span id="cb9-11"><a href="tutorial.html#cb9-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb9-12"><a href="tutorial.html#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;entry&quot;</span><span class="op">:</span> <span class="dv">16384</span><span class="op">,</span></span>
<span id="cb9-13"><a href="tutorial.html#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bins&quot;</span><span class="op">:</span>[]</span>
<span id="cb9-14"><a href="tutorial.html#cb9-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>这些地址可以在 <code>Environment Options</code> . <code>entry</code> 中找到。地址值固定为
<code>0x4000</code> ，即 <code>16384</code> 。注意 <code>json</code> 不识别常规的 <code>0xabcd</code> 十六进制文字。
<code>INGdemo</code> 可以下载其他 <code>bin</code>
指定的二进制文件到设备。在本例中，我们没有这样的二进制文件，所以这个字段作为空数组保留。</p>
<p>然后为这个更新创建一个 <code>readme</code> 文件，其中包含一些关于本次更新的信息。</p>
<p>现在FOTA包已经准备好了。为整个 <code>ota_app_v2</code> 路径制作一个
<code>ota_app_v2.zip</code> 的ZIP压缩包。注意，不应该将 <code>ota_app_v2</code> 设置为
<code>ota_app_v2.zip</code> 中的子目录。表 <a href="tutorial.html#tab:ch1-ota-package">3.2</a>
给出了压缩文件中的文件清单。</p>
<table>
<caption><span id="tab:ch1-ota-package">Table 3.2: </span> FOTA包文件清单</caption>
<thead>
<tr class="header">
<th align="left">File Name</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">readme</td>
<td align="left">Some information about this update</td>
</tr>
<tr class="even">
<td align="left">manifest.json</td>
<td align="left">Meta information</td>
</tr>
<tr class="odd">
<td align="left">platform.bin</td>
<td align="left">Platform binary</td>
</tr>
<tr class="even">
<td align="left">ota.bin</td>
<td align="left">App binary</td>
</tr>
</tbody>
</table>
<p>回到IDE，在没有定义宏 <code>V2</code>
的情况下重新构建项目，然后下载该项目到开发板。</p>
</div>
<div id="fota服务器" class="section level3 hasAnchor" number="3.4.3">
<h3><span class="header-section-number">3.4.3</span> FOTA服务器<a href="tutorial.html#fota服务器" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>INGdemo</code> APP需要一个FOTA服务器URL，定义在
<code>class Thermometer.FOTA_SERVERr</code> 。将 <code>ota_app_v2.zip</code>
移动到HTTP服务器的文档目录，并创建一个 <code>latest.json</code>
文件，它包含最新版本的信息。内容是:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="tutorial.html#cb10-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-2"><a href="tutorial.html#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;app&quot;</span><span class="op">:</span> [<span class="dv">2</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb10-3"><a href="tutorial.html#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;platform&quot;</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb10-4"><a href="tutorial.html#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;package&quot;</span><span class="op">:</span> <span class="st">&quot;ota_app_v2.zip&quot;</span></span>
<span id="cb10-5"><a href="tutorial.html#cb10-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>确保这两个文件可以通过 <code>(FOTA_SERVER + latest.json)</code> 和
<code>(FOTA_SERVER + ota_app_v2.zip)</code> 访问.</p>
</div>
<div id="尝试应用-1" class="section level3 hasAnchor" number="3.4.4">
<h3><span class="header-section-number">3.4.4</span> 尝试应用<a href="tutorial.html#尝试应用-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>在 <code>INGdemo</code> 中连接”Clickety Click”，点击 <code>Update</code> (图
<a href="tutorial.html#fig:ch1-fota-update">3.22</a>). 由于 <code>platform.bin</code>
是最新的，所以只需要升级 <code>app.bin</code>
就可以了，整个升级过程在很短的时间内完成。回到主页，再次扫描并检查我们的新版本是否起作用，有了一个名为”Barba
Trick”的设备。连接到”Barba Trick”，可以看到现在固件是最新的。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-fota-update"></span>
<img src="img/ch1-fota-update.png" alt="&quot;Clickety Click&quot;升级可用" width="40%" />
<p class="caption">
Figure 3.22: “Clickety Click”升级可用
</p>
</div>
<div class="rmdnote">
<p>
本教程给出了一个实现FOTA的例子。用户可以自由设计新的FOTA解决方案，从版本定义到FOTA服务和特性。也可以为FOTA开发一个专用的第二APP。
</p>
<p>
<em>安全性</em> 是必须要考虑的。
</p>
</div>
</div>
</div>
<div id="ibeacon扫描设备" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> iBeacon扫描设备<a href="tutorial.html#ibeacon扫描设备" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>我们已经知道如何配置iBeacon设备。在本教程中，我们将创建一个iBeacon扫描器。</p>
<p>扫描器在蓝牙微距网络中起着核心作用。和之前一样，我们在 <code>ingWizard</code>
中创建一个名为”iscanner”的新项目 (图 <a href="tutorial.html#fig:ch1-proj-iscanner">3.23</a>). 在
<code>Role of Your Device</code>
页面，选择<em>Central</em>。中心设备会一直扫描其他设备然后这些设备执行其相应的动作，我们的新项目向导自动添加代码开始扫描。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-proj-iscanner"></span>
<img src="img/ch1-proj-iscanner.png" alt="创建IAR Embedded Workbench的“iscanner”" width="40%" />
<p class="caption">
Figure 3.23: 创建IAR Embedded Workbench的“iscanner”
</p>
</div>
<p>在IDE中打开这个新项目，并找到函数 <code>user_packet_handler</code>
。我们可以看到有一个名为 <code>HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT</code>
的事件:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="tutorial.html#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT<span class="op">:</span></span>
<span id="cb11-2"><a href="tutorial.html#cb11-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb11-3"><a href="tutorial.html#cb11-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">const</span> le_ext_adv_report_t <span class="op">*</span>report <span class="op">=</span> decode_hci_le_meta_event<span class="op">(</span>packet<span class="op">,</span></span>
<span id="cb11-4"><a href="tutorial.html#cb11-4" aria-hidden="true" tabindex="-1"></a>                      le_meta_event_ext_adv_report_t<span class="op">)-&gt;</span>reports<span class="op">;</span></span>
<span id="cb11-5"><a href="tutorial.html#cb11-5" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ...</span></span>
<span id="cb11-6"><a href="tutorial.html#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-7"><a href="tutorial.html#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<p>每次接收到这个事件时，我们可以检查广播报告是否包含
<code>0xFF - «Manufacturer Specific Data»</code>，以及它是否是一个iBeacon包。有了制作iBeacon设备的知识，就可以直接用
<code>C</code> 语言定义一个iBeacon数据包的类型。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="tutorial.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> __packed <span class="kw">struct</span> ibeacon_adv</span>
<span id="cb12-2"><a href="tutorial.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="tutorial.html#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> apple_id<span class="op">;</span></span>
<span id="cb12-4"><a href="tutorial.html#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> id<span class="op">;</span></span>
<span id="cb12-5"><a href="tutorial.html#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>  uuid<span class="op">[</span><span class="dv">16</span><span class="op">];</span></span>
<span id="cb12-6"><a href="tutorial.html#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> major<span class="op">;</span></span>
<span id="cb12-7"><a href="tutorial.html#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span> minor<span class="op">;</span></span>
<span id="cb12-8"><a href="tutorial.html#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int8_t</span>   ref_power<span class="op">;</span></span>
<span id="cb12-9"><a href="tutorial.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ibeacon_adv_t<span class="op">;</span></span>
<span id="cb12-10"><a href="tutorial.html#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="tutorial.html#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#define APPLE_COMPANY_ID        0x004C</span></span>
<span id="cb12-12"><a href="tutorial.html#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define IBEACON_ID              0x1502</span></span></code></pre></div>
<p><code>__packed</code>
是一个扩展关键字，用于指定数据类型使用第一种数据对齐方式。幸运的是，
<em>ARM</em> 和 <em>IAR</em> 编译器都支持它。或者可以使用 <code>#pragma pack</code> 指令:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="tutorial.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma pack (push, 1)</span></span>
<span id="cb13-2"><a href="tutorial.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> ibeacon_adv</span>
<span id="cb13-3"><a href="tutorial.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-4"><a href="tutorial.html#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb13-5"><a href="tutorial.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> ibeacon_adv_t<span class="op">;</span></span>
<span id="cb13-6"><a href="tutorial.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma pack (pop)</span></span></code></pre></div>
<p>在继续之前，让我们创建一个将UUID转换为字符串的辅助函数。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="tutorial.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>format_uuid<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buffer<span class="op">,</span> <span class="dt">uint8_t</span> <span class="op">*</span>uuid<span class="op">)</span></span>
<span id="cb14-2"><a href="tutorial.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-3"><a href="tutorial.html#cb14-3" aria-hidden="true" tabindex="-1"></a>    sprintf<span class="op">(</span>buffer<span class="op">,</span> <span class="st">&quot;{%02X%02X%02X%02X-%02X%02X-%02X%02X-&quot;</span></span>
<span id="cb14-4"><a href="tutorial.html#cb14-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;%02X%02X-%02X%02X%02X%02X%02X%02X}&quot;</span><span class="op">,</span></span>
<span id="cb14-5"><a href="tutorial.html#cb14-5" aria-hidden="true" tabindex="-1"></a>           uuid<span class="op">[</span><span class="dv">0</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">1</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">2</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">3</span><span class="op">],</span></span>
<span id="cb14-6"><a href="tutorial.html#cb14-6" aria-hidden="true" tabindex="-1"></a>           uuid<span class="op">[</span><span class="dv">4</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">5</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">6</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">7</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">8</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">9</span><span class="op">],</span></span>
<span id="cb14-7"><a href="tutorial.html#cb14-7" aria-hidden="true" tabindex="-1"></a>           uuid<span class="op">[</span><span class="dv">10</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">11</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">12</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">13</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">14</span><span class="op">],</span> uuid<span class="op">[</span><span class="dv">15</span><span class="op">]);</span></span>
<span id="cb14-8"><a href="tutorial.html#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> buffer<span class="op">;</span></span>
<span id="cb14-9"><a href="tutorial.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div id="估算距离" class="section level3 hasAnchor" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> 估算距离<a href="tutorial.html#估算距离" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>接收到的信号强度指示(RSSI)与广播数据一起播报。一般来说，点源辐射出的电磁波强度与信号源距离的平方成反比。著名的自由空间损失方程为:</p>
<p><span class="math display">\[ Loss = 32.45 + 20log(d) + 20log(f) \]</span></p>
<p>其中 <span class="math inline">\(d\)</span> 的单位是km, <span class="math inline">\(f\)</span> 的单位是MHz, <span class="math inline">\(Loss\)</span>
的单位是dB。通过比较RSSI和1米距离下的测量功率(<code>ref_power</code>)，我们可以利用自由空间损失方程大致估计出扫描仪和信标之间的距离:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="tutorial.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> estimate_distance<span class="op">(</span><span class="dt">int8_t</span> ref_power<span class="op">,</span> <span class="dt">int8_t</span> rssi<span class="op">)</span></span>
<span id="cb15-2"><a href="tutorial.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="tutorial.html#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pow<span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="op">(</span>ref_power <span class="op">-</span> rssi<span class="op">)</span> <span class="op">/</span> <span class="fl">20.0</span><span class="op">);</span></span>
<span id="cb15-4"><a href="tutorial.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>现在，我们用不到20行代码就可以实现一个功能完整的iBeancon扫描器:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="tutorial.html#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> length<span class="op">;</span></span>
<span id="cb16-2"><a href="tutorial.html#cb16-2" aria-hidden="true" tabindex="-1"></a>    ibeacon_adv_t <span class="op">*</span>p_ibeacon<span class="op">;</span></span>
<span id="cb16-3"><a href="tutorial.html#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> str_buffer<span class="op">[</span><span class="dv">80</span><span class="op">];</span></span>
<span id="cb16-4"><a href="tutorial.html#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> le_ext_adv_report_t <span class="op">*</span>report<span class="op">;</span></span>
<span id="cb16-5"><a href="tutorial.html#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">......</span></span>
<span id="cb16-6"><a href="tutorial.html#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HCI_SUBEVENT_LE_EXTENDED_ADVERTISING_REPORT<span class="op">:</span></span>
<span id="cb16-7"><a href="tutorial.html#cb16-7" aria-hidden="true" tabindex="-1"></a>        report <span class="op">=</span> decode_hci_le_meta_event<span class="op">(</span>packet<span class="op">,</span></span>
<span id="cb16-8"><a href="tutorial.html#cb16-8" aria-hidden="true" tabindex="-1"></a>                        le_meta_event_ext_adv_report_t<span class="op">)-&gt;</span>reports<span class="op">;</span></span>
<span id="cb16-9"><a href="tutorial.html#cb16-9" aria-hidden="true" tabindex="-1"></a>        p_ibeacon <span class="op">=</span> <span class="op">(</span>ibeacon_adv_t <span class="op">*)</span>ad_data_from_type<span class="op">(</span>report<span class="op">-&gt;</span>data_len<span class="op">,</span></span>
<span id="cb16-10"><a href="tutorial.html#cb16-10" aria-hidden="true" tabindex="-1"></a>                        <span class="op">(</span><span class="dt">uint8_t</span> <span class="op">*)</span>report<span class="op">-&gt;</span>data<span class="op">,</span> <span class="bn">0xff</span><span class="op">,</span> <span class="op">&amp;</span>length<span class="op">);</span></span>
<span id="cb16-11"><a href="tutorial.html#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="tutorial.html#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>length <span class="op">!=</span> <span class="kw">sizeof</span><span class="op">(</span>ibeacon_adv_t<span class="op">))</span></span>
<span id="cb16-13"><a href="tutorial.html#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> <span class="op">(</span>p_ibeacon<span class="op">-&gt;</span>apple_id <span class="op">!=</span> APPLE_COMPANY_ID<span class="op">)</span></span>
<span id="cb16-14"><a href="tutorial.html#cb16-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">||</span> <span class="op">(</span>p_ibeacon<span class="op">-&gt;</span>id <span class="op">!=</span> IBEACON_ID<span class="op">))</span></span>
<span id="cb16-15"><a href="tutorial.html#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-16"><a href="tutorial.html#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="tutorial.html#cb16-17" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;%s %04X,%04X, %.1fm</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb16-18"><a href="tutorial.html#cb16-18" aria-hidden="true" tabindex="-1"></a>                format_uuid<span class="op">(</span>str_buffer<span class="op">,</span> p_ibeacon<span class="op">-&gt;</span>uuid<span class="op">),</span></span>
<span id="cb16-19"><a href="tutorial.html#cb16-19" aria-hidden="true" tabindex="-1"></a>                p_ibeacon<span class="op">-&gt;</span>major<span class="op">,</span> p_ibeacon<span class="op">-&gt;</span>minor<span class="op">,</span></span>
<span id="cb16-20"><a href="tutorial.html#cb16-20" aria-hidden="true" tabindex="-1"></a>                estimate_distance<span class="op">(</span>p_ibeacon<span class="op">-&gt;</span>ref_power<span class="op">,</span> report<span class="op">-&gt;</span>rssi<span class="op">));</span></span>
<span id="cb16-21"><a href="tutorial.html#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
<p>使用 <code>Locate</code> 应用程序发送iBeacon信号，并查看我们的设备是否能找到它
(图 <a href="tutorial.html#fig:ch1-iscanner">3.24</a>).
最后，由于RSSI值是波动的，可以在RSSI上增加一个低通滤波器使估算值更加稳定。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-iscanner"></span>
<img src="img/ch1-iscanner.png" alt="iBeacon扫描结果" width="50%" />
<p class="caption">
Figure 3.24: iBeacon扫描结果
</p>
</div>
<div class="rmdnote">
<p>
需要注意该APP的二进制文件的大小会急剧增加。这主要是因为Cortex-M3没有硬件浮点单元，浮点操作都是由库函数执行的。使用浮点运算前请
<em>仔细考虑一下</em> 。
</p>
</div>
</div>
<div id="并发广播扫描" class="section level3 hasAnchor" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> 并发广播&amp;扫描<a href="tutorial.html#并发广播扫描" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>作为一个练习，我们可以合并这个iBeacon项目，并检查我们的设备是否可以在发送iBeacon信号的同时继续扫描其他iBeacon设备。</p>
<div class="rmdnote">
<p>
蓝牙无线电采用TDD (Time Division
Duplex)拓扑结构，该结构要求同一时刻的数据发送在一个方向上进行，数据接收在另一个方向上进行，设备不能
接收到自己的iBeacon信号。
</p>
</div>
</div>
</div>
<div id="通知指示" class="section level2 hasAnchor" number="3.6">
<h2><span class="header-section-number">3.6</span> 通知&amp;指示<a href="tutorial.html#通知指示" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>服务器可以使用通知或指示过程来通知(不需要确认)或指示(需要确认)一个特征值。现在，让我们将通知和指示功能添加到我们在之前教程中创建的温度计中。</p>
<p>我们分别使用 <code>att_server_notify</code> 和 <code>att_server_indicate</code> 来通知或指示一个特征值。这些 <code>API</code> 必须在蓝牙协议栈 (<code>Host</code>) 任务中调用。</p>
<p>主动产生的通知和指示可以由定时器或中断触发，例如蓝牙任务栈之外的源。SDK 提供了基于 RTOS 消息的任务间通信机制以便调用这些蓝牙协议栈 API。</p>
<div id="inter-task-comm" class="section level3 hasAnchor" number="3.6.1">
<h3><span class="header-section-number">3.6.1</span> 任务间通信<a href="tutorial.html#inter-task-comm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>可使用 <code>btstack_push_user_msg</code> 发送消息到蓝牙协议栈:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="tutorial.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span>  btstack_push_user_msg<span class="op">(</span><span class="dt">uint32_t</span> msg_id<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">const</span> <span class="dt">uint16_t</span> len<span class="op">);</span></span></code></pre></div>
<p>这个消息将被传递到你的 <code>user_packet_handler</code> 下的事件ID
<code>BTSTACK_EVENT_USER_MSG</code> :</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="tutorial.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> user_packet_handler<span class="op">(</span><span class="dt">uint8_t</span> packet_type<span class="op">,</span> <span class="dt">uint16_t</span> channel<span class="op">,</span></span>
<span id="cb18-2"><a href="tutorial.html#cb18-2" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">uint8_t</span> <span class="op">*</span>packet<span class="op">,</span> <span class="dt">uint16_t</span> size<span class="op">)</span></span>
<span id="cb18-3"><a href="tutorial.html#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-4"><a href="tutorial.html#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span> event <span class="op">=</span> hci_event_packet_get_type<span class="op">(</span>packet<span class="op">);</span></span>
<span id="cb18-5"><a href="tutorial.html#cb18-5" aria-hidden="true" tabindex="-1"></a>    btstack_user_msg_t <span class="op">*</span>p_user_msg<span class="op">;</span></span>
<span id="cb18-6"><a href="tutorial.html#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>packet_type <span class="op">!=</span> HCI_EVENT_PACKET<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb18-7"><a href="tutorial.html#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="tutorial.html#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>event<span class="op">)</span></span>
<span id="cb18-9"><a href="tutorial.html#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb18-10"><a href="tutorial.html#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ......</span></span>
<span id="cb18-11"><a href="tutorial.html#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> BTSTACK_EVENT_USER_MSG<span class="op">:</span></span>
<span id="cb18-12"><a href="tutorial.html#cb18-12" aria-hidden="true" tabindex="-1"></a>        p_user_msg <span class="op">=</span> hci_event_packet_get_user_msg<span class="op">(</span>packet<span class="op">);</span></span>
<span id="cb18-13"><a href="tutorial.html#cb18-13" aria-hidden="true" tabindex="-1"></a>        user_msg_handler<span class="op">(</span>p_user_msg<span class="op">-&gt;</span>msg_id<span class="op">,</span> p_user_msg<span class="op">-&gt;</span>data<span class="op">,</span></span>
<span id="cb18-14"><a href="tutorial.html#cb18-14" aria-hidden="true" tabindex="-1"></a>                         p_user_msg<span class="op">-&gt;</span>len<span class="op">);</span></span>
<span id="cb18-15"><a href="tutorial.html#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb18-16"><a href="tutorial.html#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ......</span></span>
<span id="cb18-17"><a href="tutorial.html#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-18"><a href="tutorial.html#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在这里，我们将用户消息的处理传递给另一个叫 <code>user_msg_handler</code>
的函数。注意 <code>user_msg_handler</code>
是在蓝牙协议栈任务的上下文中运行的，现在我们可以调用那些蓝牙栈APIs了。</p>
<p>事件 <code>BTSTACK_EVENT_USER_MSG</code> 被广播到所有 <code>HCI</code> 事件回调函数。</p>
</div>
<div id="定时器" class="section level3 hasAnchor" number="3.6.2">
<h3><span class="header-section-number">3.6.2</span> 定时器<a href="tutorial.html#定时器" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>现在让我们让温度计”AccurateOne”每秒钟更新一次它的值。首先，在初始化时创建一个定时器，例如在
<code>app_main</code> 或 <code>setup_profile</code> 中。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="tutorial.html#cb19-1" aria-hidden="true" tabindex="-1"></a>TimerHandle_t app_timer <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-2"><a href="tutorial.html#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="tutorial.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">uint32_t</span> setup_profile<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>user_data<span class="op">)</span></span>
<span id="cb19-4"><a href="tutorial.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-5"><a href="tutorial.html#cb19-5" aria-hidden="true" tabindex="-1"></a>    app_timer <span class="op">=</span> xTimerCreate<span class="op">(</span><span class="st">&quot;app&quot;</span><span class="op">,</span></span>
<span id="cb19-6"><a href="tutorial.html#cb19-6" aria-hidden="true" tabindex="-1"></a>                                pdMS_TO_TICKS<span class="op">(</span><span class="dv">1000</span><span class="op">),</span></span>
<span id="cb19-7"><a href="tutorial.html#cb19-7" aria-hidden="true" tabindex="-1"></a>                                pdTRUE<span class="op">,</span></span>
<span id="cb19-8"><a href="tutorial.html#cb19-8" aria-hidden="true" tabindex="-1"></a>                                NULL<span class="op">,</span></span>
<span id="cb19-9"><a href="tutorial.html#cb19-9" aria-hidden="true" tabindex="-1"></a>                                app_timer_callback<span class="op">);</span></span>
<span id="cb19-10"><a href="tutorial.html#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb19-11"><a href="tutorial.html#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>定时器回调函数可以被定义为：</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="tutorial.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define USER_MSG_ID_REQUEST_SEND            1</span></span>
<span id="cb20-2"><a href="tutorial.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> app_timer_callback<span class="op">(</span>TimerHandle_t xTimer<span class="op">)</span></span>
<span id="cb20-3"><a href="tutorial.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-4"><a href="tutorial.html#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>temperture_notify_enable <span class="op">|</span> temperture_indicate_enable<span class="op">)</span></span>
<span id="cb20-5"><a href="tutorial.html#cb20-5" aria-hidden="true" tabindex="-1"></a>        btstack_push_user_msg<span class="op">(</span>USER_MSG_ID_REQUEST_SEND<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb20-6"><a href="tutorial.html#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当我们在 <code>HCI_EVENT_LE_META</code> 中得到
<code>HCI_SUBEVENT_LE_ENHANCED_CONNECTION_COMPLETE</code>
时，定时器开始计时，并在我们得到 <code>HCI_EVENT_DISCONNECTION_COMPLETE</code>
时定时器停止。</p>
<p>这里的 <code>temperture_notify_enable</code> 和 <code>temperture_indicate_enable</code>
是两个初始化为 <code>0s</code> 的标志，并在 <code>att_write_callback</code> 中设置为 <code>1</code> :</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="tutorial.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> att_write_callback<span class="op">(</span>hci_con_handle_t connection_handle<span class="op">,</span></span>
<span id="cb21-2"><a href="tutorial.html#cb21-2" aria-hidden="true" tabindex="-1"></a>                              <span class="dt">uint16_t</span> att_handle<span class="op">,</span> <span class="dt">uint16_t</span> transaction_mode<span class="op">,</span></span>
<span id="cb21-3"><a href="tutorial.html#cb21-3" aria-hidden="true" tabindex="-1"></a>                              <span class="dt">uint16_t</span> offset<span class="op">,</span> <span class="dt">uint8_t</span> <span class="op">*</span>buffer<span class="op">,</span> <span class="dt">uint16_t</span> buffer_size<span class="op">)</span></span>
<span id="cb21-4"><a href="tutorial.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-5"><a href="tutorial.html#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>att_handle<span class="op">)</span></span>
<span id="cb21-6"><a href="tutorial.html#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-7"><a href="tutorial.html#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> HANDLE_TEMPERATURE_MEASUREMENT <span class="op">+</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb21-8"><a href="tutorial.html#cb21-8" aria-hidden="true" tabindex="-1"></a>        handle_send <span class="op">=</span> connection_handle<span class="op">;</span></span>
<span id="cb21-9"><a href="tutorial.html#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(*(</span><span class="dt">uint16_t</span> <span class="op">*)</span>buffer<span class="op">)</span></span>
<span id="cb21-10"><a href="tutorial.html#cb21-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb21-11"><a href="tutorial.html#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> GATT_CLIENT_CHARACTERISTICS_CONFIGURATION_INDICATION<span class="op">:</span></span>
<span id="cb21-12"><a href="tutorial.html#cb21-12" aria-hidden="true" tabindex="-1"></a>            temperture_indicate_enable <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb21-13"><a href="tutorial.html#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-14"><a href="tutorial.html#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> GATT_CLIENT_CHARACTERISTICS_CONFIGURATION_NOTIFICATION<span class="op">:</span></span>
<span id="cb21-15"><a href="tutorial.html#cb21-15" aria-hidden="true" tabindex="-1"></a>            temperture_notify_enable <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb21-16"><a href="tutorial.html#cb21-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb21-17"><a href="tutorial.html#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-18"><a href="tutorial.html#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-19"><a href="tutorial.html#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb21-20"><a href="tutorial.html#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-21"><a href="tutorial.html#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在这里，我们将 <code>connection_handle</code> 存储到一个全局变量 <code>handle_send</code>
，并在之后会使用该变量。最后一段代码是在 <code>user_msg_handler</code> 中处理消息
<code>USER_MSG_ID_REQUEST_SEND</code> :</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="tutorial.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> user_msg_handler<span class="op">(</span><span class="dt">uint32_t</span> msg_id<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">,</span> <span class="dt">uint16_t</span> size<span class="op">)</span></span>
<span id="cb22-2"><a href="tutorial.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-3"><a href="tutorial.html#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>msg_id<span class="op">)</span></span>
<span id="cb22-4"><a href="tutorial.html#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb22-5"><a href="tutorial.html#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> USER_MSG_ID_REQUEST_SEND<span class="op">:</span></span>
<span id="cb22-6"><a href="tutorial.html#cb22-6" aria-hidden="true" tabindex="-1"></a>        att_server_request_can_send_now_event<span class="op">(</span>handle_send<span class="op">);</span></span>
<span id="cb22-7"><a href="tutorial.html#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb22-8"><a href="tutorial.html#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-9"><a href="tutorial.html#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>并在 <code>ATT_EVENT_CAN_SEND_NOW</code>中报告温度值：</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="tutorial.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb23-2"><a href="tutorial.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> ATT_EVENT_CAN_SEND_NOW<span class="op">:</span></span>
<span id="cb23-3"><a href="tutorial.html#cb23-3" aria-hidden="true" tabindex="-1"></a>    temperature_meas<span class="op">.</span>mantissa <span class="op">=</span> rand<span class="op">()</span> <span class="op">%</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb23-4"><a href="tutorial.html#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>temperture_notify_enable<span class="op">)</span></span>
<span id="cb23-5"><a href="tutorial.html#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb23-6"><a href="tutorial.html#cb23-6" aria-hidden="true" tabindex="-1"></a>        att_server_notify<span class="op">(</span>handle_send<span class="op">,</span></span>
<span id="cb23-7"><a href="tutorial.html#cb23-7" aria-hidden="true" tabindex="-1"></a>                          HANDLE_TEMPERATURE_MEASUREMENT<span class="op">,</span></span>
<span id="cb23-8"><a href="tutorial.html#cb23-8" aria-hidden="true" tabindex="-1"></a>                          <span class="op">(</span><span class="dt">uint8_t</span><span class="op">*)&amp;</span>temperature_meas<span class="op">,</span></span>
<span id="cb23-9"><a href="tutorial.html#cb23-9" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">sizeof</span><span class="op">(</span>temperature_meas<span class="op">));</span></span>
<span id="cb23-10"><a href="tutorial.html#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-11"><a href="tutorial.html#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="tutorial.html#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>temperture_indicate_enable<span class="op">)</span></span>
<span id="cb23-13"><a href="tutorial.html#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb23-14"><a href="tutorial.html#cb23-14" aria-hidden="true" tabindex="-1"></a>        att_server_indicate<span class="op">(</span>handle_send<span class="op">,</span></span>
<span id="cb23-15"><a href="tutorial.html#cb23-15" aria-hidden="true" tabindex="-1"></a>                          HANDLE_TEMPERATURE_MEASUREMENT<span class="op">,</span></span>
<span id="cb23-16"><a href="tutorial.html#cb23-16" aria-hidden="true" tabindex="-1"></a>                          <span class="op">(</span><span class="dt">uint8_t</span><span class="op">*)&amp;</span>temperature_meas<span class="op">,</span></span>
<span id="cb23-17"><a href="tutorial.html#cb23-17" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">sizeof</span><span class="op">(</span>temperature_meas<span class="op">));</span></span>
<span id="cb23-18"><a href="tutorial.html#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-19"><a href="tutorial.html#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb23-20"><a href="tutorial.html#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>尝试重新构建并下载项目，并检查 <code>INGdemo</code>
中显示的温度值是否每秒变化一次。</p>
<div class="rmdnote">
<p>
有一个完整功能的温度计示例，即<code>thermoota</code>，它支持FOTA，通知和指示。
</p>
</div>
</div>
</div>
<div id="吞吐量" class="section level2 hasAnchor" number="3.7">
<h2><span class="header-section-number">3.7</span> 吞吐量<a href="tutorial.html#吞吐量" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>BLE 5.0介绍了一种新的采样率为2M的非编码PHY。</p>
<div id="理论峰值吞吐量" class="section level3 hasAnchor" number="3.7.1">
<h3><span class="header-section-number">3.7.1</span> 理论峰值吞吐量<a href="tutorial.html#理论峰值吞吐量" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>数据物理通道PDU的最大有效载荷长度为251字节。采用2M PHY，传输时间为1048
μs。一个空的数据物理通道PDU的传输时间为44 μs。</p>
<p>为了实现一个方向上的最大吞吐量，该方向上所有pdu的长度应该为251字节，而另一个方向上所有pdu的长度应该为空。所以，251个字节总的传输时间为：</p>
<p><span class="math display">\[ 1048 + 44 + 150 * 2 = 1392 (\mu s) \]</span></p>
<p>因此，链路层提供的理论峰值吞吐量为：</p>
<p><span class="math display">\[ 251 * 8 / 1392 * 1000000 \approx 1442.528 (kbps) \]</span></p>
<p>对于一个运行在GATT之上的应用程序，I2CAP和ATT都有它们自己的开销。通常，GATT的最大有效负载为(251 -
7 =)244字节。因此，GATT可以提供的理论上的峰值吞吐量为：</p>
<p><span class="math display">\[ 244 * 8 / 1392 * 1000000 \approx 1402.298 (kbps) \]</span></p>
</div>
<div id="测试吞吐量" class="section level3 hasAnchor" number="3.7.2">
<h3><span class="header-section-number">3.7.2</span> 测试吞吐量<a href="tutorial.html#测试吞吐量" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>在SDK中有一对用于吞吐量测试的示例 （图 <a href="tutorial.html#fig:ch1-tpt">3.25</a>）.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-tpt"></span>
<img src="img/ch1-tpt.png" alt="吞吐量测试示例" width="60%" />
<p class="caption">
Figure 3.25: 吞吐量测试示例
</p>
</div>
<div id="对-ingdemo-进行测试" class="section level4 hasAnchor" number="3.7.2.1">
<h4><span class="header-section-number">3.7.2.1</span> 对 <code>INGdemo</code> 进行测试<a href="tutorial.html#对-ingdemo-进行测试" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>下载 <code>peripheral_throughput</code>. 使用 <code>INGdemo</code> 连接到 <code>ING Tpt</code> ,
打开吞吐量测试页面。在这个页面上，我们可以测试从主到从、从到主或同时在两个方向上的吞吐量。</p>
<p>图中 （图 <a href="tutorial.html#fig:ch1-tpt-app">3.26</a>）显示，使用支持2M
PHY的普通Android手机，我们可以实现1M+ bps的空中传输吞吐量。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-tpt-app"></span>
<img src="img/ch1-tpt_app.png" alt="Android手机上的吞吐量" width="30%" />
<p class="caption">
Figure 3.26: Android手机上的吞吐量
</p>
</div>
</div>
<div id="对我们的app进行测试" class="section level4 hasAnchor" number="3.7.2.2">
<h4><span class="header-section-number">3.7.2.2</span> 对我们的APP进行测试<a href="tutorial.html#对我们的app进行测试" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>示例 <code>central_throughput</code> 演示了BLE中心设备的一般工作过程:</p>
<ol style="list-style-type: decimal">
<li>扫描并连接到在其广播中声明了吞吐量服务的设备;</li>
<li>发现吞吐量服务;</li>
<li>发现服务的特性;</li>
<li>发现特性描述。</li>
</ol>
<p><code>INGChips Throughput Service</code> 有两个特点。</p>
<ul>
<li><p>通用输出</p>
<p>通过这一特性，外围设备向中心设备发送数据。</p>
<p>这个特性有一个 <code>Client Characteristic Configuration</code> 描述符。</p></li>
<li><p>通用输入</p>
<p>通过这个特性，中心设备向外围设备发送数据。</p></li>
</ul>
<p>下载 <code>central_throughput</code>
到另一块板。这个应用程序有一个UART命令行接口给到主机。连接到主机，输入”?“以查看所支持的命令。这个APP自动连接到
<code>peripheral_throughput</code> 。输入命令 <code>start s-&gt;m</code> 或 <code>start m-&gt;s</code>
开始测试从外设到中心设备的吞吐量，或从中心设备到外设的。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-cmd"></span>
<img src="img/ch1-cmd.png" alt="指令接口" width="40%" />
<p class="caption">
Figure 3.27: 指令接口
</p>
</div>
<p>图中（图 <a href="tutorial.html#fig:ch1-board-tpt">3.28</a>）显示，使用两块板，我们在空中实现了1.2M+
bps的稳定数据传输。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-board-tpt"></span>
<img src="img/ch1-board_tpt.png" alt="板间吞吐量" width="70%" />
<p class="caption">
Figure 3.28: 板间吞吐量
</p>
</div>
<div class="rmdnote">
<p>
这个吞吐量是在空中测试的，比理论峰值略低，但真实性更高。
</p>
</div>
</div>
</div>
</div>
<div id="双角色-ble网关" class="section level2 hasAnchor" number="3.8">
<h2><span class="header-section-number">3.8</span> 双角色 &amp; BLE网关<a href="tutorial.html#双角色-ble网关" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在本教程中，我们将创建一个BLE网关，它从几个外设收集数据并将数据报告给一个中心设备。在收集数据时，这个网关是一个中心设备，而报告数据时，它是一个外设，也就是说，我们的APP能够扮演双角色。</p>
<p>具体而言，我们的网关只支持从温度计收集数据。我们称之为 <code>smart_meter</code> 。</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-smart-meter"></span>
<img src="img/ch1-smart-meter.png" alt="Smart Meter架构" width="60%" />
<p class="caption">
Figure 3.29: Smart Meter架构
</p>
</div>
<p><code>smart_meter</code>
使用一个通用型基于字符串的输出服务将数据报告到中心设备，比如运行在智能手机上的
<code>INGdemo</code> 。它还拥有可以连接到主机的UART控制接口。</p>
<div class="rmdnote">
<p>
检查示例 <code>peripheral_console</code>
以了解如何进行字符串输入和输出。
</p>
<p>
我们同样提供了完整功能的 <code>smart_meter</code>
app作为示例。在创建您自己的示例时，请参考此示例。
</p>
</div>
<p>现在，让我们创建这个BLE网关。</p>
<div id="用-ingwizard-创建一个外设app" class="section level3 hasAnchor" number="3.8.1">
<h3><span class="header-section-number">3.8.1</span> 用 <code>ingWizard</code> 创建一个外设APP<a href="tutorial.html#用-ingwizard-创建一个外设app" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>使用GUI编辑器编辑广播数据，命名我们的应用程序为”ING Smart Meter”。</p>
<p>使用GUI编辑器编辑GATT配置文件。将 <code>INGChips Console Service</code>
添加到GATT配置文件 （图 <a href="tutorial.html#fig:ch1-smart-meter-gatt">3.30</a>）.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-smart-meter-gatt"></span>
<img src="img/ch1-smart-meter-gatt.png" alt="Smart Meter GATT配置文件" width="60%" />
<p class="caption">
Figure 3.30: Smart Meter GATT配置文件
</p>
</div>
</div>
<div id="定义温度计数据" class="section level3 hasAnchor" number="3.8.2">
<h3><span class="header-section-number">3.8.2</span> 定义温度计数据<a href="tutorial.html#定义温度计数据" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>温度计由它的设备地址和id来识别。每个温度计使用由 <code>conn_handle</code>
来显示自己的连接状态。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="tutorial.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> slave_info</span>
<span id="cb24-2"><a href="tutorial.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-3"><a href="tutorial.html#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint8_t</span>     id<span class="op">;</span></span>
<span id="cb24-4"><a href="tutorial.html#cb24-4" aria-hidden="true" tabindex="-1"></a>    bd_addr_t   addr<span class="op">;</span></span>
<span id="cb24-5"><a href="tutorial.html#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint16_t</span>    conn_handle<span class="op">;</span></span>
<span id="cb24-6"><a href="tutorial.html#cb24-6" aria-hidden="true" tabindex="-1"></a>    gatt_client_service_t                   service_thermo<span class="op">;</span></span>
<span id="cb24-7"><a href="tutorial.html#cb24-7" aria-hidden="true" tabindex="-1"></a>    gatt_client_characteristic_t            temp_char<span class="op">;</span></span>
<span id="cb24-8"><a href="tutorial.html#cb24-8" aria-hidden="true" tabindex="-1"></a>    gatt_client_characteristic_descriptor_t temp_desc<span class="op">;</span></span>
<span id="cb24-9"><a href="tutorial.html#cb24-9" aria-hidden="true" tabindex="-1"></a>    gatt_client_notification_t              temp_notify<span class="op">;</span></span>
<span id="cb24-10"><a href="tutorial.html#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> slave_info_t<span class="op">;</span></span></code></pre></div>
<p>设定了4个温度计。</p>
</div>
<div id="扫描温度计" class="section level3 hasAnchor" number="3.8.3">
<h3><span class="header-section-number">3.8.3</span> 扫描温度计<a href="tutorial.html#扫描温度计" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>调用两个GAP
API接口开始扫描。一旦找到一个设备，会检查它的设备地址是否是温度计。如果是，停止扫描并调用
<code>gap_ext_create_connection</code> 进行连接。
连接建立后，如果有温度计未连接，则重新开始扫描。</p>
</div>
<div id="发现服务" class="section level3 hasAnchor" number="3.8.4">
<h3><span class="header-section-number">3.8.4</span> 发现服务<a href="tutorial.html#发现服务" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>连接建立后，调用 <code>gatt_client</code> API接口来发现它的服务。
这些API接口遵循类似Android和IOS的逻辑。</p>
</div>
<div id="数据处理" class="section level3 hasAnchor" number="3.8.5">
<h3><span class="header-section-number">3.8.5</span> 数据处理<a href="tutorial.html#数据处理" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>预定温度计的 <code>Temperature Measurement</code>
特性。当接收到一个新的测量值时，将该值转换为一个字符串并将其报告给主机。如果我们的应用程序已经连接到一个中心设备，通过GATT特性将该信息转发给它。</p>
</div>
<div id="鲁棒性" class="section level3 hasAnchor" number="3.8.6">
<h3><span class="header-section-number">3.8.6</span> 鲁棒性<a href="tutorial.html#鲁棒性" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>为了让我们的应用更稳健:</p>
<ul>
<li><p>如果与温度计断开连接，则开始扫描;</p></li>
<li><p>如果与中心设备断开连接，则开始广播。</p></li>
</ul>
</div>
<div id="准备温度计" class="section level3 hasAnchor" number="3.8.7">
<h3><span class="header-section-number">3.8.7</span> 准备温度计<a href="tutorial.html#准备温度计" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>我们可以将示例 <code>thermo_ota</code>
用做温度计。但是我们需要为每一个温度计配置不同的地址。</p>
<p>我们可以写一个简单的脚本为下载程序自动生成这些地址:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode pascal"><code class="sourceCode pascal"><span id="cb25-1"><a href="tutorial.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">procedure</span> OnStartBin(<span class="kw">const</span> BatchCounter, BinIndex: <span class="dt">Integer</span>;</span>
<span id="cb25-2"><a href="tutorial.html#cb25-2" aria-hidden="true" tabindex="-1"></a>                     <span class="kw">var</span> Data: TBytes; <span class="kw">var</span> Abort: <span class="dt">Boolean</span>);</span>
<span id="cb25-3"><a href="tutorial.html#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">begin</span></span>
<span id="cb25-4"><a href="tutorial.html#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> BinIndex &lt;&gt; <span class="dv">6</span> <span class="kw">then</span> <span class="kw">Exit</span>;</span>
<span id="cb25-5"><a href="tutorial.html#cb25-5" aria-hidden="true" tabindex="-1"></a>  Data[<span class="dv">0</span>] := BatchCounter;</span>
<span id="cb25-6"><a href="tutorial.html#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>;</span></code></pre></div>
<p>有关下载脚本的更多信息，请参见 <a href="core-tools.html#script-mass-prod">Scripting &amp; Mass
Production</a>.</p>
</div>
<div id="测试" class="section level3 hasAnchor" number="3.8.8">
<h3><span class="header-section-number">3.8.8</span> 测试<a href="tutorial.html#测试" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>在主机上输入 <code>start</code> 命令来启动我们的应用程序(开始扫描并广播)。使用
<code>INGdemo</code> 连接到名为”ING Smart Meter”的设备，检查温度测量结果。</p>
<p>关闭和打开一个或多个温度计，我们的应用程序应该能够重新连接到它们。</p>
</div>
</div>
<div id="hello-nim" class="section level2 hasAnchor" number="3.9">
<h2><span class="header-section-number">3.9</span> Hello, Nim<a href="tutorial.html#hello-nim" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>要使用 <code>Nim</code> 开发应用程序，需要 <code>Nim</code> 和 <code>Gnu 工具链</code> 。 <code>Nim</code> 编译器将
<code>Nim</code> 源代码翻译成 <code>C</code> 源代码，然后调用 <code>Gnu工具链</code> 将翻译后的 <code>C</code>
源代码与SDK进行编译链接，如图所示。（图 <a href="tutorial.html#fig:ch1-nim-build">3.31</a>）.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-nim-build"></span>
<img src="img/ch1-nim-build.png" alt="建立一个Nim应用程序" width="80%" />
<p class="caption">
Figure 3.31: 建立一个Nim应用程序
</p>
</div>
<p>推荐使用 <code>Visual Studio Code</code> 编辑和构建 <code>Nim</code> 代码。让我们使用 <code>Nim</code>
制作一个简单的应用程序。</p>
<div id="创建一个-nim-app" class="section level3 hasAnchor" number="3.9.1">
<h3><span class="header-section-number">3.9.1</span> 创建一个 <code>Nim</code> APP<a href="tutorial.html#创建一个-nim-app" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>在 <code>Develpment Tool</code> 页面，选择 <code>Nim + Gnu Toolchain</code> 。选择 <code>By Code</code>
生成广播和ATT数据库 （图 <a href="tutorial.html#fig:ch1-nim-by-code">3.32</a>）.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ch1-nim-by-code"></span>
<img src="img/ch1-nim-by-code.png" alt="通过代码生成数据" width="60%" />
<p class="caption">
Figure 3.32: 通过代码生成数据
</p>
</div>
<p><code>ingWizard</code> 也支持为 <code>Nim</code>
应用程序创建这些数据。在本教程中，我们将展示轻松地在 <code>Nim</code>
中使用元程序创建这些数据。</p>
</div>
<div id="创建广播数据" class="section level3 hasAnchor" number="3.9.2">
<h3><span class="header-section-number">3.9.2</span> 创建广播数据<a href="tutorial.html#创建广播数据" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>使用 <code>Nim</code> 模块 <code>btdatabuilder</code> ，我们可以轻松创建广播和GATT配置文件。</p>
<ul>
<li><p>例1:创建一个名为”Hello, Nim”的设备</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb26-1"><a href="tutorial.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb26-2"><a href="tutorial.html#cb26-2" aria-hidden="true" tabindex="-1"></a>  advData <span class="co">=</span> <span class="at">ToArray</span><span class="kw">([</span><span class="at">Flags</span><span class="kw">({</span><span class="at">LEGeneralDiscoverableMode</span><span class="kw">,</span> <span class="at">BR_EDR_NotSupported</span><span class="kw">}),</span></span>
<span id="cb26-3"><a href="tutorial.html#cb26-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">LocalName</span><span class="kw">(</span><span class="st">&quot;Hello, Nim&quot;</span><span class="kw">)])</span></span></code></pre></div></li>
<li><p>例2:创建iBeacon</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb27-1"><a href="tutorial.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb27-2"><a href="tutorial.html#cb27-2" aria-hidden="true" tabindex="-1"></a>  advData <span class="co">=</span> <span class="at">ToArray</span><span class="kw">([</span><span class="at">Flags</span><span class="kw">({</span><span class="at">LEGeneralDiscoverableMode</span><span class="kw">,</span> <span class="at">BR_EDR_NotSupported</span><span class="kw">}),</span></span>
<span id="cb27-3"><a href="tutorial.html#cb27-3" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">iBeacon</span><span class="kw">(</span><span class="st">&quot;{E9052F1E-9D67-4A6E-B2D7-459D132D6A94}&quot;</span><span class="kw">,</span></span>
<span id="cb27-4"><a href="tutorial.html#cb27-4" aria-hidden="true" tabindex="-1"></a>                             <span class="dv">0</span><span class="kw">,</span> <span class="dv">0</span><span class="kw">,</span> <span class="co">-</span><span class="dv">50</span><span class="kw">)])</span></span></code></pre></div></li>
</ul>
</div>
<div id="创建配置数据" class="section level3 hasAnchor" number="3.9.3">
<h3><span class="header-section-number">3.9.3</span> 创建配置数据<a href="tutorial.html#创建配置数据" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb28-1"><a href="tutorial.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">defineProfile</span><span class="kw">([</span><span class="at">Service</span><span class="kw">(</span><span class="at">SIG_UUID_SERVICE_GENERIC_ACCESS</span><span class="kw">),</span></span>
<span id="cb28-2"><a href="tutorial.html#cb28-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">Characteristic</span><span class="kw">(</span><span class="at">SIG_UUID_CHARACT_GAP_DEVICE_NAME</span><span class="kw">,</span> <span class="at">ATT_PROPERTY_READ</span><span class="kw">,</span></span>
<span id="cb28-3"><a href="tutorial.html#cb28-3" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&quot;Hello, Nim&quot;</span><span class="kw">),</span></span>
<span id="cb28-4"><a href="tutorial.html#cb28-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">Characteristic</span><span class="kw">(</span><span class="at">SIG_UUID_CHARACT_GAP_APPEARANCE</span><span class="kw">,</span> <span class="at">ATT_PROPERTY_READ</span><span class="kw">,</span></span>
<span id="cb28-5"><a href="tutorial.html#cb28-5" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">[</span>0u8<span class="kw">,</span> <span class="dv">0</span><span class="kw">]),</span></span>
<span id="cb28-6"><a href="tutorial.html#cb28-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">Service</span><span class="kw">(</span><span class="at">SIG_UUID_SERVICE_BATTERY_SERVICE</span><span class="kw">),</span></span>
<span id="cb28-7"><a href="tutorial.html#cb28-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">Characteristic</span><span class="kw">(</span><span class="at">SIG_UUID_CHARACT_BATTERY_LEVEL</span><span class="kw">,</span> <span class="at">ATT_PROPERTY_READ</span><span class="kw">,</span></span>
<span id="cb28-8"><a href="tutorial.html#cb28-8" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">[</span>20u8<span class="kw">],</span> <span class="st">&quot;HANDLE_BATTERY_LEVEL&quot;</span><span class="kw">)],</span></span>
<span id="cb28-9"><a href="tutorial.html#cb28-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;profileData&quot;</span><span class="kw">)</span></span></code></pre></div>
<p>上述代码编译完成后，ATT数据库存储在 <code>profileData</code> 中，电池电量特性由常量
<code>HANDLE_BATTERY_LEVEL</code> 标识，电池电量值在ATT基础(即 <code>profileData</code>
)中的偏移量(以字节为单位)由常量 <code>HANDLE_BATTERY_LEVEL_OFFSET</code> 标识。
我们可以通过宏 <code>defineProfile</code>
像使用普通变量一样使用这些生成的变量和常量。例如，让我们创建一个任务来随机更新电池电量:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb29-1"><a href="tutorial.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> <span class="st">updateBatteryLevel</span><span class="kw">(</span>unused<span class="kw">:</span> <span class="at">pointer</span><span class="kw">)</span> <span class="at">{.noconv.}</span> <span class="co">=</span></span>
<span id="cb29-2"><a href="tutorial.html#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="cn">true</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="tutorial.html#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vTaskDelay</span><span class="kw">(</span><span class="fu">pdMS_TO_TICKS</span><span class="kw">(</span><span class="dv">1000</span><span class="kw">))</span></span>
<span id="cb29-4"><a href="tutorial.html#cb29-4" aria-hidden="true" tabindex="-1"></a>    profileData<span class="kw">[</span><span class="at">HANDLE_BATTERY_LEVEL_OFFSET</span><span class="kw">]</span> <span class="co">=</span> <span class="fu">rand_level</span><span class="kw">()</span></span>
<span id="cb29-5"><a href="tutorial.html#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">...</span></span>
<span id="cb29-6"><a href="tutorial.html#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="cf">discard</span> <span class="fu">xTaskCreate</span><span class="kw">(</span>updateBatteryLevel<span class="kw">,</span> <span class="st">&quot;b&quot;</span><span class="kw">,</span></span>
<span id="cb29-7"><a href="tutorial.html#cb29-7" aria-hidden="true" tabindex="-1"></a>                    configMINIMAL_STACK_SIZE<span class="kw">,</span> <span class="cn">nil</span><span class="kw">,</span></span>
<span id="cb29-8"><a href="tutorial.html#cb29-8" aria-hidden="true" tabindex="-1"></a>                    configMAX_PRIORITIES <span class="co">-</span> <span class="dv">1</span><span class="kw">,</span> <span class="cn">nil</span><span class="kw">)</span></span></code></pre></div>
<p>在 <code>Nim</code> 中至少有三种方法可以生成伪随机数，使用 <code>C</code>
语言stdlib库提供的PRNG，使用 <code>Nim</code> 提供的PRNG，或者创建我们自己的PRNG。</p>
<ul>
<li>使用 <code>C</code> 的PRNG</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb30-1"><a href="tutorial.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># It&#39;s easy to import C functions and use them</span></span>
<span id="cb30-2"><a href="tutorial.html#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> <span class="st">rand</span><span class="kw">():</span> <span class="at">cint</span> <span class="at">{. importc: &quot;rand&quot;, header: &quot;stdlib.h&quot;.}</span></span>
<span id="cb30-3"><a href="tutorial.html#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="tutorial.html#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> <span class="st">rand_level</span><span class="kw">():</span> <span class="at">uint8</span> <span class="co">=</span> <span class="cf">cast</span><span class="kw">[</span><span class="at">uint8</span><span class="kw">](</span><span class="fu">rand</span><span class="kw">()</span> <span class="co">mod</span> <span class="dv">101</span><span class="kw">)</span></span></code></pre></div>
<ul>
<li>使用 <code>Nim</code> 的PRNG</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb31-1"><a href="tutorial.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> random</span>
<span id="cb31-2"><a href="tutorial.html#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> <span class="st">rand_level</span><span class="kw">():</span> <span class="at">uint8</span> <span class="co">=</span> <span class="cf">cast</span><span class="kw">[</span><span class="at">uint8</span><span class="kw">](</span><span class="fu">rand</span><span class="kw">(</span><span class="dv">0</span><span class="kw">..</span><span class="dv">100</span><span class="kw">))</span></span></code></pre></div>
<ul>
<li>创建一个简易的PRNG</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="sourceCode nim"><code class="sourceCode nim"><span id="cb32-1"><a href="tutorial.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> <span class="st">rand_level</span><span class="kw">():</span> <span class="at">uint8</span><span class="co">=</span></span>
<span id="cb32-2"><a href="tutorial.html#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> <span class="fu">last</span> <span class="at">{.global.}</span> <span class="co">=</span> 0u16</span>
<span id="cb32-3"><a href="tutorial.html#cb32-3" aria-hidden="true" tabindex="-1"></a>  last <span class="co">=</span> <span class="kw">(</span>last <span class="co">*</span> <span class="dv">173</span> <span class="co">+</span> <span class="dv">31</span><span class="kw">)</span> <span class="co">and</span> <span class="bn">0x7fff</span>u16</span>
<span id="cb32-4"><a href="tutorial.html#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">cast</span><span class="kw">[</span><span class="at">uint8</span><span class="kw">](</span>last <span class="co">mod</span> <span class="dv">101</span><span class="kw">)</span></span></code></pre></div>
<p>正如我们所看到的，这三种方法在 <code>Nim</code> 上使用都很简单。</p>
<div class="rmdnote">
<p>
<code>platform_hrng</code>可用于初始化PRNG。
</p>
</div>
</div>
<div id="使用-nim-的好处" class="section level3 hasAnchor" number="3.9.4">
<h3><span class="header-section-number">3.9.4</span> 使用 <code>Nim</code> 的好处<a href="tutorial.html#使用-nim-的好处" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>Nim</code> 和 <code>C</code> 一样强大，因为SDK为 <code>Nim</code> 提供了所有绑定在 <code>C</code>
语言上的API接口 。采用 <code>Nim</code>
有很多好处，比如它支持元编程，而且是强类型的。</p>
<ul>
<li><p><em>元编程</em></p>
<p>使用元编程，我们可以在编译时创建广播和ATT数据库，这显然在运行时开销为
<code>0</code> 。</p></li>
<li><p><em>强类型</em></p>
<p><code>Nim</code> 比 <code>C</code> 属于更强的类型，这有助于使代码更安全。</p></li>
</ul>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="11">
<li id="fn11"><p><a href="https://developer.apple.com/ibeacon/" class="uri">https://developer.apple.com/ibeacon/</a><a href="tutorial.html#fnref11" class="footnote-back">↩︎</a></p></li>
<li id="fn12"><p>Note that UUID is not allowed to be all 0s in final products.<a href="tutorial.html#fnref12" class="footnote-back">↩︎</a></p></li>
<li id="fn13"><p><code>Makefile</code> follows the syntax of GNU <code>make</code>.<a href="tutorial.html#fnref13" class="footnote-back">↩︎</a></p></li>
<li id="fn14"><p><a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.health_thermometer.xml" class="uri">https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.health_thermometer.xml</a><a href="tutorial.html#fnref14" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="core-tools.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["user_guide.pdf", "user_guide.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
