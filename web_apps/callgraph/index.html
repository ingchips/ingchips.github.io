<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.6.9/dist/css/uikit.min.css" />
    <title>Call Graph Visualization For Gnu Arm Toolchain</title>
</head>
<body>
<!-- UIkit JS -->
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.9/dist/js/uikit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.9/dist/js/uikit-icons.min.js"></script>

<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@hpcc-js/wasm@1.0.1/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-graphviz@3.1.0/build/d3-graphviz.min.js"></script>
<script src="main.js"></script>
<script>

    var funcs;
    var graphs;

    function on_load_btn() {
        funcs = load_asm(document.getElementById('asm_src').value);
        graphs = analyze_stack(funcs);
        UIkit.modal("#loader").hide();
        make_dropdown($('#graph-dropdown'), graphs);
    }

    function show_graph(id) {
        var graphviz = d3.select("#graph").graphviz();
        let dotLines = to_diagrpah(funcs, graphs[id]);
        var dot = dotLines.join('');
        graphviz.renderDot(dot);
        var g = graphs[id];

        $('#max-stack-usage').text(g.stack_max + (g.unknown ? ' + unknown' : ''));
        $('#call-path').text(g.stack_max_path.join(' -> '));
    }

    function on_reset_view() {
        var graphviz = d3.select("#graph").graphviz();
        graphviz.resetZoom();
    }
</script>

<div class="uk-container">

    <div class="uk-alert-danger" uk-alert>
        <a class="uk-alert-close" uk-close></a>
        <h3>Notice</h3>
        <p>The result shown might be smaller than actual value.</p>
    </div>

<div id="loader">
    <div class="uk-margin">
        <button class="uk-button uk-button-primary" onclick="javascript:on_load_btn()">Load Assembly</button>
        <span class="uk-label uk-label-warning">Data is processed locally</span> 
    </div>

    <div class="uk-margin">
        <textarea class="uk-textarea" id="asm_src" rows="15" placeholder="Paste .s file (generated by arm-none-eabi-objdump) here, then click LOAD"></textarea>
    </div>

    <div class="uk-margin">
        
    </div>

</div>

<div id="graph_viewer">

    <div class="uk-margin">
        <button class="uk-button uk-button-default" type="button">Graphs</button>
        <div uk-dropdown>
            <ul class="uk-nav uk-dropdown-nav" id="graph-dropdown">
            </ul>
        </div>

        <button class="uk-button uk-button-default" type="button" onclick="javascript:on_reset_view()">Reset View</button>
    </div>

    <div class="uk-margin">
        <div class="uk-text-lead">Maximum Stack Usage (Bytes): </div>
        <div class="uk-text-danger" id="max-stack-usage"></div>
    </div>

    <div class="uk-margin">
        <div class="uk-text-lead">Call Chain for Maximum Stack Depth: </div>
        <div class="uk-text-primary" id="call-path"></div>
    </div>

    <div class="uk-margin">
        <div id="graph" style="text-align: center;"></div>
    </div>


</div>

</div>

</body>
</html>